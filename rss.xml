<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[学习随笔]]></title><description><![CDATA[日常学习之互联网技术]]></description><link>https://www.keisei.top</link><generator>GatsbyJS</generator><lastBuildDate>Thu, 28 May 2020 15:06:20 GMT</lastBuildDate><item><title><![CDATA[前端插件机制的探索]]></title><description><![CDATA[概述 插件架构宏观上来讲就是一种框架能够在确定的点上执行外部的代码，而不需要提前知道这部分代码的细节。 它既可以很简单，也可以很复杂。我们可以编写 webpack 插件，也可以开发 vs code…]]></description><link>https://www.keisei.top/plugin-mechanism/</link><guid isPermaLink="false">https://www.keisei.top/plugin-mechanism/</guid><pubDate>Tue, 12 May 2020 23:09:00 GMT</pubDate><content:encoded>&lt;h3&gt;概述&lt;/h3&gt;
&lt;p&gt;插件架构宏观上来讲就是一种框架能够在确定的点上执行外部的代码，而不需要提前知道这部分代码的细节。&lt;/p&gt;
&lt;p&gt;它既可以很简单，也可以很复杂。我们可以编写 webpack 插件，也可以开发 vs code 的插件，其基本架构是相似的。&lt;/p&gt;
&lt;p&gt;开发插件需要遵循一些约定，就像网络传输需要协议。它们必须能够被主进程以某种方式获取并使用。通常最初的开发者会发布一些接口或开发套件，允许其他的开发者对原系统开发插件，提供新的能力。&lt;/p&gt;
&lt;p&gt;插件架构是开放封闭原则（OCP）的一种开发原则的体现，表明系统对拓展开放，对修改封闭。插件架构解决了不需要修改核心系统代码而可以对系统增加一些额外的功能特性，只需要一些额外的代码。插件可以单独开发，单独测试。&lt;/p&gt;
&lt;h3&gt;案例学习 Rollup&lt;/h3&gt;
&lt;p&gt;最近公司的部分项目开始采用 rollup 工具打包，笔者也在个人项目中开始上手使用。简单来说，配置项要比 webpack 相对来说简单一些，但是要注意 rollup 主要是为打包模块而生，并且代码需要使用 ES6 及以上的标准编写。&lt;/p&gt;
&lt;p&gt;常见的 rollup 配置：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    input&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    output&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; file&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;build/greymon.js&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; format&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;umd&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; globals &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    external&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;globals&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    plugins&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;nodeResolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;babel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBabelOptions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;commonjs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;commonjsOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;process.env.NODE_ENV&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stringify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;development&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sizeSnapshot&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    input&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    output&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; file&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;build/greymon.min.js&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; format&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;umd&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; globals &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    external&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;globals&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    plugins&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;nodeResolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;babel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBabelOptions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;commonjs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;commonjsOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;process.env.NODE_ENV&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stringify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;production&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sizeSnapshot&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;uglify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    input&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    output&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; file&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; pkg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;module&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; format&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;esm&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    external&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    plugins&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;babel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBabelOptions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sizeSnapshot&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到 rollup 可以输出多种模块依赖方式，而只需指定 &lt;code class=&quot;language-text&quot;&gt;inputundefined outputundefined externalundefined plugins&lt;/code&gt; 等。&lt;/p&gt;
&lt;p&gt;那么我们就来看一下 rollup 的 &lt;code class=&quot;language-text&quot;&gt;plugins&lt;/code&gt; 是怎么实现的。&lt;/p&gt;
&lt;p&gt;首先我们需要了解 rollup 是怎么运行的，入口文件为 &lt;a href=&quot;https://github.com/rollup/rollup/blob/462bff7b1a0c384ecc3e278b1ea877e637c70f41/src/rollup/rollup.ts#L136&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;src/rollup/rollup.ts&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在 &lt;code class=&quot;language-text&quot;&gt;rollup()&lt;/code&gt; 中执行了 &lt;code class=&quot;language-text&quot;&gt;rollupInternal()&lt;/code&gt; 函数，在该函数中运行了实际的构建细节。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rollupInternal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token parameter&quot;&gt;rawInputOptions&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; GenericConfigObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  watcher&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; RollupWatcher &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Promise&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;RollupBuild&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; inputOptions &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getInputOptions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rawInputOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;initialiseTimers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;inputOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; graph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Graph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;inputOptions&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; watcher&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// remove the cache option from the memory after graph creation (cache is not used anymore)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; useCache &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rawInputOptions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cache &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;delete&lt;/span&gt; inputOptions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;delete&lt;/span&gt; rawInputOptions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;timeStart&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;BUILD&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; chunks&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Chunk&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hookParallel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;buildStart&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;inputOptions&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    chunks &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      inputOptions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;input &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Record&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      inputOptions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;manualChunks&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      inputOptions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;inlineDynamicImports&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; watchFiles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watchFiles&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;watchFiles&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watchFiles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; watchFiles&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hookParallel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;buildEnd&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hookParallel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;buildEnd&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;timeEnd&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;BUILD&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在这我们截取了部分逻辑，首先 rollup 会根据配置信息（入口、输出类型、插件等字段）构建 &lt;code class=&quot;language-text&quot;&gt;Graph&lt;/code&gt; 对象，在 &lt;code class=&quot;language-text&quot;&gt;Graph&lt;/code&gt; 构造函数内部初始化了 rollup 构建所需要的各种信息：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Graph&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;options&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; InputOptions&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; watcher&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; RollupWatcher &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cache &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginCache &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cache &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// increment access counter&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; name &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginCache&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; cache &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginCache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; key &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginDriver &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PluginDriver&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginCache
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到这里根据配置项来决定插件是否采用缓存机制，而真实的插件注入是在 &lt;code class=&quot;language-text&quot;&gt;PluginDriver&lt;/code&gt; 类中实现的，&lt;/p&gt;
&lt;p&gt;下面我们来看一下 &lt;code class=&quot;language-text&quot;&gt;PluginDriver&lt;/code&gt; 的实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PluginDriver&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; emitFile&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; EmitFile&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;finaliseAssets&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;getFileName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;fileReferenceId&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;setOutputBundle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token parameter&quot;&gt;outputBundle&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; OutputBundleWithPlaceholders&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    assetFileNames&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; fileEmitter&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; FileEmitter&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Graph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; pluginCache&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Record&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SerializablePluginCache&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; pluginContexts&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; PluginContext&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; plugins&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Plugin&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token parameter&quot;&gt;graph&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Graph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    userPlugins&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Plugin&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    pluginCache&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Record&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SerializablePluginCache&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    basePluginDriver&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; PluginDriver&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;warnDeprecatedHooks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;userPlugins&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;graph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginCache &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pluginCache&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileEmitter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FileEmitter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      graph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      basePluginDriver &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; basePluginDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileEmitter
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;emitFile &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileEmitter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;emitFile&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getFileName &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileEmitter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getFileName&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;finaliseAssets &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileEmitter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;assertAssetsFinalized&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;setOutputBundle &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileEmitter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;setOutputBundle&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; userPlugins&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;concat&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      basePluginDriver &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; basePluginDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginContexts &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;getPluginContexts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pluginCache&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileEmitter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;basePluginDriver&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; plugin &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; userPlugins&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; hook &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; inputHooks&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hook &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;warn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;errInputHookInOutputPlugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;plugin&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hook&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;注意这里构造函数中传入了 &lt;code class=&quot;language-text&quot;&gt;Graph&lt;/code&gt; 实例，这样方便后续对 &lt;code class=&quot;language-text&quot;&gt;Graph&lt;/code&gt; 实例属性的存取。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; runHook&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;H&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncPluginHooks&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  hookName&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  args&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Parameters&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;PluginHooks&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  pluginIndex&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  permitValues&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  hookContext&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ReplaceContext &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; EnsurePromise&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;ReturnType&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;PluginHooks&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; plugin &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pluginIndex&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; hook &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;hookName&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hook&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; undefined &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;any&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginContexts&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pluginIndex&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hookContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hookContext&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Promise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// permit values allows values to be returned instead of a functional hook&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; hook &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;permitValues&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; hook&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;throwInvalidHookError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hookName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hook &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;throwPluginError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; hook&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; hookName &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; runHookSync&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;H&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncPluginHooks&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  hookName&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  args&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Parameters&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;PluginHooks&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  pluginIndex&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  hookContext&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ReplaceContext
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ReturnType&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;PluginHooks&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; plugin &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pluginIndex&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; hook &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;hookName&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hook&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; undefined &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;any&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginContexts&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pluginIndex&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hookContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hookContext&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// permit values allows values to be returned instead of a functional hook&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; hook &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;throwInvalidHookError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hookName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hook &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;throwPluginError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; plugin&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; hook&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; hookName &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里我们选取了 &lt;code class=&quot;language-text&quot;&gt;PluginDriver&lt;/code&gt; 类的两个私有方法，&lt;code class=&quot;language-text&quot;&gt;runHookSync()&lt;/code&gt; 根据 &lt;code class=&quot;language-text&quot;&gt;node.js&lt;/code&gt; 通用的命名约定，sync 结尾的表明为同步执行，而 &lt;code class=&quot;language-text&quot;&gt;runHook()&lt;/code&gt; 根据返回类型为 &lt;code class=&quot;language-text&quot;&gt;Promise&lt;/code&gt; 也可以看出是异步执行的。&lt;/p&gt;
&lt;p&gt;由于 &lt;code class=&quot;language-text&quot;&gt;runHookSync()&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;runHook()&lt;/code&gt; 是仅供 &lt;code class=&quot;language-text&quot;&gt;PluginDriver&lt;/code&gt; 内部使用的，也是执行插件逻辑的地方，而调用该私有方法的入口则是分散在 rollup 构建的各种生命周期/广播的事件中：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 并行执行&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pluginDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hookParallel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;buildStart&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;inputOptions&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 顺序执行&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; outputPluginDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hookSeq&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;generateBundle&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  outputOptions&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  outputBundle&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  isWrite&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 同步执行并把前一次的结果作为参数传入下一个插件&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; hashAugmentation &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; outputPluginDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hookReduceValueSync&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;augmentChunkHash&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getPrerenderedChunk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;hashAugmentation&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pluginHash&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pluginHash&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      hashAugmentation &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; pluginHash&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; hashAugmentation&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;总结&lt;/h3&gt;
&lt;p&gt;插件机制可以保证在系统提供的能力范围内参与系统内部定制化的改造，这为第三方开发提供了更便利的条件，而且这种机制的存在可以激发更多的想法，促进整个生态的发展。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[如何绕过图片防盗链的校验]]></title><description><![CDATA[前言 最近笔者利用休息时间仿了一波微博热搜页面，简单来讲就是在服务端利用 cheerio 解析页面 html，提取热搜标题，并根据标题展开每个热搜的详细内容。  文字内容可以很简单的提取，但是热搜中出现的图片想要直接拿来显示并非易事。 遇到问题 图片的 src…]]></description><link>https://www.keisei.top/load-image-denied-solution/</link><guid isPermaLink="false">https://www.keisei.top/load-image-denied-solution/</guid><pubDate>Mon, 27 Apr 2020 21:11:00 GMT</pubDate><content:encoded>&lt;h3&gt;前言&lt;/h3&gt;
&lt;p&gt;最近笔者利用休息时间仿了一波&lt;a href=&quot;https://keisei.now.sh/weibo&quot;&gt;微博热搜&lt;/a&gt;页面，简单来讲就是在&lt;a href=&quot;https://github.com/keisei77/micro-backend/blob/master/route/weibo.js&quot;&gt;服务端&lt;/a&gt;利用 &lt;a href=&quot;https://cheerio.js.org/&quot;&gt;cheerio&lt;/a&gt; 解析页面 html，提取热搜标题，并根据标题展开每个热搜的详细内容。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e53db35c452c52ea128c557d642ec5dc/3298e/weibo-topic.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 135.01400560224087%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB/UlEQVRIx5WUi26DMAxF+f9/3LR2tF3LKG/yHJ4vwRVrgYVKLlJIDtf2dZLB9jS0GQ26IapS6tUPFaUl/IZhiA7ejQOUdL2msmypqnsqi5rulaHsrqluDSltSZm46HWIpOocHa+WTpmlzxvH1dDpZijlaLWj3nKY7VC8p1GOOt6f4E8A17ulW2Hp8m3o+GVGeDjgWYUPz+eY1lsB1r0bD3/lAQjwmYGA4qvY/L/CGRCHPs56hCH9snWPp2x+qFyIF2DHC+fM0L22pJ0nzS/Hp/t7YA36ADIMrKThlFErQPEF/ZTifoX8h0aghoiU4XW3XLsl+GsNWaHA0G2oxQvj19PfBCL3BzALqZeNHZsCB0AtmoR9UQqxkE7KRlNnIe3DJVgHH8Ba0YSm/QuEAgCDmTV9V5b84Mn9eLJTmD0po4YAQoWohCqUAAaXEZw3aVvhNCkCQxwvegRh/f2kKWePRgNFoYyeKEUJpFFZGQEUY4+3DSu55mGO0RDUEms9D771frEZ67ZRAQhFUDI/uGTqqJTF0AA/3zDKukXQJhC1y3j8oLDT69aIAqLLSBeLc7/FXhCLl0POZoZVxH+YEjQHylu1E4ia4aAEallMlys27FaIlGVekTpGr1vpZLTCSx66jHtxyzK7buy3NFwMcxNvKdtUeOCGiLEbFQ9bAv4C5VQyaNQTlNAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;weibo topic&quot;
        title=&quot;weibo topic&quot;
        src=&quot;/static/e53db35c452c52ea128c557d642ec5dc/799d3/weibo-topic.png&quot;
        srcset=&quot;/static/e53db35c452c52ea128c557d642ec5dc/00d96/weibo-topic.png 148w,
/static/e53db35c452c52ea128c557d642ec5dc/0b23c/weibo-topic.png 295w,
/static/e53db35c452c52ea128c557d642ec5dc/799d3/weibo-topic.png 590w,
/static/e53db35c452c52ea128c557d642ec5dc/3298e/weibo-topic.png 714w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;文字内容可以很简单的提取，但是热搜中出现的图片想要直接拿来显示并非易事。&lt;/p&gt;
&lt;h3&gt;遇到问题&lt;/h3&gt;
&lt;p&gt;图片的 src 直接可以通过解析提取，如果直接拿来在我们的域名上显示会出现一个奇怪的问题：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ceb333806c254bf16ba3ef67d3d09a93/c2188/image-blocked.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.28750653423941%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABx0lEQVQoz02S13KsMBBE+f+/c9ll+8W76zWXjFAOpL4tWIeHrgGhOROawmgDaxzSsmBZ/2hbMYkRfddhGHpUVYm2qVHVNdq2Qdc16PsWI7+N4wApBQRjMcqIstL8qNB9q5OYlEc/CCYMLGiglIJhDN4fz0PfI4RwnGm+e54751E4F0hW7MYwagIUq1ms286ooG83hKpCZGIiYKYSAZGdRkJysag15pROoNSO1XL1XCGy6nwopQXWOtjLBfHzE4lJGZgIidOE+PWF6NwJZIE5xhOoHkCl3A/UmnBAD+D1iliWSNYesB9g7poFHM+jlL9ArT0Ex/UEORu4i0TQd3Rw1wsSgXMGPkae2VHiyPndP4ALRzbGovAhHV3FOCOmU4Fn87JC80JX/oOk04pJ2YBJGe5ZQLXtYYbMZnEdluC882KiAU0t0LWSmng5Oy55gR0T2NcNBJ1WdNUKAUN5wgMBIe+PUfFsaHiPhQtjwukulXeZx+/524iJI4oJ09sbytdXlC8vuD8/o2bcmQzukUnYqfr9HbenJwwfH9wh95V3tiwbtWKel1PrRvc01P2Oji53/H0aGjTyecswdrazw53jjnS85t+gaNR/i4j7VBwMC1IAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image blocked&quot;
        title=&quot;image blocked&quot;
        src=&quot;/static/ceb333806c254bf16ba3ef67d3d09a93/799d3/image-blocked.png&quot;
        srcset=&quot;/static/ceb333806c254bf16ba3ef67d3d09a93/00d96/image-blocked.png 148w,
/static/ceb333806c254bf16ba3ef67d3d09a93/0b23c/image-blocked.png 295w,
/static/ceb333806c254bf16ba3ef67d3d09a93/799d3/image-blocked.png 590w,
/static/ceb333806c254bf16ba3ef67d3d09a93/2a3d6/image-blocked.png 885w,
/static/ceb333806c254bf16ba3ef67d3d09a93/ae92f/image-blocked.png 1180w,
/static/ceb333806c254bf16ba3ef67d3d09a93/c2188/image-blocked.png 1913w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;所有的图片都没有显示。&lt;/p&gt;
&lt;p&gt;具体来看图片的请求：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e39d79ea8487d7f7851c935cab76c9ef/77ac2/blocked-reason.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.48406546080965%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABdElEQVQoz5VTi46CMBDk/z/QGBQUQcr7TaEYmZtFMfHO87wmk20WOp3d2VpZlkH3PfquQ57n8H0f9v6IUKllfz6fEQTBEuM4hmI+DEPIOfn/O6yUH7KyRDcM0OOIoiiw3zsLmRAIkiR5REGapih5pq7rH7C8nY14s0G03ULtdmj4YxQp5CQYeEnbtkuUNc/zA78tKzq40LaNznHQs5S2qpBTZcUoRMYYXK/XJ7J3sJKTh+l4xOh5MFSlqUj6J72Ssnr2d1X0TtlDYcmD4+GAgYTjnVAaXlOhmKW1fiL8U2FKhcZ1b4RsuG4axGx6QcLpcnm6ff6A1CpUeFNIjFG0ECa8ICVa9lQzd6H7i8pPSk79E4xzV8hSe1qvzgHiUKGmOdKCgWWLOR+VHNMQ41KhGMOSu7pClqdoSCSGTNOE/6zFFMORMVQ40JQqyzmgDToSdnw96xyOLFviul+x5tYRszIh4bMq+DIKRpnDV47KLK54lVvzXym1ngNpGFhzAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;blocked reason&quot;
        title=&quot;blocked reason&quot;
        src=&quot;/static/e39d79ea8487d7f7851c935cab76c9ef/799d3/blocked-reason.png&quot;
        srcset=&quot;/static/e39d79ea8487d7f7851c935cab76c9ef/00d96/blocked-reason.png 148w,
/static/e39d79ea8487d7f7851c935cab76c9ef/0b23c/blocked-reason.png 295w,
/static/e39d79ea8487d7f7851c935cab76c9ef/799d3/blocked-reason.png 590w,
/static/e39d79ea8487d7f7851c935cab76c9ef/2a3d6/blocked-reason.png 885w,
/static/e39d79ea8487d7f7851c935cab76c9ef/77ac2/blocked-reason.png 1161w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;结果发现 403 被禁用，response header 中有一个 &lt;code class=&quot;language-text&quot;&gt;x-tengine-error: denied by Referer ACL&lt;/code&gt;，经过&lt;a href=&quot;https://blog.csdn.net/johnny_mu/article/details/105166878&quot;&gt;网上的搜索发现&lt;/a&gt;应该是微博为了图片不被他人使用做了防盗链的校验，但是这个措施只是相当于校验了白名单中的 referer。那么我们有没有可能为图片的请求加上 referer 这个 header 呢？&lt;/p&gt;
&lt;h3&gt;解决方案&lt;/h3&gt;
&lt;p&gt;由于使用了免费的后端服务，所以我们没办法添加 nginx 做反向代理。但我们还可以通过服务器来劫持对图片发起的请求：&lt;/p&gt;
&lt;p&gt;我们指定图片的 src 是一串我们自己服务器的请求，把图片真实的地址和 referer 地址通过 query 的方式带入：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;img src={`${MyAPI}?src=${src}&amp;amp;referer=${referer}`} alt=&quot;media image&quot; /&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在服务器端我们解析 query 并通过 req.pipe 来还原真实请求结果：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; request &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;request&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;weiboAssetsHandler&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; src&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; referer &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; options &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      url&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; src&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      headers&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        Referer&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;encodeURI&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;referer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;pipe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;pipe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;res&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      error&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; error&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;message&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

server&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/assets&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; weiboAssetsHandler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;通过这番操作，我们再来看请求：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/55a700cc419dc109c5ed363f78faf0eb/bb3cf/image-with-proxy.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 142.61119081779051%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAGfElEQVRIx42Ve1CU1xnGdybtH800bbR1nKSml5gMRiOBysUGQQNRLuEiwgLhplwEFkUoBMJilkhVIkFNGhK0mhDMRONMzUxmmj866ZjpdDrpjEmTqGNQbst12fvl2yssu7+e74PaEGc62Zlnvvec857nnPe87/usyjb9Hq65i8yNDWAcH2Toq35uft7HzWt93Lj2Jre/PsPE0Hkmvjm/9P1/ED6qsM9K2GsWsBByTOL2LGCz+4Ag4bBAaIHQ94Tsq3J7/FjtfuxOPwG/D68/iMcXJLCwiH9+6ft9Ie9V2aV5Jgwepk0e7G4fLu8S7JIXyRfA6fHhEPNOcbBD8mET84ot5hR/YdtcHrEngFsmlLwiRFcAs7ilweLDYBUEngCS4jCP2zev2NLy1/Vf2xdQIK+7ln198wphUNxmEYtzEauAyR7EGwixGA4zvxhiQSAYCrPwXSyvyXZweeyRbxgMhXDaJYwGKw6bC7PRxuyMBZPRgdXiYmbawvSUGJscTIzPMTVpxmZ1MSvmDTNWJidMir/F7CQQEEmZDy4qC0O3JhkfNXDrup5bN/Tc+HpMmZPtm9fHGfpmkuv/HmH49rQy/+UXw9y6OYFZHGSas2O3SQSDIVRydoKhRRFiiJAIUw41pNgi7JAcbkhZWxAHy2MZC8Eg8wtBxf/bPzlshTDgXRRhiwxaPThtXhF2QJwoykcS5WR247T6CS7ITyOy6fAx7w/j94l3N7uUGxoNNrHHQVAm9IrsnBt4hxOn+untPcNbFy5y7ctLfPRhLz2nL9D//hUGrlzm08++4F+ff8XVf37GwAcXOHvmHEaTGcQlF0R2g0oEYZFlt4eUvFRS1GqKKkqI25lEU3ssR17PJqUojqzqYtSavWTnlqI9cpTOV3uJSYwl6qko7gyPKKGGl0NXCF2SG3XFPmp0LRw+Xsa2ZxM4fOkk7wy9Qlb5L0lMikVdXkxlh4ZaTR39A2+Tk60mS8BomlOIQuJdVxDuLiilqP4gu/OfZ1f6bhr691D/p2SiYpN49LEnSUxJp7CjhZLaOk6+8RqaA7VU1h4QPW9ZIgx/i9Aj3rDhcCfP17eyt6adUk0jGRVZbEmIo3jrLjIin+bx9U8RHZ/GnuL95BeVCuK9aF5oZs5guPeGfpG9upbfk55fSXnTyxzsOkbuvhYiI7Zw8Gcb0a3/HZGr17Fhw5PsSEokbvNW6rprqGquRT8yfi+hx+unqKSCZ3Mq2N/6B17sUKPRdlNa3khyVDI7EjJJTimgoLyJ7EINac/lkVdWyI5MNcP6yXsJvaLBi8sq2JaSRbmmnbID7RTXa8kvbyA5Zx9PxKWRvU/Lkbc+ouX4B2hPnqD1pWbKaw5ye3xsmSi0TCyHLGpoTK/nzsgYo/op9FOzDI+NMzY+weS0gckZI1OzJmaMoqfnLMyYrBiNE3gstrtE4WXc7RTJ5RNVLwlBcIq+dGC3uoUo2JiZsmKzSKJr3Eq/zxnsolO8wk/CKfbIQqGIhyIY0lKnyIROh4R+dIaR4RnMQjXcQlTNRrtQFNnRidftVRTGIVTJ6fTgFev25bGsSD7xbF4htEutFwjS0a6jubkNXc95dF0nada20fRyDz1nLtL2gpaiogry1HsoKVGTk5sp6jWPXWmpVNXVi8Pdd8VhqfXEaVl7SsmvaKOm9RSpBVVEp6YQL7JerT1LYkYtqh+uQaVSsfahtaxafT+rfr6KHz3wU6KiY7BarUvvqCiRXDbiuhUNOqpbX6ft+NtkV7aRe+gYefVdHDo6yM60IhorG0iN28IvHnmETdHxPLElkt9ERIhy2vk/Qln6lCwLlc0WJZJbraPztcukqutFnbVQ/eKb1AjEbopAk1/IqUPNHEsuJedXSUTGxrL5txFs356MzWZfSegR/3DZBZWUHf4zzT1XyCo4RFZmIYnPZFJc10lyQgIxjz5M18Z0Tq/aRobqATY+9jhr1/2axOR0HA7nSkKXJFF+QIf23VF0g6NkVnbzTGoRSSm7KRa93f3SCdpKG+lds53jD8aTcd+DrF+7htUPryM+YQcWi3klocNhR9d3ib6/m+i/aqb341kaX7lIqejn+pZX2V/VxNHNmRy9P4baH28gXvUDtm6OYdPTQoHEmsPh+A6hU6Lr7CX6//YP+v9ylcbuATpPX+a9T+7w7idjDH6q540//pWq6AxS7vsJESLb2o4+Ln88xOC5D/FYLSsI/wM/Jh9fbkkZJQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image with proxy&quot;
        title=&quot;image with proxy&quot;
        src=&quot;/static/55a700cc419dc109c5ed363f78faf0eb/799d3/image-with-proxy.png&quot;
        srcset=&quot;/static/55a700cc419dc109c5ed363f78faf0eb/00d96/image-with-proxy.png 148w,
/static/55a700cc419dc109c5ed363f78faf0eb/0b23c/image-with-proxy.png 295w,
/static/55a700cc419dc109c5ed363f78faf0eb/799d3/image-with-proxy.png 590w,
/static/55a700cc419dc109c5ed363f78faf0eb/bb3cf/image-with-proxy.png 697w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;可以看到，图片真实的出现在了我们自己的网站。&lt;/p&gt;
&lt;p&gt;再看一下我们的请求已经可以成功返回 200：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/dc6e1336047dfeca3345162f3137de07/30a34/success-response.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.63540569020021%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABN0lEQVQoz5WS65KCMAyF+/4vuP5aQaGUXrgoFPB2TOLUcVcddzvzTdIOPT1JUK7awHuNSq9v0F7rHLbeCM5uEXyJJmh0rflB2/ymgvI+IIQGbdsRPbSpsd8PxIgYJ8zzgongPE6zIGcURzobx0ikGKGMMSiKLaytsdvtUFuDvu8wxYjz+YzL5XLnL0vVdU0lairbk6s9nPNomoZeG8nFhMPhgOPxKPFR/B2qKAqwaAjh5pDyvu/fOvgomOe5OOTSWYwju2WHSeDTevxGfa1WyLIMLGytFYZhoMbP0sNPPDlcZ9/iiPvGJTvnaNrtvXd86XQ6SZ5igvdPQ+EeVlUloizIJbM4u1yWRYT54qt+vXKsDPWNy2TBrusk58gTToKvSJNPMSH/YVmWIsSTZmGeMrtkYX71P+sKCBhUnh3QnIcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;success response&quot;
        title=&quot;success response&quot;
        src=&quot;/static/dc6e1336047dfeca3345162f3137de07/799d3/success-response.png&quot;
        srcset=&quot;/static/dc6e1336047dfeca3345162f3137de07/00d96/success-response.png 148w,
/static/dc6e1336047dfeca3345162f3137de07/0b23c/success-response.png 295w,
/static/dc6e1336047dfeca3345162f3137de07/799d3/success-response.png 590w,
/static/dc6e1336047dfeca3345162f3137de07/2a3d6/success-response.png 885w,
/static/dc6e1336047dfeca3345162f3137de07/ae92f/success-response.png 1180w,
/static/dc6e1336047dfeca3345162f3137de07/30a34/success-response.png 1898w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;总结&lt;/h3&gt;
&lt;p&gt;虽然说这么做会有损微博的利益，但是我们也从中学到了一些处理请求转发的小技巧。
正所谓道高一尺魔高一丈，正是有了互联网的攻防才能促进我们的行业更加安全，更能保障用户的权益。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[入门 React DOM 服务端渲染]]></title><description><![CDATA[前言 当我们需要 React 服务端渲染时，需要了解  这个对象。它能够使组件渲染成静态的 html 标记。 ReactDOMServer 提供了四个方法，其中  和  可以在浏览器和 node 环境中运行， 和  由于使用了 node 中特有的 stream…]]></description><link>https://www.keisei.top/getting-started-react-dom-server-render/</link><guid isPermaLink="false">https://www.keisei.top/getting-started-react-dom-server-render/</guid><pubDate>Fri, 17 Apr 2020 23:52:00 GMT</pubDate><content:encoded>&lt;h3&gt;前言&lt;/h3&gt;
&lt;p&gt;当我们需要 React 服务端渲染时，需要了解 &lt;a href=&quot;https://reactjs.org/docs/react-dom-server.html#rendertostring&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;ReactDOMServer&lt;/code&gt;&lt;/a&gt; 这个对象。它能够使组件渲染成静态的 html 标记。&lt;/p&gt;
&lt;p&gt;ReactDOMServer 提供了四个方法，其中 &lt;a href=&quot;https://reactjs.org/docs/react-dom-server.html#rendertostring&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;renderToString()&lt;/code&gt;&lt;/a&gt; 和 &lt;a href=&quot;https://reactjs.org/docs/react-dom-server.html#rendertostaticmarkup&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;renderToStaticMarkup()&lt;/code&gt;&lt;/a&gt; 可以在浏览器和 node 环境中运行，&lt;a href=&quot;https://reactjs.org/docs/react-dom-server.html#rendertonodestream&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;renderToNodeStream()&lt;/code&gt;&lt;/a&gt; 和 &lt;a href=&quot;https://reactjs.org/docs/react-dom-server.html#rendertostaticnodestream&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;renderToStaticNodeStream()&lt;/code&gt;&lt;/a&gt; 由于使用了 node 中特有的 stream，所以不能在浏览器中运行。&lt;/p&gt;
&lt;h3&gt;&lt;code class=&quot;language-text&quot;&gt;renderToString&lt;/code&gt; 执行原理&lt;/h3&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;renderToString&lt;/code&gt; 作用&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;将 React 元素渲染为初始 HTML。React 将返回一个 HTML 字符串。你可以使用此方法在服务端生成 HTML，并在首次请求时将标记下发，以加快页面加载速度，并允许搜索引擎爬取你的页面以达到 SEO 优化的目的。&lt;/p&gt;
&lt;p&gt;如果你在已有服务端渲染标记的节点上调用 &lt;a href=&quot;https://zh-hans.reactjs.org/docs/react-dom.html#hydrate&quot;&gt;ReactDOM.hydrate()&lt;/a&gt; 方法，React 将会保留该节点且只进行事件处理绑定，从而让你有一个非常高性能的首次加载体验。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;hydrate()&lt;/code&gt; 作用&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;简单来讲这个方法是和 render() 的作用是相同的，只不过 &lt;code class=&quot;language-text&quot;&gt;hydrate()&lt;/code&gt; 在 &lt;code class=&quot;language-text&quot;&gt;ReactDOMServer&lt;/code&gt; 渲染的容器中对 HTML 的内容进行补水操作。React 会尝试在已有标记上绑定事件监听器。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;renderToString&lt;/code&gt; 的实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;renderToString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;element&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; renderer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReactPartialRenderer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;element&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; markup &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; renderer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; markup&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    renderer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;destroy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;该函数接收 react 组件参数并在内部实例化一个 &lt;code class=&quot;language-text&quot;&gt;ReactPartialRenderer&lt;/code&gt;，该渲染器调用 read 方法返回 string 类型的标记。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReactDOMServerRenderer&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;children&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; mixed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; makeStaticMarkup&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;boolean&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; flatChildren &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;flattenTopLevelChildren&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; topFrame&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Frame &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// Assume all trees start in the HTML namespace (not totally true, but&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// this is what we did historically)&lt;/span&gt;
      domNamespace&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Namespaces&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;html&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      children&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; flatChildren&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      childIndex&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      context&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; emptyObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      footer&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__DEV__&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;topFrame&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;any&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; FrameDev&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;debugElementStack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;threadID &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;allocThreadID&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;topFrame&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exhausted &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;currentSelectValue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;previousWasTextNode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;makeStaticMarkup &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; makeStaticMarkup&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;suspenseDepth &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// Context (new API)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contextIndex &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contextStack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contextValueStack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__DEV__&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contextProviderStack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ReactPartialRenderer&lt;/code&gt; 的构造函数初始化了一些属性，其中 this.stack 初始值为只有顶级 frame 的数组。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;renderer.read()&lt;/code&gt; 是内部的核心逻辑，该方法中 while 循环条件比较输出的 out 字符串长度，并进一步调用 &lt;code class=&quot;language-text&quot;&gt;render()&lt;/code&gt; 方法返回的字符串追加到 out 中。由于在 read 中传入的参数为 &lt;code class=&quot;language-text&quot;&gt;Infinity&lt;/code&gt;，所以只有在 &lt;code class=&quot;language-text&quot;&gt;this.stack.length === 0&lt;/code&gt; 时才会 break 退出。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;render()&lt;/code&gt; 方法内部根据了 child 节点类型是字符串、数字、react 组件分别执行对应的逻辑，如果 child 还有 child 节点，那么会被 push 到 this.stack 中，这样 &lt;code class=&quot;language-text&quot;&gt;read()&lt;/code&gt; 方法中的 while 循环就会继续解析该 child 的内容。&lt;/p&gt;
&lt;p&gt;这其中还有非常重要的一个函数是 &lt;code class=&quot;language-text&quot;&gt;processChild(elementundefined Component)&lt;/code&gt; element 即为 child 节点，Component 为 element 上的 type 属性，即为我们传入的类组件或函数组件。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;processChild&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;element&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; isClass &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;shouldConstruct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Component&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; publicContext &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;processContext&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Component&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; threadID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; isClass&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; queue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; replace &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; updater &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function-variable function&quot;&gt;isMounted&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;publicInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token function-variable function&quot;&gt;enqueueForceUpdate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;publicInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;warnNoop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;publicInstance&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;forceUpdate&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token function-variable function&quot;&gt;enqueueReplaceState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;publicInstance&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; completeState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      replace &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      queue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;completeState&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token function-variable function&quot;&gt;enqueueSetState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;publicInstance&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; currentPartialState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;warnNoop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;publicInstance&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;setState&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      queue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;currentPartialState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;isClass&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    inst &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;element&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; publicContext&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; updater&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; Component&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getDerivedStateFromProps &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; partialState &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Component&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDerivedStateFromProps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        element&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;partialState &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;assign&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; partialState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; componentIdentity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;prepareToUseHooks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;componentIdentity&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    inst &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;element&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; publicContext&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; updater&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    inst &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;finishHooks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Component&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; element&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; publicContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// If the flag is on, everything is assumed to be a function component.&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// Otherwise, we also do the unfortunate dynamic checks.&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;disableModulePatternComponents &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; inst &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;render &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      child &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;validateRenderResult&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;child&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Component&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;props &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; element&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; publicContext&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;updater &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; updater&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; initialState &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialState &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; initialState &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;UNSAFE_componentWillMount &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;componentWillMount &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;componentWillMount &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// In order to support react-lifecycles-compat polyfilled components,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// Unsafe lifecycles should not be invoked for any component with the new gDSFP.&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; Component&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getDerivedStateFromProps &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;componentWillMount&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;UNSAFE_componentWillMount &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; Component&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getDerivedStateFromProps &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// In order to support react-lifecycles-compat polyfilled components,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// Unsafe lifecycles should not be invoked for any component with the new gDSFP.&lt;/span&gt;
      inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;UNSAFE_componentWillMount&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; oldQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; queue&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; oldReplace &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; replace&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      queue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      replace &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;oldReplace &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; oldQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; oldQueue&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; nextState &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; oldReplace &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; oldQueue&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; dontMutate &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; oldReplace &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; oldQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; partial &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; oldQueue&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; partialState &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; partial &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;
              &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;partial&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;inst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nextState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; element&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; publicContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; partial&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;partialState &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dontMutate&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              dontMutate &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
              nextState &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;assign&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nextState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; partialState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;assign&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nextState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; partialState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; nextState&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      queue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  child &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;validateRenderResult&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;child&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Component&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 这里为了兼容历史的 context&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; childContext&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;disableLegacyContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getChildContext &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; childContextTypes &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Component&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;childContextTypes&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; childContextTypes &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;object&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        childContext &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; inst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getChildContext&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; contextKey &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; childContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;invariant&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            contextKey &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; childContextTypes&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&apos;%s.getChildContext(): key &quot;%s&quot; is not defined in childContextTypes.&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;getComponentName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Component&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Unknown&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            contextKey
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;childContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;assign&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; childContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; child&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; context &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里我们省略了 Dev 环境下的各种判断逻辑，其余部分首先判断了组件是类组件还是函数组件，然后对应执行 &lt;code class=&quot;language-text&quot;&gt;new Component()&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;Component()&lt;/code&gt; 来初始化组件实例，并对实例添加 props,state,updater 属性。在接下来根据组件是否声明了生命周期函数来进行相应的调用。最后调用实例上的 &lt;code class=&quot;language-text&quot;&gt;render()&lt;/code&gt; 方法赋值给 child 并返回。&lt;/p&gt;
&lt;h3&gt;总结&lt;/h3&gt;
&lt;p&gt;本文主要从 &lt;code class=&quot;language-text&quot;&gt;renderToString&lt;/code&gt; 入口来简单了解了一下 react 是如何根据传入的组件一步步渲染为标准的 html 字符串，可以直接在浏览器中渲染。那么给了我们一些启发，是不是我们可以有一个专门用来将 react 组件实时渲染为 html 的服务，然后将输出返回给调用方，这样我们甚至可以支持在线配置 react 组件并持久化下来支撑将来的业务需要。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[迷你富文本编辑器]]></title><description><![CDATA[前言 之前曾有打算做一个富文本编辑器，最近花了一些时间开始开发，目前处于原型开发阶段。这其中遇到了一些棘手的问题，在此先记录一下。 初步构建 通过 CRA（create-react-app…]]></description><link>https://www.keisei.top/mini-editor/</link><guid isPermaLink="false">https://www.keisei.top/mini-editor/</guid><pubDate>Tue, 14 Apr 2020 22:39:00 GMT</pubDate><content:encoded>&lt;h3&gt;前言&lt;/h3&gt;
&lt;p&gt;之前曾有打算做一个富文本编辑器，最近花了一些时间开始开发，目前处于原型开发阶段。这其中遇到了一些棘手的问题，在此先记录一下。&lt;/p&gt;
&lt;h3&gt;初步构建&lt;/h3&gt;
&lt;p&gt;通过 CRA（&lt;a href=&quot;https://github.com/facebook/create-react-app&quot;&gt;create-react-app&lt;/a&gt;）快速搭建项目。
根据常见的编辑器样式，确定分为工具栏和输入框组件。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1d6ea7377fc13429772d26e6d2bb536a/50cab/prototype-editor.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 37.890625%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAbklEQVQoz6WSwQqAIBBE9/+/UbtYeFwVpJDVKTOpc/tg2NvwBpbssmDbHIyxqLWi01r7HXJuhfceMSWIiDoUQgAzY6Kx6wvpW6ThqhyFGqNbYt5h9Rr+NxtkKYjlAHVNTeT5DLcn2Mz6ye07+eIEEmZ46zdxaIYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;prototype editor&quot;
        title=&quot;prototype editor&quot;
        src=&quot;/static/1d6ea7377fc13429772d26e6d2bb536a/799d3/prototype-editor.png&quot;
        srcset=&quot;/static/1d6ea7377fc13429772d26e6d2bb536a/00d96/prototype-editor.png 148w,
/static/1d6ea7377fc13429772d26e6d2bb536a/0b23c/prototype-editor.png 295w,
/static/1d6ea7377fc13429772d26e6d2bb536a/799d3/prototype-editor.png 590w,
/static/1d6ea7377fc13429772d26e6d2bb536a/50cab/prototype-editor.png 768w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;工具栏&lt;/h4&gt;
&lt;p&gt;工具栏暂定加粗、斜体、下划线三种样式。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;Toolbar&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;props&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Toolbar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; toolbarState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toolbarDispatch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; props&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Toggle&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;bold&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;粗体&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bold&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;toolbarDispatch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;bold&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; payload&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;BoldSvg&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bold&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Toggle&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Toggle&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;italic&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;斜体&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;italic&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;toolbarDispatch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;italic&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; payload&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ItalicSvg&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;italic&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Toggle&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;

      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Toggle&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;underline&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;下划线&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;underline&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;toolbarDispatch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;underline&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; payload&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;UnderlineSvg&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;toolbarState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;underline&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Toggle&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;工具栏部分主要是各种按钮，以及点击时应该执行的 action。&lt;/p&gt;
&lt;p&gt;这里工具栏 Icon 采用了 svg 文件，这样我们可以修改它的 fill 属性来向用户表明是否是选中的：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f0cde03962a4c815094634ccb0d6f529/95c41/indicate-button-enabled.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 35.68627450980392%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAcElEQVQoz61RSQqAMBDr//9oXQaXk3WvYjvRiop4HA3kMpBMQlRWlNBxAq0jEBECvPciMjNU1fSgvICp6+MgNQt0zkFN44DGGFhr7y9SBr1i/IfD8JlKikvLb0NRzdOMbId0bPfKH4e4As1uxbKPsgHQLilCwP8UdwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;indicate button enabled&quot;
        title=&quot;indicate button enabled&quot;
        src=&quot;/static/f0cde03962a4c815094634ccb0d6f529/799d3/indicate-button-enabled.png&quot;
        srcset=&quot;/static/f0cde03962a4c815094634ccb0d6f529/00d96/indicate-button-enabled.png 148w,
/static/f0cde03962a4c815094634ccb0d6f529/0b23c/indicate-button-enabled.png 295w,
/static/f0cde03962a4c815094634ccb0d6f529/799d3/indicate-button-enabled.png 590w,
/static/f0cde03962a4c815094634ccb0d6f529/95c41/indicate-button-enabled.png 765w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;输入框&lt;/h4&gt;
&lt;p&gt;输入框部分，我们不能使用 textarea 标签来渲染的原因是不能对它的内容改变样式。我们使用了 &lt;code class=&quot;language-text&quot;&gt;contentEditable&lt;/code&gt; 属性来使 div 变为可编辑状态。&lt;/p&gt;
&lt;p&gt;另外，我们需要在输入时重置光标的位置，否则光标会一直在文本首位闪烁。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;resetCaret&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;el&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; HTMLElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; tailNode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createTextNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  el&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;appendChild&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tailNode&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; isTargetFocused &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;activeElement &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; el&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tailNode &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; tailNode&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;nodeValue &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; isTargetFocused&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; selection &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getSelection&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;selection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; range &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createRange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      range&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setStart&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tailNode&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; tailNode&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;nodeValue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      range&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;collapse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      selection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;removeAllRanges&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      selection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addRange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;range&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;el &lt;span class=&quot;token keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HTMLElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; el&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;focus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;Textarea&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;props&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Textarea&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; content&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; changeHandler &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; props&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; elRef &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; useRef &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; HTMLDivElement &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; isMount &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;elRef&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;useEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;elRef&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;content &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; elRef&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;innerHTML&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      elRef&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;innerHTML &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; content&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;resetCaret&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elRef&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; isMount&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;textarea&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;contentEditable&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;elRef&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;onInput&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;changeHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;onBlur&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;changeHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;onKeyUp&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;changeHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;onKeyDown&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;changeHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;那么我们是如何知道用户选择了哪些文本呢？&lt;/h4&gt;
&lt;p&gt;我们可以通过 &lt;code class=&quot;language-text&quot;&gt;window.getSelection()&lt;/code&gt; 这个函数来获取用户选择的文本对象。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5e7cd2d83b2c85402f6b4ef614d5222f/c87be/selection.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 44.86094316807739%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAxklEQVQoz6WQ2w6DIBBE+f+P9KW3tIUqAgILOl0w9pY+tDrJCbsbMpmM0FpD3RQOxwOkkoghgogQI7+REHjvuq5irIG19gNXcW5GeO9xPV2hTgqtbBE9GwXC4IdqNhOQY0b5W2aiVGfPfwPfKY1YJHLOcHKA3vVwXcA0gZkqRcv8KyLlBHtxaBsF03OS8Wn0jx6GJaE5W/T7G8iFVaneEhZDfeyhGi5eGpR9TcJHh5QSxjwip7n0xPuWlGJJ9K2PTYavxy26A4M+xUvJe1PPAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;selection&quot;
        title=&quot;selection&quot;
        src=&quot;/static/5e7cd2d83b2c85402f6b4ef614d5222f/799d3/selection.png&quot;
        srcset=&quot;/static/5e7cd2d83b2c85402f6b4ef614d5222f/00d96/selection.png 148w,
/static/5e7cd2d83b2c85402f6b4ef614d5222f/0b23c/selection.png 295w,
/static/5e7cd2d83b2c85402f6b4ef614d5222f/799d3/selection.png 590w,
/static/5e7cd2d83b2c85402f6b4ef614d5222f/c87be/selection.png 827w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;当选择上面的 &lt;code class=&quot;language-text&quot;&gt;Hello&lt;/code&gt; 时，可以看到输出了各种 Node 和各种 Offset，我们可以简单通过这些 Offset 来确定当前选中的文本。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;reducer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;state&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ToolbarState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ToolbarAction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; currentSelection &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getSelection&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;currentSelection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; selectedContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; currentSelection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; currentContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;bold&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          currentContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            selectedContent&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;lt;span style=&quot;font-weight: 700;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;selectedContent&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; bold&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bold&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; content&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; currentContent &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;italic&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          currentContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            selectedContent&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;lt;span style=&quot;font-style: italic;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;selectedContent&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; italic&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;italic&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; content&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; currentContent &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;underline&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          currentContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            selectedContent&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;lt;span style=&quot;text-decoration: underline;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;selectedContent&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            underline&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;underline&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            content&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; currentContent&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;change&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; payload&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;payload &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;change&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; payload&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;payload &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; state&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;toolbarState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toolbarDispatch&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; useReducer&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;
    Reducer&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;ToolbarState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ToolbarAction&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;reducer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    content&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;div&gt;Hello World!&amp;lt;/div&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    bold&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    italic&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    underline&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这部分是目前实现比较挫的地方，简单使用了 &lt;code class=&quot;language-text&quot;&gt;useReducer&lt;/code&gt; 来简化 setState 操作。可以看到这部分代码存在一些问题，首先由于 &lt;code class=&quot;language-text&quot;&gt;contentEditable&lt;/code&gt; 存在的缘故，用户输入的任何内容其实 React 并不能控制，我们只能通过各种事件的回调拿到 target 中的 innerHTML(TODO: innerText 是不是更好)&lt;/p&gt;
&lt;p&gt;当然我们可以通过 &lt;code class=&quot;language-text&quot;&gt;document.execCommand()&lt;/code&gt; 方法来传入对应的命令生成格式化的文本，但为了更深入地实现文本的可编辑性，我们暂时不考虑这种现成的 API。&lt;/p&gt;
&lt;h3&gt;开源 draft.js 体验&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://draftjs.org/&quot;&gt;draft.js&lt;/a&gt; 是 facebook 团队开源的 React 版富文本编辑器库，官方提供了一个简易的 Demo：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9aebc6248acb34be03dd3af267bb34ea/83225/draft.js.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.751914241960186%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/0lEQVQoz51Sy3KDMAzk//+tJ9J7J6d4CjgYbPwAtpYSEYeSmbSa0ch6sKy8ruZ5RowRKSXQmeK6rm85mUSxytoRdV3j63zG6fOEy0XhXTsCr0IIaNsWxvRQSkFrjYZzg77X0NcrurbjqLs213o0TYNlWX6BM0NqyMoEHmOA955r7Fs9ckwpcp++O2RIDQKjwVt8OIE45xjgqCZgAr4xnKaJnYastRizUz4MhnMSi+bERUCxpWBZ0eG2Dq2YB+9MWP3MmuJLpYufgHIBnCaPYbQcX6m5V/apXjLcq1UO7t9Yacu992EUlLcPUeRS/+PE7Ds4uHw1G+D+gf7V91v9AMG1YsQJMjuEAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;draft.js&quot;
        title=&quot;draft.js&quot;
        src=&quot;/static/9aebc6248acb34be03dd3af267bb34ea/799d3/draft.js.png&quot;
        srcset=&quot;/static/9aebc6248acb34be03dd3af267bb34ea/00d96/draft.js.png 148w,
/static/9aebc6248acb34be03dd3af267bb34ea/0b23c/draft.js.png 295w,
/static/9aebc6248acb34be03dd3af267bb34ea/799d3/draft.js.png 590w,
/static/9aebc6248acb34be03dd3af267bb34ea/83225/draft.js.png 653w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;RichEditor-editor&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;DraftEditor-root&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;DraftEditor-editorContainer&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;aria-describedby&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;placeholder-7k0cv&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;notranslate public-DraftEditor-content&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;contenteditable&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;true&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;role&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;textbox&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;spellcheck&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;false&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token style-attr language-css&quot;&gt;&lt;span class=&quot;token attr-name&quot;&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;style&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&quot;&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token property&quot;&gt;outline&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; none&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token property&quot;&gt;user-select&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token property&quot;&gt;white-space&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; pre-wrap&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token property&quot;&gt;overflow-wrap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; break-word&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;data-contents&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;true&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;
            &lt;span class=&quot;token attr-name&quot;&gt;data-block&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;true&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token attr-name&quot;&gt;data-editor&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;7k0cv&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token attr-name&quot;&gt;data-offset-key&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;b6so6-0-0&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;
              &lt;span class=&quot;token attr-name&quot;&gt;data-offset-key&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;b6so6-0-0&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
              &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;public-DraftStyleDefault-block public-DraftStyleDefault-ltr&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
              &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;span&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;data-offset-key&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;b6so6-0-0&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token style-attr language-css&quot;&gt;&lt;span class=&quot;token attr-name&quot;&gt; &lt;span class=&quot;token attr-name&quot;&gt;style&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&quot;&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token property&quot;&gt;font-weight&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bold&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
                &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;span&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;data-text&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;true&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;hello&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;span&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
              &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;span&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当实现粗体时，可以看到生成的 html 中，多出了一段&lt;code class=&quot;language-text&quot;&gt;font-weight: bold;&lt;/code&gt;的 span，其中很关键的一处是节点上有 offset-key 的 dataset，&lt;code class=&quot;language-text&quot;&gt;b6so6-0-0&lt;/code&gt; 第一段为标识文本片段的随机字符串，第二段目的不明，第三段为各种样式的索引值。&lt;/p&gt;
&lt;p&gt;那么是如何实现的呢？&lt;/p&gt;
&lt;p&gt;首先我们来创建编辑器：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; React&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; useState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; useEffect&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; useCallback &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;react&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; Editor&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; RichUtils&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; EditorState &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;draft-js&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; InlineStyleControls &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;./InlineStyleControls&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;draft-js/dist/Draft.css&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;DraftEditor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;editorState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; setEditorState&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;EditorState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createEmpty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; editor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; React&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;useRef&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;focusEditor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;editor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;editor &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; any&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;focus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;useEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;focusEditor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; onChange &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useCallback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;editorState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setEditorState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;editorState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; toggleInlineStyle &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useCallback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;inlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;onChange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;RichUtils&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toggleInlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;editorState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inlineStyle&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;onChange&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; editorState&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;style&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; padding&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;24px&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;focusEditor&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;InlineStyleControls&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;editorState&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;editorState&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token attr-name&quot;&gt;onToggle&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;toggleInlineStyle&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Editor&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;editor&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;editorState&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;editorState&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;onChange&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;onChange&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; DraftEditor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们以加粗为例，当点击加粗按钮时，实际上会调用 &lt;code class=&quot;language-text&quot;&gt;RichUtils.toggleInlineStyle()&lt;/code&gt; 方法：
&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/540e2fdfa04da6df5641babb6ff1e0db/97b2d/draft-editor.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.29612756264237%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACA0lEQVQ4y61T7Y6bMBDk/Z+uf3pqc2lIckBIwAb8DdhM1+aSSxq1p1ZdaWQQ9nhmZ8maZsRmK7A7SFQVx2GXo8j3YOcOXCzggwfrPYQOsOMC41bYEdDWoyhr1Ocz2rbFsizIfhQjvrwIfH0VeNl02OQc+XFA/qaRlzMO1YztcUTNZigLIl4gzQqhApqW40yEnHN475EFaxFGum7xWILHR9HzMq/rrZan1dL5y+WCoihwOp2Q+TmAlyXq/R7H/ZGsNnC0aXQWxlg4N5KVlSKtD/ggLImj73tS6AMUyRYdQ8taDLyFFgOU1rDGYDIKSkoopRH3RpJ7GNoTLUfCqqqQVWWFC6kSQkLTIaUUpBT0/gxJxIwxNE2TUNd16t31OQaTbQ8VGO/TgSg5Hoik0co9opKu6xKGYXi66IqseFubGUlOxQm84enDSEE5NyG8Ny/aiylGhBB+i+y42xJhnTaa3kC2ilQIukCmUB5T/byyb983OFDCs58xqgmGWQxE2LAe/n2Mfg3iT8hiI2PfwhIw6Rm6MbDcom8lvRuEeX4g/VShTCOhkhonRxohja7pYAcJR6MTCZe/UJldU4qW7WAhGYVTU0ha4V/qRpgUDg79JY6PoJSn9MfEb5qUOuduiBOwToG7rdpMxHGncCJryXKn0h8zz+t4fDYm90iWZRzOZNnjf9RPuHTakzx7vL4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;draft editor&quot;
        title=&quot;draft editor&quot;
        src=&quot;/static/540e2fdfa04da6df5641babb6ff1e0db/799d3/draft-editor.png&quot;
        srcset=&quot;/static/540e2fdfa04da6df5641babb6ff1e0db/00d96/draft-editor.png 148w,
/static/540e2fdfa04da6df5641babb6ff1e0db/0b23c/draft-editor.png 295w,
/static/540e2fdfa04da6df5641babb6ff1e0db/799d3/draft-editor.png 590w,
/static/540e2fdfa04da6df5641babb6ff1e0db/97b2d/draft-editor.png 878w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;这里 &lt;code class=&quot;language-text&quot;&gt;editorState&lt;/code&gt; 是我们通过 &lt;code class=&quot;language-text&quot;&gt;EditorState.createEmpty()&lt;/code&gt; 创建的 immutable 的初始状态，可以看到初始化了 currentContent,redoStack,selection,treeMap,undoStack 等属性。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;toggleInlineStyle&lt;/code&gt;内部实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;toggleInlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;editorState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 首先获取用户选择的文本&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; selection &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; editorState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getSelection&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 获取当前 style&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; currentStyle &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; editorState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getCurrentInlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 获取当前文本内容&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; content &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; editorState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getCurrentContent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; newContent&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 如果当前 style 中已有需要设置的 style，那直接去除，否则新增样式。&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 这里调用了 DraftModifier 模块来更新样式&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;currentStyle&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;has&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;inlineStyle&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    newContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DraftModifier&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;removeInlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      content&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      selection&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      inlineStyle
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    newContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DraftModifier&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;applyInlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      content&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      selection&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      inlineStyle
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; EditorState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;editorState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; newContent&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;change-inline-style&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DraftModifier.applyInlineStyle&lt;/code&gt; 内部简单调用了 &lt;code class=&quot;language-text&quot;&gt;ContentStateInlineStyle.add(contentStateundefined selectionStateundefined inlineStyle);&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; ContentStateInlineStyle &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function-variable function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;contentState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;modifyInlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;contentState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inlineStyle&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token function-variable function&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;contentState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;modifyInlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;contentState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inlineStyle&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;modifyInlineStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token parameter&quot;&gt;contentState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  selectionState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  inlineStyle&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  addOrRemove&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; blockMap &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; contentState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBlockMap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; startKey &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getStartKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; startOffset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getStartOffset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; endKey &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getEndKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; endOffset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getEndOffset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 这里 blockMap 为 immutable 类型，skipUntil，takeUntil，concat 可以简单理解为跳过某部分，获取某部分，最终获取 startKey，endKey 之间的内容。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; newBlocks &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; blockMap
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;skipUntil&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;_&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; k &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; startKey&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;takeUntil&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;_&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; k &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; endKey&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;concat&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;endKey&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; blockMap&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;endKey&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;block&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; blockKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; sliceStart&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; sliceEnd&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// 这里是确定分片的起止位置&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;startKey &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; endKey&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        sliceStart &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; startOffset&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        sliceEnd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; endOffset&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        sliceStart &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; blockKey &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; startKey &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; startOffset &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        sliceEnd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; blockKey &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; endKey &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; endOffset &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; block&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getLength&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; chars &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; block&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getCharacterList&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; current&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// 针对每个字符确定样式&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sliceStart &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; sliceEnd&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        current &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; chars&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sliceStart&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        chars &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; chars&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
          sliceStart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          addOrRemove
            &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; CharacterMetadata&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;applyStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inlineStyle&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; CharacterMetadata&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;removeStyle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; inlineStyle&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        sliceStart&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; block&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;characterList&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; chars&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; contentState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    blockMap&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; blockMap&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;newBlocks&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    selectionBefore&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    selectionAfter&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; selectionState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;总结&lt;/h3&gt;
&lt;p&gt;在线编辑器虽然目前是非常常见的一个功能，但是想要做到优秀的体验和强大的能力，并不是那么容易实现的。此外，通过阅读优秀项目的源码，可以为我们的工作提供一些新的思路，也能提高阅读源码的能力和速度。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[前端开发人员应该知道的后端知识]]></title><description><![CDATA[对于前端开发者来说，除 API…]]></description><link>https://www.keisei.top/what-frontend-developer-should-know-about-banckend/</link><guid isPermaLink="false">https://www.keisei.top/what-frontend-developer-should-know-about-banckend/</guid><pubDate>Sun, 15 Mar 2020 22:23:00 GMT</pubDate><content:encoded>&lt;p&gt;对于前端开发者来说，除 API 外不需要知道其他任何后端知识就能出色的完成绝大多数的工作。如果在不同的前端工作中都有深入涉猎，那么你应该已经了解了一些必要的后端知识。以下是有关前端开发者需要知道的后端知识清单。&lt;/p&gt;
&lt;h3&gt;请求率&lt;/h3&gt;
&lt;p&gt;后端资源是有限的，只能处理确定的请求率。通常情况下，不需要关心—前端应该致力于创建良好的用户体验，后端负责优化和拓展。当前，网络请求至后端并不是免费的，并且它们不是同样的昂贵（就资源的使用来说）。&lt;/p&gt;
&lt;p&gt;如何衡量一个请求的价值呢？据以往的经验是写入要比读取的成本高，所以改变的数据越多，成本越高。举一个简单的例子：假设我们在开发 Google docs，我们希望用户退出时不丢失任何工作内容，所以需要经常保存。那是否在每个字符插入或删除时都进行保存呢？后端服务可能不能够进行处理，或者相应的成本会因不必要的请求变得异常高。在用户停止输入后节流保存可以达到 99%的期望效果，而不需要为了 1%消耗巨大成本。&lt;/p&gt;
&lt;p&gt;此外我们想要轮询后端来获取变更，想要获取最新的 doc 版本，那么需要多久发起一个请求呢？读取要比写入成本更低，因此可以比写入请求更多但仍然有限制。&lt;/p&gt;
&lt;p&gt;这个限制依赖于许多因素，比如在任何给定时间的最大活动客户端数，后端基础设施和预算。如果有一个需要达到限制的变更，需要告知后端团队。否则，可能就是在对自己发起 DDoS 攻击。&lt;/p&gt;
&lt;h3&gt;宕机时间&lt;/h3&gt;
&lt;p&gt;需要做好每个后端请求在某些用户某种情况下可能会失败的准备。后端在某个时刻必然会宕机，或者对于某个接口失败而其余正常工作。需要鉴别出应用中哪些请求在失败时是紧急的，需要在整个应用之上显示稍后重试的错误信息，哪些请求时可以通过优雅的降级来保证用户体验（例如，将某功能的按钮置灰并在 hover 时提供当前不可用的错误提示）。&lt;/p&gt;
&lt;p&gt;如果后端被拆分为了多个微服务，那么一些接口失败的可能性会更高。如果后端只是一个独立的服务器，一个单独的失败会使整个应用宕机。好的前端通常会把后端调用都包裹在 try-catch 中，并准备好异常的跳转路径。JavaScript 没有恢复能力，如果没有处理好异常，整个应用会崩溃。&lt;/p&gt;
&lt;h3&gt;HTTP&lt;/h3&gt;
&lt;p&gt;后端和前端应当使用合适的 HTTP 状态码（在一定程度上）。前端应该知道后端计划返回的每个状态。不要解析错误消息来判断登录失败，401 是更适合的。不要在收到 400 时重发请求因为大概率不会成功，而 500 状态码表明服务器异常，可能在重启，因此重试可能会成功。&lt;/p&gt;
&lt;p&gt;其他值得了解的 HTTP 属性：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HTTP 请求如果花费时间太久可以被服务器关闭。如果认为某些任务可能临近限值（20 秒从经验上说相对合适的），应该从单个请求响应切换为一个轮询请求等待结果，或者采用另一种机制如 web sockets。&lt;/li&gt;
&lt;li&gt;如果发送一个非常大的数据至后端（如一个视频），应当使用 multipart 请求，可以将数据分为多块来发送。&lt;/li&gt;
&lt;li&gt;有时意外的发生是由于 URL 的长度限制。一些前端的请求是通过 query 传参数到后端的，但如果传入超过 2048 个字符，应当把数据编码通过 body 发送请求。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;分发业务逻辑&lt;/h3&gt;
&lt;p&gt;如果一些功能的业务逻辑可以在前端或后端来实现，通常应该在后端来实现。原因如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;后端的变更会更快 — 一次部署至所有服务器，过时的业务逻辑消失，但是前端客户端是在用户这边，一次部署不意味着在生产环境中已经不存在已经失效的业务逻辑在运行。&lt;/li&gt;
&lt;li&gt;如果业务逻辑需要计算能力，它很难测试客户运行的机器的能力范围。如果你只在公司提供的 Mac pro 上测试性能，那么就不会意识到$100 的 Chromebook 在计算时会多么慢。&lt;/li&gt;
&lt;li&gt;在后端实现业务逻辑更加保密。比如有一个功能只允许 pro 级用户访问，如果只在前端混淆后限制，有些人可能会通过其 API 调用返回的数据来进行反向工程，然后访问其功能。这在现实中广泛存在（如绕过限制的音乐播放器）。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;跨域请求&lt;/h3&gt;
&lt;p&gt;作为一个安全协议，如果一个请求指向后端不同的域名，它会因为是“跨源请求”而被拒绝。这被称为“同源策略”。这在开发中就会遇到，因为目前都是前端通过 NPM/Yarn 来启动前端服务器，而后端在另一个端口上，所以每个请求都是跨域请求。&lt;/p&gt;
&lt;p&gt;解决方案：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在开发环境 host 中配置映射服务器的域名&lt;/li&gt;
&lt;li&gt;在服务端通过增加判断在开发中开启，生产环境关闭的条件来运行跨域访问&lt;/li&gt;
&lt;li&gt;白名单中增加开发环境域名&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;跨站请求伪造是一种用户在其他网站发起的未鉴权的请求而发起的攻击。如，在某个网站点击了一个按钮，它执行了 JavaScript 代码去尝试使你在你的银行网站执行一个请求。为了阻止攻击，服务器会为每次会话提供一个一次性的口令，所以这个请求会由于没有口令而失败。这被称为 CSRF 口令。将它附在头部来验证请求。&lt;/p&gt;
&lt;h3&gt;缓存清除&lt;/h3&gt;
&lt;p&gt;每个请求发送至后端时会经过多重缓存。如果首次访问一个网站，等待它加载，然后重载页面，该页面会比首次加载会更快原因是浏览器缓存了一些资源如 favoritewebsite.com/static/script.js。如果想要改变 script.js 那么可以改变文件名，在 index.html 中把 script.js 变为 script.js?v=2，因为没有后续的其他请求，那么已缓存的 script.js 就变得不相关（除非 index.html 也被缓存，对于 index.html 的请求应当在后端处理为不缓存）。现代化的构建流水线每次构建都包含缓存清除，就像一些 JavaScript 文件名看起来 script.4e885f13.js。通常这只会应用于样式文件和脚本，但也可以应用到图片和其他资源。一些资源通常不会频繁改动，那么最好不要做自动缓存过期处理，只在需要更新时手动替换即可。&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://terrastruct.com/blog/what-frontend-engineers-should-know-about-backend/&quot;&gt;https://terrastruct.com/blog/what-frontend-engineers-should-know-about-backend/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[高性能前端架构]]></title><description><![CDATA[本文来介绍一些能够使 Web…]]></description><link>https://www.keisei.top/performant-frontend-architecture/</link><guid isPermaLink="false">https://www.keisei.top/performant-frontend-architecture/</guid><pubDate>Thu, 12 Mar 2020 21:02:00 GMT</pubDate><content:encoded>&lt;p&gt;本文来介绍一些能够使 Web 应用加载更快，用户体验更好的技术。&lt;/p&gt;
&lt;p&gt;从整个前端架构来看，如何能够第一时间加载最需要的资源，最大化利用已经缓存过的资源？&lt;/p&gt;
&lt;p&gt;在此我们不会阐述过多如何优化渲染时间以及后端应如何分发资源。&lt;/p&gt;
&lt;h3&gt;概览&lt;/h3&gt;
&lt;p&gt;我们将应用的加载分为三个不同的阶段：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;初始化渲染 - 在用户看到任何画面之前需要加载多长时间？&lt;/li&gt;
&lt;li&gt;应用加载 - 在用户能够使用之前需要加载多长时间？&lt;/li&gt;
&lt;li&gt;下一页 - 在跳转到下一页时需要加载多长时间？&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1013e5a81986030631b526b79fec099b/16662/performant-front-end-architecture.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 76.61900756938603%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADMUlEQVQ4y12TTW/jVBSGu2MLC8SKpvGN7ThxHDt27PgjSRM7dpp+JOnnpE3TJGSatFMJhmEQGoHECglpVvwDdoxYsoI9K/4LErBi9XKuE6aIxaNzzq366D0311tMKUOzXBh2gHLVT+HzunrQ6dxwgrQXiwZyBf0t7H/kyLXFhV6zg7B7iFa8j0bYRTs5QEi0Or20xr0+2vQ3/g+CXKKqgeU15P4LPyNpKmSVAJa3i6AVQ6d0As360QSl3iW0/asNl6gOZ1C6IwjhKVh0BhZyqO9cgHlJKk6FolqBfPwAZfUa4tESSn0P/uILeNPPEMw/hz97CX/+Eu70BcTBLbKHC7D+U7AjDvXDFVhrSMIStnKb3d8zu3jHPce7eoRCvUsSkt08hzv5BMH005TiyRLyYAGpT5LDOTEDO5itpc3+o5DfB5NVSEoJYr4I2QlhDRewBjOY/RnVOUzqK5veOJoi2z6ndWnVkGo0AnO7jyvnqzVYbh0F3cY2K0C0bKhxhGLUhtoJUQhbUKMwpURzOe6k59nAA2v4lC4As531ryxSwkzJwOjjL/Hzr7/h629eQ2rU4T9M4d9N0Hg2Q/1+Cm81SQmo53Pj2RTq5ATZsz0IowMI8e46oaQa+GBbwsnDV/j9j7/w5oc3yAU+grsbuIurNU+vUFtcpvDZ+WhE/RWkCxKddCGc9yBEzceV+T3ypLwXRBXKbhPOcowaiWySeMtrmPMLVEnk3o7hU9LieIid0y7YGcme7NPT2STkMoGL+HvkUlmDVKd3Ob2AeX2GyvUpzMk5LILP2UGM7DDBziBBhvpMv4PMcYJsq07CzZdSLllQaHVBKuBDlodarKCuu6gbXkpQrr2tnuagVrRgSTrsfAXVvAGHKCsGBdoI1YKB49sXePXd9zhePkdQsPDg7eHe72HpJFjVEtzTvHRi3NHzWFEdyzWMBBNPiHHWREesIMuFMiV7PyPh5tW3+PNv4MeffoGmmtgLOuh4IWKvjdiPkNAc+3wOEdFZQBtUZZ0wYBNaXl8nTO+QLrNoutiNEtheE5JmokjfdN6wUaCqVJy0l/ls1iBqFrbpq9ghwb/wdDlFxz9zOgjg7n6LpgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;performant frontend architecture&quot;
        title=&quot;performant frontend architecture&quot;
        src=&quot;/static/1013e5a81986030631b526b79fec099b/799d3/performant-front-end-architecture.png&quot;
        srcset=&quot;/static/1013e5a81986030631b526b79fec099b/00d96/performant-front-end-architecture.png 148w,
/static/1013e5a81986030631b526b79fec099b/0b23c/performant-front-end-architecture.png 295w,
/static/1013e5a81986030631b526b79fec099b/799d3/performant-front-end-architecture.png 590w,
/static/1013e5a81986030631b526b79fec099b/2a3d6/performant-front-end-architecture.png 885w,
/static/1013e5a81986030631b526b79fec099b/ae92f/performant-front-end-architecture.png 1180w,
/static/1013e5a81986030631b526b79fec099b/16662/performant-front-end-architecture.png 2378w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;初始渲染&lt;/h3&gt;
&lt;p&gt;在浏览器初始渲染之前用户看不到任何东西。渲染页面至少需要加载 HTML 文档，而且大多数还需要加载额外的资源，如 CSS 和 JavaScript 文件。一旦这些资源可用，浏览器开始在屏幕上渲染画面。&lt;/p&gt;
&lt;p&gt;网站的请求瀑布流大概如下：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/36a970f6e3069679776958e6e0ef10d8/c96f1/gov-uk-initial-render.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 20.954598370197903%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+klEQVQY0yWQwW6CQBRF/f8/abpp0mU3TVdaU4u2KTIjwsCM6AhKQUCgyenUrk5ect/JzZ0Yraiqisulpu97hmFgHEf66xV9KsltTKMt511L3vSYvXXZC13X0TTNjW3TUrcVp7JgEm+XRHHCeu1jjEEphZTyxq3JONuU2ljKKMf4krfgi3z1hH3RqFAR6oD8UFDUR46VZRLKBbFK8X2fOI4RQrD0PHzH2t3MXhnnM36iDaP3TrUXlPM79L0kmAo+9JQgWbFx4uyw+2+YJJogCBwTwjC8yYVrWWQZQ5pydeLOzdLlBd/HiHLxgHncop5T/v7X8pMwExyKPb+VySUXRnzFrgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;gov uk initial render&quot;
        title=&quot;gov uk initial render&quot;
        src=&quot;/static/36a970f6e3069679776958e6e0ef10d8/799d3/gov-uk-initial-render.png&quot;
        srcset=&quot;/static/36a970f6e3069679776958e6e0ef10d8/00d96/gov-uk-initial-render.png 148w,
/static/36a970f6e3069679776958e6e0ef10d8/0b23c/gov-uk-initial-render.png 295w,
/static/36a970f6e3069679776958e6e0ef10d8/799d3/gov-uk-initial-render.png 590w,
/static/36a970f6e3069679776958e6e0ef10d8/c96f1/gov-uk-initial-render.png 859w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;这个 HTML 文档加载了大量额外的文件，一旦加载完成页面开始渲染。注意到 CSS 文件是并行加载的，所以每个新的请求不会增加非常明显的延迟。&lt;/p&gt;
&lt;p&gt;（gov.uk 现在启用了&lt;a href=&quot;https://twitter.com/TheRealNooshu/status/1225403389158227971&quot;&gt;HTTP/2&lt;/a&gt;，所以当前域名下的资源可以重新利用现有的连接。）&lt;/p&gt;
&lt;h4&gt;减少阻塞渲染的请求&lt;/h4&gt;
&lt;p&gt;样式文件和（默认）脚本元素会阻塞渲染任何在它们下面的内容。&lt;/p&gt;
&lt;p&gt;可以有几种方式来解决：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在 body 最底部放置 script 标签&lt;/li&gt;
&lt;li&gt;通过 &lt;code class=&quot;language-text&quot;&gt;async&lt;/code&gt; 来异步加载脚本&lt;/li&gt;
&lt;li&gt;如果需要同步加载可以通过 inline 方式拆入 JS 或 CSS 片段&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;避免阻塞渲染的顺序请求链&lt;/h4&gt;
&lt;p&gt;网站加载慢与阻塞渲染的请求数量关系不是特别大，更重要的是每个资源的文件大小，并且浏览器何时去加载该资源。&lt;/p&gt;
&lt;p&gt;如果浏览器发现它在另一个请求完成后才需要加载某文件，这就形成了一个同步请求链。可能会有几种原因：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CSS 中使用了 @import&lt;/li&gt;
&lt;li&gt;在 CSS 文件中引用了 Web 字体&lt;/li&gt;
&lt;li&gt;JavaScript 注入了链接或 script 标签&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;可以看下面的例子：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ebea1be44487e800d63034b7fb2e9b79/5a757/circle-ci-request-chain.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 28.994082840236686%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABaElEQVQY0x2R226bUBBF+f8/qfoapVJbVYkUtU+xoQVsOMHmajA2twMYc4lWj3nYmpFGWqO9t9Y0kq7r6PueaZpYloXPz4VStqSJTyVyzqeG7FqS5zlN0yBbuc6H6rpG1i3nImQYW7QkSRHCxfd9kiQhTVOyhy5X8jRGBiVV3iHSnH/vfyg2AWnok2UZXdtxu/WMw0xaODQyRwujBMsyORwOHI9HTNNkv98TRxHDfaSf7ozjnaJvCTY/ib947N72WJFOFId0ytkwLGSVi7xd0fwgwjB0PM9bgbquY9s2B7UPfcdQVgzK/l1WtMcN121A5ofs3HeE6VEWp/WWXj6QXaGAvgIqiBBiBRqGwU4BgzhmPp9Znp9ZXl+ZX16Yn56YHVM9uFBvfyO+/iX5tcW33xCujWwqtFhl6DiOsm0RBMGaYStVUcPApEp4AOcf31m+KbDrMtcNo8pOnmKCyCK3XXa+zYfnrnn+B37WuSfm4zkRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;circle ci request chain&quot;
        title=&quot;circle ci request chain&quot;
        src=&quot;/static/ebea1be44487e800d63034b7fb2e9b79/799d3/circle-ci-request-chain.png&quot;
        srcset=&quot;/static/ebea1be44487e800d63034b7fb2e9b79/00d96/circle-ci-request-chain.png 148w,
/static/ebea1be44487e800d63034b7fb2e9b79/0b23c/circle-ci-request-chain.png 295w,
/static/ebea1be44487e800d63034b7fb2e9b79/799d3/circle-ci-request-chain.png 590w,
/static/ebea1be44487e800d63034b7fb2e9b79/5a757/circle-ci-request-chain.png 676w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;该网站 CSS 文件中使用了 @import 来加载 google 字体，就意味着浏览器需要从一个文件请求另一个文件：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;HTML 文档&lt;/li&gt;
&lt;li&gt;应用 CSS&lt;/li&gt;
&lt;li&gt;谷歌字体 CSS&lt;/li&gt;
&lt;li&gt;谷歌字体 Woff 文件（瀑布流中没显示）&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;要解决这个问题，首先从 @import 引入的谷歌字体 CSS 文件迁到 HTML 文档的 link 标签中。这从请求链中减少了一个链接。&lt;/p&gt;
&lt;p&gt;为了更快，可以直接将谷歌字体 CSS 文件内容插入 HTML 中，或应用的 CSS 文件中。&lt;/p&gt;
&lt;p&gt;有时无法消除请求链。在这种情况下，考虑使用预加载或预链接标签。例如，上面的网站可以在实际的 CSS 请求发生前先连接 fonts.googleapis.com。&lt;/p&gt;
&lt;h4&gt;重复利用服务器连接来加速请求&lt;/h4&gt;
&lt;p&gt;建立一个新的服务器连接通常需要在浏览器和服务器之间往返 3 次：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;DNS 检索&lt;/li&gt;
&lt;li&gt;建立 TCP 连接&lt;/li&gt;
&lt;li&gt;建立 SSL 连接&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一旦连接完成，在发送请求和下载响应时至少还需要一次或多次往返。&lt;/p&gt;
&lt;p&gt;下面瀑布流显示了创建了 4 个不同的连接：
hostgator.com, optimizely.com, googletagmanager.com, and googelapis.com&lt;/p&gt;
&lt;p&gt;然而，随后在同一服务器的请求可以重新利用已经建立的连接。所以加载 base.css 或 index1.css 是很快的，因为它们也存在于 hostgator.com 上。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 583px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/78df7603c84c54788fbec82a7d0622c7/71275/hostgator-render-blocking.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 40.82332761578044%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABrElEQVQozzWRy47aQBRE+f+/ySrKIoskgplIgBgjP8FvG2ywsYM9foDJme5GLErqvi1VnVs98zyHoijo+56u65TkeRxHpmlSejweVHVNXVT8a3rqa0fbfNJcr3S3G0PTcD1n3O53Zv5+yeFwxHVdLMvCNE3CMCTLMsqy5HK5KPM4jQl0jzBrMcMjmrEhTVLaJOK+2TD++M4kPGauPScRD7vdDsMwlIIgECEHFeA4DlVVCaKGtvtk6HqqJkf3PrDdkHox5/96yfixYjrnzDznjThO2O/3ik7XdVVBmj5Dttstvu8rtU1LL2hP5xJjbhB6FhdHo7IMjsWBWzsJQmmYPA0lkSSU6ydiJk3kXEreW9HvUJwJVyuCP+/kf78RaW9EdkIUh4zl8CSUK8vVpJlpmMrY8zylF53stBGf9VkWVPqWsx9wCmxifYln7jmluahjkIQLtfKrQ03TiKJI9SZDpLnsNBEVDJ7LaFs8xPxS5vg/f5O/r0isX1hbhzzJmO3MhejroCikgW3b5HmuOnzRyYCj+KT7es1jtWRaLJh2Dl0S07VXjs4Sx7SpipovrCRI1KkJORwAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;hostgator render blocking&quot;
        title=&quot;hostgator render blocking&quot;
        src=&quot;/static/78df7603c84c54788fbec82a7d0622c7/71275/hostgator-render-blocking.png&quot;
        srcset=&quot;/static/78df7603c84c54788fbec82a7d0622c7/00d96/hostgator-render-blocking.png 148w,
/static/78df7603c84c54788fbec82a7d0622c7/0b23c/hostgator-render-blocking.png 295w,
/static/78df7603c84c54788fbec82a7d0622c7/71275/hostgator-render-blocking.png 583w&quot;
        sizes=&quot;(max-width: 583px) 100vw, 583px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;减少文件大小并使用 CDN&lt;/h4&gt;
&lt;p&gt;除了文件大小，还有另外两个可控的因素会影响请求时间：资源的大小和服务器的路径。&lt;/p&gt;
&lt;p&gt;尽量发送小的数据给到用户，并保证它是压缩过的（通过 brotli 或 gzip）。&lt;/p&gt;
&lt;p&gt;内容分发网络是在各地提供了大量的服务器，其中某个服务器的位置可能是位于用户最近的地点。用户可以连接到距离他们更近的 CDN 服务器而不是网站的中心服务器。意味着服务器往返的时间会更少。对于一些静态的资源如 CSS，JavaScript 和图片是很方便的，因为它们容易部署。&lt;/p&gt;
&lt;h4&gt;通过 service worker 跳过网络请求&lt;/h4&gt;
&lt;p&gt;Service worker 允许在通过 network 发送之前劫持请求。意味着可以在初次请求过后存档资源文件。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c0c5b27bd4df5e42b3b8e57b2dfb02f2/77cf8/service-worker.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 33.19209039548023%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABaklEQVQozy1R25KjIBD1/z9ta2pqX2aSqUw0iaKIICDKJV7OttQ+dHXb58IBCy4khBwxKANtZ7wYR/VieDUdnlRcKDxrBqUNWi7QtD3qlmesJ93P/UFdYyStMg7FnwvDx03gp0+oNHDtPG5yw4U52kXc1Y7vxuHzxvPum834Wyp80e46JPzqHdV44Jd4l35D0fABrRhhl4T1ALTzmOMKOwfMYUWkpZ48pTAwhNklgg8aYrQIhKUNiNsBk3a4uKMoqxJd1yGGgHeKmCYL7xcoJfMcg8/z6/mEHIY8d10LawyC91kXiDMtC6xbULQtgzEWKSWqN0at4eYZ1lrM1EOMNE8YyMzQzjkH3gtIpcgoIsZERUHIfKJbFWV5z4Rt23AcB6XzeL/XbHYS13WlAw0YY7lncymx73vGTt1ZgcJ4eqqirmtUjweEENnsJGsSakpq/yc65/NZJGHjOKJuGrT0fWILXfU8XE8m/+l/+METOnGe9YIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;service worker&quot;
        title=&quot;service worker&quot;
        src=&quot;/static/c0c5b27bd4df5e42b3b8e57b2dfb02f2/799d3/service-worker.png&quot;
        srcset=&quot;/static/c0c5b27bd4df5e42b3b8e57b2dfb02f2/00d96/service-worker.png 148w,
/static/c0c5b27bd4df5e42b3b8e57b2dfb02f2/0b23c/service-worker.png 295w,
/static/c0c5b27bd4df5e42b3b8e57b2dfb02f2/799d3/service-worker.png 590w,
/static/c0c5b27bd4df5e42b3b8e57b2dfb02f2/77cf8/service-worker.png 708w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;当然，仅当不需要网络发送响应时，此方法才会有效。用户需要缓存过响应内容，在第二次加载应用时才会有更好的体验。&lt;/p&gt;
&lt;p&gt;下面的 service worker 缓存了渲染页面所需的 HTML 和 CSS。当应用再次加载时，它会尝试去提供缓存过的资源，并在不可用时会回退至网络请求。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addEventListener&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;install&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  caches&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;v1&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addAll&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/app&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/app.css&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addEventListener&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;fetch&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;respondWith&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    caches&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;cachedResponse&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; cachedResponse &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;查看更多关于&lt;a href=&quot;https://developers.google.com/web/ilt/pwa/caching-files-with-service-worker&quot;&gt;通过 service worker 预加载和缓存资源&lt;/a&gt;。&lt;/p&gt;
&lt;h3&gt;APP 加载&lt;/h3&gt;
&lt;p&gt;现在用户能看到一些画面，还需要做其他一些事情才能使用应用：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;加载应用代码（JS 和 CSS）&lt;/li&gt;
&lt;li&gt;加载页面必需的数据&lt;/li&gt;
&lt;li&gt;加载额外的数据和图片&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/175e7f810d7e33f9647203ad609b402f/e5b7c/app-load-stages.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 26.350245499181668%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABNklEQVQY0zWQTUvDQBCG8/f0rv9ALyIeFfWmF9GTUtBSaOmp1OLBbxSkVigollDrpfWipaJtssnme5M0+zrZ4sDsMPO8M7O72pdhozdi+Jg4GIw53r8Z7EAgt5zpQwODnJH3RiZMN1BsSKzzOaaeGcv7Jo4Pba1Qw1m7q0RpJiEpxklKp8RGsYHC+SMikcDyQpjk3MsHTrFXu8H6SUPlnC7wYzIY3Ia2dFDFymEdt699nLa6qDV19Ie/NC/B8n4ZpYumWialVDGOY6SRj+1SA6tHdfzbVPgQkQeteveC+a0iFnYqWNytYG7zGA96X4nK1y3cP7+ROkUQhoiiCELEil21dVw+dSCJhVQPPJd4CE1tDX2EngOXW8iS2f9lWaai63AwxpRblqXq/0zQEkY1wzBg21y94g/PzGmMuKqysQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;app load stages&quot;
        title=&quot;app load stages&quot;
        src=&quot;/static/175e7f810d7e33f9647203ad609b402f/799d3/app-load-stages.png&quot;
        srcset=&quot;/static/175e7f810d7e33f9647203ad609b402f/00d96/app-load-stages.png 148w,
/static/175e7f810d7e33f9647203ad609b402f/0b23c/app-load-stages.png 295w,
/static/175e7f810d7e33f9647203ad609b402f/799d3/app-load-stages.png 590w,
/static/175e7f810d7e33f9647203ad609b402f/e5b7c/app-load-stages.png 611w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;注意并不是只有从网络请求数据会延迟渲染。一旦代码加载，浏览器需要解析，编译并执行。&lt;/p&gt;
&lt;h4&gt;代码分离：只加载必要的代码，最大化命中缓存&lt;/h4&gt;
&lt;p&gt;代码分离允许当前页面只加载必需的代码而不是整个应用代码。代码分离也意味着每部分都是可以被缓存的，尽管其他部分可能是已经改变的，需要重新加载。&lt;/p&gt;
&lt;p&gt;典型的，代码分割为三种不同类型的文件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;指定页面的代码&lt;/li&gt;
&lt;li&gt;共享的应用代码&lt;/li&gt;
&lt;li&gt;第三方不经常变化的模块（更适合缓存）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Webpack 可以通过 &lt;a href=&quot;https://webpack.js.org/plugins/split-chunks-plugin/&quot;&gt;optimization.splitChunks&lt;/a&gt; 自动分割共享的代码来减少总文件体积。确保开启运行时 chunk 这样 chunk 哈希值就是稳定的，可以更长久地缓存。Ivan Akulov 有一篇&lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching&quot;&gt;深入介绍代码分割和缓存的教程&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;对于页面特定的代码没有办法自动分割，需要指定哪些可以分开加载。通常是一个特别的路由或页面的集合。&lt;a href=&quot;https://webpack.js.org/guides/code-splitting/#dynamic-imports&quot;&gt;使用动态 import 来惰性加载代码。&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;代码分割会造成加载应用时发送更多的请求。但只要这些请求是并行的，就不是太大的问题，尤其是通过 HTTP/2 托管的。可以看下面瀑布流前三个请求：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9958167144c54dc634d1b7daa03077e3/4abbd/bundle-splitting-synchronous.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 24.486803519061585%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABIElEQVQY0yWQ2XKCQBBF/f8vyg8kVJTCuCACKsYhYR9lGxYfTsbJQ1dXd906ffsumqZlGAaUUozjyDzPPJ9PU7JuSPOMVrbIqqBXWjdOWj8abd/3ug/c7z1NrZjmiYUQv6zXDpvNhsvlwna7ZbfbcTwc+PID/FOAvJZ8uA77pY2MzojblbwojYlBdeRpT1W9DCkWaVbg+0fCMCRJEoIgMNBXT/Vs3EyKsoqQpaAIV0TuijiODXDSn+T5iJTDPzBJclx3r8s1ohfY8zx9xOcmBG3XofqO+v5N02QUsY88f1KHFj+nM5k4ksUlWfZg6DQwugpse4XjOOZl27axLMtEEEURTdvStQ8e8qYzUya3tqnp9KFC+OTbN9zlOwcvoNe7P7CcccC0CVKYAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;bundle splitting synchronous&quot;
        title=&quot;bundle splitting synchronous&quot;
        src=&quot;/static/9958167144c54dc634d1b7daa03077e3/799d3/bundle-splitting-synchronous.png&quot;
        srcset=&quot;/static/9958167144c54dc634d1b7daa03077e3/00d96/bundle-splitting-synchronous.png 148w,
/static/9958167144c54dc634d1b7daa03077e3/0b23c/bundle-splitting-synchronous.png 295w,
/static/9958167144c54dc634d1b7daa03077e3/799d3/bundle-splitting-synchronous.png 590w,
/static/9958167144c54dc634d1b7daa03077e3/4abbd/bundle-splitting-synchronous.png 682w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;然而瀑布流中也有 2 个请求是顺序发起的。这些文件是该页面需要的，通过 import()调用动态加载的。&lt;/p&gt;
&lt;p&gt;如果知道哪些 chunks 是需要的，可以通过插入&lt;a href=&quot;https://www.debugbear.com/blog/resource-hints-rel-preload-prefetch-preconnect#preload&quot;&gt;预加载 link 标签&lt;/a&gt;来解决。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9552cfefcbb751b50e378a0834320b73/cef4e/bundle-splitting-parallel.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 22.919708029197082%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABLUlEQVQY0yWQy3KCQBBF+f8fsiqVTRZmkSgKiC9QBERxVBQBZ0CrTlqz6JrpRZ8691pVVWGMQWtN27Z0Xcfj8eApcylvqOJMfS7lb1DXK5eLons80V2LNu371hgt94bq1mLFScZoZOM4Duv1Gs/zmEwmTH0fd77EiwKKRcru0LDKMnqDL8LxmCJIyLMIpRR1U1NVd1SusfLDkeVySRiG7HY7FosFvsCCIGAveycWujO08t5qRao8yiLnGHkot8dm+st2u6WSNKeDwcqyXKzcNyRJkjd8Npsxn8+JZW+ahruMvhsuN0WuXLE5sI/GpP43e/eDzPvkOP0hCXOsaJMyHA4YS4xXZNu26ff7UsOIOI55dVzXNU19lx7/gWWZckrFMLQ5rwakAnMcEYqv/AHTwW+1p+yFXQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;bundle splitting parallel&quot;
        title=&quot;bundle splitting parallel&quot;
        src=&quot;/static/9552cfefcbb751b50e378a0834320b73/799d3/bundle-splitting-parallel.png&quot;
        srcset=&quot;/static/9552cfefcbb751b50e378a0834320b73/00d96/bundle-splitting-parallel.png 148w,
/static/9552cfefcbb751b50e378a0834320b73/0b23c/bundle-splitting-parallel.png 295w,
/static/9552cfefcbb751b50e378a0834320b73/799d3/bundle-splitting-parallel.png 590w,
/static/9552cfefcbb751b50e378a0834320b73/cef4e/bundle-splitting-parallel.png 685w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;然而可以看到这与整个页面加载的时长比较来看收益不是太大。&lt;/p&gt;
&lt;p&gt;而且，使用预加载有时候适得其反，它会延迟其它更重要的文件加载。有一篇&lt;a href=&quot;https://andydavies.me/blog/2019/02/12/preloading-fonts-and-the-puzzle-of-priorities/&quot;&gt;预加载字体&lt;/a&gt;的博文介绍了在 CSS 文件前加载字体文件会阻塞初始化渲染。&lt;/p&gt;
&lt;h4&gt;加载页面数据&lt;/h4&gt;
&lt;p&gt;有些应用是用来展示一些数据的，有一些技巧可以用来提前加载数据并且避免延迟渲染。&lt;/p&gt;
&lt;h5&gt;&lt;strong&gt;开始加载数据前不需要等待 bundles&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;对于顺序请求链这有一个特殊的情况：加载应用 bundle 代码后才发送请求获取数据。&lt;/p&gt;
&lt;p&gt;有两种方式来避免：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在 HTML 文档中嵌入页面数据&lt;/li&gt;
&lt;li&gt;在文档中插入 inline 脚本来发起数据请求&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在 HTML 中嵌入数据保证应用不需要等待数据的加载。由于不需要处理加载中的状态，它也减少了应用的复杂度。&lt;/p&gt;
&lt;p&gt;如果请求数据过久会延迟文档的响应，也会延迟初次渲染。这种情况下，或通过 service worker 缓存了 HTML 文档，可以通过嵌套 inline 脚本去加载数据。可以通过一个全局的 promise：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;userDataPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/me&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对这两种方案需要知道在应用开始渲染前哪些数据是页面需要加载的。这对于用户相关的数据（用户名称，通知等）是简单的，但对于特定页面的内容会比较麻烦。考虑识别数最重要的页面并为这些页面实现特殊的逻辑。&lt;/p&gt;
&lt;h5&gt;&lt;strong&gt;不要在等待加载不重要的数据时阻塞渲染&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;有时生成的页面数据需要很慢的很复杂的后端逻辑。这种情况下可以第一时间加载简化版的页面，使应用功能基本可用。&lt;/p&gt;
&lt;p&gt;例如，一个分析应用首次加载时可以先加载所有的图表列表而不是图表的数据。这允许用户去找到他们感兴趣的图表，
还可以帮助将后端请求分散到不同的服务器上。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/996ab66136976b0b22d95e7778fb4664/581a4/essential-data-first.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 32.29166666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABUElEQVQY032Qz07CQBDG+wCIWvqf0kK7ULSUAhq8IR7xKTBCDPiWtFAwgUtJaoIJhFfgwPFzd42JJw+/zLe7M9/MjtDrPSKXy0PXi1AUDZKkcFRV54iihMPhgDRNUShIUNi9ZtAclWujaMKybVzkLzEcvkAYDJ65GSE1OA5BpeJyfnW57GC3+8Jms4HrEty3Orhrd9Buhqh5N2gEAfyggZJtYTp9h8AmlGWVJld5sWWVUSrZ3JDBdJZliKIImqbD9wMEQYg6NWPvrM6jWpY1jMdvEPr9p38nZA2OxyO225Q3JsTjkzIjx62hFfhohSFM08R0MoHQ7T7wHaqqwbuwIgbbJ4uiKGO/3/MvX9E9dfxbNG/q8AiBYZiokioIbS5eFzB6HUFYr9eYzWaI4zkl/sPPOYpinM9nnE4n/u3V6oOTJEss5gskSxoXCc/Lsk98AyWb5sB8lpBvAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;essential data first&quot;
        title=&quot;essential data first&quot;
        src=&quot;/static/996ab66136976b0b22d95e7778fb4664/799d3/essential-data-first.png&quot;
        srcset=&quot;/static/996ab66136976b0b22d95e7778fb4664/00d96/essential-data-first.png 148w,
/static/996ab66136976b0b22d95e7778fb4664/0b23c/essential-data-first.png 295w,
/static/996ab66136976b0b22d95e7778fb4664/799d3/essential-data-first.png 590w,
/static/996ab66136976b0b22d95e7778fb4664/581a4/essential-data-first.png 672w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h5&gt;&lt;strong&gt;避免顺序发起数据请求链&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;比如，第一次发起请求去查找哪个用户登录了，然后发起另一个请求查询属于哪个团队并返回用户相关的团队数据。可以通过 &lt;a href=&quot;https://graphql.org/&quot;&gt;GraphQL&lt;/a&gt; 来解决。&lt;/p&gt;
&lt;h4&gt;服务端渲染&lt;/h4&gt;
&lt;p&gt;服务端渲染意味着在服务器端先预渲染应用，然后返回完整的 HTML 文档。这意味着在客户端可以看到页面完整的渲染而不需要去等待加载额外的代码或数据。&lt;/p&gt;
&lt;p&gt;因为服务器只发送静态的 HTML 文件，应用还是不能交互。应用需要重新加载渲染逻辑，然后在 DOM 上增加必要的事件监听器。&lt;/p&gt;
&lt;p&gt;如果某些非交互的内容是有价值的考虑使用服务端渲染。例如，服务端渲染可以对博客渲染有很大收益。&lt;/p&gt;
&lt;h3&gt;下一页&lt;/h3&gt;
&lt;p&gt;在某个节点用户开始操作应用，并跳转至下一页。一旦初始页面在浏览器中呈现，就可以准备下一个交互。&lt;/p&gt;
&lt;h4&gt;预请求资源&lt;/h4&gt;
&lt;p&gt;如果预加载了下一页所需要的代码，那么当用户开始跳转时可以减少延迟。使用&lt;a href=&quot;https://www.debugbear.com/blog/resource-hints-rel-preload-prefetch-preconnect#prefetch&quot;&gt;预请求 link 标签&lt;/a&gt;，或对于动态导入使用 &lt;code class=&quot;language-text&quot;&gt;webpackPrefetch&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;/* webpackPrefetch: true, webpackChunkName: &quot;todo-list&quot; */&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;./TodoList&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;确保发送用户数据和带宽的大小，尤其是用户使用移动端连接。当用户使用移动端的网站或开启了节省数据模式时需要预加载更少的资源。&lt;/p&gt;
&lt;p&gt;对用户最可能需要的部分制定策略。&lt;/p&gt;
&lt;h4&gt;重复利用已经加载的数据&lt;/h4&gt;
&lt;p&gt;在应用中缓存 Ajax 请求数据到本地避免将来发起请求。如果用户从团队列表页跳转至编辑团队页面，可以直接利用已经请求过的数据立即跳转。&lt;/p&gt;
&lt;p&gt;注意这对于其他用户操作同一份数据是不生效的，有可能该用户下载的数据已经过期了。在这种情况下，考虑在获取最新数据时先以只读的方式展示现有数据。&lt;/p&gt;
&lt;h3&gt;总结&lt;/h3&gt;
&lt;p&gt;本文介绍了一些可能会在加载过程中不同节点出现使页面加载变慢的因素。使用 &lt;a href=&quot;https://developers.google.com/web/tools/chrome-devtools&quot;&gt;Chrome 开发者工具&lt;/a&gt;，&lt;a href=&quot;https://www.webpagetest.org/&quot;&gt;WebPageTest&lt;/a&gt; 和 &lt;a href=&quot;https://developers.google.com/web/tools/lighthouse&quot;&gt;Lighthouse&lt;/a&gt; 来找出应用中出现了哪些问题。&lt;/p&gt;
&lt;p&gt;通常不太可能优化所有的问题，找出最影响用户使用的最关键的问题并专注去修复。&lt;/p&gt;
&lt;p&gt;非常推荐分割请求。只加载必要的资源，最大化利用缓存的内容并当文件更新时才去重新加载。&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://www.debugbear.com/blog/performant-front-end-architecture&quot;&gt;https://www.debugbear.com/blog/performant-front-end-architecture&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[使用 Next.js + Puppeteer + heroku 构建爬虫 Web APP]]></title><description><![CDATA[背景 我之前每天都会去腾讯新闻页面上去关注有关疫情发展的当日的数据状况，久而久之就感觉该页面不够精简，而且路径过长，需要二次点击才能看到主页面。那么就干脆直接去拿他们的数据来自己做个页面好了，仓库地址：前端https://github.com/keisei77/small…]]></description><link>https://www.keisei.top/build-crawler-with-nextjs-and-heroku/</link><guid isPermaLink="false">https://www.keisei.top/build-crawler-with-nextjs-and-heroku/</guid><pubDate>Sun, 08 Mar 2020 22:46:00 GMT</pubDate><content:encoded>&lt;h3&gt;背景&lt;/h3&gt;
&lt;p&gt;我之前每天都会去腾讯新闻页面上去关注有关疫情发展的当日的数据状况，久而久之就感觉该页面不够精简，而且路径过长，需要二次点击才能看到主页面。那么就干脆直接去拿他们的数据来自己做个&lt;a href=&quot;https://keisei.now.sh/&quot;&gt;页面&lt;/a&gt;好了，仓库地址：前端&lt;a href=&quot;https://github.com/keisei77/small-ideas.git&quot;&gt;https://github.com/keisei77/small-ideas.git&lt;/a&gt;，后端&lt;a href=&quot;https://github.com/keisei77/micro-backend.git&quot;&gt;https://github.com/keisei77/micro-backend.git&lt;/a&gt;。
目前没有 UI，只是简单排了序。后续根据心情在做样式上的改进吧。&lt;/p&gt;
&lt;h3&gt;前期分析&lt;/h3&gt;
&lt;p&gt;当我开始想要去获取腾讯的数据时，首先在疫情动态主页面&lt;a href=&quot;https://xw.qq.com/act/qgfeiyan&quot;&gt;https://xw.qq.com/act/qgfeiyan&lt;/a&gt;上看了一下浏览器请求，找了一小会发现地图、列表所渲染的数据并不是通过异步的 Ajax 请求的。由于地图用的是 echarts 渲染的，这肯定不是服务端渲染的，所以数据一定藏在某个地方。那么可以尝试通过全局搜索该页面上的唯一数值，如果没有找到，就有可能是在某个文件请求返回的。&lt;/p&gt;
&lt;p&gt;经过逐个排查，终于找到原来是通过 JSONP 方式请求的数据&lt;a href=&quot;https://view.inews.qq.com/g2/getOnsInfo?_t=0.12532683853215&amp;#x26;name=disease_h5&amp;#x26;callback=__jpcb1&quot;&gt;https://view.inews.qq.com/g2/getOnsInfo?_t=0.12532683853215&amp;#x26;name=disease&lt;em&gt;h5&amp;#x26;callback=\&lt;/em&gt;_jpcb1&lt;/a&gt;，可以看到通过这种方式解决了跨域问题：
&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.69565217391304%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABcUlEQVQoz5VR2ZKCMBDk/z/Lh63ygPUA5Q4oKLdcC4hH7ySWW/uoqerqTGbSmfRIB1+Fa3/DsWRYxhy2KcO1FMGWsXjGlOesb6cw9TmYsxQ5vk8iC3V5QHXeoyx8SC7zsdsZUNUtlqsNNhsNqrYTvF5rgjWK+dlstsCUoOsmNlSvKCswut+2HermB1XVQPI8BsPQKcHguq4AY5wduI4jYs/zRN62bTiODX6H19i2hf3eR5omSJIERZFDyrIM4fGIlDg/n+mlBt0woCd0fY++73C/33G73QT/33O+XC4YqJbz9XolQVIOqYPQ93Hakw9pioFEb12HgVBVFT5ZUrBVoU8mMKdTMFkGU5Qnvr5wUFVkeS4KH4/HW5CS+ISQfIrIozwIBMo4RlWWqOuavtz/Cb7VYZbGCMIAWVGg534QRvKC+zOOo/DnM8EsRUBdHcOQppUKkRdehn8kmJNHIYlFUSRGX9JXGxpK27ZiIB0N5hPBX1w49WvE5U0fAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;jsonp&quot;
        title=&quot;jsonp&quot;
        src=&quot;/static/0e239e2e2084b8504794b4093c41dbca/799d3/jsonp.png&quot;
        srcset=&quot;/static/0e239e2e2084b8504794b4093c41dbca/00d96/jsonp.png 148w,
/static/0e239e2e2084b8504794b4093c41dbca/0b23c/jsonp.png 295w,
/static/0e239e2e2084b8504794b4093c41dbca/799d3/jsonp.png 590w,
/static/0e239e2e2084b8504794b4093c41dbca/2a3d6/jsonp.png 885w,
/static/0e239e2e2084b8504794b4093c41dbca/c112d/jsonp.png 1150w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;注意截图中的_t 参数为类似时间戳的数据，callback 为回调函数。由于我们只是需要他返回的数据，而不关心回调函数的执行，所以我索性去掉了 callback 参数，发现该请求仍能返回数据，并且是 json 格式！正好符合了我们的预期。&lt;/p&gt;
&lt;h3&gt;搭建应用&lt;/h3&gt;
&lt;p&gt;有了接口，那么开发页面就是信手拈来的事情。在之前曾经了解过 &lt;a href=&quot;https://nextjs.org/&quot;&gt;Next.js&lt;/a&gt; 这个 React SSR 框架，并且了解到该公司还免费部署个人应用，并提供免费的域名使用。于是就开始了轻松的开发之旅。&lt;/p&gt;
&lt;p&gt;Next.js 提供了一个页面渲染前先获取初始化数据的 API：&lt;a href=&quot;https://nextjs.org/docs/api-reference/data-fetching/getInitialProps&quot;&gt;getInitialProps&lt;/a&gt;，该函数会在 nodejs 环境下运行，把请求的数据通过 props 的方式注入到调用该 API 的组件内。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; fetch &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;isomorphic-unfetch&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Page&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; stars &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;Next stars&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;stars&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;div&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

Page&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;getInitialProps&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; res &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;https://api.github.com/repos/zeit/next.js&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; stars&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stargazers_count &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; Page&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;来自官网的例子，通过几行代码我们就可以拿到需要的数据，然后简简单单的做个表格就可以直观看到疫情发展啦。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 468px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/87d947a455f5ea1138770fc6e65cae37/45d15/snapshot.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 164.74358974358975%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAhCAYAAADZPosTAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAD10lEQVRIx51WaW/iVhTl/0uVqkbTL/OlnTaTmUzV9he0naqTsIcQsoB3491mMYuNFzi975khkFBh1eKA/aR3OHc597liC28QWm8Rmm+hP3xH+AZj4yMs24asmRBlFQNRhqjokBQNT30JgqRC1Q1MwgXmyxgzQjiPMCVUltYZJvoZAvUMkf0GY/Vbuv8eofMRU+McrnZBf3gBX/sZtnxOa+8x0s/5fWBcYmxeYkS/C/83RP4nVNLxrwjtXxAMPyGb/I6ZfQlDeIeZ8wGR+x4+bV4FRG4ywnf8fulewJF/oucf4RIs8QfM3UvE3gUqU5LtBwEc14MXTBCvUvzfa0OoKIqEavUKnz//jW63C8/zEMURfN9HGE4xGY8wnU4xHo8xGgXI85xv3Wxeg75QkSQR19Uqrr5coXZdRf/xCYIgwjBMIhjBc124BI/+IKBIsiwr1GyOk5JCGXf395BlGQ+Pj1CoqpblIMvXWK83yAn0IdUxkvSZ7L+uiigI6PbuD/Kwpg0pbWZI0pTCXGNE6vxgfKDuKKEkyajVmljGK8SEiP8mVJxnrJIUi2WEyTQ8TWgMTXRu73g4haICjOQr2Ho4m8MflVBomCb6g8FWWYwoirAiVRlVkyPLeS6Z+jCcnSaUZQn1Rgvtmy5arTZuWh30+yIWUczV8bCJjIWcvqjwUUKB1FWbrSJUIkj2QmVg61G0xIBayfVGpwn7VOUGKdN0kxTkRRG2YPcJz98MDw+PGE9KFEVVFHQ6t6Qs4y7I9rHN33K5JMIHau4SCjVNR6vT4R5e7bXJLmSWR8qhJEoIRpPThAOBcthoFM7YgCN90TYMiqIS4fQ0oUjDs31zC5Ps1rvv4a7b47liuSvyWSh/eurDcrwSbaOqaNTb3MN+4MMyLWqRmNuNtQnLI4NMuXZcv4xCAf98uaamnfMF5mNGwDycbL3MniUaHo5XglDTh+hSqDzEIz4uipRQUWSKoEyVdR0CqUz2fHyIQqFKRXG9oIz1ZBpfvV3fHUNOUCiHrl+CcEDWa1IfJmn+KtSvSEmlTApNu0SVVVWnaSOSG6JXPn4eXylUTaNDrMT4Gho66rU6hsPCy6sXTmHIMlJI7WWXahuaIq3WDXdI9tLLW6zXOdjcLOWUAc2+6nUdMVOzSg+mzWqXwwT6UIdXxsuSrNC5XKMcGdzPr0MuprdLLwKl2kZRNTrg73YExxXm9ALglzv1HMflfdhstzCbL3bW25+JbC8/9Ms4hfVXvdnElA6g5fYc2Q+bKWSktu2UGw6ypOCvP/6kKlp8OidJemg9embrlmXTO6N7kvBfBrXjjTmNlW0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;snapshot&quot;
        title=&quot;snapshot&quot;
        src=&quot;/static/87d947a455f5ea1138770fc6e65cae37/45d15/snapshot.png&quot;
        srcset=&quot;/static/87d947a455f5ea1138770fc6e65cae37/00d96/snapshot.png 148w,
/static/87d947a455f5ea1138770fc6e65cae37/0b23c/snapshot.png 295w,
/static/87d947a455f5ea1138770fc6e65cae37/45d15/snapshot.png 468w&quot;
        sizes=&quot;(max-width: 468px) 100vw, 468px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;新的挑战&lt;/h3&gt;
&lt;p&gt;上线几天后，发现国内的数据是每日更新的，但是国外的数据却停留在了某一天。感觉腾讯耍了一点小心机。于是我投身另一平台：丁香园疫情动态页面&lt;a href=&quot;https://ncov.dxy.cn/ncovh5/view/pneumonia_peopleapp?from=timeline&amp;#x26;isappinstalled=0&quot;&gt;https://ncov.dxy.cn/ncovh5/view/pneumonia_peopleapp?from=timeline&amp;#x26;isappinstalled=0&lt;/a&gt;。该页面也是类似腾讯展示了国内和国外的疫情发展状况。而我所需要的数据正是国外的数据，那么对丁香园的页面，我们有需要重新去查找他们的数据来源情况。&lt;/p&gt;
&lt;p&gt;经过一番查找，发现该页面既没有通过 Ajax 请求，也没有通过 JSONP 的方式，最终确认数据是服务端直接输出到 html 中了。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/25a7eacbca90ed8930609d229f77cd97/1d346/dingxiang.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.399693721286376%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACnUlEQVQ4y42Tu8/cRBTF/bfRUIOEKNJEJEgUKKn5n5AQkSJEgShQGiqKILJf9tuX1+/XeB6eGXuXH9eGQIulK1vjmTPnnHtuorWlKHvKStG2mrzoyYqOrlMopRjHEecctfxP046iGDieOg7ngbrWdL1hVIZpctu+5PsfIp88ufH0qxsff3bn6fOC518ceP3jCMyEEPE+0Oct5TknP5UU+5T2lKI6jdUOH2fmWfbGQPLd64XPn8GXL+589Cm8fOH45uuONz+vgMsGGJcbLi/p/3iPenigE2B1LYn5FXvKmMqGxVn8qEn6IfBu53j/qNgfRq7pQH5VaOW2W6PUPHlClmPzejtsxBJbNPiqxjYad62Ys6sAWpJZaC5mxBgjbMSrdqAdDD4IWFzZLUStCXLYXXNMWmKFnctKfCHVKoKLApgRR0MSQmDQ4tHgMXZCmShN6RnFm2Vl+A+gL+sNzKUZgzRHpxWTsFa5wkpjYp4zXTJhKAdMIehGM7YFS/T0dcmyAq0MV8lyaThfMOcMI7JtVm2e+qrCC1gwnkUNeFlLltvCmGeyaFASkTBHCtX/Byg13++EsmJ8+w53OKLPxebnKtk2I5NYFNN02yOSF06nlrqxnFPFRWi3dSdRuDF/ABTwRUveziXTCrg7Yh4O+MdHxt0JJ8yXuhJrxMPJ39ntO9JMbYB1YyTo3ZapDUwkT9LlsmhxMgSTdds7iN9Bvv22Nm1ZDJLXxE2RXKag6S3HLPLtT5pXv8j0NJ77bfVQMmhlQq6/o/ozY38SBXv69kLfpVIXynwvUdvR1MdVcpQuz4zS3bScePOb5te3VqLjud3W6KxTEOA+yQXrJfJeJknA3zVH9+/3WsksTVjmVVrkz/u8TcdaH8BW2WuD/u/zF1Fs0zqXwAF2AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;dingxiang&quot;
        title=&quot;dingxiang&quot;
        src=&quot;/static/25a7eacbca90ed8930609d229f77cd97/799d3/dingxiang.png&quot;
        srcset=&quot;/static/25a7eacbca90ed8930609d229f77cd97/00d96/dingxiang.png 148w,
/static/25a7eacbca90ed8930609d229f77cd97/0b23c/dingxiang.png 295w,
/static/25a7eacbca90ed8930609d229f77cd97/799d3/dingxiang.png 590w,
/static/25a7eacbca90ed8930609d229f77cd97/2a3d6/dingxiang.png 885w,
/static/25a7eacbca90ed8930609d229f77cd97/ae92f/dingxiang.png 1180w,
/static/25a7eacbca90ed8930609d229f77cd97/1d346/dingxiang.png 1306w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;那么这种直接写在 html 中的数据该如何获取呢？&lt;/p&gt;
&lt;p&gt;我考虑了几种方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;获取 html 的 text 文本然后通过正则匹配&lt;/li&gt;
&lt;li&gt;通过&lt;a href=&quot;https://github.com/cheeriojs/cheerio&quot;&gt;cheerio&lt;/a&gt;来根据 script 标签来获取&lt;/li&gt;
&lt;li&gt;使用无头浏览器直接访问该 html&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;正则匹配比较原始，而且应该会有性能问题，暂不考虑。cheerio 以类似 jQuery 的方式来获取节点，我有做过尝试但是感觉不够新颖，因此也未继续实践。
正巧之前也关注过无头浏览器相关的概念，即在服务端运行一个没有界面的浏览器，业内最知名的应该是&lt;a href=&quot;https://phantomjs.org/&quot;&gt;phantomjs&lt;/a&gt;。&lt;a href=&quot;https://pptr.dev/&quot;&gt;Puppeteer&lt;/a&gt;最近是越来越火，毕竟谷歌家的东西比较有保障，所以采用了 Puppeteer 来跑丁香园的页面。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; puppeteer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;puppeteer&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; browser &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; puppeteer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;launch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; page &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; browser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newPage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; page&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;https://ncov.dxy.cn/ncovh5/view/pneumonia_peopleapp&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; page&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;evaluate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      overseas&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; getListByCountryTypeService2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      homeland&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; getAreaStat&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; browser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;核心代码就这么多，不过要注意里面有几个需要注意的地方：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;puppeteer.launch()&lt;/code&gt; 为初始化启动，可以传入必要的参数（&lt;code class=&quot;language-text&quot;&gt;args&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;executablePath&lt;/code&gt; 等）&lt;/li&gt;
&lt;li&gt;因为数据直接是放在 script 标签内的，所以可以使用 &lt;code class=&quot;language-text&quot;&gt;page.evaluate()&lt;/code&gt; API 来在当前页面上下文中执行传入的回调，所以可以直接获取到 window 对象下的 getListByCountryTypeService2，getAreaStat 等&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;browser.close()&lt;/code&gt; 用来释放浏览器&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;拿到数据后，根据 Next.js 的文档，可以注册为接口供前端请求，相应的 API 需要以单文件为单位放在 &lt;code class=&quot;language-text&quot;&gt;/pages/api&lt;/code&gt; 目录下。当完成这一切后，却发现前端不能请求到接口 &lt;code class=&quot;language-text&quot;&gt;/api/ncov&lt;/code&gt; ，原因是 Next.js 官方提供的应用部署服务 zeit 目前是以 serverless 方式部署的，每个 API 都被转换成单独的函数，而我们的 API 需要依赖 puppeteer 包，获取不到因而无法执行。转而去寻求支持 puppeteer 的方案，在根目录下创建 server.js 文件，结果可惜官方聊天间现在不再支持 &lt;a href=&quot;https://spectrum.chat/zeit/general/next-js-custom-server-now-v2-deployments~ebd1f14e-cacb-48cb-9df1-97b4ceca6b87?m=MTU2Nzk1NjI2ODY2NQ==&quot;&gt;custom server&lt;/a&gt;。&lt;/p&gt;
&lt;h3&gt;绝境逢生&lt;/h3&gt;
&lt;p&gt;之前曾了解过 salesforce 旗下的 heroku 这个平台，提供免费的部署服务，而该平台应该是可以支持任意架构的服务。因此，把之前的代码部署到了 heroku 平台，而且该平台提供了命令行工具，如查看 logs &lt;code class=&quot;language-text&quot;&gt;heroku logs --tail&lt;/code&gt;，远程 SSH &lt;code class=&quot;language-text&quot;&gt;heroku run bash&lt;/code&gt; 等。在我们的 server.js 中，使用了 express.js 并定义了 &lt;code class=&quot;language-text&quot;&gt;/api/ncov&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; express &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;express&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PORT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dev &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NODE_ENV&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;production&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; app &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; dev &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; handler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getRequestHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; ncovHandler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;./pages/api/ncov&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;prepare&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; server &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;express&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  server&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;handler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  server&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/ncov&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ncovHandler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  server&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// eslint-disable-next-line no-console&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&gt; Ready on http://localhost:&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;port&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;部署完开始测试 &lt;a href=&quot;https://small-ideas.herokuapp.com/api/ncov&quot;&gt;https://small-ideas.herokuapp.com/api/ncov&lt;/a&gt;，结果发现 node modules 虽然安装了 puppeteer 却仍然没有执行， 具体报错 Error: Browser is not downloaded. Run “npm install” or “yarn install”。具体原因目前仍不得而知，转而去平台搜索 buildpack（构建脚本），发现有个比较好用的 &lt;a href=&quot;https://elements.heroku.com/buildpacks/jontewks/puppeteer-heroku-buildpack&quot;&gt;puppeteer 安装脚本：heroku buildpacks:add https://github.com/jontewks/puppeteer-heroku-buildpack.git&lt;/a&gt;。
该作者提醒需要在 &lt;code class=&quot;language-text&quot;&gt;puppeteer.launch()&lt;/code&gt; 中传入 &lt;code class=&quot;language-text&quot;&gt;{ args: [&amp;#39;--no-sandbox&amp;#39;] }&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;再次测试 API 时，发现仍有报错，根据 &lt;a href=&quot;https://stackoverflow.com/questions/53997175/puppeteer-error-chromium-revision-is-not-downloaded&quot;&gt;stackoverflow 的解答&lt;/a&gt;，可以通过在&lt;code class=&quot;language-text&quot;&gt;puppeteer.launch()&lt;/code&gt; 中传入指定的 &lt;code class=&quot;language-text&quot;&gt;executablePath&lt;/code&gt;，这就需要我们连接远程服务器，找出当前目录下可执行的 chrome 文件，&lt;code class=&quot;language-text&quot;&gt;./node_modules/puppeteer/.local-chromium/linux-722234/chrome-linux/chrome&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;配置完成再测试后终于成功。&lt;/p&gt;
&lt;h3&gt;辅助工作&lt;/h3&gt;
&lt;p&gt;配置 sentry 来记录线上问题，不过目前来说因为只有遇到了问题才会上报。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cross-env&lt;/code&gt; 可以跨系统配置 node 环境变量，但是如果安装在 devDependencies 中，则线上运行会报 cross-env: not found，因此我暂时放到了 dependencies 中。&lt;/p&gt;
&lt;h3&gt;将来打算&lt;/h3&gt;
&lt;p&gt;希望能把后端独立出一个仓库，这样前后端可以分开部署。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[处理 Web 应用中的内存泄露问题]]></title><description><![CDATA[当我们从构建服务端渲染的网站切换到构建客户端渲染的单页面应用时，我们需要对用户设备上的资源格外小心。不能阻碍 UI…]]></description><link>https://www.keisei.top/fixing-memory-leaks-in-web-app/</link><guid isPermaLink="false">https://www.keisei.top/fixing-memory-leaks-in-web-app/</guid><pubDate>Sun, 01 Mar 2020 22:08:00 GMT</pubDate><content:encoded>&lt;p&gt;当我们从构建服务端渲染的网站切换到构建客户端渲染的单页面应用时，我们需要对用户设备上的资源格外小心。不能阻碍 UI 线程，不要使笔记本风扇快速旋转，不要榨干手机的电池等等。我们为了更好的交互和类似原生应用的体验而带来的这些问题是服务端渲染所不存在的。&lt;/p&gt;
&lt;p&gt;其中一个很重要的问题是内存泄漏。一个糟糕实现的 SPA 可以轻松吃掉 MB 级内存甚至 GB 级的内存，甚至在后台 tab 中也会持续吞噬资源。这时页面开始变慢，甚至浏览器直接终结这个 tab：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 570px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2a8b7d6e23c2563f2c7e1e2f51123c08/f65ec/aw-snap.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 32.631578947368425%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAAfUlEQVQY052QPQ7CMAyFfW5OBAMLl4AOSEggJhbWZIn/SGWHlKCOVALy7OHzYD/bkPNYa526BOfLNaXUqGMEhBhVtdOZiEKIxPJ7T1txTiBEJhIRbcHyZuLGiOjuX5xZ/TGW55I+vzDX672tNnl3NDCrXv479XAr28FO9/ICVWWbxk/ldyoAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;aw snap&quot;
        title=&quot;aw snap&quot;
        src=&quot;/static/2a8b7d6e23c2563f2c7e1e2f51123c08/f65ec/aw-snap.png&quot;
        srcset=&quot;/static/2a8b7d6e23c2563f2c7e1e2f51123c08/00d96/aw-snap.png 148w,
/static/2a8b7d6e23c2563f2c7e1e2f51123c08/0b23c/aw-snap.png 295w,
/static/2a8b7d6e23c2563f2c7e1e2f51123c08/f65ec/aw-snap.png 570w&quot;
        sizes=&quot;(max-width: 570px) 100vw, 570px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;当然，服务端渲染的网站也可能会在服务端出现内存泄漏。但它完全不像客户端的内存泄漏，因为浏览器在每次切换页面时都会清除内存。&lt;/p&gt;
&lt;p&gt;关于内存泄漏的主题在 web 开发文献中并没有很好地覆盖。可以肯定的是，大多数的 SPA 应用都存在内存泄漏，除非这些团队有健壮的基础设施来捕获并修复内存泄漏。在 JavaScript 中太容易分配了内存却疏忽清理。&lt;/p&gt;
&lt;p&gt;为什么没有多少人写有关内存泄漏的文章呢？大概如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;没有多少抱怨&lt;/strong&gt;：没有多少用户在浏览网页时去用心关注任务管理器。通常，我们不会听到用户的抱怨，除非泄露非常严重使 tab 直接崩溃或应用变慢&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;缺少数据&lt;/strong&gt;：没有团队或应用提供测量网站存在多少内存泄露的功能&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;缺少工具&lt;/strong&gt;：现有的工具也很难简单去检查或修复内存泄漏&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;缺少关注&lt;/strong&gt;：浏览器会扼杀那些占用内存过多的 tab 页，用户更可能去抱怨浏览器而不是网站&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在本文将来介绍一些修复内存泄漏的经验，并提供一些例子来高效鉴别它们。&lt;/p&gt;
&lt;h3&gt;内存泄漏剖析&lt;/h3&gt;
&lt;p&gt;现代 web 应用框架像 React，Vue 和 Svelte 都是基于组件的模型。在这种模型下，最常见的一种内存泄漏是：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addEventListener&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;onMessage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bind&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这就会造成内存泄漏。如果在全局对象（&lt;code class=&quot;language-text&quot;&gt;window&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;&amp;lt;body&amp;gt;&lt;/code&gt; 等）上调用 &lt;code class=&quot;language-text&quot;&gt;addEventListener&lt;/code&gt; 却忘记在组件卸载时通过 &lt;code class=&quot;language-text&quot;&gt;removeEventListener&lt;/code&gt; 清除，那么就造成了内存泄漏。&lt;/p&gt;
&lt;p&gt;更坏的是，我们直接泄露了整个组件。因为 &lt;code class=&quot;language-text&quot;&gt;this.onMessage&lt;/code&gt; 是绑定在 &lt;code class=&quot;language-text&quot;&gt;this&lt;/code&gt; 上，这个组件被泄露了。它的子组件也被泄露了，而且很有可能所有有关这些组件的 DOM 节点也被泄露了。这会很快变得糟糕。&lt;/p&gt;
&lt;p&gt;可以通过下面来解决：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 挂载阶段&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;onMessage &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;onMessage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bind&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addEventListener&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;onMessage&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 卸载阶段&lt;/span&gt;
window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;removeEventListener&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;onMessage&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;注意我们缓存了对绑定的 &lt;code class=&quot;language-text&quot;&gt;onMessage&lt;/code&gt; 函数的引用。必须向 &lt;code class=&quot;language-text&quot;&gt;removeEventListener&lt;/code&gt; 传入和 &lt;code class=&quot;language-text&quot;&gt;addEventListener&lt;/code&gt; 完全一样的函数，否则不会生效。&lt;/p&gt;
&lt;h3&gt;内存泄漏常见情况&lt;/h3&gt;
&lt;p&gt;常见的造成内存泄漏的 API：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;addEventListener&lt;/code&gt;，最常见的一种。调用 &lt;code class=&quot;language-text&quot;&gt;removeEventListener&lt;/code&gt; 来清除。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt;&lt;/a&gt; / &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;setInterval&lt;/code&gt;&lt;/a&gt;，如果创建了递归的计时器（如每 30 秒执行一次），那么需要通过 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/clearTimeout&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;clearTimeout&lt;/code&gt;&lt;/a&gt; 或 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/clearInterval&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;clearInterval&lt;/code&gt;&lt;/a&gt; 来清除。（如果 &lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 像 &lt;code class=&quot;language-text&quot;&gt;setInterval&lt;/code&gt; 那么使用会造成泄漏，即在 &lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 回调内部调用 &lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt;）。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;IntersectionObserver&lt;/code&gt;&lt;/a&gt;，&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/ResizeObserver&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;ResizeObserver&lt;/code&gt;&lt;/a&gt;，&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;MutationObserver&lt;/code&gt;&lt;/a&gt;等。这些新的 API 非常方便，但是它们很容易造成泄漏。如果在一个组件中创建了它们，并且它绑定到了一个全局可见的元素上，那么需要调用 &lt;code class=&quot;language-text&quot;&gt;disconnect()&lt;/code&gt; 来清理。（注意垃圾回收 DOM 节点时，也会回收它们的监听器和 observer。所以通常只需要关心全局的元素，如 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;body&amp;gt;&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;document&lt;/code&gt; 以及全局可见的 header/footer 元素等）。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Promises&lt;/code&gt;&lt;/a&gt;，&lt;a href=&quot;https://rxjs.dev/guide/observable&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Observables&lt;/code&gt;&lt;/a&gt;，&lt;a href=&quot;https://nodejs.org/api/events.html#events_class_eventemitter&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;EventEmitters&lt;/code&gt;&lt;/a&gt;等。如果忘记停止监听，那么任何模型上设置的监听器都可能泄漏。（一个 Promise 如果永远没有 resolved 或 rejected，那么任何附着的 &lt;code class=&quot;language-text&quot;&gt;.then()&lt;/code&gt; 回调都会泄漏。）&lt;/li&gt;
&lt;li&gt;全局保存的对象。像 &lt;a href=&quot;https://redux.js.org/&quot;&gt;Redux&lt;/a&gt; 的状态是存在全局对象下的，所以如果不加小心，可能会不断增加内存消耗，而它永远不会被清理。&lt;/li&gt;
&lt;li&gt;无尽的 DOM 增长。如果实现了一个无线滚动的功能而没有使用&lt;a href=&quot;https://github.com/WICG/virtual-scroller#readme&quot;&gt;虚拟化&lt;/a&gt;，那么 DOM 节点的数量会无限制的增长。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;当然还有很多其他泄漏内存的方式，以上是比较常见的类型。&lt;/p&gt;
&lt;h3&gt;鉴别内存泄漏&lt;/h3&gt;
&lt;p&gt;在 Chrome 开发者工具中，我们主要使用 “Memory tab” 下面的 “Heap snapshot”：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 570px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8f2fa0b193b0dd41794c141ad9480a38/f65ec/chrome-dev-tool.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.42105263157894%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB8klEQVQoz52T627aQBCF/eCV0hACRBApL9Dn6I9KfYqqlQgGXwr4tmB7zdpr7D0964QqRcmfWvo0u76cmTk7dibjz7gf3xgbJ5NbMsLk/hZj7ufzKeaLBywe53h6WuDhYYy7u5vhmWU6HWE2G5vZdGQeF1N8mY/OThzHRogDDscjikxARPGAlhVMXUNJi8L5dIJpmlf0ENGegTN5uUx2zOH8+PkLnu+b7XaL3HURk2S9QRVFqJNkQGcpydBY0vQviugoMlDKWEXf84zjrtfI8wLVqUJdFIiDAFEQYu/7JOA+RJlmKCh8TX5ZszvdtgjDEM6KFR1ZqpQSjdbIKVpyLauKSU5DIrs+KQXN9uyH1zRsv++6F8Hn1eofwexwQJSkyMsSqqkhKWqxgs1F4E1smcTSGXMlaCuKY8SbDSLaELlrJJ4PyXv2vqSnxX6PkrG0kdi9oq9tnqNj2yG/dexhFGzTVljSP2/lInU3EPTOo2jAAxIULIVA8R4UzBklxf3lEk7FygYxip6ZpdEtur4f5kDRG1t5TSt6tvQhdmY4YgG7dUp6dRHs6N9/X28FL6JVlOD3mvO49NHt6NluB8HR0Rx8w3d6JjXv0PMZDwI+J2YQLIhWEt+fK3z6KjD7JpBLtqs0VM0/w1rA1sxHvFq0p49/ADB3e6V6DyMRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;chrome dev tool&quot;
        title=&quot;chrome dev tool&quot;
        src=&quot;/static/8f2fa0b193b0dd41794c141ad9480a38/f65ec/chrome-dev-tool.png&quot;
        srcset=&quot;/static/8f2fa0b193b0dd41794c141ad9480a38/00d96/chrome-dev-tool.png 148w,
/static/8f2fa0b193b0dd41794c141ad9480a38/0b23c/chrome-dev-tool.png 295w,
/static/8f2fa0b193b0dd41794c141ad9480a38/f65ec/chrome-dev-tool.png 570w&quot;
        sizes=&quot;(max-width: 570px) 100vw, 570px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;当我们点击 “Take snapshot” 按钮，在页面的 JavaScript 虚拟机上就开始捕获所有的存活对象。包括被 &lt;code class=&quot;language-text&quot;&gt;window&lt;/code&gt; 引用的对象，被 &lt;code class=&quot;language-text&quot;&gt;setInterval&lt;/code&gt; 回调函数引用的对象等。将它看作该网页使用的所有内存的停滞时刻。&lt;/p&gt;
&lt;p&gt;下一步是重现某些你认为会造成泄露的场景，例如，打开然后关闭一个对话框。一旦关闭对话框，期望内存会回到之前的水平。所以再记录一个快照，然后与之前的快照进行对比。&lt;/p&gt;
&lt;p&gt;然而，需要意识到这个工具有一些限制：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;尽管点击了 “collect garbage” 按钮，可能也需要连续几次快照才能真正清除未引用的内存。（检查每次快照的总内存，它应该保持一样稳定。）&lt;/li&gt;
&lt;li&gt;如果存在 web workers，service workers，iframes，shared workers 等。那这些内存不会出现在 heap 快照中，因为它们存在于另一个 JavaScript 虚拟机中。可以捕获这部分内存，但是要确保你知道在测量哪一部分。&lt;/li&gt;
&lt;li&gt;有时候快照会卡住或崩溃。需要关闭浏览器 tab 然后重新开始。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;看到这里，你或许会去看两个快照之间有哪些对象是被泄露了。这会变得有些棘手，因为那些对象不是所有的都是真的泄漏。许多只是正常的使用 — 有些对象会因为是被另一个对象引用而再次被分配，有些是被某种方式缓存起来在将来被清除等。&lt;/p&gt;
&lt;h3&gt;遍历 retainer 树&lt;/h3&gt;
&lt;p&gt;堆快照 diff 可以展示一个 “retainer” 链，从链上可以找出哪些对象指向其他哪些保持存活的对象。可以据此找出泄漏的对象是在哪里被创建的。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 570px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4574b346b300d67936c66ac6f03476b7/f65ec/retainer-chain.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 19.473684210526315%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAxUlEQVQY012OUQ6DIBBEvf8h21hRC4isCgqKTBfiV0leNpksb6cRrxbzMGASAvph6nsYzkyZD2WHxgGy69CJHoL3Pp8OUiq83m/0vKOUQmO+tgqUKJIRJCXObUPyHtfDvXusdoOWhG2UOEKA55yWBc45TJOBMTPatkUTYsJMC/RsQSyidcV13/h/mSlpZkHOGSklXFdCjJGlvlIbhtWBBgXJDRU3Ja3hrMVOhMDyyEdOltS2PE9jEFhy7EdtV5BKY+Jc898fIk0wgsBwGCkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;retainer chain&quot;
        title=&quot;retainer chain&quot;
        src=&quot;/static/4574b346b300d67936c66ac6f03476b7/f65ec/retainer-chain.png&quot;
        srcset=&quot;/static/4574b346b300d67936c66ac6f03476b7/00d96/retainer-chain.png 148w,
/static/4574b346b300d67936c66ac6f03476b7/0b23c/retainer-chain.png 295w,
/static/4574b346b300d67936c66ac6f03476b7/f65ec/retainer-chain.png 570w&quot;
        sizes=&quot;(max-width: 570px) 100vw, 570px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;上面例子中，有一个变量 &lt;code class=&quot;language-text&quot;&gt;someObject&lt;/code&gt; 被一个闭包（context）引用，实际是由一个事件监听器引用的。如果点击源代码链接，它会定位到 JavaScript 声明的地方：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SomeObject&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/* ... */&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; someObject &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SomeObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;onMessage&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/* ... */&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addEventListener&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; onMessage&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面例子中，“context” 就是引用了 &lt;code class=&quot;language-text&quot;&gt;someObject&lt;/code&gt; 变量的 &lt;code class=&quot;language-text&quot;&gt;onMessage&lt;/code&gt; 闭包。（这是一个&lt;a href=&quot;https://github.com/nolanlawson/pinafore/commit/de6ca2d85334ad5f657ddd0f335750b60afab895&quot;&gt;故意的例子&lt;/a&gt;，真实环境中的内存泄漏会比这更难以发现。）&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://nolanlawson.com/2020/02/19/fixing-memory-leaks-in-web-applications/&quot;&gt;https://nolanlawson.com/2020/02/19/fixing-memory-leaks-in-web-applications/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[了解 V8 内存管理]]></title><description><![CDATA[本文我们来看一下用于ECMAScript和WebAssembly的V8 引擎的内存管理。V8 引擎现在被 NodeJS，Deno 等运行时，Electron，还有 Chrome，Chromium，Brave，Opera 和 Microsoft Edge…]]></description><link>https://www.keisei.top/architecture-of-v8-memory/</link><guid isPermaLink="false">https://www.keisei.top/architecture-of-v8-memory/</guid><pubDate>Mon, 24 Feb 2020 23:03:00 GMT</pubDate><content:encoded>&lt;p&gt;本文我们来看一下用于&lt;a href=&quot;https://tc39.es/ecma262/&quot;&gt;ECMAScript&lt;/a&gt;和&lt;a href=&quot;https://webassembly.github.io/spec/core/&quot;&gt;WebAssembly&lt;/a&gt;的&lt;a href=&quot;https://v8.dev/&quot;&gt;V8 引擎&lt;/a&gt;的内存管理。V8 引擎现在被 NodeJS，Deno 等运行时，Electron，还有 Chrome，Chromium，Brave，Opera 和 Microsoft Edge 等浏览器采用。由于 JavaScript 是一门解释型语言，需要引擎来解释并执行。V8 引擎解释 JavaScript 代码并将代码编译成原生的机器码。V8 引擎是通过 C++编写的，可以嵌套在任意的 C++程序中。&lt;/p&gt;
&lt;h3&gt;V8 内存架构&lt;/h3&gt;
&lt;p&gt;由于 JavaScript 是单线程的，V8 会在每个 JavaScript 上下文中使用一个单独的进程，如果使用了 service worker，它会根据每个 worker 产生一个新的 V8 进程。每个运行中的应用程序总是被 V8 进程分配一些内存，被称为&lt;strong&gt;常驻集（Resident Set）&lt;/strong&gt;。然后被进一步分为一下不同的片段：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/51d594675e95270d44f2ba31e0459f30/b7c40/memory-structure-of-V8.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACZ0lEQVQoz2O4cvP2teXrTs9ZeWbuyrPzVp2btwrIgKDLS9YdXLB177xN++Zt2j9v8745W3fP3rJ7zpads7acXbrl6o1bDHevXV9V2RVY1BZT3R1d2p6R3RxR0Rld1R1a3LIkta+spDFnbmTerNjCicm+/rPkgqYrh06X8Jo2J2fO/etXGO5du7Gkrt+lpjekY6p/fV9kQatP04SQzqme9V0LsiaV1dUXbAgvWh1bND/B0X+mcPgMhYTZfAEzZuTPv3/jKsPNmzcPFHXNDW9clt69LK17VXrPstTOpcld84Obt6RNLIxckxG5vCx9bXn6qprsXaUZOwoSN8cFbVpatuIu0OZr12/ebey4ll12s6jmZmH1jcLq29Ud97rbbjUl3ulIPdWce6Ip/3xn5anWmfODYhaGxi2JSp3sErgnv/Q20M9Xb9x+UlX5MCn+cV7u47ych8kJT4srXs8qfTFJ/eU007ezrV9P0Xoz1ezZxI7pxgozzJXmO+hO0BLenRBy+9Y9hivXbj5u63hYXv6ophaIHlZUPG5qez6t5enEqKeT4p5OTnw6Meb5lNQHfd3z7I0Xedsu9XOaYaO7JyXm1s27DNev3fi6dMG3JfOhCMJeNO/78qXf16z6vnrlt6WLvy9Z/GH21PU+lhuDHbbHei131jtXknbn9l2Gw9futS0+3rLoWCsCHQeRi493rTjdteIUkAERbF5wpGn+oaZ5B5vmH25dePTQ1XsMu688CJt+Lmja2WBUFDjlTMLcC0AEZEBEQqadC5kOQsHTzoVOP7fz0n2GCw8eX3yIHZ2//+j8g0e4ZIEaAWRwlfz83vVPAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;memory structure of V8&quot;
        title=&quot;memory structure of V8&quot;
        src=&quot;/static/51d594675e95270d44f2ba31e0459f30/799d3/memory-structure-of-V8.png&quot;
        srcset=&quot;/static/51d594675e95270d44f2ba31e0459f30/00d96/memory-structure-of-V8.png 148w,
/static/51d594675e95270d44f2ba31e0459f30/0b23c/memory-structure-of-V8.png 295w,
/static/51d594675e95270d44f2ba31e0459f30/799d3/memory-structure-of-V8.png 590w,
/static/51d594675e95270d44f2ba31e0459f30/2a3d6/memory-structure-of-V8.png 885w,
/static/51d594675e95270d44f2ba31e0459f30/b7c40/memory-structure-of-V8.png 960w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;堆内存&lt;/h4&gt;
&lt;p&gt;这是 V8 存储对象或动态数据的地方。这是内存区域最大的块，这也是&lt;strong&gt;垃圾回收（Garbage Collection）&lt;/strong&gt;发生的地方。并不是整个堆内存都会被回收，只有新生代和老生代会被垃圾回收管理。堆会进一步分为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;新生代（New Space）&lt;/strong&gt; 新生代或“&lt;strong&gt;年轻代（Young generation）&lt;/strong&gt;”是新对象存储的地方，这些新对象通常都是短暂存活的。这块内存非常小，有两个 semi-space。这块内存被“清道夫（&lt;strong&gt;Scavenger(Minor GC)&lt;/strong&gt;）”管理。新生代可以通过 &lt;code class=&quot;language-text&quot;&gt;--min_semi_space_size(初始化)&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;--max_semi_space_size(最大)&lt;/code&gt; 标志来控制大小。&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;老生代（Old Space）&lt;/strong&gt; 老生代或“&lt;strong&gt;老年代（Old generation）&lt;/strong&gt;”是那些在新生代中在两次二级 GC 中存活下来的对象。这块内存是被“&lt;strong&gt;主 GC（Major GC: Mark-Sweep &amp;#x26; Mark-Compact）&lt;/strong&gt;”管理。老生代可以通过 &lt;code class=&quot;language-text&quot;&gt;--initial_old_space_size(初始化)&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;--max_old_space_size(最大)&lt;/code&gt; 标志来控制大小。这块内存又被分为两份：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;旧指针空间（Old pointer space）&lt;/strong&gt;：包含具有指向其他对象的幸存对象&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;旧数据空间（Old data space）&lt;/strong&gt;：包含保存数据的对象（没有指向其他的对象）。字符串，包装过的数字等保存新生代中在两次二级 GC 中存活下来的对象。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;大对象空间（Large object space）&lt;/strong&gt;：这是超过其他内存限制的更大的对象存活的地方。大对象不会被垃圾回收。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;代码空间（Code-space）&lt;/strong&gt;：这是即时（&lt;strong&gt;Just In Time: JIT&lt;/strong&gt;）编译器存储编译过的代码的地方。这是唯一可执行的内存空间（尽管代码可能被分配在“大对象空间”，这些也是可执行的）。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;细胞空间，属性细胞空间，map 空间（Cell space, property cell space, and map space）&lt;/strong&gt;：这些空间分别包含：&lt;code class=&quot;language-text&quot;&gt;Cells&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;PropertyCells&lt;/code&gt;, 和 &lt;code class=&quot;language-text&quot;&gt;Maps&lt;/code&gt;。这些空间中的每个空间都包含相同大小的对象，并且对它们指向的对象有一些限制，从而简化了回收。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这些空间中的每一个都由一组 pages 组成。Page 是使用 mmap 从操作系统分配的连续内存块。除较大的对象空间外，每个页面的大小均为 1MB。&lt;/p&gt;
&lt;h4&gt;栈内存&lt;/h4&gt;
&lt;p&gt;每个 V8 进程会有对应的栈。这里是静态数据，包含方法/函数帧，基本数据，指向对象的指针存放的地方。栈内存的大小限制可以通过 &lt;code class=&quot;language-text&quot;&gt;--stack_size&lt;/code&gt; 标志控制。&lt;/p&gt;
&lt;h3&gt;V8 内存使用（栈 vs 堆）&lt;/h3&gt;
&lt;p&gt;现在我们已经清楚内存是如何管理的，我们来看一下当应用运行时内存是如何使用的。&lt;/p&gt;
&lt;p&gt;我们来看下面这段代码，注意代码并未优化，主要来关注栈和堆的内存使用。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Employee&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; salary&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sales&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;salary &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; salary&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sales &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sales&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;BONUS_PERCENTAGE&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getBonusPercentage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;salary&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; percentage &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;salary &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;BONUS_PERCENTAGE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; percentage&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;findEmployeeBonus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;salary&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; noOfSales&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; bonusPercentage &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getBonusPercentage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;salary&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; bonus &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; bonusPercentage &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; noOfSales&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; bonus&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; john &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Employee&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;John&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
john&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bonus &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;findEmployeeBonus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;john&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;salary&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; john&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sales&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;john&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bonus&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;相关 slide 可以&lt;a href=&quot;https://speakerdeck.com/deepu105/v8-memory-usage-stack-and-heap&quot; target=&quot;_blank&quot;&gt;点击新窗口打开&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;可以看到：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;全局作用域是存在于栈的“全局帧”中&lt;/li&gt;
&lt;li&gt;每个函数调用都作为帧块被加入栈内存&lt;/li&gt;
&lt;li&gt;所有的局部变量包括参数和返回值都在栈的函数帧块中&lt;/li&gt;
&lt;li&gt;所有的原始数据如 &lt;code class=&quot;language-text&quot;&gt;int&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;string&lt;/code&gt; 都被直接存入栈中。这也适用全局作用域&lt;/li&gt;
&lt;li&gt;所有的对象类型如 &lt;code class=&quot;language-text&quot;&gt;Employee&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;Function&lt;/code&gt; 都在堆中被创建，从栈中使用栈指针引用它们。在 JavaScript 中函数本质上是对象，这也适用全局作用域&lt;/li&gt;
&lt;li&gt;从当前函数调用的函数被加入栈顶&lt;/li&gt;
&lt;li&gt;当函数返回时，它的帧在栈中被移除&lt;/li&gt;
&lt;li&gt;一旦主流程完成，堆中的内存没有栈中任何的指针指向会成为孤立对象&lt;/li&gt;
&lt;li&gt;除非做了复制，其他对象内的所有对象引用都使用引用指针&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;栈就像看到的一样是操作系统而不是 V8 本身管理并结束的，因此我们不需要太关注栈。相反，堆内存不是操作系统自动管理的，由于它有最大的内存空间并存储动态数据，可能随着时间增长呈指数增长以至程序执行用光内存。这就是垃圾回收需要的原因。&lt;/p&gt;
&lt;p&gt;对于垃圾回收区分堆中的指针和数据是非常重要的，V8 使用“&lt;strong&gt;标记指针（Tagged pointer）&lt;/strong&gt;”的方式来回收，它在每个字母后面预留了一比特来标记是指针还是数据。这个方式需要有限的编译器支持，但实现起来很简单，而且效率很高。&lt;/p&gt;
&lt;h3&gt;V8 内存管理：垃圾回收&lt;/h3&gt;
&lt;p&gt;现在我们知道 V8 是如何分配内存的，我们来看一下它又是如何自动管理对应用程序性能非常重要的堆内存的。当一个应用程序尝试分配超过堆剩余内存（取决于 V8 设置的标志大小）时，会造成&lt;strong&gt;内存溢出的异常&lt;/strong&gt;。对堆不正确的管理也会造成内存泄露。&lt;/p&gt;
&lt;p&gt;V8 通过垃圾回收管理堆内存。简单来说，它释放孤立对象的内存，即没有在栈中有直接或间接（在另一个对象中的引用）引用的对象会被回收来为新对象的创建提供空间。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Orinoco&lt;/strong&gt; 是 V8 垃圾回收项目的代号，通过并行，增量，并发的技术进行垃圾回收，来释放主线程。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在 V8 中垃圾回收器是回收未使用的内存来供 V8 进程重新利用。&lt;/p&gt;
&lt;p&gt;V8 垃圾回收器是传代的（堆中的对象根据年代进行分组并在不同的阶段被清除）。V8 中有两个阶段，采用了三种不同的算法来进行垃圾回收：&lt;/p&gt;
&lt;h4&gt;二级 GC（清道夫）&lt;/h4&gt;
&lt;p&gt;这种类型的 GC 保证年轻或新生代空间紧凑整洁。对象分配在新生代空间中，该空间很小（介于 1MB 至 8MB，取决于行为启发）。在“新空间”中分配内存很容易：只要想为新对象预留空间，可以直接增加分配的指针。当指针达到新空间的极限，二级 GC 就会被触发。这个过程也被称为&lt;strong&gt;清道夫&lt;/strong&gt;，它实现了&lt;a href=&quot;http://en.wikipedia.org/wiki/Cheney&amp;#x27;s_algorithm&quot;&gt;Cheney 的算法&lt;/a&gt;。它发生的频率较高，通过使用平行的帮助线程执行非常快。&lt;/p&gt;
&lt;p&gt;我们来看一下二级 GC 的过程：&lt;/p&gt;
&lt;p&gt;新空间被分为均等的两份半空间：&lt;strong&gt;到空间（to-space）&lt;/strong&gt;和&lt;strong&gt;来空间（from-space）&lt;/strong&gt;。大多数的分配都是在到空间的（除了确切类型的对象，如可执行代码始终存储在老空间中）。当到空间填满时，二级 GC 就会被触发。&lt;/p&gt;
&lt;p&gt;相关 slide 可以&lt;a href=&quot;https://speakerdeck.com/deepu105/v8-minor-gc&quot; target=&quot;_blank&quot;&gt;点击新窗口打开&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;假设当我们开始时已经有一些对象存在于“到空间”（块 01 至 06 标记为已使用的内存）&lt;/li&gt;
&lt;li&gt;创建了一个新对象（07）&lt;/li&gt;
&lt;li&gt;V8 尝试从到空间中获取内存，但是没有空余的空间来容纳，因此 V8 会触发二级 GC&lt;/li&gt;
&lt;li&gt;二级 GC 将“到空间”和“来空间”进行交换，所有的对象现在都在“来空间”，“到空间”现在是空的&lt;/li&gt;
&lt;li&gt;二级 GC 递归地遍历“来空间”的对象图开始从栈指针（GC 根）找出被使用的或存活的（使用了内存）对象。这些对象引用的任何对象也都在“到空间”中移动到此 page，并且它们的指针都更新了。这个过程会持续到所有“来空间”的对象都被扫描过。在最后，“到空间”自动压缩以减少碎片&lt;/li&gt;
&lt;li&gt;二级 GC 现在清空“来空间”，因为任何留下的对象都成为了垃圾&lt;/li&gt;
&lt;li&gt;新对象在“到空间”中分配内存&lt;/li&gt;
&lt;li&gt;我们假设一会儿时间过去了，“到空间”中现在有更多的对象（块 07 到 09 都被标记为已使用的内存）&lt;/li&gt;
&lt;li&gt;应用创建了一个新对象（10）&lt;/li&gt;
&lt;li&gt;V8 尝试从“到空间”中获取内存，但是没有多余的内存来容纳，因此 V8 触发了第二次二级 GC&lt;/li&gt;
&lt;li&gt;以上的过程会重复，而任何在第二次二级 GC 中存活的对象被移动到“老生代空间”。第一次幸存者被移动到“到空间”，剩余的从“来空间”中被清除&lt;/li&gt;
&lt;li&gt;新对象在“到空间”中被分配内存&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;现在我们看到了二级 GC 从年轻代中回收空间，并保持紧凑。这是一个会中断其他过程的（stop-the-world）过程，但是由于它是很快的高效的，在大多数时间中都是微不足道的。由于此过程不会扫描“老生代”的对象来获取“新生代”中的任何引用，它使用从老生代到新生代的所有指针的寄存器。这通过一个&lt;a href=&quot;https://www.memorymanagement.org/glossary/w.html#term-write-barrier&quot;&gt;&lt;strong&gt;写屏障（write barriers）&lt;/strong&gt;&lt;/a&gt;的过程记录到存储缓冲区中。&lt;/p&gt;
&lt;h4&gt;主 GC（Major GC）&lt;/h4&gt;
&lt;p&gt;该类 GC 保证老生代空间的紧凑整洁。在它从二级 GC 循环中被填满时，它会基于一个动态计算出的内存限制在老生代没有额外空间时触发。&lt;/p&gt;
&lt;p&gt;清道夫算法对小的数据非常契合，对大的堆难以处理。老生代内存有开销，主 GC 是通过&lt;strong&gt;标记清除压缩（Mark-Sweep-Compact）&lt;/strong&gt;算法来完成的。它使用了三色（白-灰-黑）标记系统。因此主 GC 是一个三步执行的过程，第三步的执行取决于片段的启发式。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7bccbe1e01240d0a409a8cd80d89e4f9/major-gc.gif&quot; alt=&quot;major gc&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;标记&lt;/strong&gt;：第一步，两种算法共同之处，垃圾回收器分辨哪些对象是在使用中的，哪些不是。使用中的或从 GC 根（栈指针）可访问的对象会被递归地标记为存活。它在堆中的深度优先查找，可以想象成为一个有向图&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;清除&lt;/strong&gt;：垃圾回收器遍历堆，对任何没有标记为存活的对象记录它们的内存地址。在空闲列表中这块空间被标记为空闲，可以被用来存储其他对象&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;压缩&lt;/strong&gt;：清除之后，如果需要，所有存活的对象会被移动到一起。这可以降低碎片化，增加分配新对象内存的性能&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这种类型的 GC 在执行垃圾回收时也是会中断其他的执行，因为它引入了停止时间的特性。为了避免该问题，V8 使用了如下技术：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/0cd12639e82d99d64ca29e089183cab6/technique.svg&quot; alt=&quot;technique&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;增量 GC&lt;/strong&gt;：垃圾回收执行多个增量的步骤来完成&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;并发标记&lt;/strong&gt;：通过使用多个帮助线程来并发标记而不干扰主要的 JavaScript 线程。写屏障（write barriers）被用来追踪 JavaScript 创建的对象的新引用&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;并发清除/压缩&lt;/strong&gt;：清除压缩是并发在帮助线程完成的，不干扰主要的 JavaScript 线程&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;惰性清除&lt;/strong&gt;：惰性清除可以在内存需要时再删除 pages 的垃圾&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们来看一下主要的 GC 过程：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;假设许多二级 GC 循环都通过了，老年代已经填满，V8 决定触发一次主 GC&lt;/li&gt;
&lt;li&gt;主 GC 递归地遍历对象图，从堆栈指针开始，以标记在旧空间中被用作活动对象（已用内存）和其余对象作为垃圾（孤立对象）的对象。 这是使用多个并发的帮助线程完成的，每个线程都基于一个指针。 这不会影响 JS 主线程。&lt;/li&gt;
&lt;li&gt;完成并发标记或达到内存限制后，GC 将使用主线程执行标记完成步骤。这会短暂暂停时间。&lt;/li&gt;
&lt;li&gt;现在，主要 GC 使用并发清除线程将所有孤立对象的内存标记为空闲。还会触发并行压缩任务，以将相关的内存块移至同一 page 以避免碎片。在这些步骤中将更新指针。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://v8.dev/blog/trash-talk&quot;&gt;v8.dev/blog/trash-talk&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://jayconrod.com/posts/55/a-tour-of-v8-garbage-collection&quot;&gt;jayconrod.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.codeship.com/understanding-garbage-collection-in-node-js/&quot;&gt;blog.codeship.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management&quot;&gt;developer.mozilla.org&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.sessionstack.com/how-javascript-works-memory-management-how-to-handle-4-common-memory-leaks-3f28b94cfbec&quot;&gt;blog.sessionstack.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://deepu.tech/memory-management-in-v8/&quot;&gt;Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[初识小程序架构]]></title><description><![CDATA[笔者之前接手过一些小程序的项目，不过当时时间紧任务重，基本上就是边看文档边撸代码，并没有真正好好的理解小程序的设计。今天准备花些时间来了解一下，小程序背后的故事。 前世今生 小程序这个概念应该是微信最早提出并推广应用的。当时发布之后我也尝试做过类似 Instagram…]]></description><link>https://www.keisei.top/architecture-of-miniprogram/</link><guid isPermaLink="false">https://www.keisei.top/architecture-of-miniprogram/</guid><pubDate>Sun, 23 Feb 2020 20:52:00 GMT</pubDate><content:encoded>&lt;p&gt;笔者之前接手过一些小程序的项目，不过当时时间紧任务重，基本上就是边看文档边撸代码，并没有真正好好的理解小程序的设计。今天准备花些时间来了解一下，小程序背后的故事。&lt;/p&gt;
&lt;h3&gt;前世今生&lt;/h3&gt;
&lt;p&gt;小程序这个概念应该是微信最早提出并推广应用的。当时发布之后我也尝试做过类似 Instagram 这样的支持上传，浏览图片的小程序，无奈当时刚发布时小程序的框架还有很多不完善的地方，比如像素单位在 Android 和 iOS 上不统一，开发工具体验差等，因此而弃坑。现在回过头来看小程序的发展已然非常成熟，各家大厂纷纷跟进，百花齐放。&lt;/p&gt;
&lt;p&gt;回到正题，小程序是如何出现的？&lt;/p&gt;
&lt;p&gt;据微信官方文档的介绍，在早期微信就封装过一个微信 JS-SDK，包含了很多拍摄，录音，二维码，支付等 API。记得当时做微信公众号的开发时，确实体会到了在 web 页面中调用微信原生功能的强大与便捷。但是，由于 web 应用会共享一个线程，即渲染线程和脚本线程是互斥的，所以当脚本执行时页面的渲染会卡住，给人不好的体验。所以微信开发者后面就给出了一个新的方案，既能够提供原生功能和体验，又能保障用户的安全前提下快速开发迭代。&lt;/p&gt;
&lt;h3&gt;设计理念&lt;/h3&gt;
&lt;h4&gt;选型&lt;/h4&gt;
&lt;p&gt;小程序的初衷就是要求渲染快，加载快。所以通常的渲染页面的技术：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;纯客户端原生渲染&lt;/li&gt;
&lt;li&gt;纯 Web 技术渲染&lt;/li&gt;
&lt;li&gt;Hybrid 技术渲染&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;纯客户端渲染需要跟随宿主环境一起发布，这种会破环小程序开发者的发布，并且不能云端热更新。
纯 Web 渲染就像之前提到了在复杂交互页面上会存在性能问题。
所以最终采用 Hybrid 方式，轻量级的组件采用 Web 技术渲染，而复杂的应用则会采用客户端原生渲染（如地图），两者结合来提供更好的性能和体验。&lt;/p&gt;
&lt;h4&gt;安全&lt;/h4&gt;
&lt;p&gt;不完全采用 Web 技术渲染小程序的另一大原因是由于 Web 技术的灵活性，可以通过 JavaScript 脚本随意跳转或修改页面上的内容。另外还有一些只允许展示的敏感数据是禁止 JavaScript 访问的。&lt;/p&gt;
&lt;p&gt;所以需要提供一个单独的沙箱环境来运行 JavaScript 代码。这个沙箱环境中不能提供浏览器相关接口，只能用作解释执行 JavaScript。就像浏览器中的 Service Worker，WebWorker 一样，启用单独的 worker 线程来执行 JavaScript。这个沙箱环境在客户端有提供（iOS 下是内置的 JavaScriptCore 框架，Android 下是微信 x5 内核的 JsCore 环境），该环境就是小程序逻辑层。&lt;/p&gt;
&lt;h3&gt;宿主环境&lt;/h3&gt;
&lt;p&gt;所谓的宿主环境其实就是微信 APP，在小程序中，渲染线程和逻辑线程是分开执行的，渲染层的界面使用 WebView 进行渲染，逻辑线程运行在 JsCore 中。&lt;/p&gt;
&lt;p&gt;一个小程序存在多个界面，即渲染层存在多个 WebView 线程。&lt;/p&gt;
&lt;h4&gt;通信模型&lt;/h4&gt;
&lt;p&gt;渲染层和逻辑层的的通信是通过宿主环境（Native）进行中转的，逻辑层发送的网络请求也由 Native 转发。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ad156d1c827ca78a893b6ed057d2f8a6/7eaff/communication.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.10865874363327%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABwUlEQVQ4y41T0W7TMBTth05omhAPaA8IxKfA+I9Nmnie2BAICQQd1ZSpq9bEWZqkSdMmce344OvKXhLSgaUTO/eee3xuYo+gh1KqAzv68f/hjOghhMB2u91Br8uyxGq1ArexPsQW680aeZ5rDnfxjqAV1XsiZAGux7/Q6MJGCpd/5ABszjAZT4AGLt51qEHFq0piHClMYuBHqBAVEkru8sSTQiItE/hrH2zD8LAOhwUtru4Vzm6Ac0/hVM93S22hoQJh2iNH73+/w7OLA7y4fI7XX16ZuND5jqCkb8eFETn3YOaPt8CylMZ5W/DD5ARHnw5x/Pkl3n59s1+Q6+DPhwbfmcQ3X2Km3bXbtS1nVYagCODncyw2i6dbph9RVyUEr3diehMppYHlKKkguX6vd+tBQSooigK+7yMIAgfGGGazGabTqVm3c3N/jjRNYTX+EqTzF8cJkiQxRDtHUYQwDM17G3Ecm/NKRqjWCdp2aG6axsB9Ar2mduq6dpw+jzajQ05jtO8KEYEckEMSJJEsy0ysqipX0x7OoU0M3VnOuWmH2iKX1tm++z1q7zREICH6GZ7nGXf7NnYOnxLst/QvMcIf2pmH3hzrJfUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;communication&quot;
        title=&quot;communication&quot;
        src=&quot;/static/ad156d1c827ca78a893b6ed057d2f8a6/799d3/communication.png&quot;
        srcset=&quot;/static/ad156d1c827ca78a893b6ed057d2f8a6/00d96/communication.png 148w,
/static/ad156d1c827ca78a893b6ed057d2f8a6/0b23c/communication.png 295w,
/static/ad156d1c827ca78a893b6ed057d2f8a6/799d3/communication.png 590w,
/static/ad156d1c827ca78a893b6ed057d2f8a6/2a3d6/communication.png 885w,
/static/ad156d1c827ca78a893b6ed057d2f8a6/ae92f/communication.png 1180w,
/static/ad156d1c827ca78a893b6ed057d2f8a6/7eaff/communication.png 2356w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;数据驱动&lt;/h4&gt;
&lt;p&gt;即逻辑层的 data 与渲染层的 view 是相对应的，当调用了 setData 时，逻辑层生成新的 DOM 树并与旧的树进行 diff，然后把有差异的部分通过中转传递到渲染层，从而完成 UI 更新。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1dc3badd29cbcf2218de43a9c4f803db/3c7f1/render-process.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70.62818336162988%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB20lEQVQ4y4WUTW/UMBCG+y+RKn4CAnGGIxzhBD+EAx83RG+AhEC7Krtqy2rzpV013aydxI4dxy8zDgndD4qlJ7Fn7Ncz9sgnoOa932Fo+/b/zeF2wh1r7UjbtijLEkVR7Nj3KbZFIIxNbxsFWYTpjR5JkmA2m8E5N/p25wDRVYT4Vxz6QyA7gta28K7FdeXwfQ1Mr4GvqUdOY7azfxBdiAXmYh5YyiW6tjseYUOLzpYe7y48Plx2eHsBZNKBVoxRME+/PcH9s1OcfrqH5z+ecVIw1tw6Q5rUURSlbvFm7vH+EvQHPi48auPgOINbab+cvsDjL4/w8PMDvP75ijbcE+RJ/aIOVwVwvjaYrm1I37s/F9H29Jk0tFENbXUQGvwHKVdVCVVJNLqksaKdO9qoo+j/4loXBA3hnQ+w7eBSmNVqhSiKIUm4blRAagmhRUASHBELKsP+OthLmnNUsKOIuOlGh5Ru1A2yMkMiY0Qion4a0mzpvJVVyFUe7IlIjgtqrUNRb8UWQgrUVd1T1nQUKlBVFUQpRj8XNd/ygSAXsZQScRyHwma4n2UpJtMJJpMJ0jQdfYN/s9kgz3MopfYL28IYE6I8Bi/4l51FuR8E+cNnN3DXg3DXQzH8fwN2azZtybJe2wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;render process&quot;
        title=&quot;render process&quot;
        src=&quot;/static/1dc3badd29cbcf2218de43a9c4f803db/799d3/render-process.png&quot;
        srcset=&quot;/static/1dc3badd29cbcf2218de43a9c4f803db/00d96/render-process.png 148w,
/static/1dc3badd29cbcf2218de43a9c4f803db/0b23c/render-process.png 295w,
/static/1dc3badd29cbcf2218de43a9c4f803db/799d3/render-process.png 590w,
/static/1dc3badd29cbcf2218de43a9c4f803db/2a3d6/render-process.png 885w,
/static/1dc3badd29cbcf2218de43a9c4f803db/3c7f1/render-process.png 1178w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.weixin.qq.com/ebook?action=get_post_info&amp;#x26;docid=0008aeea9a8978ab0086a685851c0a&quot;&gt;https://developers.weixin.qq.com/ebook?action=get_post_info&amp;#x26;docid=0008aeea9a8978ab0086a685851c0a&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[初识 React Native 架构]]></title><description><![CDATA[React Native 是一个能够允许 JavaScript 和 native 代码一样在 iOS 和 Android 设备上运行和交互的现代框架。它提供了一种编写一次多端运行的能力，有机会使我们统一应用的架构。对于新手而言了解 RN…]]></description><link>https://www.keisei.top/architecture-of-rn/</link><guid isPermaLink="false">https://www.keisei.top/architecture-of-rn/</guid><pubDate>Sat, 22 Feb 2020 21:59:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;strong&gt;React Native&lt;/strong&gt; 是一个能够允许 JavaScript 和 native 代码一样在 iOS 和 Android 设备上运行和交互的现代框架。它提供了一种编写一次多端运行的能力，有机会使我们统一应用的架构。对于新手而言了解 RN 是如何工作的比较让人困惑，因此本文将归结为理解以下三个架构：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;JavaScript 运行环境架构&lt;/li&gt;
&lt;li&gt;构建流程架构&lt;/li&gt;
&lt;li&gt;调试架构&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;JavaScript 运行环境架构（Bridge）&lt;/h3&gt;
&lt;p&gt;为了理解 RN 的原理，需要知道 javascript 在 iOS/Android 设备中是如何执行的。为了 javascript 的执行，react native 使用了称为 JavaScript Core 的运行环境，它其实是在操作系统上层的一些代码。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cdd834927424eabe5afebf55416b7b91/28aaf/architecture-of-rn.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 84.22818791946308%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAAC4ElEQVQ4y42Q21MSYRjG16ausuwiyy6766r/wNNoiBwWCAVBscOVN9VYF3ZjNzXjlAKOOk5kVtNpyqZuMm3EdmUFtVREARHQVGiyRjxAKivIvr0LaacZ69tnvnne93t+37u7BPy1ZsPDE4vdrpDZFerZlnlisWuVXcBTDp/tRfxC/eh2+GrqRnINdpHeLkwJfd1wjmeZ5kNcYjf41fQ1g13Y4lA2OeSNY2SzQ4FeP1rkXWb+Db+crsVpSJqcFQ8mq5odp1ENo4L/h4t4ZlzZOq5qcih2g7mtraTiuMMW92Kq5taHvMYRsdEuMY6JjaMi9Dff53oWKQwn4rFUHq8hfv/T/HBqwfTYf/H5TM1Tb/UTz6Vn/ivoH/kvzK87/pyMd4Q9k6su56rblVJ40hNxT615fdFvGxsx2PzyNex0RzzeVbd7J7PicsbX14lYOGxRyt8VCyhJ8Y6wZEoUIa+fBfDfbu3Jz6FJ0c+AVNQrKECeiEUi/RoVLZP0yaW0VESTYt7IJFaNask/EweYbjOZC/L4Jh6hZBgQUyIBzk/CZaWIMeoSW2W5VadFgyXCC5PeFQ587W1MqXLgrM6mK+/Xai1lGou2glYo8StSk0tosphRY6ICeaZMiSU2Qz4fvrb37h30A+d1/bpyZ7UmeKMkcF01VyuPziZhRq2ipBKalFJiESUW0yRJkRJGpV6bm8df6jWZevLzaBlpLhL5L4sTHZWbHVWb9xSJz+NEPBIeOiezqk/ZtEKbJiWBVV04eEayNjMCwM601zPy7IEKIaMSfrxaGLsviD5URluzeZiLLbHdx9jX+9nODLbzIL93ZbFvMrHJDZ6AkZNx+ngUS2x2Hoq/PcD1pnPmdK5nH6zYCIiFoD8daAL60qCPAMseGMwEWwYMHQXbYbAegYEs3g9lgWUvH6MIoNOgl4AVCwGJDS7YwgUMXMC4rQYuoMcdgnoIGoD3+mTTAEFjUo0QqAf203czYeLt0NrnRQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;architecture of rn&quot;
        title=&quot;architecture of rn&quot;
        src=&quot;/static/cdd834927424eabe5afebf55416b7b91/799d3/architecture-of-rn.png&quot;
        srcset=&quot;/static/cdd834927424eabe5afebf55416b7b91/00d96/architecture-of-rn.png 148w,
/static/cdd834927424eabe5afebf55416b7b91/0b23c/architecture-of-rn.png 295w,
/static/cdd834927424eabe5afebf55416b7b91/799d3/architecture-of-rn.png 590w,
/static/cdd834927424eabe5afebf55416b7b91/2a3d6/architecture-of-rn.png 885w,
/static/cdd834927424eabe5afebf55416b7b91/ae92f/architecture-of-rn.png 1180w,
/static/cdd834927424eabe5afebf55416b7b91/28aaf/architecture-of-rn.png 1192w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;为了使 JavaScript 能够运行原生应用，必须仍然使用底层原生代码。从上图中，我们可以看到每个 RN 控件都会与对应的原生控件进行交互。RN 通过 bridge 来完成这两种方式的通信。所以原生代码实际上在它自己的线程操作，即如果 RN 的 JavaScript 代码执行了很长时间，并不会使 UI 卡住或者变慢。通过 bridge 传递事件来执行回调。&lt;/p&gt;
&lt;h3&gt;构建流程架构&lt;/h3&gt;
&lt;p&gt;在构建 react native 应用时，react native 做了下面两件事情：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;它在本地运行一个 node web 服务器，来发布一个持有所有我们 RN JavaScript 代码的 payload 文件&lt;/li&gt;
&lt;li&gt;然后它会构建一个原生的应用程序并部署到设备上。该程序中配置了拥有 JavaScript 运行环境，并下载之前生成好的 payload&lt;/li&gt;
&lt;li&gt;这个 payload 文件随后直接被传递到 JavaScript 运行环境，这样就拥有了原生容器和支撑运行整个应用程序的 JavaScript 代码&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;调试架构&lt;/h3&gt;
&lt;p&gt;对于调试 react native 应用程序的过程，我们需要做以下事情：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;设置源码的地址&lt;/li&gt;
&lt;li&gt;开启浏览器使调试器可以输出调试信息&lt;/li&gt;
&lt;li&gt;或者可以执行通过控制台打印日志来理解构建过程或调试程序&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;React Native 开启了快速开发原型应用的篇章。许多基础的功能可以很轻松的实现。如果需要，它们可以通过原生代码和视图进行扩展，并且也可以与其他视图控制器进行集成。由于 RN 使用了 javascript，开发者可以更快更高效的工作，并且不需要每次更新代码后重启，可以直接刷新视图。&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;http://jyaasa.com/blog/getting-started-with-react-native-core-architecture-of-react-native&quot;&gt;http://jyaasa.com/blog/getting-started-with-react-native-core-architecture-of-react-native&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Koa 对比 Express]]></title><description><![CDATA[从理念上来说，Koa 意图“修复并取代 node”，而 Express 做的是“增强 node”。Koa 使用 promise 和 async 函数来摆脱回调地狱并简化异常处理逻辑。它暴露了自身的  和  对象而取代了 node 的  和  对象。 Express…]]></description><link>https://www.keisei.top/koa-vs-express/</link><guid isPermaLink="false">https://www.keisei.top/koa-vs-express/</guid><pubDate>Thu, 20 Feb 2020 20:31:00 GMT</pubDate><content:encoded>&lt;p&gt;从理念上来说，Koa 意图“修复并取代 node”，而 Express 做的是“增强 node”。Koa 使用 promise 和 async 函数来摆脱回调地狱并简化异常处理逻辑。它暴露了自身的 &lt;code class=&quot;language-text&quot;&gt;ctx.request&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;ctx.response&lt;/code&gt; 对象而取代了 node 的 &lt;code class=&quot;language-text&quot;&gt;req&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;res&lt;/code&gt; 对象。&lt;/p&gt;
&lt;p&gt;Express 从另一方面，通过增加额外的属性和方法增强了 node 的 &lt;code class=&quot;language-text&quot;&gt;req&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;res&lt;/code&gt; 对象，并引入了许多框架上的功能，例如路由和模板，而 Koa 没有这么做。&lt;/p&gt;
&lt;p&gt;Koa 可以被看作是 node.js 的 &lt;code class=&quot;language-text&quot;&gt;http&lt;/code&gt; 模块的抽象，Express 是 node.js 的应用框架。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;功能&lt;/th&gt;
&lt;th&gt;Koa&lt;/th&gt;
&lt;th&gt;Express&lt;/th&gt;
&lt;th&gt;Connect&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;中间件内核&lt;/td&gt;
&lt;td&gt;✓&lt;/td&gt;
&lt;td&gt;✓&lt;/td&gt;
&lt;td&gt;✓&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;路由&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;✓&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;模板&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;✓&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;发送文件&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;✓&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;JSONP&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;✓&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;因此，如果你更倾向于 node.js，喜欢传统的 node.js-style 编码方式，那么可以采用 Connect/Express 或类似的框架。如果想摆脱回调，使用 Koa。&lt;/p&gt;
&lt;p&gt;作为不同理念的结果是传统 node.js 中间件，即形如 &lt;code class=&quot;language-text&quot;&gt;(requndefined resundefined next)&lt;/code&gt; 的函数，与 Koa 是不兼容的。如果要迁移应用，需要从根本上重写。&lt;/p&gt;
&lt;h3&gt;Koa 会取代 Express 吗？&lt;/h3&gt;
&lt;p&gt;Koa 更像 Connect，但是好多 Express 的优点都移植到了 Koa 的中间件层来帮助构建更强大的基础。这使得不仅是终端应用代码还是整个技术栈在编写中间件时更加友好，更少出错的可能。&lt;/p&gt;
&lt;p&gt;通常，当诸如签名的 cookie 之类的功能通常是特定于应用程序而非特定于中间件时，许多中间件会重新实现类似的功能，甚至更糟糕地错误实现它们。&lt;/p&gt;
&lt;h3&gt;Koa 会取代 Connect 吗？&lt;/h3&gt;
&lt;p&gt;并不是，现在生成器允许我们用少量的回调编写代码，只是对类似的功能有着不同的看法。Connect 具有同样的功能，有些人可能仍然喜欢它，这取决于个人爱好。&lt;/p&gt;
&lt;h3&gt;为什么 Koa 不是 Express 4.0？&lt;/h3&gt;
&lt;p&gt;Koa 与人们所熟知的 Express 大相径庭，设计从根本上有很大的不同，所以从 Express 3.0 到 Express 4.0 的迁移成本意味着要重写整个应用，所以我们认为创建一个新的库是更加合适的。&lt;/p&gt;
&lt;h3&gt;Koa 与 Connect/Express 有哪些不同？&lt;/h3&gt;
&lt;h4&gt;基于 Promise 的控制流&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;没有回调地狱&lt;/li&gt;
&lt;li&gt;通过 try/catch 对错误有更好的处理&lt;/li&gt;
&lt;li&gt;无需域名&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Koa 是精简的&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;不像 Connect 和 Express，Koa 本身没有包含任何中间件&lt;/li&gt;
&lt;li&gt;不像 Express，Koa 不提供路由&lt;/li&gt;
&lt;li&gt;不像 Express，许多方便的工具没有提供。例如，发送文件。&lt;/li&gt;
&lt;li&gt;Koa 更加模块化&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Koa 较少依赖中间件&lt;/h4&gt;
&lt;p&gt;例如，不使用“body 解析”中间件，而是使用一个 body 解析函数&lt;/p&gt;
&lt;h4&gt;Koa 抽象了 node 的 request/response&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;更少黑科技&lt;/li&gt;
&lt;li&gt;更好的用户体验&lt;/li&gt;
&lt;li&gt;正确的处理流&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Koa 路由（第三方库支持）&lt;/h4&gt;
&lt;p&gt;由于 Express 自带路由，但是 Koa 没有任何内建路由，社区现在有许多如 koa-router 和 koa-route 的库可以使用。同样的，就像 Express 中有 helmet 保障安全性，对于 Koa，我们有可用的 koa-helmet，更多可用的&lt;a href=&quot;https://github.com/koajs/koa/wiki&quot;&gt;第三方库&lt;/a&gt;可查看。&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/koajs/koa/blob/master/docs/koa-vs-express.md&quot;&gt;https://github.com/koajs/koa/blob/master/docs/koa-vs-express.md&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Express.js 工作原理]]></title><description><![CDATA[web 开发者想必都一定听说过 express.js。Express 是 node 中比较受欢迎的轻量的 web 服务器框架。 本文我们将通过分析 express…]]></description><link>https://www.keisei.top/how-expressjs-works/</link><guid isPermaLink="false">https://www.keisei.top/how-expressjs-works/</guid><pubDate>Fri, 14 Feb 2020 18:25:00 GMT</pubDate><content:encoded>&lt;p&gt;web 开发者想必都一定听说过 &lt;a href=&quot;https://expressjs.com/&quot;&gt;express.js&lt;/a&gt;。Express 是 node 中比较受欢迎的轻量的 web 服务器框架。&lt;/p&gt;
&lt;p&gt;本文我们将通过分析 express 源码来了解在底层它是如何工作的。学习一个流行框架的原理，可以帮助我们更好地使用它们来构建应用程序，减少引入它们带来的“魔法”问题。&lt;/p&gt;
&lt;p&gt;本文目录：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;#hello-world-example&quot;&gt;“Hello World” 例子&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#create-new-express-app&quot;&gt;创建新的 express 应用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#create-new-route&quot;&gt;创建新的路由&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;#layers&quot;&gt;分层&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#start-http-server&quot;&gt;启动 HTTP 服务&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#handle-http-request&quot;&gt;处理 HTTP 请求&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#everything-else&quot;&gt;其他&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;为了更好地理解源码，将它 clone 到本地是比较好地方式，本文&lt;a href=&quot;https://github.com/expressjs/express/tree/c0136d8b48dd3526c58b2ad8666fb4b12b55116c&quot;&gt;使用的版本&lt;/a&gt;。
评论中的 &lt;code class=&quot;language-text&quot;&gt;// ...&lt;/code&gt; 是部分源码为了简洁做了省略。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;&lt;a name=&quot;hello-world-example&quot;&gt;&lt;/a&gt;“Hello World” 例子&lt;/h3&gt;
&lt;p&gt;我们从官网的“Hello world”例子开始深入源码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; express &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;express&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; app &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;express&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Hello World!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Example app listening on port 3000!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上述代码启动了端口号 3000 的 HTTP 服务器，并在命中 &lt;code class=&quot;language-text&quot;&gt;GET /&lt;/code&gt; 路由后发送“Hello World!”文本响应。笼统地来讲，我们可以从以下四个阶段来分析：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;创建一个新的 express 应用&lt;/li&gt;
&lt;li&gt;创建一个新的路由&lt;/li&gt;
&lt;li&gt;基于给定的端口号启动 HTTP 服务器&lt;/li&gt;
&lt;li&gt;当有请求进来时做出对应处理&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;&lt;a name=&quot;create-new-express-app&quot;&gt;&lt;/a&gt;创建新的 express 应用&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;const app = express()&lt;/code&gt; 这个表达式可以创建一个新的 express 应用。在 &lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/express.js#L37&quot;&gt;lib/express.js&lt;/a&gt; 中的 &lt;code class=&quot;language-text&quot;&gt;createApplication&lt;/code&gt; 函数是默认导出的对象，就是我们看到的 &lt;code class=&quot;language-text&quot;&gt;express()&lt;/code&gt; 函数调用。&lt;/p&gt;
&lt;p&gt;比较关键的代码是：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; mixin &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;merge-descriptors&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; proto &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;./application&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createApplication&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 这个是该函数返回的变量，具体我们会在后面讲到，重要的是要记住它的签名：function(req, res, next)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;app&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// `mixin` 函数将所有 `proto` 的方法合并至 `app`，我们例子中用到的 `get` 方法就是合并进来的&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mixin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;app&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; proto&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; app&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;从这个函数中返回的&lt;code class=&quot;language-text&quot;&gt;app&lt;/code&gt; 对象就是我们程序中用到的。&lt;code class=&quot;language-text&quot;&gt;app.get&lt;/code&gt; 方法通过 &lt;a href=&quot;https://github.com/component/merge-descriptors&quot;&gt;merge-descriptors&lt;/a&gt; 库中的 &lt;code class=&quot;language-text&quot;&gt;mixin&lt;/code&gt; 函数从 &lt;code class=&quot;language-text&quot;&gt;proto&lt;/code&gt; 中获取并添加的。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;proto&lt;/code&gt; 它是从 &lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/application.js&quot;&gt;lib/application&lt;/a&gt; 中导入的。&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;create-new-route&quot;&gt;&lt;/a&gt;创建新的路由&lt;/h3&gt;
&lt;p&gt;我们下面来简单看一下 &lt;code class=&quot;language-text&quot;&gt;app.get&lt;/code&gt; 方法在&lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/application.js#L472&quot;&gt;源码&lt;/a&gt;中的实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; slice &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;slice&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/**
 * Delegate `.VERB(...)` calls to `router.VERB(...)`.
 */&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// `methods` 是一个包含 [&apos;get&apos;, &apos;post&apos;, ...] 等 HTTP 方法的数组&lt;/span&gt;
methods&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 这应该是 app.get 方法的签名&lt;/span&gt;
  app&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;method&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 一些初始化的代码&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 在应用的 router 内部根据 path 创建一个 route&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 根据从第二个参数开始后续的参数来调用 handler&lt;/span&gt;
    route&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;method&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;slice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arguments&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 返回 `app` 实例，来使方法可以链式调用&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里实现比较巧妙的是，所有的 HTTP 动词方法，如 &lt;code class=&quot;language-text&quot;&gt;app.get&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;app.post&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;app.put&lt;/code&gt; 本质上功能都是类似的。如果我们只关注 &lt;code class=&quot;language-text&quot;&gt;get&lt;/code&gt; 方法，可以简化为：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  route&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;handler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;尽管上面的函数有两个参数，它实际和 &lt;code class=&quot;language-text&quot;&gt;app[method] = function(path){...}&lt;/code&gt; 定义是相似的。第二个参数 &lt;code class=&quot;language-text&quot;&gt;handler&lt;/code&gt; 是在 slice.call(arguments, 1) 中获取的。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;长话短说，&lt;code class=&quot;language-text&quot;&gt;app.&amp;lt;method&amp;gt;&lt;/code&gt; 只是在应用 router 中使用 &lt;code class=&quot;language-text&quot;&gt;route&lt;/code&gt; 方法保存 route，然后传递 &lt;code class=&quot;language-text&quot;&gt;handler&lt;/code&gt; 到 &lt;code class=&quot;language-text&quot;&gt;route.&amp;lt;method&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;router 的 &lt;code class=&quot;language-text&quot;&gt;route()&lt;/code&gt; 方法在 &lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/router/index.js#L491&quot;&gt;lib/router/index.js&lt;/a&gt; 中定义：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// proto 是 `_router` 对象的原型定义&lt;/span&gt;
proto&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;route&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; layer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Layer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      sensitive&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;caseSensitive&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      strict&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;strict&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      end&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    route&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;dispatch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bind&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  layer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; route&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;layer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; route&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;route.get&lt;/code&gt; 方法的定义与 &lt;code class=&quot;language-text&quot;&gt;app.get&lt;/code&gt; 类似，在 &lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/router/route.js#L192&quot;&gt;lib/router/route.js&lt;/a&gt; 中：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;methods&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;Route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;method&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// `flatten` 将嵌套的数组转换成一维的数组&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; handlers &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;flatten&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;slice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arguments&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; handles&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; handle &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; handles&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// 传给 route 的每个 handler 都会创建一个 layer，并添加到 route 栈中&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; layer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Layer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; handle&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;layer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;每个 route 可以有多个 handler，并基于每个 handler 构造 &lt;code class=&quot;language-text&quot;&gt;Layer&lt;/code&gt; 并压入栈中。&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;layers&quot;&gt;&lt;/a&gt;分层&lt;/h4&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;_router&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;route&lt;/code&gt; 都使用了同一类型的对象 &lt;code class=&quot;language-text&quot;&gt;Layer&lt;/code&gt;。我们可以从&lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/router/layer.js#L33&quot;&gt;构造函数的定义&lt;/a&gt;来观察 layer 是用来做什么的：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Layer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;handle &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; fn&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;regexp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;pathRegexp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;keys &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; opts&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;每个 layer 都有一个 path，一些 option 和一个待处理的函数。在我们的 router 中，这个函数是 &lt;code class=&quot;language-text&quot;&gt;route.dispatch&lt;/code&gt;(我们会在下面的章节介绍用途，它类似于将请求传递到单个路由)。在 route 中，这个函数就是我们定义的 handler 函数。&lt;/p&gt;
&lt;p&gt;每个 layer 也有一个&lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/router/layer.js#L86&quot;&gt;处理请求&lt;/a&gt;的函数：&lt;code class=&quot;language-text&quot;&gt;handle_request&lt;/code&gt;，在 Layer 初始化阶段真正执行传入的函数。&lt;/p&gt;
&lt;p&gt;我们来回顾一下通过 &lt;code class=&quot;language-text&quot;&gt;app.get&lt;/code&gt; 方法创建一个 route：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在应用的 router(&lt;code class=&quot;language-text&quot;&gt;this._router&lt;/code&gt;) 上创建一个 route&lt;/li&gt;
&lt;li&gt;route &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt; 方法作为 handler 方法传递给 layer，这个 layer 压入 router 栈中&lt;/li&gt;
&lt;li&gt;请求的 handler 本身作为 handler 方法传递给 layer，这个 layer 压入 route 栈&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在最后，所有的 handler 以在 route 栈内部的 layer 的形式存储到 &lt;code class=&quot;language-text&quot;&gt;app&lt;/code&gt; 中，&lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt; 方法传递给 layer 并存储在 router 栈上。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/a1d440ab10d27252ebff47ee98075640/express-routing.svg&quot; alt=&quot;express routing&quot;&gt;&lt;/p&gt;
&lt;p&gt;处理 HTTP 请求也与此类似，我们随后来&lt;a href=&quot;#handle-http-request&quot;&gt;了解&lt;/a&gt;。&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;start-http-server&quot;&gt;&lt;/a&gt;启动 HTTP 服务&lt;/h3&gt;
&lt;p&gt;在配置好路由之后，服务器开始启动。在我们的例子中调用了 &lt;code class=&quot;language-text&quot;&gt;app.listen&lt;/code&gt; 方法，传入了端口号和回调函数。可以通过 &lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/application.js#L616&quot;&gt;lib/application.js&lt;/a&gt; 来了解：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;listen&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; server &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; http&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createServer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; server&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;server&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; arguments&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;看起来 &lt;code class=&quot;language-text&quot;&gt;app.listen&lt;/code&gt; 只是包装了一下 &lt;code class=&quot;language-text&quot;&gt;http.createServer&lt;/code&gt;。这是说的通的，回想一下&lt;a href=&quot;#create-new-express-app&quot;&gt;第一章&lt;/a&gt;，&lt;code class=&quot;language-text&quot;&gt;app&lt;/code&gt; 实际上是 function(req, res, next){…} 签名的函数，与 &lt;code class=&quot;language-text&quot;&gt;http.createServer&lt;/code&gt; 所需要的函数签名 function(req, res) {…} 是兼容的。&lt;/p&gt;
&lt;p&gt;当意识到这些时你会发现这样非常简洁，express.js 所提供的所有能力可以总结为是一个非常高明的处理函数。&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;handle-http-request&quot;&gt;&lt;/a&gt;处理 HTTP 请求&lt;/h3&gt;
&lt;p&gt;现在我们知道 &lt;code class=&quot;language-text&quot;&gt;app&lt;/code&gt; 实际是一个普通的请求处理对象，我们下面通过定位一个 HTTP 请求来最终定位到内部 handler 的位置。&lt;/p&gt;
&lt;p&gt;从 &lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/express.js#L38&quot;&gt;lib/express.js&lt;/a&gt; 中的 &lt;code class=&quot;language-text&quot;&gt;createApplication&lt;/code&gt; 函数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;app&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;请求传递到 &lt;code class=&quot;language-text&quot;&gt;app.handle&lt;/code&gt; 的方法在 &lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/application.js#L158&quot;&gt;lib/application.js&lt;/a&gt; 中定义：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;handle&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; callback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// `this._router` 是我们从 `app.get` 处定义的路由&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; router &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_router&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 请求进一步传递到 `handle` 方法&lt;/span&gt;
  router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;router.handler&lt;/code&gt; 方法在 &lt;a href=&quot;https://github.com/expressjs/express/blob/c0136d8b48dd3526c58b2ad8666fb4b12b55116c/lib/router/index.js#L136&quot;&gt;lib/router/index.js&lt;/a&gt; 中定义：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;proto&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;handle&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; out&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; self &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// self.stack 是在调用时压入的所有layer&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 根据请求获取path name&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getPathname&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; layer&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; match&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; route&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;match &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; idx &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; stack&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      layer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; stack&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;idx&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      match &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;matchLayer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;layer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; layer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;match &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// ... 一些验证 HTTP 方法，headers 的校验代码&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// ... 一些验证&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 为 layer 处理所有参数&lt;/span&gt;
    self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process_params&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;layer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; paramcalled&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// 一旦参数处理完成， 就会调用 `layer.handler_request` 方法&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; layer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;handle_request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;简单来讲，&lt;code class=&quot;language-text&quot;&gt;router.handle&lt;/code&gt; 函数在它的栈上遍历所有的 layer，直到找到匹配 path 的请求。最终会调用 layer 的 &lt;code class=&quot;language-text&quot;&gt;handle_request&lt;/code&gt; 方法，执行先前定义过的 handler 函数。这个 handler 函数就是在 [lib/router/route.js] 中定义的 &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt; 方法：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;Route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;dispatch&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dispatch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; layer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; stack&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;idx&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// ... 一些校验和错误检查&lt;/span&gt;
    layer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;handle_request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;与 router 类似，每个 route 遍历所有的 layer，调用它们的 &lt;code class=&quot;language-text&quot;&gt;handle_request&lt;/code&gt; 方法，即执行传递给 layer 的 handler 方法。最后，HTTP 请求到达应用的底层。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/267bfd0839b56afc11b097382797ae8d/express-routing-http.svg&quot; alt=&quot;express routing http&quot;&gt;&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;everything-else&quot;&gt;&lt;/a&gt;其他&lt;/h3&gt;
&lt;p&gt;尽管我们看到了 express 来使 web 服务器工作的的核心代码，它还提供了很多其他的功能。我们跳过了许多必要的验证和所有的帮助函数。最后，一个非常关键的中间件功能，它能够帮助我们劫持所有请求并做出对应的处理。&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://www.sohamkamani.com/blog/2018/05/30/understanding-how-expressjs-works/&quot;&gt;https://www.sohamkamani.com/blog/2018/05/30/understanding-how-expressjs-works/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[React SSR 初体验]]></title><description><![CDATA[当前已经有很多的文章或会议中谈到了服务端渲染这种技术。而且社区中也出现了许多一站式的 React 框架，但是真正想要了解服务端渲染还是需要自己动手实现一下比较好。不过首先我们需要了解什么是服务端渲染和客户端渲染。 JavaScript 革命 浏览器比 5-1…]]></description><link>https://www.keisei.top/react-ssr/</link><guid isPermaLink="false">https://www.keisei.top/react-ssr/</guid><pubDate>Sun, 09 Feb 2020 20:10:00 GMT</pubDate><content:encoded>&lt;p&gt;当前已经有很多的文章或会议中谈到了服务端渲染这种技术。而且社区中也出现了许多一站式的 React 框架，但是真正想要了解服务端渲染还是需要自己动手实现一下比较好。不过首先我们需要了解什么是服务端渲染和客户端渲染。&lt;/p&gt;
&lt;h3&gt;JavaScript 革命&lt;/h3&gt;
&lt;p&gt;浏览器比 5-10 年之前更加先进，我们如今通过客户端 JavaScript 来创建整个网站和 web 应用。我们称之为 &lt;strong&gt;“单页面应用（Single Page Application）”&lt;/strong&gt;。这可以使我们创建更加互动性的最新的 web 应用。&lt;/p&gt;
&lt;p&gt;但这种方式存在一个问题，我们初始化的 HTML 不再含有与该 URL 相关的所有数据/内容。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token doctype&quot;&gt;&amp;lt;!DOCTYPE html&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;html&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;head&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;title&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;My SPA APP Title&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;title&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;head&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;body&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;root&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;text/javascript&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;/bundle.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token script&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;body&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;html&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;什么是客户端渲染？（CSR）&lt;/h3&gt;
&lt;p&gt;在浏览器中渲染应用，通常使用 DOM。&lt;/p&gt;
&lt;p&gt;服务器渲染的初始化 HTML 只是一个占位符，整个用户界面和数据都在浏览器的所有脚本加载完成之后渲染。&lt;/p&gt;
&lt;h4&gt;客户端渲染是如何工作的？&lt;/h4&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/582713f0d3e3646517ce9b7b81d2448e/01d6c/csr-work.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 54.63239689181112%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACFUlEQVQoz3WRy28SQRzH92/x6M1Uo6YakppoEy+eevPgyRg9efF1VC9eWh8xxgMx9VFrBGt5SMUiWGgLyOPQAC2PhZ267G6BXZZ9wczsOMvWtJo4h1++M/l+fvP7zjDkv8seF6itXmnOn9jynq69nTSj54zolPXtrBXzGInzjGOwbZZlWxw3HA6pRggdbqF8ubx098jTG0fDD48ZIU97+WLt63U2eq27Ms24ltm5x/du3+K4VrFYBAD8ATEtSEgr/gvKwgQMnok8m/G/uu9tdV5XQPXjpX048SMV+fTOMg1RkkzT/Gd4W/tlZh5YvlPxJ9Mr3pup2Mt45DlYGsM9DW01esQQD6IepjGmwRwll8zYVX1xwvKdtAIePTjlwCOIRdBA3bpjRfJf/BiT5Z4kCVJHoRsEolp4Rl08PvBPMvuD6R3UbVBVX8tZGnRfkdaBpuXyhc1s/nsildzYLFXZXl8n2MQggfgk47bPs+znQh6IosJxapcPGqRsYgLVPa4cCb5PxT6kk8sbQd966A3g6B12tV/HNnZhUm/zoZ/p3HaZ9Otw0A6PyA60icoN+IpUmS/H7vD5R9nAi9TqXE9pr+1GdjpFyjHueALP5zKZ0WhEdV8d7LaakiBgmxiGsV3KsdVCrZRdWI/OxgNAFBCBCKMDuK+qbLPpHkEIZVnWdd35ZxsjbCOaABOMqXIMnIp5cW9omb8BBrM+KdRPmToAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;csr work&quot;
        title=&quot;csr work&quot;
        src=&quot;/static/582713f0d3e3646517ce9b7b81d2448e/799d3/csr-work.png&quot;
        srcset=&quot;/static/582713f0d3e3646517ce9b7b81d2448e/00d96/csr-work.png 148w,
/static/582713f0d3e3646517ce9b7b81d2448e/0b23c/csr-work.png 295w,
/static/582713f0d3e3646517ce9b7b81d2448e/799d3/csr-work.png 590w,
/static/582713f0d3e3646517ce9b7b81d2448e/2a3d6/csr-work.png 885w,
/static/582713f0d3e3646517ce9b7b81d2448e/ae92f/csr-work.png 1180w,
/static/582713f0d3e3646517ce9b7b81d2448e/01d6c/csr-work.png 3346w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;center&gt;常见的客户端渲染模式&lt;/center&gt;
&lt;p&gt;&lt;strong&gt;优势&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;丰富的页面交互&lt;/li&gt;
&lt;li&gt;初次加载后的快速渲染&lt;/li&gt;
&lt;li&gt;分块实时更新&lt;/li&gt;
&lt;li&gt;更有性价比的部署和扩展&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;劣势&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SEO 和索引问题&lt;/li&gt;
&lt;li&gt;bundle.js 加载时间问题&lt;/li&gt;
&lt;li&gt;旧的设备/慢的网络会有性能问题&lt;/li&gt;
&lt;li&gt;社交媒体爬虫和分享问题（SMO）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;什么是服务端渲染？（SSR）&lt;/h3&gt;
&lt;p&gt;页面加载时服务端返回渲染过的一个页面的整个 HTML。&lt;/p&gt;
&lt;p&gt;对于我们使用的 React 或其他任何 JavaScript 库/框架，服务端渲染是一种在服务器端渲染一个正常的客户端的单页面应用的技术，并返回一个完整的渲染过的页面到浏览器。&lt;/p&gt;
&lt;h4&gt;服务端渲染是如何工作的？&lt;/h4&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e30650c36ac88b6af3b705e5f566f2d1/ef11a/ssr-work.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 54.74626865671641%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACLElEQVQoz3WSz2sTQRTH8zd47aFUxR8prS0FT0Wl+ANp0IsgilUKKqggFg8Wf/Qilh48FE8WCh4UMYFKFVsL1jQmKmnSNknNpj+Smu7u7G6223HX3U3S3Z3sOJM9RA8Ow5s3X+bD9/He+PD/luvSUK1K/b1LPS1fz+xnLvlLNzsyt7t/DJ5cfXhKHOz0kRcAACbL6LpBcoTQ3zB2bO7c6bHmXUP+pplje6S+ttG7N4afjj5/8kgYOEThqanp61evRebCWYZJJBLlcrnO1txajSSVWJTr7mLbm4WeVi7Q9mzo/p3HwyMDl6VbdXhl7eeHideKxBuGqWmq63nW3T1/BHj44B7XsY/t2j15PjB+sXe67yjob/chF6fWFFuTGqXS083DrG5pXgmevpNMyFcuCAeatg63SCf8/NlW6gxLfFVYJknNskyYo7XApaQU9qxp8KqgLXDMd29B4DjfuRccOUhh17EseZ0kYk4v5vJQhRubHAtEVdWJSFoAikWB5yzLJldOgfFwlAuGjGiEwgVRCM7PL+TXDZmtyMWVbDL26dX3j6HCagbbpqOX3ivVlFbGVa1W3s4szH37ElyMzwKZp/AvQ48xy+F0CpkyNkRFzLHpN58jL1OFRfwbODAfquA0cdU5tL0h82khMzEz+yJbTFNYU1WwyUJF8brlINdxsGGjioP++TX1TTRW4+NC3EaYwpZlSaWSWR8vbsypgXgSbyBhC5JphtlJdYc6/QEEFSmC56mgFQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;ssr work&quot;
        title=&quot;ssr work&quot;
        src=&quot;/static/e30650c36ac88b6af3b705e5f566f2d1/799d3/ssr-work.png&quot;
        srcset=&quot;/static/e30650c36ac88b6af3b705e5f566f2d1/00d96/ssr-work.png 148w,
/static/e30650c36ac88b6af3b705e5f566f2d1/0b23c/ssr-work.png 295w,
/static/e30650c36ac88b6af3b705e5f566f2d1/799d3/ssr-work.png 590w,
/static/e30650c36ac88b6af3b705e5f566f2d1/2a3d6/ssr-work.png 885w,
/static/e30650c36ac88b6af3b705e5f566f2d1/ae92f/ssr-work.png 1180w,
/static/e30650c36ac88b6af3b705e5f566f2d1/ef11a/ssr-work.png 3350w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;center&gt;常见的服务端渲染模式&lt;/center&gt;
&lt;p&gt;&lt;strong&gt;优势&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SEO 一致性&lt;/li&gt;
&lt;li&gt;性能更优，初始化页面加载更快&lt;/li&gt;
&lt;li&gt;社交媒体爬虫和平台配合良好&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;劣势&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;频繁的请求&lt;/li&gt;
&lt;li&gt;很慢的页面渲染（TTFB — 获取第一个字节的时间）&lt;/li&gt;
&lt;li&gt;复杂的架构（为了统一的方式）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;谷歌是如何索引的？&lt;/h3&gt;
&lt;p&gt;我们之前提到了单页面应用存在 SEO 的问题。理解谷歌索引系统是如何通过服务端渲染解决此问题很重要，谷歌有两种索引的方式：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ddbd4e7ef2456bbc08128066fa5c81bf/690a9/google-indexing.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.074014481094125%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACoUlEQVQozyWS2VNSARTG7//T9GZjlpOmoKghoo4bCoq2Wj74YJk5ZdPUQw+NNZM4iYQWuCFXuAhBwqgXuEi4xKIsKpdFL5sg4NJluaGeOQ/ffHN+D2e+D+h0QOxteceOpmMbZm5qGWvaelhrDEcJgshks7nNCfVhkA5rmesIy6xnWZfbraoc0uWAgJxq/aMoGf5AHv1SJRTWQspqjakX2cEzF1huEnj6sc5WrdIXffxEGuVUCXh0qbDdrGaZFQBzXdNkWK4QiSjCOdrCb7rCUK+ykCXmedfRFczfDpEklrpfW2VCebkAvAfKauSLDONqm0kNtOi1T4zrA2bHwzU7VWWuVthokJ0idjZI0dh5xhdP0UB3JeisW3SwVlxM2N6hs7KRrSZY34zAQOPK2jPEOmTafa7f7VK72pX7lfN7VXOem3zv5N/kV1O8gO+tmPW0yNC3iP+Fzj1k3H9pdNaqTTkQoKs2+xDXK8Tdr/W+1h0yIB9Z6KMIsMLxUDcU7wSP7/BCpJ9YI3gwuBrohw8GdN5+vbt1yUpXbQC0RVsfjL43YG+0gT5NkA0FqVOhovHI9c8x0IZPbODXhmPFvEjNTKhLFuxWYmyFr0fjfaDeo8qsAHXBlXuvWeJvEGMMcZgNxorGjsnjyWlL5uQfnkimvpvSpdxk3ki0mBe+O4mVCvykaZQi2qVKXED5DFo25Sv9gZXwQ3mcaP5I/N3SOXZCEPGIVmZctQcIIoVGiUHl+W1O4ta3KHkyXC4IVEz7yTMo0CAKFnCDhWNH+Zx4j/TMgmUI4iLhU5czBc9KPRP7Uc9lZFmjN3NffHZj5LiQe3STG2hbCAI7odRTKPEIPFU60unM5VWWuOwVgUcMeMyUvXCyV5XB04TEluoUnfbKE2gs/R+XmNIBUpT2DAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;google indexing&quot;
        title=&quot;google indexing&quot;
        src=&quot;/static/ddbd4e7ef2456bbc08128066fa5c81bf/799d3/google-indexing.png&quot;
        srcset=&quot;/static/ddbd4e7ef2456bbc08128066fa5c81bf/00d96/google-indexing.png 148w,
/static/ddbd4e7ef2456bbc08128066fa5c81bf/0b23c/google-indexing.png 295w,
/static/ddbd4e7ef2456bbc08128066fa5c81bf/799d3/google-indexing.png 590w,
/static/ddbd4e7ef2456bbc08128066fa5c81bf/2a3d6/google-indexing.png 885w,
/static/ddbd4e7ef2456bbc08128066fa5c81bf/ae92f/google-indexing.png 1180w,
/static/ddbd4e7ef2456bbc08128066fa5c81bf/690a9/google-indexing.png 2486w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;如何实现 SSR？&lt;/h3&gt;
&lt;p&gt;让我们来看一下 React 如何实现服务端渲染。&lt;/p&gt;
&lt;h4&gt;方法&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;服务端初始化渲染&lt;/li&gt;
&lt;li&gt;展示全内容 HTML&lt;/li&gt;
&lt;li&gt;JS 执行&lt;/li&gt;
&lt;li&gt;React 接管/重渲染&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;挑战&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Node.js 中使用 JSX&lt;/li&gt;
&lt;li&gt;服务端使用 Redux&lt;/li&gt;
&lt;li&gt;路由&lt;/li&gt;
&lt;li&gt;补水&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;补水&lt;/strong&gt;
在客户端启动 JavaScript 来复用服务端渲染的 HTML 的 DOM 树和数据。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/11eb8e76dccb3e54fb2c633f98fbb424/7b49a/react-rehydration.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 33.73349339735894%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABRUlEQVQY001QWU7DMBTMITkFN+AAHIFvfjgBEqgflC5URUUUlYpIUBqcpHHdNEsTp46deAkvpUgdjS15mXnzntX8w5h255W+uPbPr5wkr+GotTmFVBoubx6js8uv7iyzXC9IyVuKbiPnjpEuLxPbpVOnPNi10Fr9UyqlwBBHfPSR5UxaYFbmfpm8s9iWpRe6GL0unBcbTebhp8uY0H+RTgDl0wIiGCuO47YIGEqWkcl20VnbffS9oSQq4oLtUB70cvxE16MsGIr4eTlzO6PhFC1AZTHGjj1LSnF/Twb7ZB5RdTBsJAtS/2HrdtNVbxcMqnS8nHn34+EcO60Ylqh4UVImOJeGVdCb0SXXQqiCaiYaAT90A+Pj2gjTGAUhTaWO4nyf4XC1ifBqg8IYm/ZZA2tCKt8TLmqJfoSzrMnagHldm3ZyzS+6/4aRUXq/rQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;react rehydration&quot;
        title=&quot;react rehydration&quot;
        src=&quot;/static/11eb8e76dccb3e54fb2c633f98fbb424/799d3/react-rehydration.png&quot;
        srcset=&quot;/static/11eb8e76dccb3e54fb2c633f98fbb424/00d96/react-rehydration.png 148w,
/static/11eb8e76dccb3e54fb2c633f98fbb424/0b23c/react-rehydration.png 295w,
/static/11eb8e76dccb3e54fb2c633f98fbb424/799d3/react-rehydration.png 590w,
/static/11eb8e76dccb3e54fb2c633f98fbb424/2a3d6/react-rehydration.png 885w,
/static/11eb8e76dccb3e54fb2c633f98fbb424/ae92f/react-rehydration.png 1180w,
/static/11eb8e76dccb3e54fb2c633f98fbb424/7b49a/react-rehydration.png 1666w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;总结&lt;/h3&gt;
&lt;p&gt;服务端渲染并不是魔法，需要根据商业逻辑来决定要不要采用。&lt;/p&gt;
&lt;h4&gt;什么时候使用单页面应用？&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;网站丰富的交互&lt;/li&gt;
&lt;li&gt;网络很快&lt;/li&gt;
&lt;li&gt;最小服务端资源&lt;/li&gt;
&lt;li&gt;主代码量比较小或采用懒加载&lt;/li&gt;
&lt;li&gt;实时/分部更新&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;什么时候使用服务端渲染？&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;SEO 很重要&lt;/li&gt;
&lt;li&gt;网络比较慢&lt;/li&gt;
&lt;li&gt;足够的服务器资源&lt;/li&gt;
&lt;li&gt;主代码庞大，加载慢&lt;/li&gt;
&lt;li&gt;社交分享比较重要&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;更多&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.google.com/web/updates/2019/02/rendering-on-the-web&quot;&gt;Rendering on the Web | Web | Google Developers&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://medium.com/dev-channel/a-netflix-web-performance-case-study-c0bcde26a9d9&quot;&gt;A Netflix Web Performance Case Study&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/brillout/awesome-universal-rendering&quot;&gt;awesome universal rendering&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://itnext.io/server-side-rendering-with-react-redux-and-react-router-fa5b67d4965e?_branch_match_id=755024804793509077&amp;#x26;gi=cd56fb5a4621&quot;&gt;https://itnext.io/server-side-rendering-with-react-redux-and-react-router-fa5b67d4965e?_branch_match_id=755024804793509077&amp;#x26;gi=cd56fb5a4621&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 可视化之迭代器和迭代函数]]></title><description><![CDATA[generator 函数不同于通常的函数，运行就结束。我们可以任意暂停函数的执行，并在合适时机输出。 通过在  关键字后面添加  创建 generator 函数。 generator 函数与普通函数实际上工作方式完全不同： 调用 generator…]]></description><link>https://www.keisei.top/javascript-visualized-generator-function/</link><guid isPermaLink="false">https://www.keisei.top/javascript-visualized-generator-function/</guid><pubDate>Wed, 05 Feb 2020 18:08:00 GMT</pubDate><content:encoded>&lt;p&gt;generator 函数不同于通常的函数，运行就结束。我们可以任意暂停函数的执行，并在合适时机输出。&lt;/p&gt;
&lt;p&gt;通过在 &lt;code class=&quot;language-text&quot;&gt;function&lt;/code&gt; 关键字后面添加 &lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt; 创建 generator 函数。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// function *generatorFunction() {} 这样也是可以的&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;generatorFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;generator 函数与普通函数实际上工作方式完全不同：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调用 generator 函数返回&lt;strong&gt;生成器对象&lt;/strong&gt;，实际上是一个迭代器&lt;/li&gt;
&lt;li&gt;我们可以使用 &lt;code class=&quot;language-text&quot;&gt;yield&lt;/code&gt; 关键字来“暂停”执行&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/1177388af025abcd4fd2cd7c5ce49089/generator-return-value.gif&quot; alt=&quot;generator return value&quot;&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;genFunc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;yield&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;:sparkles:&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;First log!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;yield&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;:two_hearts:&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Second log!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Done!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当遇到 &lt;code class=&quot;language-text&quot;&gt;yield&lt;/code&gt; 关键字时，generator 函数的执行会暂停。下次我们再运行该函数时，它会记住上次暂停的位置，并从该位置开始执行：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;第一次执行，它在第一行暂停，并 &lt;em&gt;产出&lt;/em&gt; 字符串:sparkles:&lt;/li&gt;
&lt;li&gt;第二次执行，从上一个 &lt;code class=&quot;language-text&quot;&gt;yield&lt;/code&gt; 关键字的行开始，直到遇到第二个 &lt;code class=&quot;language-text&quot;&gt;yield&lt;/code&gt; 关键字并 &lt;em&gt;产出&lt;/em&gt; :two_hearts:&lt;/li&gt;
&lt;li&gt;第三次执行，从上一个 &lt;code class=&quot;language-text&quot;&gt;yield&lt;/code&gt; 关键字的行开始，直到遇到 &lt;code class=&quot;language-text&quot;&gt;return&lt;/code&gt; 关键字，并 &lt;em&gt;返回&lt;/em&gt; &lt;code class=&quot;language-text&quot;&gt;Done!&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;当调用 generator 函数返回了生成器对象，我们下次该如何调用呢？生成器对象在原型链上拥有一个 &lt;code class=&quot;language-text&quot;&gt;next&lt;/code&gt; 方法，这个方法是用来迭代生成器对象的。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/4065f02ab5025440562a201eb9746d8b/set-variable-to-generator-object.gif&quot; alt=&quot;set variable to generator object&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/580c5d114dac318beb7b5f478a358dc4/call-next.gif&quot; alt=&quot;call next&quot;&gt;&lt;/p&gt;
&lt;p&gt;调用 &lt;code class=&quot;language-text&quot;&gt;next&lt;/code&gt; 方法返回值为一个对象，包含 &lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt; 属性和 &lt;code class=&quot;language-text&quot;&gt;done&lt;/code&gt; 属性，&lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt; 的值就产出的值，&lt;code class=&quot;language-text&quot;&gt;done&lt;/code&gt; 是一个布尔值，只有遇到 &lt;em&gt;return&lt;/em&gt; 时才会置为 &lt;code class=&quot;language-text&quot;&gt;true&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/45a46b8c570a3280f6f8403015ceb9dd/invoke.gif&quot; alt=&quot;invoke all next&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ef914d69af50f342e1ee3cce50cbb2a8/invoke-after-done.gif&quot; alt=&quot;invoke after done&quot;&gt;&lt;/p&gt;
&lt;p&gt;当 &lt;code class=&quot;language-text&quot;&gt;done&lt;/code&gt; 为 &lt;code class=&quot;language-text&quot;&gt;true&lt;/code&gt; 时，再次调用 next()，返回的 &lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt; 会永远为 &lt;code class=&quot;language-text&quot;&gt;undefined&lt;/code&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;那什么是迭代器呢？它可以在 &lt;code class=&quot;language-text&quot;&gt;for ... of&lt;/code&gt; 循环和扩展运算符中使用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/65b9e5b7297b53f9902558d82017b99c/spread-operator.gif&quot; alt=&quot;spread operator&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/d8af13fef372e0a5511d913bddb6906b/for-of-loop.gif&quot; alt=&quot;for of loop&quot;&gt;&lt;/p&gt;
&lt;p&gt;为什么迭代器如 array，string，map 和 set 可以迭代呢？实际上它们都实现了 &lt;em&gt;迭代器协议&lt;/em&gt; ：&lt;code class=&quot;language-text&quot;&gt;[Symbol.iterator]&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f6b34ef4b42b6cf56085ee7fde6b3c7d/50fa5/iterator-code.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 84.43181818181817%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAC7UlEQVQ4y62Ty27TQBSGB6dpGyc0QkgISqvY47l4bMfx3YmTNOLaghAIBAhY8Qaw4iF4DV6ALcqGBRKqBOIloCxAQiwBV4djt0IFRGGBpU/Hkyif/98zIQSv7vEucR1G7uZTci1Pyc1Nj2wUfXLl6jly+3pOJrOQPNq6RzanQ3LtzpjcuHWBpFlA4sQjWT4gXl+QU6snSH2trp0k/+ti3CDk4YP79UII87GU9AXyTNrmXEhzLm06txWdV2tHsbm9v7aVVX+PPEOeI09WV0+0D8qXJTfeTF0PElfAMKKQhhLCyINgwMDFzwp3AMrlMIg5+AMblMMAxeC4DLgwPh871l0/KGxzbrzMlA0Dxb7EvlnGPi0dl5f+gJdhKMoBzjiR9X0YiRKTlpjsK7aohO9Wuh3jV+F2rlQlLCPfhMSn4HkCvD6DKBKAIkhTG1MLiGOJ6WiVcLdKicL33e7R3k9CgcKRciB0WDmODQg8E9y+A36CNYd71fLchiSROBVKRVX9ECGrhAoyibUUg2FoQh7QemYBEnJM59bvDTepBiv/WciEsT12XTgvvTK1BUxHAmaFDbOxDRs4x5huY+oDvke4OPGg71WbcYhQ2HRb+QKo7JUWPp1yWmOJPSg3Ac9ZlQqEsHBSEPYhQs5622PbgUIqTCihiClMEgqjqJpWPYsENyTp4/u06k35a+XCc+GsdMsEKxd5VduGCXJm6sBsomCEtUcjF4ZDBUEg/lJZ0peqj5VF75uFT7b4Hkzs3zMD6e0y3ttFQQ0mLPfP4c5vQvynvN5wPMjx7M0yCuPYqqueySzcZQpRFkA6G0E8ySCZ5vWMihTSUQxKWR/bHf2ng60bxumnnPY+Mbr+VvD1Hcb24IhlIdzYYdKs5wHeIR9Mc+2V3m6tHRQ2kQC5jGwhl/6Rrf3fDKtQP2yNxQWy1Gwe6SwsafpiU+vqDa2zvIA0tJVWQ9OXGlqrrWv6ylGt1Wn/YLmN6K3GYrOpLS41a9d3t71D+on6Rp8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;iterator code&quot;
        title=&quot;iterator code&quot;
        src=&quot;/static/f6b34ef4b42b6cf56085ee7fde6b3c7d/799d3/iterator-code.png&quot;
        srcset=&quot;/static/f6b34ef4b42b6cf56085ee7fde6b3c7d/00d96/iterator-code.png 148w,
/static/f6b34ef4b42b6cf56085ee7fde6b3c7d/0b23c/iterator-code.png 295w,
/static/f6b34ef4b42b6cf56085ee7fde6b3c7d/799d3/iterator-code.png 590w,
/static/f6b34ef4b42b6cf56085ee7fde6b3c7d/50fa5/iterator-code.png 880w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/b6cdf7f555289198eea3ace785453216/symbol-iterator.gif&quot; alt=&quot;symbol iterator&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ea60169eb55a3b1f98e666686f12ad16/pass-value-to-next.gif&quot; alt=&quot;pass value to next&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;生成器一个最大的优势是它们可以&lt;strong&gt;惰性求值&lt;/strong&gt;。这意味着每次调用 &lt;code class=&quot;language-text&quot;&gt;next&lt;/code&gt; 方法才返回值，只在我们需要是才会计算。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/24a2874bfb25cfa43e733bf10705972c/lazy-evaluated.gif&quot; alt=&quot;lazy evaluated&quot;&gt;&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://dev.to/lydiahallie/javascript-visualized-generators-and-iterators-e36&quot;&gt;https://dev.to/lydiahallie/javascript-visualized-generators-and-iterators-e36&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 可视化之原型继承]]></title><description><![CDATA[当我们对字符串，数组或对象使用内置的方法或属性如 ，， 等时，这是通过 原型继承（prototypal inheritance…]]></description><link>https://www.keisei.top/javascript-visualized-prototypal-inheritance/</link><guid isPermaLink="false">https://www.keisei.top/javascript-visualized-prototypal-inheritance/</guid><pubDate>Tue, 04 Feb 2020 17:24:00 GMT</pubDate><content:encoded>&lt;p&gt;当我们对字符串，数组或对象使用内置的方法或属性如 &lt;code class=&quot;language-text&quot;&gt;.length&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;.split()&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;.join()&lt;/code&gt; 等时，这是通过 &lt;em&gt;原型继承（prototypal inheritance）&lt;/em&gt; 的方式使得我们可以直接调用。&lt;/p&gt;
&lt;p&gt;我们经常创建相同类型的多个对象。比方说我们有一个展示宠物狗的网站。对于每个宠物狗，我们需要对应的对象来表示。我们可以通过使用 &lt;code class=&quot;language-text&quot;&gt;new&lt;/code&gt; 关键字调用构造函数来创建 Dog&lt;strong&gt;实例&lt;/strong&gt;。每个 Dog 都有一个 name，breed，color 和 bark 方法。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Dog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; breed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; color&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;breed &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; breed&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;color &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; color&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;bark&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Woof!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当我们创建 &lt;code class=&quot;language-text&quot;&gt;Dog&lt;/code&gt; 这个构造函数时，它并不是唯一被创建的。相应的，还自动创建了另一个称为 &lt;em&gt;prototype&lt;/em&gt; 的对象。默认情况下，该对象有一个 &lt;em&gt;constructor&lt;/em&gt; 属性，是指向原始构造函数的引用，本例中指向 &lt;code class=&quot;language-text&quot;&gt;Dog&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/c8d9b09d05571666ee6a6f4cef2e922b/prototype.gif&quot; alt=&quot;prototype&quot;&gt;&lt;/p&gt;
&lt;p&gt;在 Dog 构造函数上的 &lt;code class=&quot;language-text&quot;&gt;prototype&lt;/code&gt; 属性不可枚举。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dog1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Dog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Daisy&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Labrador&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;black&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dog2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Dog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Jack&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Jack Russell&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;white&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/326b8a39c1c51ae43434c03c1b1c90d7/dogs.gif&quot; alt=&quot;dogs&quot;&gt;&lt;/p&gt;
&lt;p&gt;我们看到除了 &lt;code class=&quot;language-text&quot;&gt;name&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;breed&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;color&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;bark&lt;/code&gt; 之外还有一个 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 属性，它也是不可枚举的，就是说我们访问对象时它通常不可见。我们来展开一下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/82b6553647f5b61f495cbd5bccc27d65/expand-proto.gif&quot; alt=&quot;expand __proto__&quot;&gt;&lt;/p&gt;
&lt;p&gt;可以看到 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 实际上是 &lt;code class=&quot;language-text&quot;&gt;Dog.prototype&lt;/code&gt; 对象的引用。这就是&lt;strong&gt;原型继承&lt;/strong&gt;：每个构造函数的实例都能够访问构造函数的原型。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7eb31f1b0fa07f0750193bc91b0ec955/access-prototype.gif&quot; alt=&quot;access prototype&quot;&gt;&lt;/p&gt;
&lt;p&gt;每个 Dog 都有 &lt;code class=&quot;language-text&quot;&gt;bark&lt;/code&gt; 方法，为了节省每创建一个实例时都要添加该方法消耗的内存，我们可以把它添加到 &lt;code class=&quot;language-text&quot;&gt;Dog.prototype&lt;/code&gt; 对象上。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/855d89c52be7cf25ece8806b99285807/add-method-to-prototype.gif&quot; alt=&quot;add method to prototype&quot;&gt;&lt;/p&gt;
&lt;p&gt;当我们在实例上访问属性时，引擎会先在当前实例上查找，如果没有找到，引擎会继续通过 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 属性向上层原型链来查找。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ad44fc3457e5ae5ded069e95211f87d6/walk-prototype-chain.gif&quot; alt=&quot;walk prototype chain&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Dog.prototype&lt;/code&gt; 本身也是一个对象，就是说它本身是 &lt;code class=&quot;language-text&quot;&gt;Object&lt;/code&gt; 构造函数的实例，&lt;code class=&quot;language-text&quot;&gt;Dog.prototype&lt;/code&gt; 上也有 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 属性，它是指向 &lt;code class=&quot;language-text&quot;&gt;Object.prototype&lt;/code&gt; 的引用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/3b9b9be213a84a782b86db1563b5c0b8/object-prototype.gif&quot; alt=&quot;object prototype&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在我们知道了所有内置的方法都是来自原型链。&lt;/p&gt;
&lt;p&gt;例如 &lt;code class=&quot;language-text&quot;&gt;.toString()&lt;/code&gt; 方法，它不是定义在 &lt;code class=&quot;language-text&quot;&gt;dog1&lt;/code&gt; 上，也不在 &lt;code class=&quot;language-text&quot;&gt;dog1.__proto__&lt;/code&gt; 指向的 &lt;code class=&quot;language-text&quot;&gt;Dog.prototype&lt;/code&gt; 上，而是在 &lt;code class=&quot;language-text&quot;&gt;Dog.prototype.__proto__&lt;/code&gt; 对象指向的 &lt;code class=&quot;language-text&quot;&gt;Object.prototype&lt;/code&gt; 上。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/26b6a24098e77270a2e33620ccd6faeb/toString.gif&quot; alt=&quot;toString&quot;&gt;&lt;/p&gt;
&lt;p&gt;目前为止我们使用的构造函数（&lt;code class=&quot;language-text&quot;&gt;function Dog() { ... }&lt;/code&gt;）都是基本的 JavaScript 语法。ES6 引入了新的语法来创建构造函数：class。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Class 只是构造函数的语法糖。底层还是原型链的方式工作。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们通过 &lt;code class=&quot;language-text&quot;&gt;class&lt;/code&gt; 关键字创建 classes，每个 class 都有一个 &lt;code class=&quot;language-text&quot;&gt;constructor&lt;/code&gt; 函数，就像之前 ES5 的语法，添加到原型上的属性可以直接在 classes 体上定义。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/1d5044ec9cce2b71a8b1f2055625a015/define-class.gif&quot; alt=&quot;define class&quot;&gt;&lt;/p&gt;
&lt;p&gt;classes 另一个好处是可以方便&lt;strong&gt;继承&lt;/strong&gt;其他 classes。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Dog&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;bark&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Woof!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Chihuahua&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Dog&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;smallBark&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Small woof!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; myPet &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Chihuahua&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Max&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;myPet&lt;/code&gt; 能够访问 &lt;code class=&quot;language-text&quot;&gt;Chihuahua.prototype&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;Dog.prototype&lt;/code&gt; 对象（还有 &lt;code class=&quot;language-text&quot;&gt;Object.prototype&lt;/code&gt;）。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/1b6a2e893231c26368af1408bdad882f/extend-class.gif&quot; alt=&quot;extend class&quot;&gt;&lt;/p&gt;
&lt;p&gt;原型链也是有尽头的， &lt;code class=&quot;language-text&quot;&gt;Object.prototype.__proto__&lt;/code&gt; 的值为 &lt;code class=&quot;language-text&quot;&gt;null&lt;/code&gt;。当我们尝试访问未出现在原型链上的属性时，返回 &lt;code class=&quot;language-text&quot;&gt;undefined&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/8d77f5dbb379a26f9029b09b8019c9e1/access-property.gif&quot; alt=&quot;access property&quot;&gt;&lt;/p&gt;
&lt;p&gt;我们还可以通过 &lt;code class=&quot;language-text&quot;&gt;Object.create&lt;/code&gt; 方法创建对象，通过传入对象参数，返回的对象的原型指向传入的参数。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; person &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  name&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Lydia&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  age&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; me &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;person&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;通过控制台来看：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/a45109c2949ffc03caec6a615c717c36/object-create.gif&quot; alt=&quot;object create&quot;&gt;&lt;/p&gt;
&lt;p&gt;我们没有向 &lt;code class=&quot;language-text&quot;&gt;me&lt;/code&gt; 对象上添加任何属性，它只有一个 &lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 属性，&lt;code class=&quot;language-text&quot;&gt;__proto__&lt;/code&gt; 属性指向了我们定义作为原型的对象：&lt;code class=&quot;language-text&quot;&gt;person&lt;/code&gt;，它有 &lt;code class=&quot;language-text&quot;&gt;name&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;age&lt;/code&gt; 属性。&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://dev.to/lydiahallie/javascript-visualized-prototypal-inheritance-47co&quot;&gt;https://dev.to/lydiahallie/javascript-visualized-prototypal-inheritance-47co&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 可视化之执行引擎]]></title><description><![CDATA[作为 JavaScript 开发人员，我们有必要了解关于 JavaScript 引擎的基础，它是如何将 JS 代码编译成机器码的。以下内容会以 V8 引擎为主。 HTML 解析器当遇到  标签时，源代码会从该 source 路径从网络，缓存或者安装的 service worker…]]></description><link>https://www.keisei.top/javascript-visualized-engine/</link><guid isPermaLink="false">https://www.keisei.top/javascript-visualized-engine/</guid><pubDate>Mon, 03 Feb 2020 16:24:00 GMT</pubDate><content:encoded>&lt;p&gt;作为 JavaScript 开发人员，我们有必要了解关于 JavaScript 引擎的基础，它是如何将 JS 代码编译成机器码的。以下内容会以 V8 引擎为主。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;HTML 解析器当遇到 &lt;code class=&quot;language-text&quot;&gt;script&lt;/code&gt; 标签时，源代码会从该 source 路径从&lt;strong&gt;网络&lt;/strong&gt;，&lt;strong&gt;缓存&lt;/strong&gt;或者安装的 &lt;strong&gt;service worker&lt;/strong&gt; 中获取。响应的内容为字节流，将由字节流解码器接管，在下载时就开始进行解码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/9559723c6e73715f10c226f30dc2278c/decoder.gif&quot; alt=&quot;byte stream decoder&quot;&gt;&lt;/p&gt;
&lt;p&gt;解码器根据解码的字节生成&lt;strong&gt;令牌（tokens）&lt;/strong&gt;。例如，&lt;code class=&quot;language-text&quot;&gt;0066&lt;/code&gt; 解码为 &lt;code class=&quot;language-text&quot;&gt;f&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;0075&lt;/code&gt; 解码为 &lt;code class=&quot;language-text&quot;&gt;u&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;006e&lt;/code&gt; 解码为 &lt;code class=&quot;language-text&quot;&gt;n&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;0063&lt;/code&gt; 解码为 &lt;code class=&quot;language-text&quot;&gt;c&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;0074&lt;/code&gt; 解码为 &lt;code class=&quot;language-text&quot;&gt;t&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;0069&lt;/code&gt; 解码为 &lt;code class=&quot;language-text&quot;&gt;i&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;006f&lt;/code&gt; 解码为 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;006e&lt;/code&gt; 解码为 &lt;code class=&quot;language-text&quot;&gt;n&lt;/code&gt; 并附带一个空格。就像编写的 &lt;code class=&quot;language-text&quot;&gt;function&lt;/code&gt;，这是一个保留的关键字，口令生成后会被发送至解析器（还有预解析器，将在后面解释）。其余的字节流也如此解码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/6ec45a27a67c0b8f71e6bfb5ed200983/parser.gif&quot; alt=&quot;parser&quot;&gt;&lt;/p&gt;
&lt;p&gt;引擎使用两种解析器：预解析器和解析器。为了减少加载网站的时间，引擎尽量避免立即解析非必要的代码。预解析器处理将来可能用到的代码，解析器处理当前用到的代码。如果一个函数只在用户点击按钮后调用，那么在网站加载时就不需要立即去编译这部分代码。如果用户最终按下按钮并请求该段代码，它会被发送至解析器。&lt;/p&gt;
&lt;p&gt;解析器基于从字节流解码器接受的令牌来创建节点。通过这些节点来创建抽象语法树（Abstract Syntax Tree）。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/c64416782ca3527cc76e649ee1aef0aa/ast.gif&quot; alt=&quot;ast&quot;&gt;&lt;/p&gt;
&lt;p&gt;下一步是&lt;strong&gt;解释器（interpreter）&lt;/strong&gt;的工作。解释器遍历 AST 并基于 AST 包含的信息生成&lt;strong&gt;字节码&lt;/strong&gt;。一旦字节码完全生成，AST 会被删除，在内存中释放。最终我们得到了机器可运行的代码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/9cf8dc84f7da8e0b8bb711e9b154e0a2/interpreter.gif&quot; alt=&quot;interpreter&quot;&gt;&lt;/p&gt;
&lt;p&gt;尽管机器码很快，但它还可以更快。在机器码运行时，某些信息也会随之生成。引擎可以检测出哪些行为是经常发生的，哪些数据类型被使用。可能有一个函数被调用了很多次，那么引擎就可以对此进行优化使其执行更快。&lt;/p&gt;
&lt;p&gt;机器码和生成的类型反馈信息会被发送至&lt;strong&gt;优化编译器（optimizing compiler）&lt;/strong&gt;。该编译器根据这些数据生成高度优化过的机器码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2d949e8d01fa4c41b259210bcd5b349d/optimizing-compiler.gif&quot; alt=&quot;optimizing compiler&quot;&gt;&lt;/p&gt;
&lt;p&gt;JavaScript 是一种动态类型语言，意味着数据的类型可以不断变化。如果 JavaScript 引擎每次都要检查某个值的数据类型无疑是非常低效的。&lt;/p&gt;
&lt;p&gt;为了减少解释代码的时间，优化过的机器码只处理引擎之前遇到的运行的字节码的情况。如果我们重复使用那段代码并返回相同的数据类型，优化过的机器码可以直接重复使用来加快运行。然而，当同一段代码返回了不同类型的数据，机器码未优化，引擎只能回退到解释生成的字节码的阶段。&lt;/p&gt;
&lt;p&gt;例如下面的 sum 函数，它每次调用接收数字类型的参数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;结果返回了 &lt;code class=&quot;language-text&quot;&gt;3&lt;/code&gt;，下次我们调用，它会假设我们仍然传入两个数字的值。&lt;/p&gt;
&lt;p&gt;如果是这样的，不需要动态检索，引擎可以直接使用优化过的机器码。否则，如果假设是错误的，它会回退到最初的字节码而不是优化过的机器码。&lt;/p&gt;
&lt;p&gt;例如，下次我们调用时传入了一个字符串参数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;1&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这会使数字 &lt;code class=&quot;language-text&quot;&gt;2&lt;/code&gt; 强制转换成字符串，函数最终会返回字符串 &lt;code class=&quot;language-text&quot;&gt;&amp;quot;12&amp;quot;&lt;/code&gt;。引擎会执行解释过的字节码并更新类型反馈。&lt;/p&gt;
&lt;h3&gt;相关推荐&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://v8.dev/&quot;&gt;V8 文档&lt;/a&gt; | &lt;a href=&quot;https://github.com/v8/v8&quot;&gt;V8 Github&lt;/a&gt; | &lt;a href=&quot;https://www.youtube.com/watch?v=voDhHPNMEzg&amp;#x26;t=729s%3Cbr%3E%0A&quot;&gt;Chrome University 2018: Life Of A Script&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://dev.to/lydiahallie/javascript-visualized-the-javascript-engine-4cdf&quot;&gt;https://dev.to/lydiahallie/javascript-visualized-the-javascript-engine-4cdf&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 可视化之作用域链]]></title><description><![CDATA[本文假设读者已了解执行上下文的基本概念。 我们首先来看以下代码： 我们调用  函数时，返回了一串包含 ,  和  变量的字符串：。但是  函数内并没有声明变量 `city，它是怎么得到的呢？ JavaScript…]]></description><link>https://www.keisei.top/javascript-visualized-scope/</link><guid isPermaLink="false">https://www.keisei.top/javascript-visualized-scope/</guid><pubDate>Sat, 01 Feb 2020 15:02:00 GMT</pubDate><content:encoded>&lt;p&gt;本文假设读者已了解执行上下文的基本概念。&lt;/p&gt;
&lt;p&gt;我们首先来看以下代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Lydia&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; age &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; city &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;San Francisco&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getPersonInfo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Sarah&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; age &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;name&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; is &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;age&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; and lives in &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;city&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getPersonInfo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们调用 &lt;code class=&quot;language-text&quot;&gt;getPersonInfo&lt;/code&gt; 函数时，返回了一串包含 &lt;code class=&quot;language-text&quot;&gt;name&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;age&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;city&lt;/code&gt; 变量的字符串：&lt;code class=&quot;language-text&quot;&gt;Sarah is 22 and lives in San Francisco&lt;/code&gt;。但是 &lt;code class=&quot;language-text&quot;&gt;getPersonInfo&lt;/code&gt; 函数内并没有声明变量 `city，它是怎么得到的呢？&lt;/p&gt;
&lt;p&gt;JavaScript 引擎为不同上下文设置了内存空间。我们有默认的&lt;strong&gt;全局上下文&lt;/strong&gt;（浏览器中为&lt;code class=&quot;language-text&quot;&gt;window&lt;/code&gt;，Node 中为&lt;code class=&quot;language-text&quot;&gt;global&lt;/code&gt;），调用 &lt;code class=&quot;language-text&quot;&gt;getPersonInfo&lt;/code&gt; 函数的&lt;strong&gt;本地上下文&lt;/strong&gt;。每个上下文都有一个作用域链。&lt;/p&gt;
&lt;p&gt;对于 &lt;code class=&quot;language-text&quot;&gt;getPersonInfo&lt;/code&gt; 函数，作用域链看起来如下：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5203582e886807af3efd51e6a77e96c3/50fa5/scope-chain.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.79545454545455%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABLElEQVQoz42Ri07DMAxF9w2D5t02Sds8ljZ9t2OTBv//VZhJHQwmwLIi+crHlm92+H9BKWdcMMYxJjdx9yeGEOKcnE/D62V9uyzOqCRBj2CECPqYTDBJAAIBY2i1lYyNsdY4U4SDusobDG2MMd/UzdCHto3joLWKwXWNH+LBFHocmja6eV5irOug72CgKWPSmVRJIWVaVdYV0arj1J+X4TjUzpbWpN5K72ShBUL4HuacK/W83ydPT0SItqtLlY3zOi/rae7TVJiq6GBt7cmnX9vNhFJYKGAsZFVmuQhlGn3Zeh2droOZJ/+ydsclBi8R+mEY8PAdkIRRKOGhBBGcgHl9F5wrQ4hFUX437Kvb19yqzW2txNT7aWzBUIAfbP4l4M48Y3lGZc7gz2/6O3fBRhm5VzQdAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;scope chain&quot;
        title=&quot;scope chain&quot;
        src=&quot;/static/5203582e886807af3efd51e6a77e96c3/799d3/scope-chain.png&quot;
        srcset=&quot;/static/5203582e886807af3efd51e6a77e96c3/00d96/scope-chain.png 148w,
/static/5203582e886807af3efd51e6a77e96c3/0b23c/scope-chain.png 295w,
/static/5203582e886807af3efd51e6a77e96c3/799d3/scope-chain.png 590w,
/static/5203582e886807af3efd51e6a77e96c3/50fa5/scope-chain.png 880w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;作用域链本质上来说是对对象的引用链，这些对象包含对该执行上下文中可引用的值（和其他作用域）的引用。作用域链在执行上下文创建时一同创建，就是说是在运行时创建的。&lt;/p&gt;
&lt;p&gt;在本文中对活动对象（activation object）、执行上下文不做过多描述，只来聚焦于作用域。在下面的例子中，执行上下文中的键值对代表作用域链对变量的引用。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8f8046c3c8f6c9b56e293ff404c6a560/50fa5/scope-reference.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.81818181818182%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABeElEQVQoz6WR227kIAyG5xmaNhwSSIBwMAkQkp3ZqlKlvv9T1cx0dvd+yYdlm/w2whfS95wxIcSInxCcc8xQxghFKNr+bv+Ed0tJ+4FecC8RtrrHkrdadQh4wIdB6Uk3pDGTUnJWUmlkQotJMYkmpuPoIrjFyVkap/gkuRRsYL8hfp3hdk3X25ayW1cbYHkA0WKVnpALE+MSvHcoFrMW0iiGYs5qdEdytfha3FlDKR7APIhxmbVsYuyMYoCweO2Cma3Bctj5jP5ji5+/3McVbid4PPfGB+O9Rr02TzHe5Mxxz+HcAcCScUBxie59bdcuR07Zpx1ydlty6Ocd9KMzF8LZOQKoRSkrrZ2wMx94KZCTL0csdd2PtR5rTjYhKC7w0xmn5INeg8ES3k7oY4YyGjNse8wVUs3bvq1bsE41rHIOX180Mb74OE9CNaSe0Mch42y719eu616edBhhBnlrvBFynzOu/u9Cn9wPHtCn0yD/0EJyGf5jfQMR+VPrNgjn1AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;scope chain reference&quot;
        title=&quot;scope chain reference&quot;
        src=&quot;/static/8f8046c3c8f6c9b56e293ff404c6a560/799d3/scope-reference.png&quot;
        srcset=&quot;/static/8f8046c3c8f6c9b56e293ff404c6a560/00d96/scope-reference.png 148w,
/static/8f8046c3c8f6c9b56e293ff404c6a560/0b23c/scope-reference.png 295w,
/static/8f8046c3c8f6c9b56e293ff404c6a560/799d3/scope-reference.png 590w,
/static/8f8046c3c8f6c9b56e293ff404c6a560/50fa5/scope-reference.png 880w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;全局执行上下文中的作用域链中有 3 个变量的引用：&lt;code class=&quot;language-text&quot;&gt;name: Lydia&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;age: 21&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;city: San Francisco&lt;/code&gt;。在本地上下文中，我们有两个变量的引用：&lt;code class=&quot;language-text&quot;&gt;name: Sarah&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;age: 22&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;当我们在 &lt;code class=&quot;language-text&quot;&gt;getPersonInfo&lt;/code&gt; 函数中访问这些变量时，引擎会首先去检查本地作用域链。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/e36484bd93fc66d04d92102d8ec603c8/local-scope-chain.gif&quot; alt=&quot;local scope chain&quot;&gt;&lt;/p&gt;
&lt;p&gt;在本地作用域链中只找到了 &lt;code class=&quot;language-text&quot;&gt;name&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;age&lt;/code&gt;，那么 &lt;code class=&quot;language-text&quot;&gt;city&lt;/code&gt; 应该去哪获取呢？实际上 JavaScript 引擎如果在当前作用域找不到，会跳到上层作用域直至找到或者返回 &lt;code class=&quot;language-text&quot;&gt;ReferenceError&lt;/code&gt;，本例中在全局对象中找到了 &lt;code class=&quot;language-text&quot;&gt;city&lt;/code&gt; 变量。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/979cf578f16964dd453d3089610c71d1/global-scope.gif&quot; alt=&quot;global scope&quot;&gt;&lt;/p&gt;
&lt;p&gt;在全局上下文中，我们声明了值为 &lt;code class=&quot;language-text&quot;&gt;San Francisco&lt;/code&gt; 的 &lt;code class=&quot;language-text&quot;&gt;city&lt;/code&gt; 变量，&lt;code class=&quot;language-text&quot;&gt;getPersonInfo&lt;/code&gt; 函数得以找到该变量。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;我们可以向外层作用域链但不能向内部去寻找。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/00db91f9265a1e17b41708f56f97a627/50fa5/down-scope.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 42.38636363636364%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABB0lEQVQY031R0W7CMAzsR9DGdpLGTtICAjoGaOP/v2xHyiZ4mXWxrORsny6dQwwD0Pf90Ar3FkTOCbsgBDA1+u9bh8MxeDOdZm+Zx/jXByq7Xmjw/GgD1hGYRWszMcdiKfrb90ctCTWJQAKoyy7fb0vNaWjbgL7dp8BlFCLqHEuuWiN9ng9TkmlW3IDJItv97njc3a+LgQrxrc00zts51yoiHfakajnyFnlkm8wxs7Bo2i+nw7KoasmmY1DIQmWWS4mmwbSDfFH1pqIjMtA8eohMOZ8ul/P9q8yTJgx5JD9G8oIFT8Oepq54CfjfbzY+Bvbex8jBQ+Yrp3P/BlwZ2ufROvr9H38AlDQzwZzcwEUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;down scope&quot;
        title=&quot;down scope&quot;
        src=&quot;/static/00db91f9265a1e17b41708f56f97a627/799d3/down-scope.png&quot;
        srcset=&quot;/static/00db91f9265a1e17b41708f56f97a627/00d96/down-scope.png 148w,
/static/00db91f9265a1e17b41708f56f97a627/0b23c/down-scope.png 295w,
/static/00db91f9265a1e17b41708f56f97a627/799d3/down-scope.png 590w,
/static/00db91f9265a1e17b41708f56f97a627/50fa5/down-scope.png 880w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;或者更高层：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cfad8ece43ed22e8141eaacdeba0dfe5/50fa5/deep-scope.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.86363636363636%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABjElEQVQoz42S627bMAyF8xCxrpREXaxIcuzEaZvehmHv/1Sj6qRrsf2YcCDYAj9S4uGOcy6k5AAmhMM0CWMEAP/XYn+d7LgQkIL3ttSwXGr0xkVUznLGPhmSEF3s/nuDhVI2YtLDVPDtZQ6aBac04oYNAyMEtAB1k5IfGdknHLB6Eb1tNWcnkweNjlAteRsxeSvuxQTnSgqrhdHiDzxanqwcu8RWmTFmQT+d2vv1XEbPhoGiZSdlSZhCD+hv1sFjcP5DITjKpawZ9gMadV2Pz4/rsWZnNCl6TDGcl3aIG0w3Aa09KrwJPEqt6K0GMddybOU0lTzGFP1hjPRRW/Upcil29BowcG3leRmf1vz4UEtN2miuFAScHy7L5ZLySIZQWe+9Q7RUAJ0E6DCFvs71x3n+ec2/Xo/rqWhQrDeUKQAyP7VqnOuMtcoA1dw6vlXWy5yX83FZy7JO85To5G4z3+/3lIj6Supefx2S7dqnObcaphZbjbTrL7D4DnyfsO4AjQ8N6SZBO3nC/2P9BhV2Uv5JDQSWAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;deep scope&quot;
        title=&quot;deep scope&quot;
        src=&quot;/static/cfad8ece43ed22e8141eaacdeba0dfe5/799d3/deep-scope.png&quot;
        srcset=&quot;/static/cfad8ece43ed22e8141eaacdeba0dfe5/00d96/deep-scope.png 148w,
/static/cfad8ece43ed22e8141eaacdeba0dfe5/0b23c/deep-scope.png 295w,
/static/cfad8ece43ed22e8141eaacdeba0dfe5/799d3/deep-scope.png 590w,
/static/cfad8ece43ed22e8141eaacdeba0dfe5/50fa5/deep-scope.png 880w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;我们再来看下面的例子：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b4312b87e35376b659bf744ce48d98b9/50fa5/mutated-demo.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.68181818181818%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABWElEQVQoz42S63KDIBCF+wxNFFBAkKvgXWMvk399/3fqokk6+dFOzxzXGZxvjyy8IITyPM/O5+Qsy7MM/VsvQFJKrfeHldbHhzz1TE96/QYjjLmqTWiE0SYEqITRsiTRqMZJ6OZ9rbRQ6smyrnaY4EqrNgReMeMl45xwzmixteEy2WGMsbMWWjT64SYYY2v4o5QMsLWWgwTjoiLAlmQOfoluHe1lcsPgXaOdV4d9o7SRCcaEFBW/zSnPcUEALkryEduvOVzf2+vnME3OOsBqqNbVwD/B6JjKATMGe+6D7bwe5rYf3LjEfvBdb9vW9GNoooUp7HCxw5AMfJZBL8xA5fI2j3NYtm7ZxnmNyzasazNNflnjtPYQfksupSCQRSkpaZEGxjBGUgkhmazBXEp6VCHAaYXxch8YQrgoEnk3tIPb8vqnTqcTOuBjtz9+CMNR4L0mo7vT4q5vUSdOhY3SrFkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;mutated demo&quot;
        title=&quot;mutated demo&quot;
        src=&quot;/static/b4312b87e35376b659bf744ce48d98b9/799d3/mutated-demo.png&quot;
        srcset=&quot;/static/b4312b87e35376b659bf744ce48d98b9/00d96/mutated-demo.png 148w,
/static/b4312b87e35376b659bf744ce48d98b9/0b23c/mutated-demo.png 295w,
/static/b4312b87e35376b659bf744ce48d98b9/799d3/mutated-demo.png 590w,
/static/b4312b87e35376b659bf744ce48d98b9/50fa5/mutated-demo.png 880w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;和一开始的例子类似，不过有个最大的不同点：我们只在 &lt;code class=&quot;language-text&quot;&gt;getPersonInfo&lt;/code&gt; 函数内部声明了 &lt;code class=&quot;language-text&quot;&gt;city&lt;/code&gt; 变量。我们没有调用 &lt;code class=&quot;language-text&quot;&gt;getPersonInfo&lt;/code&gt; 函数，所以没有本地上下文被创建。我们尝试在全局上下文中获取 &lt;code class=&quot;language-text&quot;&gt;name&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;age&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;city&lt;/code&gt; 变量。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ffd47f0819df952bae3a7bb5035aa628/reference-error.gif&quot; alt=&quot;reference error&quot;&gt;&lt;/p&gt;
&lt;p&gt;在全局作用域中找不到 &lt;code class=&quot;language-text&quot;&gt;city&lt;/code&gt; 变量，没有更外层的作用域来查找，抛出了 &lt;code class=&quot;language-text&quot;&gt;ReferenceError&lt;/code&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;除了全局和本地作用域，还有&lt;strong&gt;块级作用域&lt;/strong&gt;。通过 &lt;code class=&quot;language-text&quot;&gt;let&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;const&lt;/code&gt; 关键字声明的变量的作用域在距&lt;code class=&quot;language-text&quot;&gt;{}&lt;/code&gt;最近的内部。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; age &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;checkAge&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;age &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; message &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;You cannot drink!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; message &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;You can drink!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7c3b8c6148a2aec718dc5403896ed5b3/50fa5/block-scope.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.36363636363636%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABAElEQVQoz4WRi26DIBSG+xCbKK0oyB2Pgrfazu39H2vULI3Lpv3zcUKAj5PACT2TpukZU1ooyaRiXPJK0CdcUFIW8RDa5LR1Ec4Mp3Ojp6A86NpxZ3+I84KSBKFDWZQD2NDqe6/G3rrVt44DcFaR92RfTnGmZDEHWK7d5w1CMG2rQtCtV+Ogq2MZZZkx5eTNzZt56fqxblsRgvReDoN6LVtLvwZYgpt67b32IXZWsXovXstalz3oAcz1o/O9q2sOjaxBNI1gL2VwVRe0sZVd3+lRV6COcnEoY1yQc8VytoU+iIsXctn9qpgM4yRN3xD6l3h17PBLJpvkeR4H2cufrW9HX1AnjViEFAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;block scope&quot;
        title=&quot;block scope&quot;
        src=&quot;/static/7c3b8c6148a2aec718dc5403896ed5b3/799d3/block-scope.png&quot;
        srcset=&quot;/static/7c3b8c6148a2aec718dc5403896ed5b3/00d96/block-scope.png 148w,
/static/7c3b8c6148a2aec718dc5403896ed5b3/0b23c/block-scope.png 295w,
/static/7c3b8c6148a2aec718dc5403896ed5b3/799d3/block-scope.png 590w,
/static/7c3b8c6148a2aec718dc5403896ed5b3/50fa5/block-scope.png 880w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;我们创建了一个全局作用域，函数作用域和两个块级作用域。我们能够声明两次 &lt;code class=&quot;language-text&quot;&gt;message&lt;/code&gt;，因为该变量的作用域是在大括号内的。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;快速回顾：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;作用域链实际是对我们在当前上下文中访问的值的链式的引用。&lt;/li&gt;
&lt;li&gt;得益于作用域链向上查找的规则，我们可以使用上层作用域已声明过的变量。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://dev.to/lydiahallie/javascript-visualized-scope-chain-13pd&quot;&gt;https://dev.to/lydiahallie/javascript-visualized-scope-chain-13pd&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 可视化之变量提升]]></title><description><![CDATA[什么是变量提升？ 从概念的字面意义上说，“变量提升”意味着变量和函数的声明会在物理层面移动到代码的最前面，但这么说并不准确。实际上变量和函数声明在代码里的位置是不会动的，而是在编译阶段被放入内存中。(MDN) 提升的对象是定义的变量或函数（Declarations…]]></description><link>https://www.keisei.top/javascript-visualized-hoisting/</link><guid isPermaLink="false">https://www.keisei.top/javascript-visualized-hoisting/</guid><pubDate>Tue, 28 Jan 2020 10:27:00 GMT</pubDate><content:encoded>&lt;p&gt;什么是变量提升？&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;从概念的字面意义上说，“变量提升”意味着变量和函数的声明会在物理层面移动到代码的最前面，但这么说并不准确。实际上变量和函数声明在代码里的位置是不会动的，而是在编译阶段被放入内存中。(&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Glossary/Hoisting&quot;&gt;MDN&lt;/a&gt;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;提升的对象是定义的变量或函数（Declarations），而不是赋值初始化（Initializations）。&lt;/p&gt;
&lt;p&gt;当 JS 引擎拿到我们的代码，首先会为我们代码里的数据分配内存。没有代码在此过程运行，只是简单的为执行做准备。函数声明和变量声明的存储方式不同。因为函数也是对象，所以存储的函数是指向函数实际内容的地址引用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/0bf82098dbf021fa48a75d0ca9a74da2/function.gif&quot; alt=&quot;function&quot;&gt;&lt;/p&gt;
&lt;p&gt;ES6 引入了两个定义变量的新关键字：&lt;code class=&quot;language-text&quot;&gt;let&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;const&lt;/code&gt;。变量通过 &lt;code class=&quot;language-text&quot;&gt;let&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;const&lt;/code&gt; 声明的被存储为 &lt;em&gt;未初始化&lt;/em&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/dba2e5fef92518d9eb76a44301badd19/variable.gif&quot; alt=&quot;variable&quot;&gt;&lt;/p&gt;
&lt;p&gt;变量通过 &lt;code class=&quot;language-text&quot;&gt;var&lt;/code&gt; 关键字声明的在存储时有默认值 &lt;code class=&quot;language-text&quot;&gt;undefined&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/71934af404a8367c01f4f046a3f5846b/var.gif&quot; alt=&quot;var keyword&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在创建阶段完成，可以真正执行代码了。我们来看一下在文件顶部在函数或任何变量声明之前执行 3 个 console.log 表达式会发生什么。&lt;/p&gt;
&lt;p&gt;由于函数是指向实际函数体的引用，我们可以在创建它们那一行之前运行。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/6780331a3551cd3d04078c5732e0217b/invoke.gif&quot; alt=&quot;invoke functions&quot;&gt;&lt;/p&gt;
&lt;p&gt;当我们遇到变量通过 &lt;code class=&quot;language-text&quot;&gt;var&lt;/code&gt; 关键字声明的代码时，它们简单的返回存储的默认值：&lt;code class=&quot;language-text&quot;&gt;undefined&lt;/code&gt;。然而这通常不是我们所期望的。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/fe9d78d7bf9419e05ba98a52c9830878/var-hoisting.gif&quot; alt=&quot;var hoisting&quot;&gt;&lt;/p&gt;
&lt;p&gt;为了防止意外引用了 &lt;code class=&quot;language-text&quot;&gt;undefined&lt;/code&gt; 变量，可以使用 &lt;code class=&quot;language-text&quot;&gt;const&lt;/code&gt; 关键字，当我们访问 &lt;em&gt;未初始化&lt;/em&gt; 的值时会抛出 &lt;code class=&quot;language-text&quot;&gt;ReferenceError&lt;/code&gt; ，这被称为&lt;strong&gt;暂时性死区&lt;/strong&gt;：不能在变量初始化之前使用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/03a7c75ddde72507b57c4aa5258c73e4/tdz.gif&quot; alt=&quot;temporal dead zone&quot;&gt;&lt;/p&gt;
&lt;p&gt;当引擎执行到我们真正声明变量的那行代码时，在内存中的值会被实际的值覆盖。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2354299e4170f18beef4657eba909b61/overwritten.gif&quot; alt=&quot;overwritten&quot;&gt;&lt;/p&gt;
&lt;p&gt;快速回顾：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;函数和变量在执行代码前先作为执行上下文存储在内存中&lt;/li&gt;
&lt;li&gt;函数存储了函数体的引用，变量通过 &lt;code class=&quot;language-text&quot;&gt;var&lt;/code&gt; 声明的默认值为 &lt;code class=&quot;language-text&quot;&gt;undefined&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;let&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;const&lt;/code&gt; 声明的默认值为 &lt;em&gt;未初始化&lt;/em&gt; 。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://dev.to/lydiahallie/javascript-visualized-hoisting-478h&quot;&gt;https://dev.to/lydiahallie/javascript-visualized-hoisting-478h&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 可视化之事件循环]]></title><description><![CDATA[事件循环大概是每个 JavaScript 初学者都会感到困惑的概念。本文将通过可视化的方式来尽量对该概念作详细的解释。 我们来首先了解一下什么是事件循环，以及我们为什么要关心它？ JavaScript…]]></description><link>https://www.keisei.top/javascript-visualized-event-loop/</link><guid isPermaLink="false">https://www.keisei.top/javascript-visualized-event-loop/</guid><pubDate>Sat, 25 Jan 2020 20:45:00 GMT</pubDate><content:encoded>&lt;p&gt;事件循环大概是每个 JavaScript 初学者都会感到困惑的概念。本文将通过可视化的方式来尽量对该概念作详细的解释。&lt;/p&gt;
&lt;p&gt;我们来首先了解一下什么是事件循环，以及我们为什么要关心它？&lt;/p&gt;
&lt;p&gt;JavaScript 是&lt;strong&gt;单线程&lt;/strong&gt;的：任何时候都只能执行一个任务。这通常没有太大的问题，但当要执行一个 30 秒的任务时，我们只能等待任务执行完毕才能继续别的任务（JavaScript 在浏览器中默认运行在主线程，所以整个 UI 就卡住了）。已经 2020 年了，没人愿意访问慢的，失去响应的网站。&lt;/p&gt;
&lt;p&gt;幸运的是，浏览器给了我们 JavaScript 引擎没有提供的功能：Web API。包含 DOM API，&lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt;，HTTP 请求等等。这可以帮助我们实现异步，非阻塞的需求。&lt;/p&gt;
&lt;p&gt;当我们执行函数时，它被放入了调用栈中。调用栈是 JS 引擎的一部分，不是浏览器特有的。它本质是一个栈，一种先入后出的数据结构。当函数返回一个值时，它会从栈顶中弹出。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/050d10baa1b0a5c6421959dbb21aff9e/call-stack.gif&quot; alt=&quot;call stack&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;respond&lt;/code&gt; 函数返回了 &lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 函数。&lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 是 Web API 提供的：它允许我们延迟执行任务而不阻塞主线程。传入 &lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 函数的回调函数 &lt;code class=&quot;language-text&quot;&gt;() =&amp;gt; { return &amp;#39;Hey!&amp;#39; }&lt;/code&gt; 被加入 Web API。与此同时，&lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 函数和 &lt;code class=&quot;language-text&quot;&gt;respond&lt;/code&gt; 函数从栈顶弹出，它们都返回了各自的值。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/53e8d25ab9ffbca763742a73d0968885/setTimeout.gif&quot; alt=&quot;setTimeout&quot;&gt;&lt;/p&gt;
&lt;p&gt;在 Web API 中，一个计时器尽可能运行第二个参数传入的值的时长，1000ms。回调函数不会立即添加到调用栈中，它们被添加到队列中。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/bb133167acba9732c254fe1b4e2604a3/queue.gif&quot; alt=&quot;queue&quot;&gt;&lt;/p&gt;
&lt;p&gt;这是比较困惑的地方：这不是说回调函数不会在 1000ms 后添加到调用栈中！它们在 1000ms 后添加到 &lt;em&gt;queue&lt;/em&gt; 中。但这是一个队列，该函数必须等待轮到它。&lt;/p&gt;
&lt;p&gt;现在这是我们必须要等待的部分，事件循环做的唯一的任务：&lt;strong&gt;连接调用栈和队列&lt;/strong&gt;。如果调用栈是空的，即之前所有函数都返回了值，已经从栈中弹出，那么队列中的第一个值出队列被加入调用栈。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7e58f74b2b2116d7cb8ae573570df2a5/dequeue.gif&quot; alt=&quot;dequeue&quot;&gt;&lt;/p&gt;
&lt;p&gt;回调函数被加入调用栈，然后执行，返回值，最后中栈中弹出。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/55d383fd555ff564285059d89c8f4abd/new-item.gif&quot; alt=&quot;new item added to call stack&quot;&gt;&lt;/p&gt;
&lt;p&gt;通过之前的了解，来推断一下下面的结果：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;foo&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;First&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;bar&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Second&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;baz&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Third&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;baz&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;让我们来快速看一下执行上述代码，浏览器发生了什么：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/edca0b28d3de98f77da38d0f994beebd/demo.gif&quot; alt=&quot;demo&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;我们调用 &lt;code class=&quot;language-text&quot;&gt;bar&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;bar&lt;/code&gt; 返回了 &lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 函数。&lt;/li&gt;
&lt;li&gt;我们传入 &lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 的回调函数添加到了 Web API，&lt;code class=&quot;language-text&quot;&gt;setTimeout&lt;/code&gt; 函数和 &lt;code class=&quot;language-text&quot;&gt;bar&lt;/code&gt; 函数从栈中弹出。&lt;/li&gt;
&lt;li&gt;计时器开始运行，于此同时 &lt;code class=&quot;language-text&quot;&gt;foo&lt;/code&gt; 被调用并输出 &lt;code class=&quot;language-text&quot;&gt;First&lt;/code&gt;。&lt;code class=&quot;language-text&quot;&gt;foo&lt;/code&gt; 返回（undefined），&lt;code class=&quot;language-text&quot;&gt;baz&lt;/code&gt; 被调用，回调函数被加入队列中。&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;baz&lt;/code&gt; 输出 &lt;code class=&quot;language-text&quot;&gt;Third&lt;/code&gt;。事件循环看到 &lt;code class=&quot;language-text&quot;&gt;baz&lt;/code&gt; 返回后的调用栈为空，回调函数被加入到调用栈中。&lt;/li&gt;
&lt;li&gt;回调函数输出 &lt;code class=&quot;language-text&quot;&gt;Second&lt;/code&gt;。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://dev.to/lydiahallie/javascript-visualized-event-loop-3dif&quot;&gt;https://dev.to/lydiahallie/javascript-visualized-event-loop-3dif&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[2019年末总结]]></title><description><![CDATA[2019年平平淡淡的就这么度过了，本身没有太多值得回顾的，但是自从没有坚持继续记日记之后，好久没有花时间好好自我反省过了。 工作 全年主要在公司承担业务UI改版的工作，期间并没有亮眼的成绩，反而还造成了一些由于业务不熟悉导致的bug…]]></description><link>https://www.keisei.top/annual-summary/</link><guid isPermaLink="false">https://www.keisei.top/annual-summary/</guid><pubDate>Wed, 22 Jan 2020 17:51:00 GMT</pubDate><content:encoded>&lt;p&gt;2019年平平淡淡的就这么度过了，本身没有太多值得回顾的，但是自从没有坚持继续记日记之后，好久没有花时间好好自我反省过了。&lt;/p&gt;
&lt;h3&gt;工作&lt;/h3&gt;
&lt;p&gt;全年主要在公司承担业务UI改版的工作，期间并没有亮眼的成绩，反而还造成了一些由于业务不熟悉导致的bug。工作内容说实话都没有太大的挑战性，所以在与leader谈年终绩效时没有得到太多的认可，整年的工作过于平坦，这种方式方法将来难以有大的成长。说起来确实有点扎心，不过我也没啥可反驳的。毕竟做的工作出现过因为设计稿的变动而返工，整体的产出没有太多。对于个人来说，本年公司开始从Vue迁移到React，正值hooks刚发布，这波学习之后感觉对react有了新的认识。这也是我在工作中感受到的为数不多的成长吧。&lt;/p&gt;
&lt;p&gt;P.S：由于我对运维还比较感兴趣，我们运维同学开发了一个命令行工具，来帮助我们打包发布测试/生产环境，我把Python源码克隆下来学习了一波，有一个统一的manager加载用户的权限配置，注册每个服务如Jenkins打包，python代码加密打包，更新Apollo配置等，另外有console来接收用户输入指令来执行对应的服务。这也算是一个小小的收获吧。&lt;/p&gt;
&lt;h3&gt;闲时&lt;/h3&gt;
&lt;p&gt;上半年没有太多的进步，期间读过react, redux, express, nodejs handbook，平心而论这些手册看完之后感觉还只是入门，尽管有一些深入的内容，但是只要平时用不到真的记忆只有那么一两天，成效不够。下半年开始研究了一下npm的发布，顺便学习了一下CI，打了tag自动发布。10月份开始有过两三次的外出交流，没想到被虐，感觉还是个人实力比较欠缺。痛定思痛，开始了我如今的日常commit，也终于开始了blog之旅。必须要承认，目前的节奏还是有很大问题的，没有个人真正思考的沉淀，还是主要以学习为主，顺便提高一下翻译的水平。多说几句，坚持了两年半的背单词确实有比较大的进步，现在看英文文档压力没以前那么大了，但口语还是个硬伤。本站目前采用了gatsby框架部署静态页面，真的很方便，host用的github pages，CI就直接使用的github的action，一套下来体验还是很不错的。&lt;/p&gt;
&lt;p&gt;五月份去杭州参加了一场前端分享会，十月份学妹送了一套JS Conf China 的门票，见到了一些大佬，后面有报名参与了几场谷歌中国的活动，作为安卓粉收获了一个限量版安卓公仔还是非常开心的。我觉得参加了多场活动之后，尽管讲师的内容有高有低但还是能接触到一些不一样的东西，希望向他们一样把分享带给公司的同事。&lt;/p&gt;
&lt;p&gt;八月份偶然间看到阿里的公益平台：码上公益，随后加了一个钉钉群，在里面接到了几个项目。接触了小程序，官网，后台管理系统，在其中了解了一些没有见过的框架，类库，还是很有收获的。通过这种方式做公益，尤其是已经有两个参与的项目已经完结，真的有满满的成就感。这种远程工作的体验也是很不错的。&lt;/p&gt;
&lt;h3&gt;生活&lt;/h3&gt;
&lt;p&gt;平时没事会打打游戏，看看电影，差不多每个月都会去影院看场电影。八月份表弟来上海，带他吃了几天的好吃的。国庆节回家看了一下房子，并在十二月份办了过户，心里的一块石头算是落地了。&lt;/p&gt;
&lt;h3&gt;展望&lt;/h3&gt;
&lt;p&gt;2020年希望技术水平、工作能力有一个新的提高，不再唯唯诺诺，主动承担一些具有挑战性的工作。继续坚持学习，坚持daily commit。家人朋友平平安安，幸福感稳步提升。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[虚拟DOM和diff算法在React中的工作方式]]></title><description><![CDATA[写了这么久的 React，你或许对虚拟 DOM 是怎么工作的感到好奇，本文将通过解读部分  和  源码来尝试作详细的解释。在开始前，你是否考虑过为什么我们不是直接对 DOM 进行修改？  接下来的章节将总结一下 DOM 是如何被创建的，并给出为什么 React…]]></description><link>https://www.keisei.top/react-virtual-dom-and-diff/</link><guid isPermaLink="false">https://www.keisei.top/react-virtual-dom-and-diff/</guid><pubDate>Sun, 19 Jan 2020 22:31:00 GMT</pubDate><content:encoded>&lt;p&gt;写了这么久的 React，你或许对虚拟 DOM 是怎么工作的感到好奇，本文将通过解读部分 &lt;code class=&quot;language-text&quot;&gt;React&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;React DOM&lt;/code&gt; 源码来尝试作详细的解释。在开始前，你是否考虑过为什么我们不是直接对 DOM 进行修改？&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3fa419ab1c7985e55a5ae2ce264949c8/1241b/render-circle.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 51.99386503067485%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABcElEQVQoz21SUU/CMBDmzRefTPylvpoQ3nz1xQff9B8Yf4BIxEgCCUEBFRFdZIOtXVnXbV27W72xEZFwvTbXy12v931XM/8lz/PSgBxQ0bHt3JGaVjrDpTQArONwZwsmzlvBWTMe29wYjX4hBPGo63p4Eo8snWUGUPv+svq9wfB57C48n64IobHgo5lzektObsL2m5dGq1XAnbkz6L+Mhq8Yac8dSnzI85pKlQhFkkh8nvl+FEVoBIm+7orLTmKxFK9SJsx1UhFwHmABKdPq21WrxtCV+FkQncGmyVILUWAex153yhVUuJQoVMlSw9Ms6liZRZKq8bzQ9VPmYaYP6/FBXd1PipqlcytZQXsStKexRfH/iHNVs4xrfcJxgx814rt3tScZo20/fv6wXRoUV4AwFJyHSVKUcmh00SRXPU1FVjGynbxhGSIR+r4fhpyxAnnGEEQmBBKW7eF5azz+5kRKicQi8miU2GS50WB2huUX8MI39nX6qNEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;render circle&quot;
        title=&quot;render circle&quot;
        src=&quot;/static/3fa419ab1c7985e55a5ae2ce264949c8/799d3/render-circle.png&quot;
        srcset=&quot;/static/3fa419ab1c7985e55a5ae2ce264949c8/00d96/render-circle.png 148w,
/static/3fa419ab1c7985e55a5ae2ce264949c8/0b23c/render-circle.png 295w,
/static/3fa419ab1c7985e55a5ae2ce264949c8/799d3/render-circle.png 590w,
/static/3fa419ab1c7985e55a5ae2ce264949c8/1241b/render-circle.png 652w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;接下来的章节将总结一下 DOM 是如何被创建的，并给出为什么 React 首先会创建虚拟 DOM 的原因。&lt;/p&gt;
&lt;h2&gt;理解 DOM 是如何构建的&lt;/h2&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bffdaae72a3f7e0e6f897fb3de65d61c/71f87/dom-build-process.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 44.223107569721115%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABTUlEQVQoz31Ra0/CMBTdT/enmGhi/OAHExMNKFmCxiEQI7BNNhh7sfejpRtbu1Ic6PiA4k3Tk9yee3LuKbc9Kra7KkwHd7ajwl2DbU8Vd+p5Oc7XadXI/S3AATBcgfu5t3zTLTdJe3NtqBkhit/joQylgpQ1SXScnm6GCDUy7Bs5CPlsdTvSjQdxqvlBW5R5efaZzDpuRwYSwbgm9XWzJSoBREc2OcY2NVBKMcGUViWp+QRXmFBixfHYMJcp9KEv+RN3Fcz8yIeoLJSiUH92/r0S2+sL6uKcf26NpFdHePLasqvd9D8EdR54F1F0dRjeAjD1/U6WmWuygUVBqqpkpYNCKwxAlgMMEUW4Ikme5yWmVUpIckh743mXhnnmeTwvL66FgRpZj07rJequ1mBvjP3zVSzLugB0MYZ6GE8M20OhAhQb2U2ybH+alBv8An7s++YHoKVgAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;dom build process&quot;
        title=&quot;dom build process&quot;
        src=&quot;/static/bffdaae72a3f7e0e6f897fb3de65d61c/799d3/dom-build-process.png&quot;
        srcset=&quot;/static/bffdaae72a3f7e0e6f897fb3de65d61c/00d96/dom-build-process.png 148w,
/static/bffdaae72a3f7e0e6f897fb3de65d61c/0b23c/dom-build-process.png 295w,
/static/bffdaae72a3f7e0e6f897fb3de65d61c/799d3/dom-build-process.png 590w,
/static/bffdaae72a3f7e0e6f897fb3de65d61c/71f87/dom-build-process.png 753w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;来自 Mozilla: &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Mozilla/Introduction_to_Layout_in_Mozilla&quot;&gt;Basic Data Flow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;我们不会详细介绍 DOM 是如何创建并在屏幕上打印的，可以通过&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Introduction_to_Layout_in_Mozilla&quot;&gt;这篇&lt;/a&gt;和&lt;a href=&quot;http://taligarsiel.com/Projects/howbrowserswork1.htm#Parsing_general&quot;&gt;这篇&lt;/a&gt;了解从 HTML 转换成 DOM 并打印到屏幕上的全流程。&lt;/p&gt;
&lt;p&gt;DOM 是一种树形结构，每次对 DOM 操作都是很快的，但是被改变的部分，和它的子代元素需要执行&lt;strong&gt;重绘/重排&lt;/strong&gt;（&lt;strong&gt;Reflow/Layou&lt;/strong&gt;）步骤，改变的部分需要重新渲染，这个过程是比较慢的。所以越多的元素重绘/重排，你的应用就会越慢。&lt;/p&gt;
&lt;p&gt;虚拟 DOM 是减少这两个步骤，为大型复杂应用提供更好的性能表现。&lt;/p&gt;
&lt;h2&gt;理解虚拟 DOM&lt;/h2&gt;
&lt;p&gt;现在了解了 DOM 是如何构建的，我们来看一下虚拟 DOM。我们将通过一个简单的应用来解释虚拟 DOM 是如何工作的。通过视觉化会比较容易理解。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;我们不会对首次渲染进行过多解释，会专注于重新渲染，这会帮助我们理解虚拟 DOM 和 diff 的工作原理。一旦了解了这部分内容，首次渲染的理解就会非常容易。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面是一个简单的计算器&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 337px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7b2e308585291237a12e35044afdbd61/a4aa2/basic-calculator.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.66765578635015%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABZElEQVQoz6WSbVOCUBCF+f8/I+tz4WQEKGoqcGl8qQkUTAQREBRwUEl5M9JqQmjGpufjvXvm7O5ZKN6niKIoCIL9eUAohl5dXjyzfQRDxdGIYRhZEm/gW4psVogHGC5VyjgDKLY/ONSnvCCuz5WxexIwGI5LY0mW5akiIwja67RrtQZeJqoEASiSH4of0jgt3v8DyJqbAs/zw1dVmQCamkxVVVXmln2c/5sTz0+xwL3U67XiXanVbACabJEUTZOKpmebzBHnviZGYZrEPEesT1WOHRiGPpsvTNN0V65/IEiz3W5zxDNN51jBse2FZen6zHacTR7r9Trxzzhr2iPTThISRZHnhfFYWi6XcRSdtJ2YZzuHTGMGAM1ybK/TJRtNQNGGYSQfxzl/EmaAvq4yPu42jMLd2UCu6zqO4202nue5q1XuVn+N6qnXhYtFBL6+KhTQSjXw/XMSTuXs73ae9/bX83wHHQdUVYEnRsoAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;basic calculator&quot;
        title=&quot;basic calculator&quot;
        src=&quot;/static/7b2e308585291237a12e35044afdbd61/a4aa2/basic-calculator.png&quot;
        srcset=&quot;/static/7b2e308585291237a12e35044afdbd61/00d96/basic-calculator.png 148w,
/static/7b2e308585291237a12e35044afdbd61/0b23c/basic-calculator.png 295w,
/static/7b2e308585291237a12e35044afdbd61/a4aa2/basic-calculator.png 337w&quot;
        sizes=&quot;(max-width: 337px) 100vw, 337px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; React &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;react&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; ReactDOM &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;react-dom&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Calculator&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;React&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Component&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;props&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; output&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; IntegerA&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IntegerB&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IntegerC&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;className&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;container&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;h2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;using React&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;h2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
          Input 1:
          &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;input&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;placeholder&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;Input 1&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;input1&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;input&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
          Input 2 :&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;input&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;placeholder&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;Input 2&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;input2&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;input&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;button&lt;/span&gt;
            &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;add&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token attr-name&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              IntegerA &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReactDOM&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findDOMNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;refs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;input1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
              IntegerB &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReactDOM&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findDOMNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;refs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;input2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
              IntegerC &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; IntegerA &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IntegerB&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
              &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; output&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; IntegerC &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
            Add
          &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;button&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;

          &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;button&lt;/span&gt;
            &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;subtract&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token attr-name&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              IntegerA &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReactDOM&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findDOMNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;refs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;input1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
              IntegerB &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReactDOM&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findDOMNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;refs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;input2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
              IntegerC &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; IntegerA &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; IntegerB&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
              &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; output&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; IntegerC &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
            Subtract
          &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;button&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;hr&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;h2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;Output: &lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;output&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;h2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Calculator.js&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; React &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;react&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Calculator &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;./Calculator&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Layout&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;React&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Component&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;h1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;Basic Calculator&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;h1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Calculator&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Main.js&lt;/p&gt;
&lt;p&gt;初次渲染后 DOM 的结构：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 397px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b90b0dbade3fdf737d45b6f465961c1d/3c7c4/dom-structure.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 136.27204030226702%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsSAAALEgHS3X78AAACYklEQVQ4y5VTCW7jMAzs/9+3wAK7aJo0tmvLsu6DOr2UnXZ7oElKKHYMacjRcPjwt+O/f02HR9Ut7jTH05wGkXH1PPcs4Rq+Xw+lFsm46iUwwkbCiCigS7A1hfVWPNRaU85OevXCh+MfRvq5O07nw9g/O+tBejzwLbiUgi9jjB41nwntnyhlTyd2OCzToKIPa11vgFNOmio5cELGhS6EzFZZEHCl7IU2vjCFt14LlWvhlttgpJMu+RAh57Ri9e3Yp1QNvONxnzI6kWlciLTaRZdyLOutyhdwrVorI+xEO0LPwzwzacCpYFW0MuIfSNrEEDLGO9pb9hyzPAvHfHIaTxuTrUnJKZCLlzRo5l1kDJxLKeUPgsUUFVN60q1zteS2Uq2l3kkbs3DBhRLDMjDNmOEWHOyCNXbt0Pb7ovZ+Zy45akb4zDTXXoUU0H/3CbZWTbWdHZvPjJz6kRP8FMTMvaWDW16MhmnySsUI8cOdUUArrXwWKaT1fUNb5lJrE6GUmhK+6hvZV3DJ3jgzaS8hWgfWChGtsVLJqCJwyCFfo42hXiR/5IYQtZBz585nQYgkPemeOkqoExb974V7a8FFMKyMZpadTJB2qkgy57aJmqHz8V4llRLb8/Ng4J7Tjfb+eWf8p+29l6PIm2Bl06dVf41rU7UHgBdSzGKmiqJPcLAsWEiAl7pRuYEjtKmaRkSivbTXSOGKTz6A0VI4w4thR3LsaNezfmlZ7H2VARtslVM9G5A5kdM21ekOe5aiBgnK/0zt3YfYpzaSV2fwC7hsfeIO7VXKD5CXysGAOPHo4/rD+AdryyriQlVhxAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;dom structure&quot;
        title=&quot;dom structure&quot;
        src=&quot;/static/b90b0dbade3fdf737d45b6f465961c1d/3c7c4/dom-structure.png&quot;
        srcset=&quot;/static/b90b0dbade3fdf737d45b6f465961c1d/00d96/dom-structure.png 148w,
/static/b90b0dbade3fdf737d45b6f465961c1d/0b23c/dom-structure.png 295w,
/static/b90b0dbade3fdf737d45b6f465961c1d/3c7c4/dom-structure.png 397w&quot;
        sizes=&quot;(max-width: 397px) 100vw, 397px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;React 内部构建组件树的方式：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3517317595645abc36f5b23c6bc82098/b66d4/react-internal-build-component-tree.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 69.45454545454545%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAChUlEQVQoz3WSW08TQRTH9yP4QXzw1RhJjAR88Y1EiC8aHtBHvIQEEhLkRQWtGCxGiEVpTcVqwiVYI4hQAcvNS6nQloJAu2wvuzu3nb3N7rqwiiSEf04mJzPnN3POP8PhQ0IIaxQLIj7VWTjRIkwkiiYRMcHHiXOOCFIjvg5mM0BEVFVV53j9hW3blgFyTKV/Ua/yFwLz1HFY0wi44M83RCBS2X7NEdjdsvbCNk3m2FZwWb32RgosuLAdnIeNEf7pDNQMdvCGdegOzsu9VWf21bB0xrdVGwLMspK8dmd4ezJF3CPrH+JWHtAcsx2ZGCIgmkqxon5eKYRj67NrxbIM0zl5IStndyFEiO4LY0Lofxe4rphS5edr+sUfOe16RK7qEVo/4ImUcq5bOO8Xvv7Wlna0mv5yAZludXBRqQ9LBrO9FrjJjOoOdn8ClIg1nEC+cWF0haQLWs90+cmUuCUaOcACcazoLmCt5GlkGdqm6s3Bre5qjz8VQ3GJeWOrimuKm5iGYeqaZxJBwE3ujkP/tHTvo1TZnb/yGkHV4lTDSvN4p6wwXbE0olHi2KYbpk4NnXowgi5s9s3Bwe9K+ButD+abR2Wi29xPXk/xZChptI8VuqZQqsTiGzCRU3yTctuo4Ja+XFTbRnL+GOiJgY4o/3xelSHSdW2v7epnUu2AVBcEZx9k60Lg1gi+2Ftqfk8vvSid7sg2DpMbQ6Di4Ub9IL4cFCs60w1vkYwUm+35x/GQuVb9EvRoEs9taiJhPLJExZrbpNEk+rJpDMSlwEwxuqYHZkq9sdKrJZzYBoltlClb3HH/lu1/i/aodLI9E4iT2+92qx9lWsekSl+mpi/fMpi6GVr9A55D2lhlm3ohAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;react internal build component tree&quot;
        title=&quot;react internal build component tree&quot;
        src=&quot;/static/3517317595645abc36f5b23c6bc82098/799d3/react-internal-build-component-tree.png&quot;
        srcset=&quot;/static/3517317595645abc36f5b23c6bc82098/00d96/react-internal-build-component-tree.png 148w,
/static/3517317595645abc36f5b23c6bc82098/0b23c/react-internal-build-component-tree.png 295w,
/static/3517317595645abc36f5b23c6bc82098/799d3/react-internal-build-component-tree.png 590w,
/static/3517317595645abc36f5b23c6bc82098/b66d4/react-internal-build-component-tree.png 825w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;当按下 Add 按钮时发生了什么&lt;/h3&gt;
&lt;p&gt;我们在两个输入框中输入 100 和 50 并按下 &lt;strong&gt;Add&lt;/strong&gt; 按钮。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;txt&quot;&gt;&lt;pre class=&quot;language-txt&quot;&gt;&lt;code class=&quot;language-txt&quot;&gt;Input 1: 100
Input 2: 50

Output: 150&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当按下 &lt;strong&gt;Add&lt;/strong&gt; 按钮时，我们对 &lt;strong&gt;&lt;em&gt;State&lt;/em&gt;&lt;/strong&gt; 设置了新的值：150。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;//Calculator.js&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;button&lt;/span&gt;
  &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;add&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token attr-name&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    IntegerA &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReactDOM&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findDOMNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;refs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;input1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    IntegerB &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReactDOM&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findDOMNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;refs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;input2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    IntegerC &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; IntegerA &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IntegerB&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; output&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; IntegerC &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
  Add
&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;button&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;将组件标记为脏值&lt;/h3&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 543px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/774c95201fdd2a386e74a5d3f9a384e8/bd6bc/marking-component-dirty.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 41.436464088397784%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABe0lEQVQY021QT0sCURzcS7cuQnXuE3iuQ13KQ0JE9z5CUNekQ4ZEUHmI3FKoQ4hQp1SwCMoKForMSxbuYbVS3BZ3bfftPvfPe29fuoJeHIY5/H4zDAxDh8H1NPkG1zNw48Zay8BUEfbvfTDDw10Xnj2CzKo7tV9j1tzAiQn+JKFS/VPVQdglxMW4Q0pIN9QhQi5ClJK9ez14ZqwklcVzK/pkUuIAaJq2gwnFnnd4cwemp46pS2Kdoja2DBfb1O0QDZphoSCzrHIcVy8vtOucLYpYEMDtbTWVUh4e5Z9aSwWqBjRNKwoyxytZrvzesD9Ex0KEAS/P5fDW53b4O52G0q/F88bYmOL3S4GAOTJixmLeSPjlyxrfsUa3nZlDcSKiMyFj905nCKVKGzahIbWUNqWoXoeTk63p6UYwqPt8MJEgXjhfBvOsuBRvLET55dPmHCsf3LWY3rKDnTFGlQrkOJDP41IJ63rvLQE7kvvdzDZDV+LWtRrKyK9V+A+tf5k2fPY/aQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;marking-component-dirty&quot;
        title=&quot;marking-component-dirty&quot;
        src=&quot;/static/774c95201fdd2a386e74a5d3f9a384e8/bd6bc/marking-component-dirty.png&quot;
        srcset=&quot;/static/774c95201fdd2a386e74a5d3f9a384e8/00d96/marking-component-dirty.png 148w,
/static/774c95201fdd2a386e74a5d3f9a384e8/0b23c/marking-component-dirty.png 295w,
/static/774c95201fdd2a386e74a5d3f9a384e8/bd6bc/marking-component-dirty.png 543w&quot;
        sizes=&quot;(max-width: 543px) 100vw, 543px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;首先我们来了解第一步，组件是如何被标记为脏值的。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;所有 DOM 的事件监听器都被 React 自定义的事件监听器所包装。所以当按下 &lt;strong&gt;&lt;em&gt;Add&lt;/em&gt;&lt;/strong&gt; 时，事件被发送到 react 的事件监听器，所以会执行上面的匿名函数。&lt;/li&gt;
&lt;li&gt;在匿名函数中，我们调用了 &lt;strong&gt;&lt;em&gt;this.setState()&lt;/em&gt;&lt;/strong&gt; 函数并传入了新值。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;em&gt;setState()&lt;/em&gt;&lt;/strong&gt; 函数会将该组件标记为脏值。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// ReactUpdate.js - enqueueUpdate(component) function&lt;/span&gt;
dirtyComponents&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;component&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;你可能会好奇，为什么 React 不直接将按钮标记为脏值，而是整个组件，那是因为，在调用 setState 时，通过 &lt;strong&gt;this.setState()&lt;/strong&gt; 调用的，&lt;strong&gt;this&lt;/strong&gt; 在这里指向的是 &lt;strong&gt;Calculator&lt;/strong&gt; 组件实例。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start=&quot;4&quot;&gt;
&lt;li&gt;现在，&lt;strong&gt;Calculator&lt;/strong&gt; 组件被标记为脏值。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;遍历组件的生命周期&lt;/h3&gt;
&lt;p&gt;现在组件被标记为脏值，下一步是更新虚拟 DOM 并使用 diff 算法来做协调（reconciliation），最终更新真正的 DOM。&lt;/p&gt;
&lt;p&gt;在 React 中，我们的 Calculator 组件的数据格式：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 285px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4491dc548f08eb284a346c1e7be3af4d/0f1af/calculator-data.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 138.24561403508773%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAADMklEQVQ4y4VU25baOBCc//+8PCQ7y4DBtoQly7rffGVLmCSTDDOro2MEuFTd1dX9IoQghPRDLwbRsW4/YDPO9vOVXYUUHe+UEoNfXb5hbeVxexnHrJQWVLALI0dC3uj11LGa01NH3yive/zCzqx+bYZOSJ4VCYufbjt4/0hDNhdnG29rp47GkxBY0jRFkZNI2FmOU5y3PGfqR5ke4G3bpnHyPPT/DKrSprWG2b4Simnr122P75P1Mk0TZzz2SddGn3UQYRiG4+FIWpJTnOcZVy/LWrLcL/p1ABh/I+fAo+u8u/rhIPXFqJP2XcDvVVWdz2dr7XPmcte6mcbKSvPvwjJr9LzMj/u3+9pffX9+xywVmOVRgRORq8pY4iJLrvHZjfRKm6ZBLtsHAQCeei4CiyCHWsjcti7a2JybjnTI/Hg8Hg4H4Luu6/v+b+ZhkGDWFw2YpS65xHvetE3d1oAxxpCzMcY5F0L4A7yuawwx9hGhFqnOOprEOWeso/QqpUQ5Pi3VrgRg8qQQuXiV3Tc+TpM2NqX0673tWcULeF1WwEqdwQzNah3j7O32VOEnpSoxA1zw1rY2+snb5Sf2U/zOvBni1LmAYdIiOLGIBZ6BHBAZz69yBrN8U8D3P4Q86eGgIHuMEZ3ovf8qbOQMKhDeBRvQJLirqNAYy13WMV1DFvH20SR72PYeNroKzCVgWiSAz6Ff0imcTKzdmpe/wahzignpQWrA+u9CHnXxKTwDFYmxGk2qVTMYYZ60JOu4uwbkjN4Q/0rww+f3rZ10LW2ry/nS1i1pw88FOaDUy7IsRpvQx6L2faMfgUTBTOvcEFpCYTeYvG5qOLyua8w8Sil8/ci5gCsNb5ZqvQ64yBBfVJSYcbcv1Z7XIEpXIdUiUqWcm5zbHfYw5vZh/R6AZYa8ldoiZlMXnyOQ5JNSsuccFrw9bnpWZ8+8rAoAMHd1UA5fkUJwOcblf7yNmIHEGMEkMrU1ldXYJyMxWBrvmJ/SmFlILCxp/g1e1gXKZ5UDD56FOCQnPDlR1nJM3yQTdpQJdphMhs+Wd1Ypk0RrPbox24zn6MdS+Z6hqtbZ9/28vRuD+/oPXZZCBym7D1QAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;calculator data&quot;
        title=&quot;calculator data&quot;
        src=&quot;/static/4491dc548f08eb284a346c1e7be3af4d/0f1af/calculator-data.png&quot;
        srcset=&quot;/static/4491dc548f08eb284a346c1e7be3af4d/00d96/calculator-data.png 148w,
/static/4491dc548f08eb284a346c1e7be3af4d/0f1af/calculator-data.png 285w&quot;
        sizes=&quot;(max-width: 285px) 100vw, 285px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;下一步更新组件：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;这是通过 React 执行批量更新来完成的。&lt;/li&gt;
&lt;li&gt;在批量更新时，它会检查哪些组件被标记为脏值并开始更新。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;flushBatchedUpdates&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dirtyComponents&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; asapEnqueued&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dirtyComponents&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; transaction &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ReactUpdatesFlushTransaction&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getPooled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      transaction&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;perform&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;runBatchedUpdate&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; transaction&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;下一步，它会检查是否存在进行中的需要更新的状态，或者有一个 &lt;strong&gt;&lt;em&gt;forceUpdate&lt;/em&gt;&lt;/strong&gt; 被调用。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_pendingStateQueue &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_pendingForceUpdate&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;updateComponent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    transaction&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_currentElement&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_currentElement&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_context
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 236px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/427c95929f06e16a09805582aa0b4d56/2ac26/pending-state-queue.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 22.033898305084744%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAlklEQVQI132L2RKCMAxF/f/f88XBBcpYKBWbNE1py4BaQHn0ZJ2b3IO1FgGDDigsN97WzoqcZG5gSsTasmZypJRq23br0zS9Vw55gyeoQlPjOqGbQqlrBxKGPmTFP4ZIyXsmIgAwK/M8f825OHAv+8hJdlLcRVmXfvBZf+X4y2LefpIbTYHmjFjRGNPpGKpL3K/L/LGbP9Db5MZFUleuAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;pending state queue&quot;
        title=&quot;pending state queue&quot;
        src=&quot;/static/427c95929f06e16a09805582aa0b4d56/2ac26/pending-state-queue.png&quot;
        srcset=&quot;/static/427c95929f06e16a09805582aa0b4d56/00d96/pending-state-queue.png 148w,
/static/427c95929f06e16a09805582aa0b4d56/2ac26/pending-state-queue.png 236w&quot;
        sizes=&quot;(max-width: 236px) 100vw, 236px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;在我们的例子中， &lt;strong&gt;&lt;em&gt;this.\&lt;/em&gt;pendingStateQueue_&lt;/strong&gt; 持有我们新的 output 值。&lt;/p&gt;
&lt;ol start=&quot;4&quot;&gt;
&lt;li&gt;首先它会检查我们是否声明了 &lt;a href=&quot;https://facebook.github.io/react/docs/react-component.html#componentwillreceiveprops&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;componentWillReceiveProps()&lt;/code&gt;&lt;/a&gt;，如果声明了，那么可以通过传入的新的 &lt;strong&gt;props&lt;/strong&gt; 来更新 &lt;strong&gt;state&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;下一步检查是否声明了 &lt;a href=&quot;https://facebook.github.io/react/docs/react-component.html#shouldcomponentupdate&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;shouldComponentUpdate()&lt;/code&gt;&lt;/a&gt;，我们可以检查 &lt;strong&gt;state&lt;/strong&gt; 或 &lt;strong&gt;props&lt;/strong&gt; 是否变化了来决定组件是否需要重新渲染。&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;当你知道什么情况下不需要组件重新渲染时使用，可以提高组件的性能。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;6.下一步是执行 &lt;a href=&quot;https://facebook.github.io/react/docs/react-component.html#componentwillupdate&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;componentWillUpdate()&lt;/code&gt;&lt;/a&gt;， &lt;a href=&quot;https://facebook.github.io/react/docs/react-component.html#render&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;render()&lt;/code&gt;&lt;/a&gt; 和 &lt;a href=&quot;https://facebook.github.io/react/docs/react-component.html#componentdidupdate&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;componentDidUpdate&lt;/code&gt;&lt;/a&gt;。&lt;/p&gt;
&lt;ol start=&quot;7&quot;&gt;
&lt;li&gt;我们来详细看一下 &lt;strong&gt;&lt;em&gt;render()&lt;/em&gt;&lt;/strong&gt; 内部的执行：&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;render 是虚拟 DOM 重新构建和 diff 执行的地方。
在我们的例子中，所有在当前组件内部的元素在虚拟 DOM 中都会重新构建。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e229c27fe81bb40185f5a44369b4f46c/2cc4f/virtual-dom-updating.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 69.49152542372882%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAClUlEQVQoz3VSW0sbQRjd1/4VH/sblLb0Ua3ikyAE8tKgIgRBBTF4AQlKbAQlBgQFLzQmVEUKYlM13kESNRIhNrddk53Z3cnOzO5mZzuJ0kKxB2Z3duc73/nO2RVEUYQQAg6EZJVDyZXVt9PFNwO/vl0UdCDKAMrgdQimaToctu0AwBByHGZQI/Gg7d+pABHToM7/IRBC+K2m67mVlaerK7q8LH14b3wJ8Jcj2/DjfMG1oUDd4k1tm/0DgVLqMMaV+ZHtOOburjI4iNfXOXnlFH5eK87+UInByQ6rL15k/1WmDeU6n89eq2nDw2Jnp+LxOERPP5m+aPb7XbV+1Cj4U/lCNgixIKyWy5hSglA+Hk9tbuZPT1Wx9JgtnWTgfUFBEOgcGFcRIvVcXloIMBQqdXVVenpoMqlw2Y4ONDaG4/FSR2f5U5ud+Gnd3lRcLkuSeDWORuX+fvacMfesnp2Jfj9YWqrxj5VISGtr1cNDI5erbG1VvkZosWTJAO3sMIy5V/z4qB4cUPvFt4CSycrsLAiFnFqNP+uEsMZIpmUZDQWekNIYVZufB4uLMBAotrdXPR4bIQFzL/f3vCWxbcqYTqnFGA9XtyzyTGZM0TS+0/b28P6+fnSUm54G4bBNiIDOz9WbGxyLlXw+ODNjplLayYnO/QeDos9HNjbI6mphfFzhmgsLRb8fh8NIlg3DqHsuNTfLra1ab++DywWGh6tDQ+V373Svtzwykunu1gMBZW4u43ark5NwdPTO7damprCmWc9p42zWkSSekHZxQdJpHhvL520AuBft8tK8vpaj0adYjB4fS5FIORJRt7eVZBKlUmY6LRiW9fqP28gPTkxkmppQMCh5vZmWFti45tvaMgMDt319vwEmUczZhGckBgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;virtual dom updating&quot;
        title=&quot;virtual dom updating&quot;
        src=&quot;/static/e229c27fe81bb40185f5a44369b4f46c/799d3/virtual-dom-updating.png&quot;
        srcset=&quot;/static/e229c27fe81bb40185f5a44369b4f46c/00d96/virtual-dom-updating.png 148w,
/static/e229c27fe81bb40185f5a44369b4f46c/0b23c/virtual-dom-updating.png 295w,
/static/e229c27fe81bb40185f5a44369b4f46c/799d3/virtual-dom-updating.png 590w,
/static/e229c27fe81bb40185f5a44369b4f46c/2cc4f/virtual-dom-updating.png 826w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;它会检查前一个和下一个渲染过的元素是同一类型和 key，随后对类型和 key 的匹配进行协调。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; prevRenderedElement &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_renderedComponent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_currentElement&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; nextRenderedElement &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_instance&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Calculator.render() 方法被调用&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;这就是我们组件的 render 方法被调用的地方。即 &lt;code class=&quot;language-text&quot;&gt;Calculator.render()&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;和解的过程通常是经历如下步骤：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5c7876a7db015a9253bbc118f2de9942/026e8/reconciliation-process.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 139.3313667649951%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAAE3UlEQVQ4y11UW29TRxA+P6tPfaiQ+lBVqlS1UvtSqQ9V1T6BRAVUBChqoVwElFtakQINNMRJuNlNQhKSloTmQhzbsZ34Ft/t+O6z57KXs3vOdtYGQhmtpTnj+WZnvplZTUpZtFsj2cVYIyc9mUCVrFEDhVJ6Kjwea+akK7Nod6y8TBiVjvi1MHck6esyC4Aa/K6X5/dt/LzezcquPb4xPZN4LrnXRfpgyL9ZzUgm/fnVj16cb6Eut8jJxMSXm781iP4SzKVLpfAIcQg2HUxMZArqSs9fWW9QBA4l1FhrpATkIOW5dOCb8BBitgLXScuhjnRdx7IGEuMHk6M7pZ2jmyMT+X+lzZlwJBODyScfrp6NdgtgORwb+Xj9QsVuK/Dg5lI5l+eMccs6nPrj2+3ByE78QHz4VvqpYI7DHUjsTmnp8/DV7XZROvJOZelSfpoIpsD3H4dbrTojxGNsOFy8tpyhlpkyKh3H4q64m3v2oLjCPZd5Io9qL+opwLSpeTYTmKqFNRQNVep1alsCk3OT9e8ftIiOpOeBE+POo/Df/q0l9SHlk2roWPSeJCJSS7/7/NBP26Oa7IsQwrZHN8yhZeTYtucJsEFuJ2K+i9uBvkvNaCc7ZVDyXf29sccXgxENqILAnhAepX0nF2PPVcRanHwVvfFdYgR0dbnwPKbsDd055qtPrKKXNwPYJQT+UQdu7oExpycSE5d2pvo+u2Y73iyAUmjT9wfLFxdae2AP49c3yx74tXg9CuK72bHNBcmcSrN7/a/4P9GKtudBiORcKZB/T3kLvNHO3i+sgIIw/3O1vZ6398CuK6xuByNEMcadDnUc+koIJR5xBrZ8H6ycKVpN5dwL9wZYuIJybpgMxDSpYTic9w/0TDre5dzM1/Hf67iruHNVNlqPSRWmgfVYp0gphqqUkTHFguNAF1UVnHscpuZ/5Wi9Fih6hnLz7ywOBBspuMR9VYkLIRhzKYWjAoECvYBx7JGyB/aVlz8JXoq1c5L3uPa8vYr6fVaKp9IFegwDlL2aYcYoZWpmgPa3xHvboApxXa0PcyhrmJ2ZQgg2hADhDrcJ8AZLBaSzyzvTwWbGIex8KrDVLkCsRmijNDurwLZtU0wKrepIbF4QhnXd84AzWEigmesG+mLt6sPcimEYn639slCOSCEzwfVIIKBB6rg3W0B+yqimzZrE9koOj4SIjkU/51B9B3EMSrCWxlxtsiiVeDqtWQTPp9c7SHdt9qwY+SF6X6DOycn6vsF2YlcFbZnsylztWdKoI3Jlrv48rR4mWEFhWZppW8uJsGGZELhgNlfzEVkpzryoXZhtNU3VD9PiN2eLi7F2V2c3Z0vL270hQYZASLMZWakmXOiWWk2px7czw8M4k5GmztstqeuR7NbA1JwvuLaYDB6bWhjbWGOdpqg3YH80eBkPbNwuNnfT5RzyWDeZLN0dpoVcbwZVzb7s4qHwjVORe6ej48ejt07HxxoY9bdFq7bq05k12Pv9odvnE34YKUbFZoUFy04FqbQfVdf3R+6cS/qhYQejI2dS/v6Lr8CTMePTIfQ0hc4kfdeSTxi2t0udIw+rB8aroys1zrDDHNu0XC7gEBt7b0yMNhk3912rLiRNQ6IGNcGUrRk/zppHp83AJpKCwdgpgabDQwzr8Qb4Pzad6zej5SOnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;reconciliation process&quot;
        title=&quot;reconciliation process&quot;
        src=&quot;/static/5c7876a7db015a9253bbc118f2de9942/799d3/reconciliation-process.png&quot;
        srcset=&quot;/static/5c7876a7db015a9253bbc118f2de9942/00d96/reconciliation-process.png 148w,
/static/5c7876a7db015a9253bbc118f2de9942/0b23c/reconciliation-process.png 295w,
/static/5c7876a7db015a9253bbc118f2de9942/799d3/reconciliation-process.png 590w,
/static/5c7876a7db015a9253bbc118f2de9942/2a3d6/reconciliation-process.png 885w,
/static/5c7876a7db015a9253bbc118f2de9942/026e8/reconciliation-process.png 1017w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;红色的虚线表示对于下一个子组件或子组件的后代都重复执行这些协调步骤&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;上面的流程图就是通过虚拟 DOM 更新真实 DOM 的过程。&lt;/p&gt;
&lt;p&gt;所以在我们的例子中，协调的结果如下：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 260px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/272554ad013f2f522a901aa6faa896eb/54dde/reconciliation-result.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 104.23076923076924%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAAB5klEQVQ4y5VUi46bMBDk/z8wOrVHGhIIYBt7/X5Dl0srRW1ylxsZgw2zOx6vaZRWnHI7m5JysuBYn6x0tnCeGEsz8RPx3oa1rtt/aHLOKSQ9aTMrINdre6BjPxPx/n7tOnod1PCDO+23R2jwiilabeQZOAPClve3du6nvj+zhSQf3KyTj0/JQghgIE8QtA8hmEGri1zXdfsKOxkkCMJFy40w1lq4gDjxlNK6rTd8RuaCCyYwm9cOIXsJZ1FyeSmzVJKNlP9cnHKllJpqiWX7WvUHudaKO+GFM1TXUm8vds1/2z58JL653bTVEj07wytq/yX74J2yikqsFJRhozXBuIgbbGywpRbsc8mppHsJzX2kRS3a6ZDCsAzt1OJwhHGECaPMMCMZH8paHpOVUm3bHo/HYRi89+jFS7L/kL0KOaBIYUU7txNMVLEzu4CVPnpM+xkZLKSacs0dPR/6A5I72v0iJ1wwxsIevcDQT8gAXdcRSnB5+BE6hw6VD/ExR1wFTj41TFpFFmLdnoEpJp00HktW7D7V/cg+lY2BJUjvPCYUFk6kW/SCix/FiNuGXmB7TMYy8trri7TMfLtIoot4MGQPOeVbrL1i73CbfEDGn4mhRvUyxbR9B01OSV6AvhEn3Ss/gHv8Bl5qymvVzqY8AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;reconciliation result&quot;
        title=&quot;reconciliation result&quot;
        src=&quot;/static/272554ad013f2f522a901aa6faa896eb/54dde/reconciliation-result.png&quot;
        srcset=&quot;/static/272554ad013f2f522a901aa6faa896eb/00d96/reconciliation-result.png 148w,
/static/272554ad013f2f522a901aa6faa896eb/54dde/reconciliation-result.png 260w&quot;
        sizes=&quot;(max-width: 260px) 100vw, 260px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;我们将步骤分解来看一下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;协调开始于组件的主 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;div class=&amp;quot;container&amp;quot;&amp;gt;&lt;/code&gt; 节点。&lt;/li&gt;
&lt;li&gt;它的子节点中包含 &lt;strong&gt;Output&lt;/strong&gt;，所以 react 会对子节点协调。&lt;/li&gt;
&lt;li&gt;现在子节点有了自己的子节点 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;hr&amp;gt;&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;h2&amp;gt;&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;react 开始协调 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;hr&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;下一步 react 协调 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;h2&amp;gt;&lt;/code&gt;，由于它的子节点是 &lt;strong&gt;Output&lt;/strong&gt;：来自 &lt;strong&gt;state&lt;/strong&gt; 的文本内容，所以它会对两者进行协调。&lt;/li&gt;
&lt;li&gt;首次 &lt;strong&gt;Output&lt;/strong&gt;：文本开始协调，由于没有变化，所以 DOM 不需要更新&lt;/li&gt;
&lt;li&gt;后来来自 &lt;strong&gt;state&lt;/strong&gt; 的 &lt;strong&gt;output&lt;/strong&gt; 得到了一个新值，react 开始协调并更新真实的 DOM。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;渲染真实 DOM&lt;/h3&gt;
&lt;p&gt;在协调过程中，只有我们的 &lt;strong&gt;Output&lt;/strong&gt; 部分如在页面上闪烁绘制的一样发生了变化。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 518px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/38e2282df894c8a93a006209aef05c9b/9eb08/paint-flashing.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAA90lEQVQoz6WQS2+DMBCE/f//T2/NIRwIUQBH4RUqioOggSAHBMTEEK8pfajqoQ1IGX2HPezMjha5e5+QMI7j5C3xPM9/CRzHPRBS180wDFLK4X+h9UbHGKdZFkXRWtM2uqmqK1M36LmcNjN2aduW0nPXd3B39Q/zSlNt29INc+/7TfNRFWAMkXJGEAIh6roWQnyVhF+aNvuvYUjIKcs5vzLG2k+NA+d82vxkLixntzUwpVSCBAHfzLlMLwW7tmNz3nEBor/1P4wvvA9SdopiL+3Me8YLN3NzyI/8mHbpHJB1sLYBjqskOAVpk1ZQFX1R3so5oOEBvQMY4ncu9BnnQQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;paint flashing&quot;
        title=&quot;paint flashing&quot;
        src=&quot;/static/38e2282df894c8a93a006209aef05c9b/9eb08/paint-flashing.png&quot;
        srcset=&quot;/static/38e2282df894c8a93a006209aef05c9b/00d96/paint-flashing.png 148w,
/static/38e2282df894c8a93a006209aef05c9b/0b23c/paint-flashing.png 295w,
/static/38e2282df894c8a93a006209aef05c9b/9eb08/paint-flashing.png 518w&quot;
        sizes=&quot;(max-width: 518px) 100vw, 518px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;center&gt;只有output被重新绘制&lt;/center&gt;
&lt;p&gt;在真实 DOM 中的更新：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7164951a80f4c007755d05771b874233/299c1/actual-dom-update.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 69.16354556803995%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACg0lEQVQoz4VSW08TQRjdP+Bf8Cf46AMI8qAJL8YHL9GQ+GBMNF4STSDRxERDonhBKBApPABGoKAE5B4RRQoNpaiAVVpuLdCml+0ue5uZnZm9uttiTBTieZh88+U7Od+ZM4z9G1YeToE1s8irHnqo+tehbWLLPhDMX3fNsFmJBNf4hU0xuws4ERDd+g/Z0RQl2STAt6yd9OYaZ5HTvDsql7fmKnyKpBr5mf3IZn5fXXcmjN4lcq1PbJ5Tnf6bRXB7gK+fVhwjLnlP5l/lwmlaV/uVY03smU6IqJkQ9UcjialVZV9Zl2xatuNLAqquURXT4FpucH57KS7woryZkb9tgzgLZAVQShyoKoII/yHX+dHxpnR5K7ewBa/0cCWeVOWw9CECij2p0ib2/SqOZPCptt04R53pwTC82OVomYVdmJkYuTeUq/cDDppjK6huShiLkBineWel5oCywelZRW8PQYW4e69nYXcIE6TvKa9k6OMJriUgFUxhBAppU+waccPTdKDITuENwoZJ5RU7dOF7zY2Yl6Uig3Vzi8OsjA0KLQ2pULFM3TIogQLFbmCmYSiSYNvk7ZLcPoe/WJ9rU55Wrk0yZWYtq8ZSuwNh/GA4/fyjEM3QnzvCBqs2zijVY9meZdK1iGvG055psWNeeTGRbplTRQgpdZ+NKX4pne4Qz3WBkvrE2U5QOYLKmoVbQ+iSTzham7wzSm6+A2UNyfM+fLlXKvUkK3pwmkcayZN5ZEvEjmbp+AoKxKmATF61JWyFtvB4RF3Yof1fc51BfjKK+kLs6xDXF06ss8nN9E5CZJmD/q2Rj+Opnx5+Ap7N0OpP8Egtrgr8OBG9X7RcUxXpvh5u/wUF2dxROBy9qAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;actual dom update&quot;
        title=&quot;actual dom update&quot;
        src=&quot;/static/7164951a80f4c007755d05771b874233/799d3/actual-dom-update.png&quot;
        srcset=&quot;/static/7164951a80f4c007755d05771b874233/00d96/actual-dom-update.png 148w,
/static/7164951a80f4c007755d05771b874233/0b23c/actual-dom-update.png 295w,
/static/7164951a80f4c007755d05771b874233/799d3/actual-dom-update.png 590w,
/static/7164951a80f4c007755d05771b874233/299c1/actual-dom-update.png 801w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;总结&lt;/h2&gt;
&lt;p&gt;尽管例子比较简单，希望它能够给到我们一个基本的对于 react 底层执行的理解。&lt;/p&gt;
&lt;p&gt;React 的协调过程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;将前一个内部实例和下一个内部实例作比较&lt;/li&gt;
&lt;li&gt;更新实质是 JavaScript 对象的组件树结构的内部实例&lt;/li&gt;
&lt;li&gt;只有当前组件以及子代组件真正发生变化才会更新真实的 DOM&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://medium.com/@gethylgeorge/how-virtual-dom-and-diffing-works-in-react-6fc805f9f84e&quot;&gt;https://medium.com/@gethylgeorge/how-virtual-dom-and-diffing-works-in-react-6fc805f9f84e&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[了解中间件]]></title><description><![CDATA[最近在看 Redux 文档，了解了 redux 的工作原理，发现 action 只能同步被 dispatch，那有没有办法执行异步调用呢？答案是通过中间件来实现。之前简单了解过 Node.js 服务端框架 Express 和 Koa…]]></description><link>https://www.keisei.top/understanding-the-middleware/</link><guid isPermaLink="false">https://www.keisei.top/understanding-the-middleware/</guid><pubDate>Sun, 12 Jan 2020 22:07:00 GMT</pubDate><content:encoded>&lt;p&gt;最近在看 Redux 文档，了解了 redux 的工作原理，发现 action 只能同步被 dispatch，那有没有办法执行异步调用呢？答案是通过中间件来实现。之前简单了解过 Node.js 服务端框架 &lt;a href=&quot;http://expressjs.com/&quot;&gt;Express&lt;/a&gt; 和 &lt;a href=&quot;http://koajs.com/&quot;&gt;Koa&lt;/a&gt;，它们的机制也依赖中间件这一概念，通过在接受请求和发送响应之间增加代码做额外的处理工作。比如，Express 和 Koa 中间件可以增加 CORS 头，记录日志，压缩等等。中间件最重要的特点是它可以链式组合。可以在一个项目中使用多个独立的第三方中间件。&lt;/p&gt;
&lt;p&gt;Redux 中间件解决了不同于 Express 和 Koa 的问题，但从概念上讲是相似的。它在分发 action 和抵达 reducer 之间提供了一个第三方切入点。我们可以用 Redux 中间件记录日志，上报崩溃异常，请求异步 API，路由切换等等。&lt;/p&gt;
&lt;h2&gt;理解中间件&lt;/h2&gt;
&lt;p&gt;中间件可以做很多事情，包括执行异步 API 请求，但理解它是如何演进而来的非常重要。我们将以记录日志和上报异常为例来思考使用中间件的过程。&lt;/p&gt;
&lt;h3&gt;问题：记录日志&lt;/h3&gt;
&lt;p&gt;Redux 的一个优势是它改变状态是可预测的、透明的。每次 action 被分发，新的 state 被计算、存储。state 不能改变它自身，只能通过特定的 action 来更新。&lt;/p&gt;
&lt;p&gt;如果我们记录每次 action 的发生和计算后的 state，在发生错误时，回过头看我们的日志，找出哪个 action 破坏了 state：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6df659574ae75aa498200a8d4c0359c1/c7896/logging.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 42.62589928057554%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABsUlEQVQoz0WSiY6kMAxE+///cGa2m5twkwNyAV1TZLe1SCUrceK8snk8sxJ5USLEiHgcOG7FWyeuGHB5m+J5vHFdVLj3HK7zwOd7v+/cleJD9AtaIVA3IsWiLDF3M9ZCYat66K8Cpplg2hk7H/ZthS1voLoFm7WQSieQT+HH85XjleXY9h3OORhj4K2HNwFBO8oi7h7ROkStcewbwsZ9Y+G0glkWRN67/lGScIXoOszLimma0Q095KSghYHrR+x5CTuQbuR6mBAGAd8PKWc7AVMxv8w4P5Z//jzZwwrfjMu6QkoJu1t4FeCkT/Im4thobRpxOpKZA1YHmNsyqeN5/rdcNSOatmX/ukQ4zTPUpEm4JZI9K+CYc6IhKclbCb06HJ5D5CCD9xzYgTcJ/1ru+kRYlHUq/PX9A7lKuMXTCjU7EvGy0fBsTWSPHemstNCbwcRWhc9QqEdWCA4lY8EqUZZ1k3pobwrFw+ypb+tk91YYuVY7H2NeG4S2gRctLHvp5IqH4uZKonsoC9WSUi0Kqjb8VWi9lth6Tn4cYLMXbJ7B1RULap6hRg6yqTH1Pa1H/AIuZ68GoIlOYAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;logging&quot;
        title=&quot;logging&quot;
        src=&quot;/static/6df659574ae75aa498200a8d4c0359c1/799d3/logging.png&quot;
        srcset=&quot;/static/6df659574ae75aa498200a8d4c0359c1/00d96/logging.png 148w,
/static/6df659574ae75aa498200a8d4c0359c1/0b23c/logging.png 295w,
/static/6df659574ae75aa498200a8d4c0359c1/799d3/logging.png 590w,
/static/6df659574ae75aa498200a8d4c0359c1/2a3d6/logging.png 885w,
/static/6df659574ae75aa498200a8d4c0359c1/c7896/logging.png 1112w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Redux 应该如何来实现呢？&lt;/p&gt;
&lt;h3&gt;尝试 1：手动记录&lt;/h3&gt;
&lt;p&gt;最原始的方式是每次调用 &lt;a href=&quot;https://redux.js.org/api/store#dispatchaction&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;store.dispatch(action)&lt;/code&gt;&lt;/a&gt; 时记录 action 和下一个 state。这并不是真正的方案，但是可以首先助于理解这个问题。&lt;/p&gt;
&lt;blockquote&gt;
&lt;h4&gt;注意：&lt;/h4&gt;
&lt;p&gt;当使用 &lt;a href=&quot;https://github.com/reduxjs/react-redux&quot;&gt;react-redux&lt;/a&gt; 或其他类似的绑定工具时，我们不需要直接访问组件的 store 实例。在接下来的内容中，我们假定直接向下传递 store。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;当我们创建一个 todo 并记录日志时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; action &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;addTodo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Use Redux&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;dispatch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这实现了我们想要的，但我们不想每次都要加这种样板代码。&lt;/p&gt;
&lt;h3&gt;尝试 2：包裹 Dispatch&lt;/h3&gt;
&lt;p&gt;我们将记录的代码抽成一个函数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dispatchAndLog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;store&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; aciton&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;dispatch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以在任何地方替换 &lt;code class=&quot;language-text&quot;&gt;store.dispatch()&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;dispatchAndLog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;store&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;addTodo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Use Redux&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;到这里差不多了，但是每次都引入这个特殊的函数还是不够方便。&lt;/p&gt;
&lt;h3&gt;尝试 3：猴子补丁 Dispatch&lt;/h3&gt;
&lt;p&gt;如果我们把 store 实例中的 &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt; 函数替换掉呢？Redux 的 store 只是有&lt;a href=&quot;https://redux.js.org/api/store/&quot;&gt;一些方法&lt;/a&gt;的普通对象，我们可以使用猴子补丁方式来实现 &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dispatch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;dispatch&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dispatchAndLog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这快要达到我们想要的了，无论在哪里分发 action，总会保证记录日志。猴子补丁虽然不推荐，但在此实现了我们的目的。&lt;/p&gt;
&lt;h3&gt;问题：上报异常&lt;/h3&gt;
&lt;p&gt;如果我们想应用更多的这种转换后的 &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt; 怎么办？&lt;/p&gt;
&lt;p&gt;一个不同的有用的转换是在生产环境上报 JavaScript 异常。全局的 &lt;code class=&quot;language-text&quot;&gt;window.onerror&lt;/code&gt; 事件不是可靠的，因为它在某些旧的浏览器上不能提供堆栈信息，这对找出发生报错的位置是非常关键的。&lt;/p&gt;
&lt;p&gt;如果我们在分发任何 action 时遇到了异常，我们将堆栈信息，触发异常的 action，当前的 state 发送到异常搜集服务商如 &lt;a href=&quot;https://getsentry.com/welcome/&quot;&gt;Sentry&lt;/a&gt; 岂不是非常有用？这种方式在开发过程中就可以重现。&lt;/p&gt;
&lt;p&gt;然而，将日志记录和报错上报分别处理是非常重要的。理想情况下，我们希望它们是在不同 package 下的不同模块。否则我们无法拥有此类工具的生态系统。&lt;/p&gt;
&lt;p&gt;如果日志记录和异常上报是单独处理的，可能的代码如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;patchStoreToAddLogging&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dispatch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;dispatch&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dispatchAndLog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;patchStoreToAddCrashReporting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dispatch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;dispatch&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dispatchAndReportErrors&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Caught an exception!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      Raven&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;captureException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        extra&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          action&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          state&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果这些函数是作为独立模块发布的，我们可以这样来为 store 打补丁：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;patchStoreToAddLogging&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;store&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;patchStoreToAddCrashReporting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;store&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;到目前为止，还是不够好。&lt;/p&gt;
&lt;h3&gt;尝试 4：隐藏猴子补丁&lt;/h3&gt;
&lt;p&gt;猴子补丁是一种 hack 方式。在之前我们有新的函数替换了 &lt;code class=&quot;language-text&quot;&gt;store.dispatch&lt;/code&gt;。如果它们&lt;em&gt;返回&lt;/em&gt;新的 &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt; 函数呢？&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dispatch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Previously:&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// store.dispatch = function dispatchAndLog(action) {}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dispatchAndLog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们可以在 Redux 内部提供一个帮助函数来应用真正的猴子补丁的具体实现细节：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;applyMiddlewareByMonkeypatching&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;store&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; middlewares&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  middlewares &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; middlewares&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;slice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  middlewares&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;reverse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 每个中间件转换dispatch函数&lt;/span&gt;
  middlewares&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;middleware&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dispatch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;store&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们可以应用多个中间件：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;applyMiddlewareByMonkeypatching&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;store&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;logger&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; crashReporter&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然而，这仍然是猴子补丁，我们内部隐藏了实现并没有改变这个事实。&lt;/p&gt;
&lt;h3&gt;尝试 5：移除猴子补丁&lt;/h3&gt;
&lt;p&gt;为什么我们要覆写 &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt;？当然可以延后执行，但另一个原因是：每个中间件可以访问并调用前一个包装过的 &lt;code class=&quot;language-text&quot;&gt;store.dispatch&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 必须指向前一个中间件返回的函数&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dispatch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dispatchAndLog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这本质就是链式中间件！&lt;/p&gt;
&lt;p&gt;如果 &lt;code class=&quot;language-text&quot;&gt;applyMiddlewareByMonkeypatching&lt;/code&gt; 没有在处理完第一个中间件后立即赋值 &lt;code class=&quot;language-text&quot;&gt;store.dispatch&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;store.dispatch&lt;/code&gt; 会保持指向原始的 &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt; 函数。那么第二个中间件也会绑定原始的 &lt;code class=&quot;language-text&quot;&gt;dispatch&lt;/code&gt; 函数。&lt;/p&gt;
&lt;p&gt;但是也有不同的链式调用方式。中间件可以接受 &lt;code class=&quot;language-text&quot;&gt;next()&lt;/code&gt; dispatch 函数作为参数，而不是从 &lt;code class=&quot;language-text&quot;&gt;store&lt;/code&gt; 实例中读取。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;wrapDispatchToAddLogging&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dispatchAndLog&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个层级看起来比较深，ES6 的箭头函数看起来更清爽：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;logger&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;crashReporter&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Caught an exception!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    Raven&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;captureException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      extra&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        action&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        state&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这就是 Redux 中间件的真实形态。&lt;/p&gt;
&lt;p&gt;现在中间件接收 &lt;code class=&quot;language-text&quot;&gt;next()&lt;/code&gt; dispatch 函数，并返回一个 dispatch 函数，该函数又充当左侧中间件 &lt;code class=&quot;language-text&quot;&gt;next()&lt;/code&gt;，以此类推。它仍然可以访问某些 store 的方法，如 &lt;code class=&quot;language-text&quot;&gt;getState()&lt;/code&gt;，因此 &lt;code class=&quot;language-text&quot;&gt;store&lt;/code&gt; 作为顶级参数仍然可用。&lt;/p&gt;
&lt;h3&gt;尝试 6：简单使用中间件&lt;/h3&gt;
&lt;p&gt;我们可以将 &lt;code class=&quot;language-text&quot;&gt;applyMiddleware()&lt;/code&gt; 替换 &lt;code class=&quot;language-text&quot;&gt;applyMiddlewareByMonkeypatching()&lt;/code&gt;，它包装了 &lt;code class=&quot;language-text&quot;&gt;dispatch()&lt;/code&gt; 函数，并返回 store 的副本：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 注意：这不是Redux 真实的实现&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;applyMiddleware&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;store&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; middlewares&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  middlewares &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; middlewares&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;slice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  middlewares&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;reverse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; dispatch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dispatch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  middlewares&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;middleware&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dispatch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;store&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dispatch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;assign&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; dispatch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;最终版本&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;logger&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;dispatching&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;next state&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;crashReporter&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;store&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;action&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Caught an exception!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    Raven&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;captureException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      extra&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        action&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        state&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; store&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;以下是我们如何在Redux store中应用：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;createStore&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; combineReducers&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; applyMiddleware&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;redux&apos;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; todoApp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;combineReducers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;reducers&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; store &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createStore&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  todoApp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// applyMiddleware() 告诉 createStore() 如何处理中间件&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;applyMiddleware&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;logger&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; crashReporter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;现在任何被分发的action都会经过 &lt;code class=&quot;language-text&quot;&gt;logger&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;crashReporter&lt;/code&gt; 处理：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;store.dispatch(addTodo(&amp;#39;Use Redux&amp;#39;))&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://redux.js.org/advanced/middleware/&quot;&gt;https://redux.js.org/advanced/middleware/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[浅析 React Hooks]]></title><description><![CDATA[React Hooks 在 React 16.7 版本发布后，在社区掀起了一股新的浪潮，真的是谁用谁都说真香。刚使用 Hooks 时难免会对该机制的原理感到神奇，在遇到问题时，由于它背后复杂的调用栈我们很难进行调试，所以有必要更深层次了解 React Hooks…]]></description><link>https://www.keisei.top/unveil-react-hooks-system/</link><guid isPermaLink="false">https://www.keisei.top/unveil-react-hooks-system/</guid><pubDate>Wed, 08 Jan 2020 23:26:00 GMT</pubDate><content:encoded>&lt;p&gt;React Hooks 在 React 16.7 版本发布后，在社区掀起了一股新的浪潮，真的是谁用谁都说真香。刚使用 Hooks 时难免会对该机制的原理感到神奇，在遇到问题时，由于它背后复杂的调用栈我们很难进行调试，所以有必要更深层次了解 React Hooks 系统，这样我们遇到问题可以快速定位甚至提前避免。今天我们就来看一下 React 是如何实现的？&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/614488308537ef9bd8f60457869947e3/3dead/react-hooks-representation.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.98830409356725%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAADGElEQVQoz41RC0hTURi+m7k5TVNTVCh1EysV6SXYAyUIyqRMc5uiqCwtRVPnA0wwE8oUUckkH4WYVlIpOt3u5szNu9mcblPm3J27alNnGJj5oocP6nS3MEIoPPBxfr7/+98QtIun4zMO6GCGt47PJO5CzPTUdYV5oJyL7rrOUHctl07VcOk0LY9BxZNQUZjhicMfx0mUH+WF8qNp+E9Df/twMKl/2TRIyw23USE5tqiywmFUfs/+C3rdCkznWc0jmTZ6XspeDE60QWE6WcePJhvbg0kLLT6kudZAkp7PoGhhJgUTXKPgE1DwhLgdQYFCjYAgM0hF8pl+IDNIFus4Naf/NU3t2Ljly1G19XMdRvrv2IOz3QlKI1I+NNP/iId1uHHyC2i8irIr64gocK7ttfe2Tjj+pkr6Hjb2TXRxinhJLiYu+7HUo7BeTAJgHUqvFHtBUu1SrmRsjS1SL7O2Az/1Cjk/RlTg+5AcLCMipT1E24PTFl2qvoZejX6+RzMiYDcwqSZtQmGLz3ZcarnYBxrQr26pZ7fAwPjKakp2sRvOk43czgGgHgFApQCfRT2GQy5HbXHermNA8UQ8ujLVo57hxN8PMXVOjs6qDlDMAOfhqVV7dpXED+INfXRBtEYvkcZAWwKL1qZKa5K+O4tSRPtNMTi4gohrtjsQoG0tkknhphiDZSXCLE8T1/TWkPROt7Ih16/O13aOx5mFMoNYKJ+V4EdBvj7l1pw1VcbhuGPVhEZZOeOVsi6/Wf4w+W5rqtlf+kJx/Fn35O1GwWT2g2aVLxRUdIsgN0jS1bP9lcpppJiHVLvtPFpefYH5z+2I9s1uowfntkcFQACYudjSPld6If9UZCE/IK5M6von6IQG+FsOA+czC8Aq4wOwTdKv293ANvax1YsWJj8nJsKyMzXWEc5kOfLS4u25MREOwvDL+5tScp3gtAwHbhrbsSk5x8mcrHh6zSppYjP95uTmhURsw4+FbR5mYVtHWBNbJtu814aCEsJgQAhRHniJaCQHQcLwMIog8ioVWEIE1fljRPU5P+LPgxDhF+XhixWhsoYwAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;react hooks representation&quot;
        title=&quot;react hooks representation&quot;
        src=&quot;/static/614488308537ef9bd8f60457869947e3/799d3/react-hooks-representation.png&quot;
        srcset=&quot;/static/614488308537ef9bd8f60457869947e3/00d96/react-hooks-representation.png 148w,
/static/614488308537ef9bd8f60457869947e3/0b23c/react-hooks-representation.png 295w,
/static/614488308537ef9bd8f60457869947e3/799d3/react-hooks-representation.png 590w,
/static/614488308537ef9bd8f60457869947e3/3dead/react-hooks-representation.png 684w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;center&gt;React hooks 粗略概要&lt;/center&gt;
&lt;p&gt;首先让我们来了解一下确保 hooks 在 React 作用域内被调用的机制，因为如果没有在正确的上下文执行 hooks 是没有意义的：&lt;/p&gt;
&lt;h3&gt;The dispatcher&lt;/h3&gt;
&lt;p&gt;dispatcher 是一个包含 hooks 函数的共享的对象。它在 ReactDOM 渲染的时期动态地被分配或被清除，并保证用户在 React 组件外不能访问 hooks（&lt;a href=&quot;https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberHooks.js#L62&quot;&gt;源码实现&lt;/a&gt;）。&lt;/p&gt;
&lt;p&gt;dispatcher 在每个和每次 hook 调用时通过 &lt;code class=&quot;language-text&quot;&gt;resolveDispatcher()&lt;/code&gt; 函数来处理（&lt;a href=&quot;https://github.com/facebook/react/blob/19f6fe170ce920d7183a5620f4e218334c8bac62/packages/react/src/ReactHooks.js#L21&quot;&gt;源码实现&lt;/a&gt;）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; currentDispatcher&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dispatcherWithHooks &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;/* ... */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;resolveDispatcher&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;currentDispatcher&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; currentDispatcher&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Hooks can&apos;t be called&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useXXX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dispatcher &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;resolveDispatcher&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; dispatcher&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;useXXX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;renderRoot&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  currentDispatcher &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; dispatcherWithHooks&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;performWork&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  currentDispatcher &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;center&gt;Dispatcher 简单实现&lt;/center&gt;
&lt;p&gt;我们有了初步认识，现在正式来了解 hooks。首先介绍一个新概念：&lt;/p&gt;
&lt;h3&gt;The hooks queue&lt;/h3&gt;
&lt;p&gt;在底层，hooks 在它们调用顺序中作为 node 节点链接在一起。它们如此表现是因为 hooks 并不是简单地创建和销毁。它们通过一种机制来实现。每个 hook 有多个属性：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在初始渲染时创建它的初始状态&lt;/li&gt;
&lt;li&gt;它们的状态随时可以更新&lt;/li&gt;
&lt;li&gt;React 在将来的渲染时能够记住 hook 的状态&lt;/li&gt;
&lt;li&gt;React 能够基于调用顺序提供正确的状态&lt;/li&gt;
&lt;li&gt;React 知道 hook 属于哪个 fiber&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;相应的，我们需要重新思考我们看待组件状态的方式。目前为止我们理解的是简单的对象：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  foo&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  bar&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;bar&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  baz&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;baz&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;但是当处理 hooks 时，它们应该被当作队列来看待，每个节点代表了状态中的每个 model：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  memoizedState&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  next&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    memoizedState&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;bar&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    next&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      memoizedState&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;baz&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      next&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;每个 hook 节点的 schema 的&lt;a href=&quot;https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L243&quot;&gt;实现&lt;/a&gt;，hook 上这些属性重点关注 &lt;code class=&quot;language-text&quot;&gt;memoizedState&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;next&lt;/code&gt;，其他的属性专门用于 &lt;code class=&quot;language-text&quot;&gt;useReducer()&lt;/code&gt; hook 来缓存 dispatched actions 和 基础状态来保证在大多数情况下 reduction 过程可以作为 fallback 重复执行：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;baseState&lt;/code&gt; - 传入 reducer 的 state 对象&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;baseUpdate&lt;/code&gt; - 创建 &lt;code class=&quot;language-text&quot;&gt;baseState&lt;/code&gt; 的最新 dispatched action&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;queue&lt;/code&gt; - dispatched actions 的最新队列，等待传入 reducer&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;回到 hooks，在每个及每次函数组件调用前，&lt;code class=&quot;language-text&quot;&gt;prepareHooks()&lt;/code&gt; 函数会先调用，当前的 fiber 和在 hooks 队列中的的第一个节点被保存在全局的变量中。通过这种方式，每次我们调用 hook 函数（&lt;code class=&quot;language-text&quot;&gt;useXXX()&lt;/code&gt;）它都知道要在哪个上下文执行。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; currentlyRenderingFiber&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; workInProgressQueue&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; currentHook&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;prepareHooks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;recentFiber&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  currentlyRenderingFiber &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; workInProgressFiber&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  currentHook &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; recentFiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;memoizedState&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;finishHooks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  currentlyRenderingFiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;memoizedState &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; workInProgressHook&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  currentlyRenderingFiber &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  workInProgressHook &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  currentHook &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;resolveCurrentlyRenderingFiber&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;currentlyRenderingFiber&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; currentlyRenderingFiber&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Hooks can&apos;t be called&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createWorkInProgressHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  workInProgressHook &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; currentHook &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cloneHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;currentHook&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createNewHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  currentHook &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; currentHook&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useXXX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; fiber &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;resolveCurrentlyRenderingFiber&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; hook &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createWorkInProgressHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;updateFunctionComponent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token parameter&quot;&gt;recentFiber&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  workInProgressFiber&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  Component&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  props&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;prepareHooks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;recentFiber&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; workInProgressFiber&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;finishHooks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;一旦更新结束，&lt;code class=&quot;language-text&quot;&gt;finishHooks()&lt;/code&gt; 函数会被调用，在 hooks 队列中的第一个节点的引用会存储在渲染过的 fiber 的 &lt;code class=&quot;language-text&quot;&gt;memoizedState&lt;/code&gt; 属性中。这意味着 hooks 队列和它的状态可以在外部被定位：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;ChildComponent&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;useState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;useState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;bar&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;useState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;baz&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;ParentComponent&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; childFiberRef &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useRef&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;useEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; hookNode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; childFiberRef&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;memoizedState&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hookNode&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;memoizedState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    hookNode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hooksNode&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hookNode&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;memoizedState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;bar&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    hookNode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hooksNode&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hookNode&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;memoizedState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;baz&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ChildComponent&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;childFiberRef&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;center&gt;外部读取组件记忆的状态&lt;/center&gt;
&lt;p&gt;我们来看一下更详细的独立的 hooks，首先看一下常见的 state hook：&lt;/p&gt;
&lt;h3&gt;State hooks&lt;/h3&gt;
&lt;p&gt;或许会感到奇怪，但是 &lt;code class=&quot;language-text&quot;&gt;useState&lt;/code&gt; hook 在底层使用了 &lt;code class=&quot;language-text&quot;&gt;useReducer&lt;/code&gt; hook 并简单提供了一个预定义的 reducer（&lt;a href=&quot;https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L339&quot;&gt;查看实现&lt;/a&gt;）。这就是说 &lt;code class=&quot;language-text&quot;&gt;useState&lt;/code&gt; 返回的结果实际是一个 reducer state 和一个 action dispatcher。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;basicStateReducer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;state&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; action &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; action&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;state setter 还可以基于父组件当前的状态执行变更，而不需要传入不同的 prop：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;ParentComponent&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; setName&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ChildComponent&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;toUpperCase&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;setName&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;ChildComponent&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;props&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;useEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    props&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toUpperCase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toUpperCase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最后我们来看一下 effect hook，在组件生命周期起了什么主要作用和如何工作的：&lt;/p&gt;
&lt;h3&gt;Effect hooks&lt;/h3&gt;
&lt;p&gt;Effect hook 表现有些不同，并且有个额外的逻辑层：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在渲染时创建，但是在绘制结束时执行&lt;/li&gt;
&lt;li&gt;如果提供了，它们会在下次绘制前被销毁&lt;/li&gt;
&lt;li&gt;它们的调用根据定义时的顺序执行&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;每个 fiber 的 hooks 队列中保存了 effect 节点。每个 effect 的类型不同，应在合适的阶段执行：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在更新前执行 &lt;code class=&quot;language-text&quot;&gt;getSnapshotBeforeUpdate()&lt;/code&gt;（&lt;a href=&quot;https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js#L646&quot;&gt;实现&lt;/a&gt;）&lt;/li&gt;
&lt;li&gt;执行所有的插入，更新，删除和卸载（&lt;a href=&quot;https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js#L687&quot;&gt;实现&lt;/a&gt;）&lt;/li&gt;
&lt;li&gt;执行所有生命周期函数和 ref 回调函数。生命周期的函数单独执行，在整棵树的所有插入，更新删除都已被执行。该执行也触发了渲染器特定的初始 effects。（&lt;a href=&quot;https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js#L732&quot;&gt;实现&lt;/a&gt;）&lt;/li&gt;
&lt;li&gt;Effects 是通过 &lt;code class=&quot;language-text&quot;&gt;useEffect()&lt;/code&gt; hook 调度（&lt;a href=&quot;https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js#L779&quot;&gt;实现&lt;/a&gt;）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;当执行到 effect hooks 时，它们被存在 fiber 的 &lt;code class=&quot;language-text&quot;&gt;udpateQueue&lt;/code&gt; 属性中，每个 effect 节点有以下 schema（&lt;a href=&quot;https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L477&quot;&gt;实现&lt;/a&gt;）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;tag&lt;/code&gt; - 二级制数指定了 effect 的行为&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;create&lt;/code&gt; - 绘制结束后应该执行的回调&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;destory&lt;/code&gt; - &lt;code class=&quot;language-text&quot;&gt;create()&lt;/code&gt; 返回的回调函数，应该在初次渲染后执行&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;inputs&lt;/code&gt; - 一些值得集合决定 effect 应该销毁和重建&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;next&lt;/code&gt; - 在函数组件中定义的下一个 effect 的引用&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;除了 &lt;code class=&quot;language-text&quot;&gt;tag&lt;/code&gt; 属性之外，其他属性比较直接和易懂。 &lt;code class=&quot;language-text&quot;&gt;tag&lt;/code&gt; 是一些二级制值的组合：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; NoEffect &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/*             */&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; UnmountSnapshot &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/*      */&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b00000010&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; UnmountMutation &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/*      */&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b00000100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; MountMutation &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/*        */&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b00001000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; UnmountLayout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/*        */&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b00010000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; MountLayout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/*          */&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b00100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; MountPassive &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/*         */&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b01000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; UnmountPassive &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;/*       */&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b10000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对于这些二进制值常用的有管道符（&lt;code class=&quot;language-text&quot;&gt;|&lt;/code&gt;）并按位添加到单个值。然后通过连字符（&lt;code class=&quot;language-text&quot;&gt;&amp;amp;&lt;/code&gt;）来检测 tag 是否实现了某中类型。如果结果非 0，意味着 tag 指定了具体的行为。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; effectTag &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; MountPassive &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; UnmountPassive&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;effectTag&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b11000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;effectTag &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; MountPassive&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b10000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;以下是 React 支持的 effect hook 类型：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Default effect — &lt;code class=&quot;language-text&quot;&gt;UnmountPassive | MountPassive&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Mutation effect — &lt;code class=&quot;language-text&quot;&gt;UnmountSnapshot | MountMutation&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Layout effect — &lt;code class=&quot;language-text&quot;&gt;UnmountMutation | MountLayout&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以下是 React 如何检测表现实现的：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;effect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tag &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; unmountTag&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; NoHookEffect&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Unmount&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;effect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tag &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; mountTag&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; NoHookEffect&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Mount&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;基于我们已经了解的 effect hooks，我们可以从外部注入 effect 到一个确切的 fiber：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;injectEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;fiber&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; lastEffect &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; fiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;updateQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lastEffect

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;destroyEffect&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;on destroy&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;createEffect&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;on create&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; destroy
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; injectedEffect &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    tag&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0b11000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    next&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; lastEffect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    create&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; createEffect&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    destroy&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; destroyEffect&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    inputs&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;createEffect&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  lastEffect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; injectedEffect
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; ParentComponent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ChildComponent&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;injectEffect&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;参考&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba&quot;&gt;https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 装饰器]]></title><description><![CDATA[什么是装饰器 装饰器是“装饰函数（或方法）”的一种简称。它是一个通过修改传入的函数或方法的行为并返回一个新函数的函数。 我们可以在任何支持函数为一等公民的语言中实现装饰器，如 JavaScript…]]></description><link>https://www.keisei.top/understanding-javascript-decorators/</link><guid isPermaLink="false">https://www.keisei.top/understanding-javascript-decorators/</guid><pubDate>Sun, 05 Jan 2020 23:21:00 GMT</pubDate><content:encoded>&lt;h2&gt;什么是装饰器&lt;/h2&gt;
&lt;p&gt;装饰器是“装饰函数（或方法）”的一种简称。它是一个通过修改传入的函数或方法的行为并返回一个新函数的函数。&lt;/p&gt;
&lt;p&gt;我们可以在任何支持函数为一等公民的语言中实现装饰器，如 JavaScript。我们可以把函数赋值为变量或将它作为参数传递到下一个函数。有一些语言有定义和使用装饰器的特殊语法糖，其中 Python 的代码如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cashify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;wrap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$$$$&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        fn&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$$$$&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; wrap

@cashify
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sayHello&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;hello!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

sayHello&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# $$$$&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# hello!&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# $$$$&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们来看一下以上代码。&lt;code class=&quot;language-text&quot;&gt;cashify&lt;/code&gt; 是一个装饰器：它接受一个函数参数，返回值也是一个函数。我们使用 Python 的 “pie” 语法来装饰我们的 &lt;code class=&quot;language-text&quot;&gt;sayHello&lt;/code&gt; 函数，与下面在 &lt;code class=&quot;language-text&quot;&gt;sayHello&lt;/code&gt; 后面执行的结果本质上是一样的：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sayHello&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;hello!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

sayHello &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cashify&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sayHello&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最终的结果是我们在我们所装饰的函数打印内容的前后打印了 &lt;code class=&quot;language-text&quot;&gt;$&lt;/code&gt; 符号。&lt;/p&gt;
&lt;p&gt;那么在介绍 ECMAScript 的装饰器时为什么使用了 Python 作为例子呢？&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Python 装饰器的概念相比 JS 来说更加直接，更好地作为基础来解释。&lt;/li&gt;
&lt;li&gt;JS 和 TypeScript 都使用了 Python 的 “pie” 语法来装饰类的方法和属性，它们视觉和语义上是相似的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;相对来说 JS 的装饰器有哪些不同呢？&lt;/p&gt;
&lt;h2&gt;JS 装饰器和属性描述符&lt;/h2&gt;
&lt;p&gt;传递给 Python 装饰器的任何函数都作为参数装饰，JS 装饰器由于对象在 JS 中的特殊性需要更多的信息。
对象在 JS 中有属性，并且属性对应各自的值:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; oatmeal &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  viscosity&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  flavor&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Brown Sugar Cinnamon&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对于属性值，每个属性有一些其他背后的信息来定义如何工作的不同方面，被称为属性描述符：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getOwnPropertyDescriptor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;oatmeal&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;viscosity&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/**
{
  configurable: true,
  enumerable: true,
  value: 20,
  writable: true
}
*/&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;JS 会对属性的相关信息追踪：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;configurable&lt;/code&gt; 决定属性的类型是否可以修改，是否可以从对象中删除。&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;enumerable&lt;/code&gt; 控制在枚举对象的属性（如 &lt;code class=&quot;language-text&quot;&gt;Object.keys(oatmeal)&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;for 循环&lt;/code&gt;）时是否可见。&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;writable&lt;/code&gt; 控制能否通过 &lt;code class=&quot;language-text&quot;&gt;=&lt;/code&gt; 操作符来赋值&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt; 是属性的值，这是我们平时最关心的一个属性。它可以是任何 JS 的类型。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;属性描述符也有另外两个属性，JS 把它们作为“访问描述符”（更常见的名称为：getters 和 setters）来对待：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;get&lt;/code&gt; 是一个返回属性值的函数。&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;set&lt;/code&gt; 是一个接收一个值作为参数的函数，并把该值赋值给当前属性。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;没有多余的装饰&lt;/h3&gt;
&lt;p&gt;JS 从 ES5 开始有了对属性描述符操作的 API。&lt;code class=&quot;language-text&quot;&gt;Object.getOwnPropertyDescriptor&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;Object.defineProperty&lt;/code&gt; 函数。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defineProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;oatmeal&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;viscosity&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  writable&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  value&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 当尝试给 oatmeal.viscosity 赋新值时，它静默失败了&lt;/span&gt;
oatmeal&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;viscosity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;oatmeal&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;viscosity&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// =&gt; 20&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们可以写一个通用的 &lt;code class=&quot;language-text&quot;&gt;decorate&lt;/code&gt; 函数来更新任何对象的任何属性的描述符：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;decorate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; property&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; callback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; descriptor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getOwnPropertyDescriptor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; property&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defineProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; property&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;callback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;descriptor&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;decorate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;oatmeal&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;viscosity&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;desc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  desc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;configurable &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  desc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;writable &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  desc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; desc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;装饰器初探&lt;/h2&gt;
&lt;p&gt;与装饰器提案的第一个主要的不同点是，它只涉及 ECMAScript 类，而不涉及常规对象。我们来新增一些类：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Porridge&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;viscosity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;viscosity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; viscosity&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;stir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;viscosity &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;This is pretty thick stuff.&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Spoon goes round and round.&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Oatmeal&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Porridge&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  viscosity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;flavor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;flavor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; flavor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; oatmeal &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Oatmeal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Brown Sugar Cinnamon&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/*
Oatmeal {
  flavor: &apos;Brown Sugar Cinnamon&apos;,
  viscosity: 20
}/&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;如何写一个装饰器&lt;/h3&gt;
&lt;p&gt;JS 装饰器函数有 3 个参数：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;target&lt;/code&gt; 是实例对象的类。&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;key&lt;/code&gt; 是属性名字符串，是我们要装饰的对象。&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;descriptor&lt;/code&gt; 属性的描述对象&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;装饰器函数内部的实现取决于我们想要装饰器来做什么。为了装饰对象的方法或属性，我们需要返回一个新的属性描述符。下面是我们对属性做只读设置：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;target&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; descriptor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;descriptor&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    writable&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Oatmeal&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Porridge&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  @readOnly viscosity &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;flavor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;flavor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; flavor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;处理 API 异常&lt;/h3&gt;
&lt;p&gt;我们向服务器请求数据是可能会出现异常，当与网络通信时假设都遵循以下约定：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在页面上显示属性 &lt;code class=&quot;language-text&quot;&gt;networkStatus&lt;/code&gt; 为 loading 的样式&lt;/li&gt;
&lt;li&gt;发送 API 请求&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;处理结果&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果成功，根据响应更新状态&lt;/li&gt;
&lt;li&gt;如果失败，&lt;code class=&quot;language-text&quot;&gt;apiError&lt;/code&gt; 属性值为接收到的异常内容&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;将 &lt;code class=&quot;language-text&quot;&gt;networkStatus&lt;/code&gt; 状态设置为 idle&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;常规写法：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WidgetStore&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getWidget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setNetworkStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;loading&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; widget &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; api&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getWidget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// 更新本地状态：&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addWidget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;widget&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setApiError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setNetworkStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;idle&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;以上代码很容易会写出很多模板代码。当我们尝试使用装饰器来处理：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apiRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;target&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; descriptor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;apiAction&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; original &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; descriptor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; descriptor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;initializer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setNetworkStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;loading&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;original&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setApiError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setNetworkStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;idle&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;descriptor&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    value&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; apiAction&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    initializer&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们将刚才的装饰器函数应用到之前的类中：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WidgetStore&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  @apiRequest
  &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getWidget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; widget &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; api&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getWidget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addWidget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;widget&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; widget&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们对异常处理的代码现在移到了装饰器函数中，我们只需要关心实现不同需求。&lt;/p&gt;
&lt;h2&gt;装饰类&lt;/h2&gt;
&lt;p&gt;除了属性和方法外，我们也可以装饰整个类。我们只需要传入 &lt;code class=&quot;language-text&quot;&gt;target&lt;/code&gt; 参数到装饰器函数即可。来看下面的例子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;customElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    customElements&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

@&lt;span class=&quot;token function&quot;&gt;customElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;intro-message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IntroMessage&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HTMLElement&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; shadow &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;attachShadow&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;mode&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;open&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wrapper &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;div&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;intro-message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;header &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;h1&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;intro-message__title&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;div&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;intro-message__text&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;header&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;textContent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getAttribute&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;header&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;innerHTML &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;innerHTML&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    shadow&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;appendChild&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wrapper&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wrapper&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;appendChild&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;header&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wrapper&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;appendChild&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;createElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;tag&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; className&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; elem &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tag&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    elem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classList&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;className&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; elem&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 HTML 中加载以上代码，我们可以这样使用：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;intro-message&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;header&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;welcome to Decorators&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;p&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;Something something content...&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;p&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;intro-message&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 427px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2f8da38b2d7f0975f6733e09b02fc0ad/a3686/custom-tag.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 27.166276346604217%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAo0lEQVQY06WNMQqEMBREc2svkMoipZBKiFoIFh4oomJMNAEtgjZCsoOwbrHb7SuG4SfDI2VZJkmSpmld13meZ1lWFEXTNG3bCiEopeKGc84Yw1NVVed5xhhDCMR775yb59kYo7Ve13VZln3fUZDDMHRdN47jNE1936Pg53Vd8YYopXCVUqJg/HSA2SOJvyDbtsEJGxI288ZaizyOI3zxGcc/eAGzcQudfXLvjgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;custom tag&quot;
        title=&quot;custom tag&quot;
        src=&quot;/static/2f8da38b2d7f0975f6733e09b02fc0ad/a3686/custom-tag.png&quot;
        srcset=&quot;/static/2f8da38b2d7f0975f6733e09b02fc0ad/00d96/custom-tag.png 148w,
/static/2f8da38b2d7f0975f6733e09b02fc0ad/0b23c/custom-tag.png 295w,
/static/2f8da38b2d7f0975f6733e09b02fc0ad/a3686/custom-tag.png 427w&quot;
        sizes=&quot;(max-width: 427px) 100vw, 427px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.simplethread.com/understanding-js-decorators/&quot;&gt;https://www.simplethread.com/understanding-js-decorators/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Docker 简介]]></title><description><![CDATA[简述 Docker 是集开发、发布、执行应用功能的一个开放平台。Docker 能够帮我们将应用和基础设施分离来达到更快的交付。有了 Docker，我们可以像管理基础设施一样管理我们的软件。有了 Docker…]]></description><link>https://www.keisei.top/docker-overview/</link><guid isPermaLink="false">https://www.keisei.top/docker-overview/</guid><pubDate>Mon, 30 Dec 2019 23:33:00 GMT</pubDate><content:encoded>&lt;h2&gt;简述&lt;/h2&gt;
&lt;p&gt;Docker 是集开发、发布、执行应用功能的一个开放平台。Docker 能够帮我们将应用和基础设施分离来达到更快的交付。有了 Docker，我们可以像管理基础设施一样管理我们的软件。有了 Docker 快速发布、测试、部署代码的优势，我们可以显著减少从编写代码到在生产环境执行的时间间隔。&lt;/p&gt;
&lt;h2&gt;Docker 平台&lt;/h2&gt;
&lt;p&gt;Docker 提供了在松散隔离的环境（被称作容器：container）中打包执行应用的能力。隔离和安全能力允许我们在一台宿主机上同时运行多个容器。容器本身是轻量的，它们不需要管理程序额外的负载，直接在宿主机的内核上运行。这意味着与虚拟机相比，我们可以在给定的硬件组合上运行更多容器。甚至我们可以在实际上是虚拟机的宿主机上运行 Docker 容器。&lt;/p&gt;
&lt;p&gt;Docker 提供了工具和平台来管理容器的生命周期：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用容器开发应用程序和它支持的组件&lt;/li&gt;
&lt;li&gt;容器时发行和测试应用的单元&lt;/li&gt;
&lt;li&gt;准备就绪后，将应用程序作为容器或编排的服务部署到生产环境。无论生产环境是本地数据中心，云厂商，还是两者的结合，它们的工作原理都是相同的。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Docker 引擎&lt;/h2&gt;
&lt;p&gt;Docker 引擎是一个拥有下面主要功能的客户端程序：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一种长期运行的称为守护进程的程序服务（&lt;code class=&quot;language-text&quot;&gt;dockerd&lt;/code&gt; 命令）&lt;/li&gt;
&lt;li&gt;REST API，指定程序可以用来与守护进程通信并指示其操作的接口&lt;/li&gt;
&lt;li&gt;命令行接口（CLI）客户端（&lt;code class=&quot;language-text&quot;&gt;docker&lt;/code&gt; 命令）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 492px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3185f40a56d6a22b714b444d515be3f0/275e0/engine-components-flow.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 78.25203252032522%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAACb0lEQVQoz6VSS2sTURSebf+ACxFRqJuiII0bH4ioG7FmIehCUKi10iyiibGBxioiLlTsQrqoi1orqS3RmrbUIgiiglBBtAttazOTkBdhksxMJjOTuTNzH/FOhsQ83Hk393G+79zzfecw1f9YTOMEETEghphYtQNpAiFMgIWteggT0k42LGyYSJT1smboJmog6AIWotnKqqFWaMBGtpMBxLoJeUGjoOb0dl5o36QyoKkRsatoJ1sQm4goFTMvKLygmrREjKsYYwiLoloQ1bJmSqphQoxwR9l15UiSlIqq8ZL+6aewsJrbSCuyrFKqrAKIcIthVADVAR1L6rFVTgtF03eXM2Pvc8PzqfEPfEGB9J2KoRIc5yiLoRxgQEHWDQs5Yj5ulC9Pc9cjidCb1I3ZpG8ucSXMjkbTomrzS6ohK0BSADWP0S1MN17UgGlbWtJQ4FXSMxPvexg7Nsodv504GmLPjsX6p9m5rwIlC4pRLFUKklZSgF02qHVIpWkw+rJVHprh3I9Yl487fY9z3/994lbc5WPdj2N3ltKaDmmFim6WNAORmmGEkEJBzmQFQwfLa8LFydiRkfhe77c9nvmDwejuq4u9/vXDI+y1lwleqBQLUjYn0olocRvXGvAjpV14yvb6N7f3z+4afL5j4EX30NTOgbcHAlwwknR635iAv2TniXo2HEn3eNeYvvFtl6Zcgddd5ye6zoX3+TYXvov2H03D09Jnp/m/svqpBzHm5GTg2ecELx8KRpgzizfDObPWyCZux5A4sUTRHJzY6vGu7PcvdXvePVnJ61Y78x9kB+Fg8jJcz1SAZd9ItUo6kH8AkflRD4xPhZkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;engine components flow&quot;
        title=&quot;engine components flow&quot;
        src=&quot;/static/3185f40a56d6a22b714b444d515be3f0/275e0/engine-components-flow.png&quot;
        srcset=&quot;/static/3185f40a56d6a22b714b444d515be3f0/00d96/engine-components-flow.png 148w,
/static/3185f40a56d6a22b714b444d515be3f0/0b23c/engine-components-flow.png 295w,
/static/3185f40a56d6a22b714b444d515be3f0/275e0/engine-components-flow.png 492w&quot;
        sizes=&quot;(max-width: 492px) 100vw, 492px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;CLI 使用 Docker REST API 通过脚本或直接 CLI 命令行来控制 Docker 守护进程或与 Docker 守护进程进行通信。许多其他 Docker 应用都使用底层 API 和 CLI。&lt;/p&gt;
&lt;p&gt;守护进程创建和管理 Docker 对象，例如镜像，容器，网络，和卷。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;注意：Docker 是基于开源的 Apache 2.0 许可&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;更多信息查看下面的 &lt;a href=&quot;#docker-architecture&quot;&gt;Docker 架构&lt;/a&gt;。&lt;/p&gt;
&lt;h2&gt;我们能用 Docker 来做什么&lt;/h2&gt;
&lt;h3&gt;快速一致地发布应用程序&lt;/h3&gt;
&lt;p&gt;Docker 允许开发者使用提供了应用程序和服务的本地容器在标准化环境下工作，从而简化开发过程。容器非常适合持续集成/持续发布（CI/CD）的工作流。&lt;/p&gt;
&lt;p&gt;考虑下面的场景：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;开发者在本地编写代码并通过 Docker 容器来与同事共享&lt;/li&gt;
&lt;li&gt;他们使用 Docker 将应用推送到测试环境并执行自动、手动的测试&lt;/li&gt;
&lt;li&gt;当开发者发现了问题，他们可以在开发环境修复问题并重新发布到测试环境进行测试和验证&lt;/li&gt;
&lt;li&gt;当测试完成，将修复后的程序推送给用户就像将更新的镜像推送到生产环境一样简单&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;响应式部署和扩容&lt;/h3&gt;
&lt;p&gt;Docker 基于容器的平台允许高度的移植性。Docker 容器可以在开发者自身的电脑上，在数据中心的物理或虚拟机上，在云厂商上或混合的环境下运行。&lt;/p&gt;
&lt;p&gt;Docker 的可移植性和轻量的本质在真实环境下亦可以动态管理工作负载，根据商业需要进行扩容或回收应用。&lt;/p&gt;
&lt;h3&gt;在同一个硬件上运行更多工作负载&lt;/h3&gt;
&lt;p&gt;Docker 是轻量的、快速的。它为基于管理程序的虚拟机提供了可行的，经济划算的替代方案，所以我们可以拥有更多算力来实现我们的商业目标。Docker 非常适合高密度环境和中小型部署需要更少资源做更多事情的场景。&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;docker-architecture&quot;&gt;&lt;/a&gt;Docker 架构&lt;/h2&gt;
&lt;p&gt;Docker 采用客户端-服务端架构。Docker 客户端与做大量构建，运行，分发 Docker 容器工作的 Docker 守护进程通信。Docker 客户端和守护进程可以在同一系统运行，或 Docker 客户端连接一个远程的 Docker 守护进程。Docker 客户端和守护进程通过基于 UNIX 套接字或 网络接口的 REST API 通信。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/b595b80b1dc39db2af4ffd6f0e8e8f55/architecture.svg&quot; alt=&quot;architecture&quot;&gt;&lt;/p&gt;
&lt;h3&gt;Docker 守护进程&lt;/h3&gt;
&lt;p&gt;Docker 守护进程（&lt;code class=&quot;language-text&quot;&gt;dockerd&lt;/code&gt;）会监听 Docker API 请求并管理 Docker 镜像，容器，网络，卷等对象。一个守护进程也能够与其他守护进程通信来管理 Docker 服务。&lt;/p&gt;
&lt;h3&gt;Docker 客户端&lt;/h3&gt;
&lt;p&gt;Docker 客户端（&lt;code class=&quot;language-text&quot;&gt;docker&lt;/code&gt;）是 Docker 用户与 Docker 主要的交互方式。当使用如 &lt;code class=&quot;language-text&quot;&gt;docker run&lt;/code&gt; 等命令时，客户端发送这些命令至 &lt;code class=&quot;language-text&quot;&gt;dockerd&lt;/code&gt; 来执行。 &lt;code class=&quot;language-text&quot;&gt;docker&lt;/code&gt; 命令使用 Docker API。Docker 客户端可以与多个守护进程通信。&lt;/p&gt;
&lt;h3&gt;Docker 注册源&lt;/h3&gt;
&lt;p&gt;Docker 注册源保存了 Docker 镜像。Docker Hub 是公开的任何人可以使用的源，Docker 默认去 Docker Hub 寻找镜像。我们也可以使用隐私源。&lt;/p&gt;
&lt;p&gt;当使用 &lt;code class=&quot;language-text&quot;&gt;docker pull&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;docker run&lt;/code&gt; 命令时，这些依赖的镜像会从配置的源拉取。当使用 &lt;code class=&quot;language-text&quot;&gt;docker push&lt;/code&gt; 命令，镜像会推送到配置的源。&lt;/p&gt;
&lt;h3&gt;Docker 对象&lt;/h3&gt;
&lt;p&gt;当使用 Docker 时，我们创建并使用镜像，容器，网络，卷，插件等对象。下面是部分对象的简单介绍。&lt;/p&gt;
&lt;h4&gt;镜像&lt;/h4&gt;
&lt;p&gt;镜像是一种只读的模板，通过指令来创建 Docker 容器。通常，一个镜像基于另外的镜像，并在上面增加一些自定义的特性。例如，我们可以基于 &lt;code class=&quot;language-text&quot;&gt;ubuntu&lt;/code&gt; 镜像，安装 Apache web 服务器和应用程序，并配置能让应用执行的配置项来创建一个新的镜像。&lt;/p&gt;
&lt;p&gt;我们可以创建自己的镜像，或使用其他人创建发布的镜像。为了创建自己的镜像，可以创建通过一些简单语法定义创建，执行镜像步骤的 &lt;em&gt;Dockerfile&lt;/em&gt; 。在 Dockerfile 中的每条指令都会在镜像中创建一个层级。当更新 Dockerfile 并重新创建镜像时，只有改变的那些层才会重新创建。这就是与其他虚拟化技术相比能够保持镜像轻量，小型，快速的原因。&lt;/p&gt;
&lt;h4&gt;容器&lt;/h4&gt;
&lt;p&gt;一个容器是一个可运行的镜像的实例。我们可以使用 Docker API 或 CLI 创建，启动，停止，移动或删除容器。我们可以把容器与一个或多个网络，存储连接，甚至可以基于当前的状态创建新的镜像。&lt;/p&gt;
&lt;p&gt;默认情况下，一个容器与其他容器和它的宿主机都高度的隔离。我们可以控制容器的网络，存储，或其他容器、宿主机的底层子系统的隔离程度。&lt;/p&gt;
&lt;p&gt;一个容器由其镜像以及在创建或启动时为其提供的任何配置选项定义。当一个容器被移除时，任何没有存储在持久化存储中的改变的状态会消失。&lt;/p&gt;
&lt;h5&gt;&lt;code class=&quot;language-text&quot;&gt;docker run&lt;/code&gt; 命令的例子&lt;/h5&gt;
&lt;p&gt;下面的命令运行一个 &lt;code class=&quot;language-text&quot;&gt;ubuntu&lt;/code&gt; 容器，附加交互的命令行会话，并执行 &lt;code class=&quot;language-text&quot;&gt;/bin/bash&lt;/code&gt;。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;docker run -i -t ubuntu /bin/bash&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当执行这条命令时，以下是内部发生的过程（假设使用了默认的源配置）：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;如果本地没有 &lt;code class=&quot;language-text&quot;&gt;ubuntu&lt;/code&gt; 镜像，Docker 会从配置的源拉取，需要手动执行 &lt;code class=&quot;language-text&quot;&gt;docker pull ubuntu&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;Docker 创建了一个新的容器，就像手动执行了 &lt;code class=&quot;language-text&quot;&gt;docker container create&lt;/code&gt; 命令。&lt;/li&gt;
&lt;li&gt;Docker 分配了一个可读写的文件系统到容器作为最后一层。这允许一个运行的容器在其内部文件系统创建，修改文件和目录。&lt;/li&gt;
&lt;li&gt;Docker 创建网络接口来连接容器到默认的网络（如果没有指定任何的网络选项）。这会分配一个 IP 地址给容器。默认情况下，容器可以使用宿主机的网络连接来连接外部网络。&lt;/li&gt;
&lt;li&gt;Docker 开启容器并执行 &lt;code class=&quot;language-text&quot;&gt;/bin/bash&lt;/code&gt;。因为容器运行时可交互，并且附在终端上（由于设置了&lt;code class=&quot;language-text&quot;&gt;-i&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;-t&lt;/code&gt; 标识），可以输入指令得到返回的输出结果。&lt;/li&gt;
&lt;li&gt;当输入 &lt;code class=&quot;language-text&quot;&gt;exit&lt;/code&gt; 来结束 &lt;code class=&quot;language-text&quot;&gt;/bin/bash&lt;/code&gt; 命令时，容器会暂停但并不会移除。可以再次启动或移除。&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;服务&lt;/h4&gt;
&lt;p&gt;服务允许我们通过多个 Docker 守护进程（多个 &lt;em&gt;manager&lt;/em&gt; 和 &lt;em&gt;worker&lt;/em&gt; 组成的集群）来扩展容器。集群中的每个成员都是一个 Docker 守护进程，这些进程都使用 Docker API 通信。一个服务允许定义期望的状态，例如任何时候都必须保证可用的服务副本的数量。默认情况下，服务在所有 worker 节点都是负载均衡的。对于消费者，Docker 服务表现为单个应用。Docker 引擎在 Docker 1.12 及以上版本支持集群模式。&lt;/p&gt;
&lt;h2&gt;底层技术&lt;/h2&gt;
&lt;p&gt;Docker 是使用 Go 语言实现的，并采用了 Linux 内核的许多特性来提供它的功能。&lt;/p&gt;
&lt;h3&gt;命名空间&lt;/h3&gt;
&lt;p&gt;Docker 使用了 &lt;code class=&quot;language-text&quot;&gt;namespaces&lt;/code&gt; 的技术来提供称为&lt;em&gt;容器&lt;/em&gt;的隔离的工作环境。当运行一个容器时，Docker 为该容器创建了一系列命名空间。&lt;/p&gt;
&lt;p&gt;这些命名空间提供了一个隔离层。容器的每部分都在独立的命名空间下运行，它们的访问权限都被限制在该命名空间下。&lt;/p&gt;
&lt;p&gt;Docker 引擎使用以下 Linux 中的命名空间：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;pid&lt;/code&gt; &lt;strong&gt;namespace&lt;/strong&gt;: 进程隔离（PID: 进程 ID）&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;net&lt;/code&gt; &lt;strong&gt;namespace&lt;/strong&gt;: 管理网络接口（NET: 网络）&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;ipc&lt;/code&gt; &lt;strong&gt;namespace&lt;/strong&gt;: 管理访问 IPC 资源（IPC: 进程间通信）&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;mnt&lt;/code&gt; &lt;strong&gt;namespace&lt;/strong&gt;: 管理文件系统挂载点（MNT: 挂在）&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;uts&lt;/code&gt; &lt;strong&gt;namespace&lt;/strong&gt;: 隔离内核和版本标识（UTS: Unix 分时系统）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;控制组&lt;/h3&gt;
&lt;p&gt;Docker 引擎在 Linux 系统也会依赖称为控制组（&lt;code class=&quot;language-text&quot;&gt;cgroups&lt;/code&gt;）的技术。一个 cgroup 限制了一个应用指定的资源集合。控制组允许 Docker 引擎分享可用的硬件资源给容器，并有选择地实行限制和约束。例如，你可以限制指定容器的可用内存大小。&lt;/p&gt;
&lt;h3&gt;统一文件系统&lt;/h3&gt;
&lt;p&gt;统一文件系统（UnionFS），是通过创建层级进行操作的文件系统，使其非常轻便快速。Docker 引擎使用 UnionFS 为容器提供构建模块。Docker 引擎可以使用多种 UnionFS 变种，如 AUSF，btrfs，vfs，DeviceMapper。&lt;/p&gt;
&lt;h3&gt;容器格式化&lt;/h3&gt;
&lt;p&gt;Docker 引擎结合命名空间，控制组，统一文件系统包装成一个容器包装称为一个容器格式化。默认的容器格式化是 &lt;code class=&quot;language-text&quot;&gt;libcontainer&lt;/code&gt;。&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/docker-overview/&quot;&gt;https://docs.docker.com/engine/docker-overview/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[迷你打包工具]]></title><description><![CDATA[模板打包器把小的代码片段转译成可在浏览器中运行的更大更复杂的文件。这些代码片段都是 JavaScript 文件，所有代码间的依赖都由模块系统来表示（https://webpack.js.org/concepts/modules…]]></description><link>https://www.keisei.top/minipack/</link><guid isPermaLink="false">https://www.keisei.top/minipack/</guid><pubDate>Wed, 25 Dec 2019 22:24:00 GMT</pubDate><content:encoded>&lt;p&gt;模板打包器把小的代码片段转译成可在浏览器中运行的更大更复杂的文件。这些代码片段都是 JavaScript 文件，所有代码间的依赖都由模块系统来表示（&lt;a href=&quot;https://webpack.js.org/concepts/modules&quot;&gt;https://webpack.js.org/concepts/modules&lt;/a&gt;）。&lt;/p&gt;
&lt;p&gt;模板打包器需要一个入口文件。我们不需要在 HTML 中插入多个 script 标签并执行，而是将该文件为我们应用的主入口文件来启动。&lt;/p&gt;
&lt;p&gt;打包器会从入口文件开始，寻找它依赖哪些文件，接着寻找依赖文件的依赖文件。就这样一直递归下去直到找出所有模块。这个过程所构成的依赖关系被称作依赖图。&lt;/p&gt;
&lt;p&gt;本文将来创建一个依赖图并通过它来将所有的模块都打包到一个文件中。&lt;/p&gt;
&lt;p&gt;注意：本文只是一个简单的来理解打包工具的例子，解决循环依赖，缓存模块导出，每个模块只解析一次等特性本文将跳过来保证简单化。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; fs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;fs&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;path&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; babylon &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;babylon&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; traverse &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;babel-traverse&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;default&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; transformFromAst &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;babel-core&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 我们创建一个接收文件路径参数的函数，读取文件内容，取出该文件的依赖。&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createAsset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 读取文件内容&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; content &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; fs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readFileSync&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;filename&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;utf-8&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 现在我们尝试去找出该文件依赖了哪些文件。我们可以通过查看内容中的 import 字符串。这个方式比较笨拙，所以我们使用 JavaScript 解析器。&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// JavaScript 解析器是读取并解析 JavaScript 代码的工具。它们会生成一个称为 AST （abstract syntax tree） 的更抽象的模型。&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 可访问 AST Explorer (https://astexplorer.net) 来了解 AST 的结构。&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// AST 包含了我们代码的大量信息。我们可以通过查看它来了解我们的代码来做什么。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; ast &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; babylon&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    sourceType&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;module&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 这个数组用来保存当前模块依赖的所有模块的相对路径。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dependencies &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 我们遍历 AST 来找出依赖了哪些模块。为了得到结果，我们检查 AST 中每个 import 声明。&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;traverse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// EcmaScript 模块因为静态的设计所以解析起来非常简单。同时这意味着我们不能条件式 import 另一个模块。每次我们看到一个 import 声明我们都可以将它的值作为一个依赖。&lt;/span&gt;
    &lt;span class=&quot;token function-variable function&quot;&gt;ImportDeclaration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; node &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// 我们把 import 的值保存至上面的依赖数组。&lt;/span&gt;
      dependencies&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;source&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 我们同时通过自增1来确定当前模块的唯一标识。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 为了保证EcmaScript 的模块和其他新特性能在所有浏览器中运行，我们使用 Babel (https://babeljs.io) 来转译。&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// `presets` 选项是告诉 Babel 如何转译的规则的集合。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; code &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;transformFromAst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    presets&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;env&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 返回该模块所有的信息。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    filename&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    dependencies&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    code&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 我们开始读取入口文件的依赖。接下来提取该文件依赖的所有依赖，以此递归。&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createGraph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 开始解析入口文件。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; mainAsset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createAsset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 我们使用一个队列来解析每个资源的依赖。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; queue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;mainAsset&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 我们使用 `for ... of` 迭代这个队列。初始时队列中只有一个资源，但是我们随后的迭代会增加新的资源到这个队列中。当队列为空时退出迭代。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; asset &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 每个资源都有自己依赖的模块的相对路径列表。我们去迭代它们，通过 `createAsset()` 函数解析它们，将该模块的依赖保存至下面的对象中。&lt;/span&gt;
    asset&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mapping &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 这是该模块的目录地址&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dirname &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;dirname&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;asset&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;filename&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 我们遍历依赖关系的相对路径&lt;/span&gt;
    asset&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dependencies&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;relativePath&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// `createAsset()` 函数需要绝对的文件路径。而 dependencies 中为相对路径。我们可以通过 join 方法来获得绝对路径。&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; absolutePath &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dirname&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; relativePath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// 解析资源，读取内容，提取它的依赖&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; child &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createAsset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;absolutePath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// 本质上 `asset` 依赖于 `child`，我们通过在 `mapping` 对象上增加相对路径的值为 child 的 id 的属性来维护这份关系。&lt;/span&gt;
      asset&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mapping&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;relativePath&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; child&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;// 最后，我们将 child 资源加入队列来使它的依赖也能被迭代和解析。&lt;/span&gt;
      queue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;child&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 此时队列包含了应用下所有的模块：这是我们表示依赖图的形式。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; queue&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 接下来我们定义一个函数，通过接收我们的依赖图并返回一个可以在浏览器中运行的文件。&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 我们的 bundle 会持有一个立即执行函数：(function() {})()&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bundle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;graph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; modules &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 我们会对依赖图进行构造，生成 `key: value,` 格式的字符串，最后通过 {} 包裹起来。&lt;/span&gt;
  graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;mod&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 图中的每个模块都有一个入口在该对象中。我们使用模块的 id 作为键，使用一个数组作为值。&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 数组中的第一个值是以一个函数包裹的模块的代码。原因是模块必须是有作用域的：在一个模块中定义的变量不应该影响到全局变量。&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 我们的模块在转译之后使用 CommonJS 的模块系统：需要 `require`, `module` 和 `exports` 对象。目前在浏览器中还不能使用，所以我们会实现它们并将它们注入我们的包装函数中。&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 对于数组第二个值，我们将模块和模块的依赖对应的 mapping 对象转为字符串。这个对象形式如： { &apos;./relative/path&apos;: 1 }&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 这是因为我们的模块转译后的代码需要调用参数为相对路径的 `require()` 函数。当该函数被调用时，我们能够知道图中哪个模块对应于此模块的相对路径。&lt;/span&gt;

    modules &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;mod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;: [
      function (require, module, exports) {
        &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;mod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
      },
      &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stringify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mapping&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;,
    ],&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 最后，我们来实现立即执行函数的函数体&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 我们首先来实现 `require()` 函数：它接收模块 id 并在我们之前构建好的 `modules` 对象中寻找。我们解构这个有两个元素的数组，来获取我们的包装函数和 mapping 对象。&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 我们的模块代码需要调用 `require()` 函数，它接收文件相对路径作为参数而不是模块的 id。我们的 require 函数需要模块 id。此外，两个不同的模块可能会 `require()` 同一个相对路径。&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 为了解决这个问题，当一个模块 required 时我们创建一个新的专有的 `require` 函数来调用。它是模块指定的函数，并且知道通过从模块的 mapping 对象的相对路径中找到对应的 id。&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 最后，通过 CommonJS, 当一个模块被加载，它可以通过改变 `exports` 对象来暴露值。`exports` 对象在被模块的代码改变后，通过 `require()` 函数返回。&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
  (function (modules) {
    function require(id) {
      const [fn, mapping] = modules[id];

      function localRequire(name) {
        return require(mapping[name]);
      }

      const module = { exports: {} };

      fn(localRequire, module, module.exports);

      return module.exports;
    }

    require(0);
  })({&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;modules&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;})
  &lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; graph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createGraph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;./example/entry.js&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bundle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;graph&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/ronami/minipack&quot;&gt;https://github.com/ronami/minipack&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[渲染器进程的内部执行]]></title><description><![CDATA[简介 前一节我们介绍了浏览器从地址栏输入 URL 开始内部是如何工作的。本文来看一下渲染器进程内部是如何工作的，由于该部分涉及到了 web 优化的众多方面，本文尽量以高度概括的方式进行讲解，如需进一步学习可访问 Web 基础之性能优化。 渲染器进程处理 web…]]></description><link>https://www.keisei.top/web-browser-render/</link><guid isPermaLink="false">https://www.keisei.top/web-browser-render/</guid><pubDate>Wed, 18 Dec 2019 23:38:00 GMT</pubDate><content:encoded>&lt;h2&gt;简介&lt;/h2&gt;
&lt;p&gt;前一节我们介绍了&lt;a href=&quot;/web-browser-happen-in-navigation&quot;&gt;浏览器从地址栏输入 URL&lt;/a&gt; 开始内部是如何工作的。本文来看一下渲染器进程内部是如何工作的，由于该部分涉及到了 web 优化的众多方面，本文尽量以高度概括的方式进行讲解，如需进一步学习可访问 &lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/why-performance-matters/&quot;&gt;Web 基础之性能优化&lt;/a&gt;。&lt;/p&gt;
&lt;h2&gt;渲染器进程处理 web 内容&lt;/h2&gt;
&lt;p&gt;渲染器进程负责任何发生在一个 tab 下的事件。在一个渲染器进程中，主线程处理了大部分发送给用户的代码。如果有 JavaScript 代码是 web worker 或 service worker，那么会由 worker 线程来处理该部分代码。合成器线程和栅格线程也在一个渲染器进程内部执行，来保证渲染页面平滑、高效。&lt;/p&gt;
&lt;p&gt;渲染器进程的核心工作是把 HTML、CSS 和 JavaScript 加载至一个 web 页面中来供用户使用。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/126df/renderer.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbklEQVQoz2WRyXLCQAxE/f9/w5EqDgQ4kIrBG3ghBuxiD2CzQ9jMY0QoV6UPY02P1GrJWpZlcRx/fum22+l0gjAMPc/zfZ9LW4Gr67q2bf8oWJY1m82out/vGp/RaOT5gem0PxTK5bJhGCTput5sNk3T5Fqr1RBCtNvtIvEqHgwGnoLjOJZtkxEEwfcfQgWCXq+HFyFxOp1O9/u9BoUl0qIoJu73+1kOyN9uNwnkvF6vBGmaJkminc9nqNPp9C7YbreHw0EmvFwuML8KURSt12vJ2e121GubzWaxWGCjUChUKhWEYJkNezwhj/p8Pl+tVsVi8e2LBs9iZk4U6vV6tVoliTe06LNcLo/HI1fIVqvF8MPhkO1OJhOqcKFhjIdSqcQPECHxiXPkxSdXfLIa1i5yr87sAyX08uuRJVMvWoA9NRoN/gWOSB6Px8/OqGb/QCqjYkqWLIz0FOa1MJbBh/HSHBgSYc48CfMOMMvrA+t4W7C5eyUwAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;renderer process&quot;
        title=&quot;renderer process&quot;
        src=&quot;/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/799d3/renderer.png&quot;
        srcset=&quot;/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/00d96/renderer.png 148w,
/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/0b23c/renderer.png 295w,
/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/799d3/renderer.png 590w,
/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/126df/renderer.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;解析&lt;/h2&gt;
&lt;h3&gt;DOM 的构建&lt;/h3&gt;
&lt;p&gt;当渲染器进程接收到导航的信息并开始接收 HTML 数据时，主线程就会开始解析文本字符（HTML）并把它转换成文档对象模型（DOM）。&lt;/p&gt;
&lt;p&gt;DOM 是一个页面在浏览器内部的表示形式，也是一种 web 开发者可以通过 JavaScript 来操作的数据结构。&lt;/p&gt;
&lt;p&gt;解析 HTML 文档为 DOM 是 &lt;a href=&quot;https://html.spec.whatwg.org/&quot;&gt;HTML 标准&lt;/a&gt;定义的。你或许发现 HTML 传递到浏览器时从不会产生异常。例如丢失一个 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;/p&amp;gt;&lt;/code&gt; 标签是有效的 HTML 文档。再比如 &lt;code class=&quot;language-text&quot;&gt;Hi! &amp;lt;b&amp;gt;I&amp;#39;m &amp;lt;i&amp;gt;Chrome&amp;lt;/b&amp;gt;!&amp;lt;/i&amp;gt;&lt;/code&gt; (b 标签先于 i 标签关闭) 会被处理为 &lt;code class=&quot;language-text&quot;&gt;Hi! &amp;lt;b&amp;gt;I&amp;#39;m &amp;lt;i&amp;gt;Chrome&amp;lt;/i&amp;gt;&amp;lt;/b&amp;gt;&amp;lt;i&amp;gt;!&amp;lt;/i&amp;gt;&lt;/code&gt;。这是因为 HTML 规范专门有对这些错误设计了兼容。如果好奇这部分是如何实现的，可通过 HTML 规范中的&lt;a href=&quot;https://html.spec.whatwg.org/multipage/parsing.html#an-introduction-to-error-handling-and-strange-cases-in-the-parser&quot;&gt;在解析器中处理异常和特殊场景&lt;/a&gt;部分来了解。&lt;/p&gt;
&lt;h3&gt;子资源加载&lt;/h3&gt;
&lt;p&gt;一个网站通常会加载外部资源，如图片、CSS 和 JavaScript。这些文件需要从网络或缓存中读取。主线程在解析构建 DOM 时会在发现这些资源时一个个去请求，同时为了加快速度，“预加载扫描器”会并行运行。如果在 HTML 文档中有 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;img&amp;gt;&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;link&amp;gt;&lt;/code&gt; 存在，预加载扫描器会查看在 HTML 解析器生成的令牌，并向浏览器进程中的网络线程发出请求。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fa689d6a31b8687522c58774c8d9d064/126df/dom.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABc0lEQVQoz22S2XKCUAyGef+namecYZi2FJFNAXfZioqK4lKgH8Txqrk45OTkXxJV2rZdLBbax6fp+YHvh2Hoed54PA6CwHEc13V936cyGo1++hgOh2magmqaRuGzXq8dzzNM6/3tGbqu0/TVx3cfg8HAsixY4Mqy7AkGic5kMrFtG3rU0ERfzldMp1OpzGazzWaTJMn5fFaAGYZhmiasqAG+XC5VVUFc1zUdXG+32+PxIN9ut5qmIV6W5W63U6je73fwsM7n8zzP6cAOxgDDSB2fIPf7fRzHqqoyFMpcFaqn0wllzPz2AUZWQoVZcAv4er1SZwXgj8fjcrnslOFASjYEGcqHw0EUQHKFl1l4avtgHE5sd8oQ8GEN0ENJN0OS88xEsideV6sV4qyWnB8Msx2YqcDThFUskAPGDvSciAPgjyAnQQNtyHRgPiyTVYFHFjWuAkYh74NuvJD8Y5sqxPIHIMQbb0VRyCkJuxBZ8iiKKP4Bs75RmkY8U9EAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;dom&quot;
        title=&quot;dom&quot;
        src=&quot;/static/fa689d6a31b8687522c58774c8d9d064/799d3/dom.png&quot;
        srcset=&quot;/static/fa689d6a31b8687522c58774c8d9d064/00d96/dom.png 148w,
/static/fa689d6a31b8687522c58774c8d9d064/0b23c/dom.png 295w,
/static/fa689d6a31b8687522c58774c8d9d064/799d3/dom.png 590w,
/static/fa689d6a31b8687522c58774c8d9d064/126df/dom.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;JavaScript 会阻塞解析&lt;/h3&gt;
&lt;p&gt;当 HTML 解析器遇到 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;script&amp;gt;&lt;/code&gt; 标签时，它会暂停解析 HTML 文档并开始加载，解析，执行 JavaScript 代码。为什么呢？因为 JavaScript 能够通过 &lt;code class=&quot;language-text&quot;&gt;document.write()&lt;/code&gt; （该方法会改变整个 DOM 树结构，如下图）等方式来改变文档的内容。这就是 HTML 解析器为什么暂停并等待 JavaScript 执行后再恢复解析文档。如果对 JavaScript 执行过程好奇，可查看&lt;a href=&quot;/V8-shapes-and-inline-cache&quot;&gt;JavaScript 引擎基础：Shapes 和 Inline Caches&lt;/a&gt;。&lt;/p&gt;
&lt;h2&gt;提示浏览器如何加载资源&lt;/h2&gt;
&lt;p&gt;目前有许多方法帮助开发者提示浏览器如何加载资源更优雅。如果 JavaScript 代码中没有使用 &lt;code class=&quot;language-text&quot;&gt;document.write()&lt;/code&gt;，可以在 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;script&amp;gt;&lt;/code&gt; 标签中添加 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#attr-async&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;async&lt;/code&gt;&lt;/a&gt; 或 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#attr-defer&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;defer&lt;/code&gt;&lt;/a&gt; 属性。浏览器会异步去加载、执行 Javscript 代码而不会阻塞解析 HTML。如果合适还可以使用 &lt;a href=&quot;https://developers.google.com/web/fundamentals/primers/modules&quot;&gt;JavaScript module&lt;/a&gt;。&lt;code class=&quot;language-text&quot;&gt;&amp;lt;link rel=&amp;quot;preload&amp;quot;&amp;gt;&lt;/code&gt; 会告诉浏览器这个资源在当前页面是绝对需要的，最好尽快下载下来。更多信息可查看&lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/resource-prioritization&quot;&gt;资源优先级加载&lt;/a&gt;。&lt;/p&gt;
&lt;h2&gt;样式计算&lt;/h2&gt;
&lt;p&gt;只有 DOM 是不够知道页面究竟展示的样子的，因为我们可以对页面元素通过 CSS 来修饰。
主线程解析 CSS 并确定每一个 DOM 节点计算后的样式。每个节点的样式是通过 CSS 选择器来确定的。可以在开发者工具 &lt;code class=&quot;language-text&quot;&gt;computed&lt;/code&gt; 一栏查看每个节点的样式。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fb7d195814a04c6ed98eab8dbda477c6/126df/computedstyle.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABiklEQVQoz1WRWY+CQBCE+f//xsRolBfXI2YDKiKKgujiiYrifUVlP2YS3e2Hoafpqq7qUeI49v2fb003bcd1HM/zuiIcx7Esq91uk3c6HdM0l8vlarVqNpuLxQLU6/VS+EwmE7vbM1rWF1EsFgqFRqNBk67r9XrdMAzOcrksiVzX/YDH47Ft21RbpgmAabKD6Pf78kTOcDj0RJBMp9P5fH46nRTkwQ3a931yTsn6EPF8Pu/3+/V6vd1u+/1+vV5Xq1UYj8cjuULHZrPhLi1FURSG4WAwqNVq6NQ0DTqK9MxmMwYCxlQQBBQVOEDSB5IcMefzmUo2m8VnJpMBjE7+giyVSsxAwmg0SsDw8ZsLK5V4KjjP5/OVSiWXy7EexCMQDKJiEbQlYMwcDoeeCFjkZFaYSqVUVU2n0/Bib7vd4vwNBpKAL5cLqnhGHgzxu92OCawUPLtll+QMD0Sg+R8YVgbih5N/PAwVdNKBVE6kyW0zRtY/soFhErfvrbDYUARXzuhPwEuRBpox8gsmH01pB0VyDQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;computed style&quot;
        title=&quot;computed style&quot;
        src=&quot;/static/fb7d195814a04c6ed98eab8dbda477c6/799d3/computedstyle.png&quot;
        srcset=&quot;/static/fb7d195814a04c6ed98eab8dbda477c6/00d96/computedstyle.png 148w,
/static/fb7d195814a04c6ed98eab8dbda477c6/0b23c/computedstyle.png 295w,
/static/fb7d195814a04c6ed98eab8dbda477c6/799d3/computedstyle.png 590w,
/static/fb7d195814a04c6ed98eab8dbda477c6/126df/computedstyle.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;即使没有提供任何的 CSS，每个 DOM 节点还是会有一个计算过的样式。&lt;code class=&quot;language-text&quot;&gt;&amp;lt;h1&amp;gt;&lt;/code&gt; 标签会显示地比&lt;code class=&quot;language-text&quot;&gt;&amp;lt;h2&amp;gt;&lt;/code&gt; 标签更大，每个元素地 margin 也有定义。这是因为浏览器本身有一套默认地样式表。&lt;/p&gt;
&lt;h2&gt;布局&lt;/h2&gt;
&lt;p&gt;现在渲染器进程知道文档的结构和每个节点的样式，但是仍然不够渲染出一个页面。想象一下通过给朋友打电话描述一幅画。“有一个大的红色圆形和一个小的蓝色方形”并不能够准确描述这幅画究竟长什么样子。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0658494542e14f7db66b913c02c03202/126df/tellgame.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.294797687861276%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB10lEQVQoz21Su47TQBQdim0QEgUUQLESP7D8AtI2iHYrOkRBS02zH4D4AUo6N2ELQrTtJqFIsnlY5GEltmfs8dqOTZLNy3b8iPfEXu1D2iv7auy555x7zwzhnHuel6ZpkiRBECyXy/V6PZ/PF4vFarXCZxiG2+0WBXEcp/eDMMYkSQIFkGCJwjD2/RTlqI2iTRjmFFEUVatVy7LGWWAfYsQwDNM0S6XSdDrFAizm5fxCY1TnoiTZlmXbNtgLhUKr1apUKr1er1gslstldERAAwxowM0oRX/ezx+ztwfu0WH7z+8w69b3fVEUkQeDAbpDFgSh0WgQWZYnk0maDc3ssf+v7e4//v9qjz4h/Q/vd7+zgTEdZJrNJpSHwyEgAJLRaASHcgPEkSwXhPPnjzqvn7Zf7n38/P3NSSAoO59klf7NQlGUWq2We0y63W6+gkkYGHnx5ZP7jKwPXrw7PiVf6bezMTb5hQmNTqeDNbLrujvwXeupqkZJEm8CX2xGmvJL2x63kto4TuMN1TQUoGHHcaBPKb0F5ycJZY0xzg1jOjMcZ2bqnsNdkzOm2baVgyGrqup12+mDsePK3uy5CUwLw/r9/vUluQ95OHCQ2IVavV7XdR2e57ftCp5ZSInelRfHAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;tell game&quot;
        title=&quot;tell game&quot;
        src=&quot;/static/0658494542e14f7db66b913c02c03202/799d3/tellgame.png&quot;
        srcset=&quot;/static/0658494542e14f7db66b913c02c03202/00d96/tellgame.png 148w,
/static/0658494542e14f7db66b913c02c03202/0b23c/tellgame.png 295w,
/static/0658494542e14f7db66b913c02c03202/799d3/tellgame.png 590w,
/static/0658494542e14f7db66b913c02c03202/126df/tellgame.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;布局是寻找元素几何的过程。主线程遍历 DOM 树和样式来创建一个包含 x,y 轴和边框尺寸的布局树。布局树或许和 DOM 树很像，但是只包含在页面上显示的元素。如果有 &lt;code class=&quot;language-text&quot;&gt;display: none&lt;/code&gt; 的元素，那么不会存在于布局树（但 &lt;code class=&quot;language-text&quot;&gt;visibility: hidden&lt;/code&gt; 的元素会存在）。同样，如果有伪类如 &lt;code class=&quot;language-text&quot;&gt;p::before{content: &amp;#39;Hi!&amp;#39;}&lt;/code&gt; 会出现在布局树中，尽管它不存在于 DOM 树。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0c1de85206f0d177f93a70931a0f8272/126df/layout.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVQoz1WS6Y6CQBCEef/30QR/aUTiZlmN3AoeCCqCovG+Vvyc2d1kO2bohqqumm6Vsiwnk8nHp2H5QRgGw+HQ9/1+vx+Goeu65EEQeJ5nWVae56vVqtfrLZdLWM/nU+GRxLHr+V3TbjQa9Tq/eqfTAfQloitC0zTbtulC0yzLfshJkvAKKduyTNN0HGcwGIQicPGXjEYjmYzH49lslqbp8XhUoNEYe3ygNwjZ9X6/Xy6XbxGPx4MT9Hq9brfbYA6HA1dQAPGgRh+3zWaTEv58PkftdrvJXpwwF4uFruuIoVwUhbLf7xkJN+SqrVarUqlAA3o+n7FDI/hgOJGhOzTKKIre5EQEfMhYUlWVz4ZhIIIyfJLNZkOvUoR0Af9N5mK73Y5N1Go1mNVqFTQ60+mUFaJAiWGgwKBxeU7yN/l0OsVxzDWYliGCwTAhSjlSZkEXJoQau2D52MTUdrtVWBrTZ+8gQJNLV2her1dyPDMFANL5P9upCAaDPf5DcoyyJIFJd16iU/wGOe04XwjcTY6e4hgvAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;layout&quot;
        title=&quot;layout&quot;
        src=&quot;/static/0c1de85206f0d177f93a70931a0f8272/799d3/layout.png&quot;
        srcset=&quot;/static/0c1de85206f0d177f93a70931a0f8272/00d96/layout.png 148w,
/static/0c1de85206f0d177f93a70931a0f8272/0b23c/layout.png 295w,
/static/0c1de85206f0d177f93a70931a0f8272/799d3/layout.png 590w,
/static/0c1de85206f0d177f93a70931a0f8272/126df/layout.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;决定页面的布局是一件很有挑战性的任务。尽管最简单的页面如一个块结构从上至下布局仍然需要考虑字体大小，从哪里断行因为这会影响段落的大小和形状，进而影响接下来的段落的布局。&lt;/p&gt;
&lt;p&gt;CSS 可以使元素浮动至一侧，遮盖溢出的元素，改变文档的方向。可以想象布局过程有着大量的工作。&lt;/p&gt;
&lt;h2&gt;绘制&lt;/h2&gt;
&lt;p&gt;有了 DOM，样式，布局还是不能渲染一个页面。让我们来尝试创建一副画，我们知道了尺寸，形状和元素的位置，但是仍然需要知道以何种顺序来绘制它们。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d8fe81b968531c8b3d4767006ea9725d/126df/drawgame.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 37.45664739884393%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABL0lEQVQY05VPPU+DUBR9iZOrcTBODk6auDv4M5z7cxydjXFxMsbJ0YnNpBKIaYSQgnyWPngUXvkoUAh4oEtXz3bPveeec4jrOCzLqaFT16HrbLmkjEWmabquG8dxtAfHcZqm8X3/Z0RZliRIs1744Fen2c1Fr8pdP2A+n6dpWlXVZkSe513XQb8YgZUgCLIsk4Cvs8ktOyL05ODl7uk9GsS6YeAiSRJKqWVZQRBAzxhTFEXTNFVVPc8Lw5CwvGhen9dnh4vry+P74PxtEBvGL67rurZtG3d4AZJzruu6KIowRzQwBE3qvs++PpPZ94O6fZwV7baGA9wQGOa7CKiAL3iHRxglSUJ/slqtkjjGkm/KLo/bAisOEg35HsCCadsWaafTKboMzv1/ADdtxK7IHzccdTm16O1FAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;draw game&quot;
        title=&quot;draw game&quot;
        src=&quot;/static/d8fe81b968531c8b3d4767006ea9725d/799d3/drawgame.png&quot;
        srcset=&quot;/static/d8fe81b968531c8b3d4767006ea9725d/00d96/drawgame.png 148w,
/static/d8fe81b968531c8b3d4767006ea9725d/0b23c/drawgame.png 295w,
/static/d8fe81b968531c8b3d4767006ea9725d/799d3/drawgame.png 590w,
/static/d8fe81b968531c8b3d4767006ea9725d/126df/drawgame.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;例如，&lt;code class=&quot;language-text&quot;&gt;z-index&lt;/code&gt; 可能在某些元素上被设置，如果按元素在 HTML 中的顺序来绘制会导致不正确的渲染。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/785924a8744dfda1428cc692e2c3f411/aa667/zindex.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.44062153163153%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABa0lEQVQoz32S/W6CQBDE7/2fo3/1KUxM1JgQg5CqIKJyIigfIgpYRforV02bmG7iZW93bmdmUfR6vclkYhjGbDYzTdP3/SiK9vv9brcLw9BxHNd1pZQkm81msVhYlrVer5fLZZqmQtf14XA4GAw0Tev3+5wfbVAHCojT8zwIbNtmChwkx+Pxer2Ky+UCCYNpMBvcdDo1DQNCT0pegp7P50gbjUbookJ+u92aphHc6fEGPbCNx2NUUKSXhKGaKB9TsMMV/M9jqnir61r5oVQU5yiOA9+X729VnpPTbV6FiONYZeiHAZPb7ZbxnI5tIwGHcK5WK5D3+/3PYwwHQcAJDjNssiiKJEnYfHo4gEZOt9vtdDrsBdvUWYrSIvjVbZAwBf7PNsj5ZmVZslhaVMCUbTBdSfjeNhdKVVWBhhnx7A/ZyKHLerIse+05+xV5np8foXIY8Mz3xxFD1YKezkXzbyDqdDqR8Jd4unvGF3HhXceMYMsUAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;z-index&quot;
        title=&quot;z-index&quot;
        src=&quot;/static/785924a8744dfda1428cc692e2c3f411/799d3/zindex.png&quot;
        srcset=&quot;/static/785924a8744dfda1428cc692e2c3f411/00d96/zindex.png 148w,
/static/785924a8744dfda1428cc692e2c3f411/0b23c/zindex.png 295w,
/static/785924a8744dfda1428cc692e2c3f411/799d3/zindex.png 590w,
/static/785924a8744dfda1428cc692e2c3f411/2a3d6/zindex.png 885w,
/static/785924a8744dfda1428cc692e2c3f411/ae92f/zindex.png 1180w,
/static/785924a8744dfda1428cc692e2c3f411/aa667/zindex.png 1802w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;在绘制这一步，主线程遍历布局树来生成绘制记录。绘制记录时绘制过程的记录如“先绘制背景，接着文本，然后是矩形”。如果有使用 JavaScript 在 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;canvas&amp;gt;&lt;/code&gt; 元素上绘制过，这个过程会比较熟悉。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a68fd128fc59b9b2bed3511fcf223c94/126df/paint.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVQoz22R23KCQBBE+f+v0iq1jFFQQECBCOJdQfGKaCQHpqzkIfOwO9U7090zqxRFEYbBx2fXsF3PdX3fdxxnPB57nmdZFrnrurZtG4ax3W53u12/31+v13S9Xi+FazabWbaj6Wa9VqvXOWqqqg4Gg24V5JqmNRoN0zRhgeu3mU6RMg1D1/XhcCiyxGQy+foTIPgCnM/nq9XqcrkolCICaxAE5JywfleBwnK5XCwWaZoCns/nOI7b7TbikivP55MLvizLxExRRZ7nEKEWhiE6IJTB1Wq1GARkv98rFN3v99FoxD6ogAtNSTDJzKxqs9kIXa/Xw8jxeJxOp2WzCALhGZ9Qgsh6yUnAhVdMyYntsvnxeHDJGnGYVsGXnE4n7DSbzU6nA7UMT0EURXSyrSRJlOv1KrMB8bG80ckbpHgD4QllSjGPF1Z9u90oKJUpZVuMgRmK4MY8RExOG+bRl4X9Y1v+g03CTTPekipAoirQFzB+B20gh8PhB0XOU3hbyxq5AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;paint&quot;
        title=&quot;paint&quot;
        src=&quot;/static/a68fd128fc59b9b2bed3511fcf223c94/799d3/paint.png&quot;
        srcset=&quot;/static/a68fd128fc59b9b2bed3511fcf223c94/00d96/paint.png 148w,
/static/a68fd128fc59b9b2bed3511fcf223c94/0b23c/paint.png 295w,
/static/a68fd128fc59b9b2bed3511fcf223c94/799d3/paint.png 590w,
/static/a68fd128fc59b9b2bed3511fcf223c94/126df/paint.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;更新渲染流的开销很大&lt;/h3&gt;
&lt;p&gt;在渲染流中最重要的是要知道每一步都会使用前一步操作的结果来生成新的数据。例如，如果在布局树上有一些变更，在文档流中被影响到的部分的绘制顺序需要重新生成。&lt;/p&gt;
&lt;h2&gt;合成&lt;/h2&gt;
&lt;h3&gt;如何绘制一个页面&lt;/h3&gt;
&lt;p&gt;在浏览器知道了文档结构，每个元素的样式，页面的坐标，绘制顺序，那么是如何生成一个页面呢？将这些信息生成屏幕上的像素被称为光栅化（rasterizing）。&lt;/p&gt;
&lt;h3&gt;什么是合成&lt;/h3&gt;
&lt;p&gt;合成是将一个页面分为许多层级，每层独立进行栅格化、再合成的技术。合成再合成器线程中执行。&lt;/p&gt;
&lt;h3&gt;分成多层&lt;/h3&gt;
&lt;p&gt;为了找到哪些元素需要位于哪些层，主线程遍历布局树来创建层级树。如果页面的某部分应该是单独层（像抽屉菜单），可以通过 CSS &lt;code class=&quot;language-text&quot;&gt;will-change&lt;/code&gt; 属性告知浏览器。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b08901dee7af151982f600e6a7a6ba43/126df/layer.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABcElEQVQoz0WR6XKCMBSFef+36ugM02kFRMomoCK4ICigjgsW+pmIPT/gJrlnyY3Sdd18Pv/8+jYdfzr1wzB0HMd1Xd/3fwSobds2TTPLst1uNx6Pt9strLZtFX5JkjiuZ5jWRw9d12kajUaaphmGwXc4HEqhIAhQeZGXy6WwcqzJBIJlWXgGAqSYClBHURQKzGazNE3X6/X5fFYQQ1s2obJYLFD97dEJUOBzOp3yPFdVFa3j8UitXK9Xju/3exzHXEnm6XqUZSlDgqIoVqsVZMw2m81+v1fQeDweqELGnBofvlKC2TCt2+1G3TQNs4BW1zUBn2RfgAW3gswI8OegqqrBYIAQ8bga0aS/FMXySZaxUWUYnuchQU60D4cDxzIt+wRGWo4QxRf5crnQQSsvyRbOtJKW2xKeu5CLBmjotgIsUf93TgQoWELgMTjDQT4M+zjDfw/y5cyL8eOMSZCQG6JC8kIAptynjToXoJ8eov0ByrBXoF/rSx8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;layer&quot;
        title=&quot;layer&quot;
        src=&quot;/static/b08901dee7af151982f600e6a7a6ba43/799d3/layer.png&quot;
        srcset=&quot;/static/b08901dee7af151982f600e6a7a6ba43/00d96/layer.png 148w,
/static/b08901dee7af151982f600e6a7a6ba43/0b23c/layer.png 295w,
/static/b08901dee7af151982f600e6a7a6ba43/799d3/layer.png 590w,
/static/b08901dee7af151982f600e6a7a6ba43/126df/layer.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;主线程的栅格化和合成&lt;/h3&gt;
&lt;p&gt;一旦层级数创建好，绘制顺序也已确定，主线程就会提交信息到合成器线程。合成器线程对每层做栅格化操作。一个层可能像整个页面那么大，所以合成器线程会把每层都切分成方块，并把每块都发送至光栅线程。光栅线程栅格化每块方块并把它们存放在 GPU 内存中。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/371b5fa654d59f0c8ccb2f4f0658c20a/126df/raster.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0UlEQVQoz01Sy5KbMBDk//8ktxySVPaQKpulYnaNMWCe4ikQIDAE2+W3DU4b55A5iJFQd8/0SHg8HpQmH3PFcIhPSBiG7hiEENM0LctCbtu2YRh1Xa/Xa13Xq6oCahgGAR/GmON62sqcIkRxMpksl0tN0xRFUVUVOVZJkkDkeR7YwfIPnGUZuD3PtVbPsMcbkE3GCIIgiiIA4jj2fR9brJRSzvnhcBBw8+NzDhgQKMkjfj8MIIYOrl4ul7ZtT6fT+Xy+3+99399uN2h2XYdz4U9TRcSxlYltLMLVzNIUmkRFUYAIlUMELNABGBTDyIuA7GazEeqSpZHH3HnoGLvS5ywmrr3f70VRBPdut0OH2+0WOXxqmga/gEQOp4R2XenqfPH+MwmcX9++vH3/Gng2XBCnU5SdpulLHG5jCxcABiPoULlQ8zKLffX9x2oha7/fAsdo67LrNsfjsR/jer3CJLQAFwFAtaAD6RPMC9Y1nDqfEbEiU962vKmKYZzEqz3goYkRQB+asBazlGUZJ0JVZIwGoS75jh7oUp6QqmSP/wImoz3gMXaUjZeD1zCbzZ7goixZXuRZwvI8z2iaMc4r1NaNgQSGvdyG/0jQLVY8Nfz6CxoTRqDyXR/aAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;raster&quot;
        title=&quot;raster&quot;
        src=&quot;/static/371b5fa654d59f0c8ccb2f4f0658c20a/799d3/raster.png&quot;
        srcset=&quot;/static/371b5fa654d59f0c8ccb2f4f0658c20a/00d96/raster.png 148w,
/static/371b5fa654d59f0c8ccb2f4f0658c20a/0b23c/raster.png 295w,
/static/371b5fa654d59f0c8ccb2f4f0658c20a/799d3/raster.png 590w,
/static/371b5fa654d59f0c8ccb2f4f0658c20a/126df/raster.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;合成器线程可以对不同的栅格线程定义优先级，所以在视窗中（或靠近视窗）的部分可以先进行栅格化。&lt;/p&gt;
&lt;p&gt;一旦方块都被栅格化，合成器线程收集称为 &lt;strong&gt;draw quads&lt;/strong&gt; 的方块信息来创建一个 &lt;strong&gt;Compositor frame&lt;/strong&gt;（合成帧）。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Draw quads&lt;/td&gt;
&lt;td&gt;包含诸如方块在内存中的位置以及在考虑页面合成的情况下在页面中绘制方块的位置之类的信息。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Compositor frame&lt;/td&gt;
&lt;td&gt;表示页面框架的四边形的集合。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;一个合成帧随后通过 IPC 被提交至浏览器进程。此时，另一个合成帧可能由于浏览器 UI 的改变从 UI 线程被添加或从扩展的其他渲染器进程中添加。这些合成帧被发送至 GPU 来呈现到屏幕上。如果触发了一个滚动事件，合成器线程会创建另一个合成帧至 GPU。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/397d4949099dd6d1aaffcb55e8678e37/126df/composit.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkElEQVQoz1WS127CQBRE9///hiceQIJgJHABI3fjgg0WHdGCKKHkyBsS5Uos17szc8ezFq/XK88zVTdsP4qjKEmSIAiGw2Ecx57n0UdR5Pu+bdur1Wq9Xg8Gg8ViAevxeAj+isnEC0LTcprN5kdZpmlaltXv92lAs7bbbcdx0EJ0uVzCej6foigK5jDEc13kwzBklFcWA13XZQWQpilrVFaWZVhgvuAMMZ6TNEVov9+DG41GTAZNA4D917twe7/fv8oS1+v1eDzebrfz+cwZPRzpSqJlA/RyuYCB/CskTqfTbrfDsGEYzNxsNmTGfLzM53MIEoeopmm9Xk/uSEUxHo+JoVqtVioVVVUJI02SPM8bjQYhoYtnmTOATqfzj4xJEBwTAN6YQFRIsK/rOvPlEQan0ylxHg6HPzI/nmu1GjcEwdB1pdXikjCp4aTb5YYkn3ep1+ukDYXMfu4ZVUVRmAMIwzTyJmazGdN4c+zgTl4eAHY4JR3BN0BahAQTC9vtlhSQg/D5LnoZJBgaLKAF8hvmbE0ktc1lqQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;composit&quot;
        title=&quot;composit&quot;
        src=&quot;/static/397d4949099dd6d1aaffcb55e8678e37/799d3/composit.png&quot;
        srcset=&quot;/static/397d4949099dd6d1aaffcb55e8678e37/00d96/composit.png 148w,
/static/397d4949099dd6d1aaffcb55e8678e37/0b23c/composit.png 295w,
/static/397d4949099dd6d1aaffcb55e8678e37/799d3/composit.png 590w,
/static/397d4949099dd6d1aaffcb55e8678e37/126df/composit.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;合成的好处是不需要涉及到主线程。合成器线程不需要等待样式计算或 JavaScript 执行。如果布局或绘制需要重新计算就会涉及到主进程。&lt;/p&gt;
&lt;h2&gt;总结&lt;/h2&gt;
&lt;p&gt;本文主要了解了渲染的流程，从解析到合成的过程。希望在阅读更深入的性能优化时能够有一些帮助。&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.google.com/web/updates/2018/09/inside-browser-part3&quot;&gt;https://developers.google.com/web/updates/2018/09/inside-browser-part3&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[浏览器输入URL...]]></title><description><![CDATA[前言 我们知道现在市场上大多数浏览器是多进程多线程的方式来处理不同的任务。我们今天来看一下进程和线程是如何合作来呈现一个网站的。 我们以简单的浏览网页为例：从地址栏中输入 URL…]]></description><link>https://www.keisei.top/web-browser-happen-in-navigation/</link><guid isPermaLink="false">https://www.keisei.top/web-browser-happen-in-navigation/</guid><pubDate>Sun, 15 Dec 2019 23:35:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;我们知道现在市场上大多数浏览器是&lt;a href=&quot;https://developers.google.com/web/updates/2018/09/inside-browser-part1&quot;&gt;多进程多线程的方式来处理不同的任务&lt;/a&gt;。我们今天来看一下进程和线程是如何合作来呈现一个网站的。&lt;/p&gt;
&lt;p&gt;我们以简单的浏览网页为例：从地址栏中输入 URL 开始，浏览器从网络请求数据并展示内容。我们重点关注用户请求网站数据和浏览器准备渲染一个页面。（如无特殊说明，以下均以 Chrome 浏览器为例）&lt;/p&gt;
&lt;h2&gt;从浏览器一个进程开始&lt;/h2&gt;
&lt;p&gt;浏览器选项卡之外的任何事情都是由浏览器进程来处理的。浏览器进程由绘制按钮和输入框的 UI 线程，处理从浏览器请求数据的网络线程，控制文件访问的存储线程等组成。当向地址栏输入 URL 时，首先会由浏览器进程的 UI 线程来处理输入内容。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4006973a23f68ec28402353d48f91a57/126df/browserprocesses.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhklEQVQoz2WSSY+CYAyG+f//QePZg0evKNGYaIy4RHFDcUNlcINB3IZ5pOMysYcv/dq+fbsp8/m8Wq32+/3hcGhZVrfbRR8MBnzb7bYoWFqt1nK53O120+m0Xq+fTqcoipTRaFSpVPCpqlosFvP5PL5ardbpdHRdR280GuilUomXXMT3er0gCO5gmG3bnkwmEifSbDblFUGnCghIShWmaTqOcz6flUKhUC6X8QnheDwOw9D3/e+HBLF8xeJ5HpbD4bDZbAhWqJ5QPvBTBXr0Iev1OplMQrDf74/HI5br9QqZgubFQpbtdks9t9sN489DcJE3nU6TGu9sNrtcLi8w+agkk8mkUqlEIqFpGpgnbS6XY+D0SfOGYTCd1Wr1B6ZDJsxI2BPzxEQL+CBhMSSFkFzC9sz4YiaIUp9s6NQJDAARrutKF+IV5QWWv7wMLJvNAuYYGCz8NIUiVyFTQJG8yntWoWUlckkcA5tj1J9bgPm+Ko7O/i+AeZkqGJBOLAzpPWaxWHAtv3nWjGZFYrbhAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;browser processes&quot;
        title=&quot;browser processes&quot;
        src=&quot;/static/4006973a23f68ec28402353d48f91a57/799d3/browserprocesses.png&quot;
        srcset=&quot;/static/4006973a23f68ec28402353d48f91a57/00d96/browserprocesses.png 148w,
/static/4006973a23f68ec28402353d48f91a57/0b23c/browserprocesses.png 295w,
/static/4006973a23f68ec28402353d48f91a57/799d3/browserprocesses.png 590w,
/static/4006973a23f68ec28402353d48f91a57/126df/browserprocesses.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;简单的导航&lt;/h3&gt;
&lt;h4&gt;第一步：处理输入&lt;/h4&gt;
&lt;p&gt;当用户向地址栏输入时，UI 线程首先会考虑这是“搜索还是 URL？”。Chrome 浏览器地址栏同时也是搜索栏，所以 UI 线程需要解析并决定是把内容发送给搜索引擎还是真的请求一个网站。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d619ac67749e633ae020812aa0b09bdd/126df/input.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjklEQVQoz51S226CQBTk///ERL/B2CiaiLBABMNFAdGiKGC5LqB0AG3avrXzwrnsmZk9C+O67mq1MgzDNE3btjebjaa1mWFu12tF13UkmqbJsux5XhRFjuPwPF+WZdM0zG63Wy6X6I3H49lsNplMJJ4l3JsqLwi/EEVJFEVFUViWVVUVRDgPrjzP2+H9fn84HCzLIoTgHBEIETiR8JiUhSkRZZG0kKSWheM4rTN2Pp8hzszncyiDG21BEMBSVVWWF3mWZLGf5zT7BgimaZokCfzjMFMUBRI0wjC83W6UUvip7/d7TZsqfCBpHsDz8wrquoYRBgn4MAYWUPTtglaeq5vq1D85lu0cj0fc7r0DPEMG7p7DSCC+3W7hBNtGXFV18nGNrm4SB0mSnjzvcrmgDs+QgRgu3A4jx2shGg6Hg8FgNBpBpDfWdAiCAAewJ/jqK2jhdu0w3hYL830flNghNoE2iHGLklIEaYc4jntBgHb1p+12Oy+dr8X0RQDBr8qPhfVL+hMw3D6V+1/gz/0EToqR/tDWRRIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;input&quot;
        title=&quot;input&quot;
        src=&quot;/static/d619ac67749e633ae020812aa0b09bdd/799d3/input.png&quot;
        srcset=&quot;/static/d619ac67749e633ae020812aa0b09bdd/00d96/input.png 148w,
/static/d619ac67749e633ae020812aa0b09bdd/0b23c/input.png 295w,
/static/d619ac67749e633ae020812aa0b09bdd/799d3/input.png 590w,
/static/d619ac67749e633ae020812aa0b09bdd/126df/input.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;第二步：开始导航&lt;/h4&gt;
&lt;p&gt;当用户按下回车键，UI 线程开始发起网络请求获取网站内容。首先在 Tab 左边会出现加载的标识，网络线程开始通过 DNS 查找并建立 TLS 连接。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/749ccda4aca068ed34465407973dc3f9/126df/navstart.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqklEQVQoz3WS2XKCUBBE+f8/8cnyLSFRAkatuBKJSFQiCrhF3MVdcoBsL05Z2HfuLN0Ngus4pXJFM9ofptnr9QzDaLVa7Xa70+k0Go0YkNE0bTQaLRaLfr9frVaPx2MQBIJldV9KpZKqPUlSLpeTZbler6uq2mw2eb5Goet6Pp8nw6But8us3W4XNtu27bpuv2fFpWoUMXj9CTATAeVymU5GTCYTlguFQoHFut7krlarwZys7/u7KPwf5Eex3++32+1ms4E/xQJnDlzM5/PlcskRPsH1GtyIa3R1Pp9ZJoBoWK/Xh8PhdDo5tp1+fJQymedsluf93V1WUfiJoqjIMlcYTAuV381wYDnGoq1aqbwbxngSBvZixy8Yj8fD4RDaf5shTAo/kslkIpFIpVKDwYBrdCIeOgD2xBmeq9WKJOTZFLrNH4JhPp1OkU3FzPMy6fSDKEqSpCjKwHWZiDpYvGkasy6XS9hMKQga/11hJ1o8z4MXrhaLRY7sRJ3jOFCA/Lfm6w1v4/xsNqOBnbxFABo/owhflXMj7Cj4GKnGMDpN07QsC0wGFRj8BRL9hPf//QcyAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;nav start&quot;
        title=&quot;nav start&quot;
        src=&quot;/static/749ccda4aca068ed34465407973dc3f9/799d3/navstart.png&quot;
        srcset=&quot;/static/749ccda4aca068ed34465407973dc3f9/00d96/navstart.png 148w,
/static/749ccda4aca068ed34465407973dc3f9/0b23c/navstart.png 295w,
/static/749ccda4aca068ed34465407973dc3f9/799d3/navstart.png 590w,
/static/749ccda4aca068ed34465407973dc3f9/126df/navstart.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;在此时，网络线程或许会收到服务器重定向的头信息，如 HTTP301。在这种情况下，网络线程会通知 UI 线程服务器请求重定向。随后另一个 URL 请求会被初始化。&lt;/p&gt;
&lt;h4&gt;第三步：读取响应&lt;/h4&gt;
&lt;p&gt;一旦收到响应体（数据载荷），网络线程会首先查看数据流的前几个字节。响应的 Content-Type 头信息会返回数据的类型，但是这个信息有可能会丢失或错误，所以&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types&quot;&gt;MIME 类型嗅探&lt;/a&gt;会帮助识别数据类型。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a049bd54e903004676c6f75ec11d373b/91043/response.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABM0lEQVQoz4WSbYuCUBCF/f9/SRDRFgKJEE0jy/I9NYpSW7Va91HZZdmCzofh3vGeM2dmFLIs2263URQlSbLf75MBZOq67v7g6wkkhd1uN5vNTNM8n89FURCbpvF9nzOfH4/HyOxeQYjj2HEcJFzXJVqWBe14PHqeh4Qsy5qmzedz8qqqUsYwjOl0OplMTqeTEA3APISqqi6Xy+12OxwOkIMgkCTpYwA0RVFEUUQLm2VZ8qwnLxaL1WqFYeyRwmqapgg9+/znXwjDEDKuNpuNbduo0gW9LJdLbOu6ju56vcYFGQbJlQav12tPpnKe58UAzBDbtk0H0AKvoaGFEGTOtEO9cRf9wCCMhu/3O0zOjACh7h0ExJgb68HJ5wDIrJqyL9f7u+SejL3xJwl/gBf6R+Vt5W949SycsWYyRgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;response&quot;
        title=&quot;response&quot;
        src=&quot;/static/a049bd54e903004676c6f75ec11d373b/799d3/response.png&quot;
        srcset=&quot;/static/a049bd54e903004676c6f75ec11d373b/00d96/response.png 148w,
/static/a049bd54e903004676c6f75ec11d373b/0b23c/response.png 295w,
/static/a049bd54e903004676c6f75ec11d373b/799d3/response.png 590w,
/static/a049bd54e903004676c6f75ec11d373b/91043/response.png 720w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;如果返回的是 HTML 文件，下一步就是把文件传递给渲染器进程。如果是 zip 文件或其他的需要下载的文件，那么这些数据就会被传到下载管理器。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b4797a3b5023a9de4ac03ad174e9bd3f/126df/sniff.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlklEQVQoz02SyZKCQBBE+f8/8aKf4HhQYwJGURRRZBVGQ8INcXBD5tGthnnoSGrJqs5GiaNI1X4My3YdJwgCy7Jms5lt2/P5fDweS0LEMIzVarXf78Mw7PV61+u1LEvF971vVVV146vZbLfbrVZrOBzquj6ZTDgHAqZpdjodIgh5nodWnudV82KxiOM4DHxZqgtIMvgAkzk1TaPTcZz1es1wpdvtMtg0J+T6/b7v+7fb7XQ6of0nIEkucD6fSWVZxv4UK3zzQXq32x0Oh8vlUr4AzwTIpml6PB7hqQARhikU0U+CNSDlB5CzBFzXpRSChYHAZrN5NrMDkhiLjdPpFCGCj8eDRfA2iqJfAdymjThZrlCtzR1I4HC9Xq/Vao1Gg2rZfL/fOYuigLAXWpxJksg1q8m4TScbMny73b7Hygm0yXuhiAV0jkYjHEWR51CktwAPSEMoXS6XLMyrsBRFUh2fGIAKO1P2vHPxAkKMgpCjlEWopp8GHpYLQ9BNBKo784cQigUkeTtEnfRJWsW/wV8Al3EM/geRPYpQ2NqBqgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;sniff&quot;
        title=&quot;sniff&quot;
        src=&quot;/static/b4797a3b5023a9de4ac03ad174e9bd3f/799d3/sniff.png&quot;
        srcset=&quot;/static/b4797a3b5023a9de4ac03ad174e9bd3f/00d96/sniff.png 148w,
/static/b4797a3b5023a9de4ac03ad174e9bd3f/0b23c/sniff.png 295w,
/static/b4797a3b5023a9de4ac03ad174e9bd3f/799d3/sniff.png 590w,
/static/b4797a3b5023a9de4ac03ad174e9bd3f/126df/sniff.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;第四步：找到渲染器进程&lt;/h4&gt;
&lt;p&gt;一旦确认所有的检查，网络线程确定浏览器可以跳转到请求的网站，该线程就会通知 UI 线程数据已经准备就绪。UI 线程会找到渲染器进程来渲染网页。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/320ebdce97d9fb29329fd47c0c5f0c07/126df/findrenderer.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQoz22SyXKCYBCEef838aKPYDwIUiAQkEWRsAhomSr3LSqajx/jKV3W1DBOT880SEWea/rQCcKvKErTNAiCyWQShuF0OnVdt0moOI6zWCw2m02WZYZhXK/X5/MpJUmsappmOR/dbr/f7/V6tm1bluX7PvFTwPM8WZapMCiOY2adz+eaPJvNiqLI0qRptQTeyRtMpKjrOkxGLJdLxCVFURD2PJ//TNNkq6qqLpfLjwAddfx5AcHj8Xg4HNifZok+Hk6nE8/b7ZbdkODnjkaom4ZBtMUmvuc9Ho+nwP1+pyaRwd/v94iQsNLIcXRNg+BwvGlCC7jfNP8no4k4xmIjkZzivCw1VR0CXTeGQ5YkUWSZCJPTMELihrIs8aPdbrdarU6ng4WQsQTlyXjsC2C4OhjYwjMorFCTaYW5Xq8RXK1W7N8s9t4QcBGzqLAjH8Ltdnspkx0F8Aw/Sbh8Pp9jO2+Ft8jCnMfc3W6HQJ7njeevm6s/MKi5h/9ohUA3R0FAme+PhLnfAvWrYjalQqBJiKUAfcSFAMwoipIkIW/qWPsLJiB+zDhRHpgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;find renderer&quot;
        title=&quot;find renderer&quot;
        src=&quot;/static/320ebdce97d9fb29329fd47c0c5f0c07/799d3/findrenderer.png&quot;
        srcset=&quot;/static/320ebdce97d9fb29329fd47c0c5f0c07/00d96/findrenderer.png 148w,
/static/320ebdce97d9fb29329fd47c0c5f0c07/0b23c/findrenderer.png 295w,
/static/320ebdce97d9fb29329fd47c0c5f0c07/799d3/findrenderer.png 590w,
/static/320ebdce97d9fb29329fd47c0c5f0c07/126df/findrenderer.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;由于网络线程可能会花费数百毫秒去请求响应，UI 线程会平行地尝试主动找到或开启一个渲染器进程。如果一切按预料的，当网络线程获取到数据时，渲染器进程就已经准备就绪。&lt;/p&gt;
&lt;h4&gt;第五步：准备跳转&lt;/h4&gt;
&lt;p&gt;一旦数据和渲染器进程准备好，一个 IPC（interprocess communication）会从浏览器进程发送到渲染器进程来提交导航。同时也会把数据流传送到渲染器进程保持继续接收 HTML 数据。一旦浏览器进程接收到渲染器进程跳转开始的信息，导航完成，开始文档加载的阶段。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b9882cfdfbc700b2698116669bf40d4e/126df/commit.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABr0lEQVQoz12S6Y6CQBCEef/3MWqMrPEEFBBdxbAaEJT1iAfiGa/9GHaN2f5Beqa7qmuqkYLAVzTNsp3hcOi67mAw+BIxGo16vR4J947jWJY1m802m814PNZ1/Xq9Pp9PCYDWbKmG9SHLtVpNluVWq2WaJkhTRLvdJq/X6/1+HyLP82zbPp/PCXgymYRhOPY8+qA3RFgiOp0OSDAknyLoQQvzVqsVKqRqtYoM1NJNDa7H43E8HndxHG23JL7vU6WkKEqqQlVVmqMokg6HAzTz+Rym3W5Hwgvh9jHD9+FCiGkYVA8iEBzH8el0SmTv93voyUB+E2HY1DQmIMfQdSaUy2W8oBvk/X5/vkUymWm5XC6TyeTzeaa9aujny/DpdEqOVVjdaDRwNC1J2MBWOJdKpUqlsl6voUcb35NQhH4w7CkdUywWs9nscrlMwLAi6Xa7pdN4AgVexRwWw00gwNyzFGzHfI6gEnA6B/zlcuGW1sViQStgEnxiwzjMsVAoYEHaTAPKJQjuIkhYRvBnMkR8eRG75Mti/rn1+5O8AsEg+YHQ1u12XREg0c+baQjeguMP44d+2mnAJh0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;commit&quot;
        title=&quot;commit&quot;
        src=&quot;/static/b9882cfdfbc700b2698116669bf40d4e/799d3/commit.png&quot;
        srcset=&quot;/static/b9882cfdfbc700b2698116669bf40d4e/00d96/commit.png 148w,
/static/b9882cfdfbc700b2698116669bf40d4e/0b23c/commit.png 295w,
/static/b9882cfdfbc700b2698116669bf40d4e/799d3/commit.png 590w,
/static/b9882cfdfbc700b2698116669bf40d4e/126df/commit.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;额外步骤：初始加载完成&lt;/h4&gt;
&lt;p&gt;当跳转后，渲染器进程会加载资源并渲染页面。一旦渲染器进程结束渲染，它会向浏览器进程返回一个 IPC（当前网站的所有页面 &lt;code class=&quot;language-text&quot;&gt;onload&lt;/code&gt; 事件已经触发并执行完成），UI 线程停止 Tab 上的加载标识。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b93f199ad2138be6e445d1ceb4416033/126df/loaded.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABrklEQVQoz2WS2W6CQBSGef/3afRGJKkbFNyqYiwIAuKGC3VH1H44qanpuZjMMOdfzj9Inu9ranVgGpZlO47T7/e/HmXbdrfbZWNZ1mAwaLVa0+l0vV6PRiPDMC6Xy/1+lxzH1T/UpvEuy8VyuSTLsq7rjUaj1+s1HtVsNmGpVCp8gch1XdM0T6dTBg6CIAwnruvRBz1rvV4XG2CsINvtdufzs9PpcMQLBpfLJS6kUqmEDdwCAIYrLB0Oh3OSpGkKfRiG2IaoVqsJF6qq0hzHsbTf76GZzWar1Yr9+Xy+3W6XNF1GUd80h7aNk1q1CsV2u93tdhhmczweM9uc0WHHJyh2j4LiO47xyZyapinFImnd/1WmDCafz789ajgcPu+wwOr7/mQyiaII/Hg8JjkSFVcS9AAYW1EU5sd8kiS4YHLGEWCCWCwWQqZQKORyOY4ZmDtsk40g22w2KIAkVV5FgClmQZ/YGQQuLGTgvw7xAwBBZkYE+uv1ii/P87jlFyBtAiMt9IC8gMUD8vKIwDKfzxmVV0T52fMSWPBbdNCNH2D8SYICfRgZgacSPc/i+AP8S4QCP7TplQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;loaded&quot;
        title=&quot;loaded&quot;
        src=&quot;/static/b93f199ad2138be6e445d1ceb4416033/799d3/loaded.png&quot;
        srcset=&quot;/static/b93f199ad2138be6e445d1ceb4416033/00d96/loaded.png 148w,
/static/b93f199ad2138be6e445d1ceb4416033/0b23c/loaded.png 295w,
/static/b93f199ad2138be6e445d1ceb4416033/799d3/loaded.png 590w,
/static/b93f199ad2138be6e445d1ceb4416033/126df/loaded.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;跳转至其他网站&lt;/h3&gt;
&lt;p&gt;当用户再次输入不同的 URL 时会发生什么？浏览器进程实际会按之前的步骤执行。不过在此之前，需要确认渲染好的页面是否绑定了 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/Events/beforeunload&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;beforeunload&lt;/code&gt;&lt;/a&gt; 事件。Tab 下的任何事情和 JavaScript 代码都由渲染器进程来处理，所以当新的跳转请求时浏览器进程需要检查渲染器进程。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/71402d5b3a3f7d5629a242727e606079/126df/beforeunload.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABv0lEQVQoz1WSWW+CQBSF+f8/wjfjiy9tapNaE7QxGjSiBRd0REUFMY0o7rv9YNKmvdHhzMw9dzl3lOl0Wq1qoqPb9sBxnG63K4To9/u2bbdaLQl6vZ5pmr7vr1YrfGq12uVyeTweChu9VjUbJVXNl0qlfF7Vdb3RaHQ6HdbP2Nrtdrlc5oRYo9HIsqzT6RSRyey6nuNMpCtrvV43DAMgV5gAqmg2m1xR13A4XCwWy+VSKRaLpCIYHtxRyPl83u12h8Nhv9+Dx+MxfErVNA0fcKVSAYRhqGw2m/l8/hUb++Px+Pix+/3OCllGXMa2Xq9JK90i8jE2jiD/cv6SaQ1MjiAIcrlcMpmk84hMbZPJJJVKJRIJTlHler3uYttutyREJBxkQrZ0jvIMhXAKnTAMrgeDAaowD8h/MyMPfEpjYKSFRi1UEfVM+NvtxopCARoGAY0FcQvgdRgKSELgwBe1CIe/TKDwp8K6rudV9TWTec9mMy8v/LJvb89PT+l0GsD5R6HQNIxbzLn/mCIjoWf0noQwDaNrWWRjGMwPXNE0XggY2X47khY9EszzvJnvezMWfxabBPSGsMgBcF13+t++AR7AfLjknAObAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;beforeunload&quot;
        title=&quot;beforeunload&quot;
        src=&quot;/static/71402d5b3a3f7d5629a242727e606079/799d3/beforeunload.png&quot;
        srcset=&quot;/static/71402d5b3a3f7d5629a242727e606079/00d96/beforeunload.png 148w,
/static/71402d5b3a3f7d5629a242727e606079/0b23c/beforeunload.png 295w,
/static/71402d5b3a3f7d5629a242727e606079/799d3/beforeunload.png 590w,
/static/71402d5b3a3f7d5629a242727e606079/126df/beforeunload.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;当新的导航与当前渲染的站点不在同一个站点上时，将调用一个单独的渲染进程来处理新的导航，而当前的渲染进程将保留下来以处理诸如卸载之类的事件。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e074926b6b24cae624f6c1c906c16616/126df/unload.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvUlEQVQoz1WS2XKCQBBF5/+/wSf/wfhAqlxLRBYVyxVxhxL3La4YcmAqVUk/NA3T9/btO4jFYqHput11Rq47nU77/b7jOMPh0HXddrsti8Fg0Gq1lsvl4XCgxzTN1+sVRZHgxTAtvdHK53KVSiWfz1uW1Wg0ut0uuZkELKqq8gWuyWTS6/Uej0cMZrLnefPZlCa72QRQr9dt26Ygxx9tu9PpgKeAF11o2W63x+NRlMtlwzA4ricB8f1+v359Xa+kOM7nc61W44jJ4AEzGWpUCNn0SOJ2uwGGTtf1qqpqmmYkxaeisO1ut+O0VCrN5/MwDFlbMAcwMJRsNpvT6cQjCAJqWnEEqz4yGcBBEoDx7zsJQfflcgE5Go3ICJES4KYVh9mwUCjABQbbfN+HdDweMzKWDVk6nU6lUtlsdr/fYyOs0W+83281Ce6CjdgWj3CB/QV8uL1er7EEkRIpwTIjpFqtytvGM/ynmM1mkAr25iEBqOACns9nPDAMJZiPANgCUUhVFIXhklpE/8P3POShCp9rmoZWNkQzvuAON8ork1erVbzz4k9wBziBNn4JmbEawfyz+MRRsVjEVycJih8hjXjGFlTEFQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;unload&quot;
        title=&quot;unload&quot;
        src=&quot;/static/e074926b6b24cae624f6c1c906c16616/799d3/unload.png&quot;
        srcset=&quot;/static/e074926b6b24cae624f6c1c906c16616/00d96/unload.png 148w,
/static/e074926b6b24cae624f6c1c906c16616/0b23c/unload.png 295w,
/static/e074926b6b24cae624f6c1c906c16616/799d3/unload.png 590w,
/static/e074926b6b24cae624f6c1c906c16616/126df/unload.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.google.com/web/updates/2018/09/inside-browser-part2&quot;&gt;https://developers.google.com/web/updates/2018/09/inside-browser-part2&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[区分CSS 分辨率和设备分辨率]]></title><description><![CDATA[前言 作为 Web 开发人员，我们在工作中可能会接触移动端 Web…]]></description><link>https://www.keisei.top/css-resolution-vs-device-resolution/</link><guid isPermaLink="false">https://www.keisei.top/css-resolution-vs-device-resolution/</guid><pubDate>Sat, 14 Dec 2019 21:33:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;作为 Web 开发人员，我们在工作中可能会接触移动端 Web 应用的开发。近年来移动端设备都是高分屏/视网膜屏，而且我们有各种尺寸的屏幕需要兼容：手机，平板，桌面端。在我们面前需要理解并运用的就是分辨率这个关键问题。
我们需要处理两种分辨率：一个是真正的设备屏幕分辨率，另一个便是 CSS 可测量的分辨率。&lt;/p&gt;
&lt;h2&gt;高分屏的新时代&lt;/h2&gt;
&lt;p&gt;在过去，这两种分辨率本质上是一致的。在现在，越来越多的手机、平板，甚至桌面端都采用了高分辨率的屏幕。CSS 分辨率和设备分辨率开始出现认知上的差异。&lt;/p&gt;
&lt;h3&gt;真正的不同之处&lt;/h3&gt;
&lt;p&gt;CSS 分辨率是在 CSS 样式中用来测量的单位，屏幕设备分辨率是实际的屏幕像素的数量。&lt;/p&gt;
&lt;p&gt;除了两种分辨率的不同，还有密度显示比（DPR）—屏幕分辨率/CSS 分辨率，如：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;iPhone 11，每个 CSS 像素有 2 个设备像素，即 DPR 是 2x&lt;/li&gt;
&lt;li&gt;iPhone 11 Pro，每个 CSS 像素有 3 个设备像素，DPR 为 3x&lt;/li&gt;
&lt;li&gt;三星 Galaxy S10，每个 CSS 像素有 4 个设备像素，DPR 为 4x&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;三星 Galaxy S10 的分辨率：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;设备分辨率&lt;/strong&gt;：1440px × 3040px&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CSS 分辨率&lt;/strong&gt;：360px × 760px&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;密度显示比&lt;/strong&gt;：4x&lt;/p&gt;
&lt;h3&gt;为什么 CSS 像素与设备像素不同&lt;/h3&gt;
&lt;p&gt;为什么 Web 会出现两种不同的分辨率？答案其实是不得不这么做。&lt;/p&gt;
&lt;p&gt;我们继续以 Galaxy S10 为例，它的屏幕分辨率为 1440px × 3040px。这个分辨率大小已经超过了部分桌面版的屏幕分辨率，而却被塞入非常小的设备中。如果不区分 CSS 分辨率和设备分辨率，桌面端的网站在手机上显示就会展现真实的宽度，我们就没有办法来创造手机和电脑不同样式的响应式网站。&lt;/p&gt;
&lt;h3&gt;设备分辨率的目的是什么&lt;/h3&gt;
&lt;p&gt;设备分辨率的主要针对的是多媒体，即图片，视频。在高分屏下，我们可以提供更清晰的图片和视频。如在 Galaxy S10 中，我们在 CSS 分辨率 300 像素下，可以加载宽度 1200 像素的图片：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;img&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;image-size-1200px&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;300&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;我们如何知道 CSS 分辨率是多少&lt;/h3&gt;
&lt;p&gt;我们可以通过 &lt;a href=&quot;https://yesviz.com/&quot;&gt;yesviz&lt;/a&gt; 来获取某一设备的具体分辨率信息。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c3dac69b18fdacef4896fb5dcf58b952/50334/google-pixel-4xl.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.48381601362861%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACnUlEQVQ4y5VTaU8aURSdxKQSW9wqIFQKU1ncULDBfjDpB7smlk1Tq6jxJ9TGVsUBjU3/pxFSBQaQnWGY4XjfIKT2Q2NfcnK388689+4dTpVbuClUUa83IUkSSqUyoaT5jUaD8nW0222oqqrZrt9qtQgKZFlGpVLpWW4nuoHo5mfsRjextxvF3s4Wdre3sL31BRvrYayHVrH26QPCwQACwQhWVwN48/Y9gqEIwuEwIpE1hMIdPxgIgXO/sMJhf4ZXLxfw8d0KVl4vY3lpEf75acy7ecxQ3TzyGCajAfoRA/p1AzAYTHC5p+B0OuEgTDLrcMEx6QTnnXXDOzcNn2cafp8Hi3MuzExOkFAHbpsFDqsZUy4n+Oc2WM1meDwe+P1L8PkWMTszBc/cLLxeLxYIHG+1gLdZoVnzKHjjIPjRJ5gYHsCYXoex4UHYxo0YH9JD39eHIZ0O+kf9MI4+Bc/zsNvtsNvssJhMmLBYwJ0KMSSEY5yfCvh1JuCncITzwwPED7/j+Jhq8TjOhBP82P+Kg/19xAUBscMjHHwjDuUTFCfiCZzEYjhNxMGxTkpSE8ViEZlsFmIuhzp1uEbdzZEvUq5araHZbKJwU0A2K6JSrWpdZdOQpbo2FVRnWpwoitrGq6s0kskkrq+vkaMc23hxcYlUKoUuJ5n6rXEymUxvzyXF6XS683Hicfl8AYVCgRJ57Wssmc/nNTBRlmNkxhHFXI/z9x4WM3CdAe1AlpmVoSgKDa+CtjbMqhazOrNddOLWvZiBw91qtdooV2R6xwpKZYneTEFDUlBvEFFR8dDFsV+JLVlWSZCaU5KQFWvUnJpmWU65E+z+ev/CPcFSuUknrGpi7JQ3xQZ1uNkT+68Tqmpbuxq7KvP/XF3OQ0RvAXxqZb8S75FnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;谷歌Pixel 4XL&quot;
        title=&quot;谷歌Pixel 4XL&quot;
        src=&quot;/static/c3dac69b18fdacef4896fb5dcf58b952/799d3/google-pixel-4xl.png&quot;
        srcset=&quot;/static/c3dac69b18fdacef4896fb5dcf58b952/00d96/google-pixel-4xl.png 148w,
/static/c3dac69b18fdacef4896fb5dcf58b952/0b23c/google-pixel-4xl.png 295w,
/static/c3dac69b18fdacef4896fb5dcf58b952/799d3/google-pixel-4xl.png 590w,
/static/c3dac69b18fdacef4896fb5dcf58b952/2a3d6/google-pixel-4xl.png 885w,
/static/c3dac69b18fdacef4896fb5dcf58b952/50334/google-pixel-4xl.png 1174w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;写在最后&lt;/h2&gt;
&lt;p&gt;了解 CSS 分辨率和设备分辨率的区别可以让我们更好地理解响应式，针对不同分辨率提供不同尺寸地图片、视频充分发挥高分辨率地优势，为用户带来更好的体验。&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://medium.com/@elad/understanding-the-difference-between-css-resolution-and-device-resolution-28acae23da0b&quot;&gt;https://medium.com/@elad/understanding-the-difference-between-css-resolution-and-device-resolution-28acae23da0b&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[简单的Promise实现]]></title><description><![CDATA[参考 https://www.youtube.com/watch?v=4GpwM8FmVgQ]]></description><link>https://www.keisei.top/promise-from-scratch/</link><guid isPermaLink="false">https://www.keisei.top/promise-from-scratch/</guid><pubDate>Sun, 08 Dec 2019 19:30:00 GMT</pubDate><content:encoded>&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; states &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pending&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;FULFILLED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;fulfilled&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;REJECTED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;rejected&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;isThenable&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;maybePromise&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  maybePromise &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; maybePromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;then &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;computation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; computation &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;computation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bind&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bind&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ex&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ex&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;fulfilledFn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; catchFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; controlledPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fulfilledFn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; catchFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;FULFILLED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_propagateFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;REJECTED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_propagateRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;catchFn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; catchFn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;finally&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sideEffectFn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sideEffectFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;FULFILLED&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; LLJSPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; LLJSPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; controlledPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sideEffectFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;_propagateFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fulfilledFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; fulfilledFn &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; valueOrPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fulfilledFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isThenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token parameter&quot;&gt;reason&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sideEffectFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sideEffectFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;_propagateRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; catchFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; catchFn &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; valueOrPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;catchFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isThenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token parameter&quot;&gt;reason&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sideEffectFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sideEffectFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;FULFILLED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_propagateFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;reason&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;REJECTED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; reason&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_propagateRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

LLJSPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
LLJSPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;reject&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;_&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const promise = new LLJSPromise((resolve, reject) =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   setTimeout(() =&gt; resolve(42), 1000);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const firstPromise = promise.then(value =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got value: ${value}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return value + 1;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const secondPromise = firstPromise.then(value =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got value: ${value}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return value + 1;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const promiseRejected = new LLJSPromise((resolve, reject) =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   setTimeout(() =&gt; reject(&apos;Something went wrong&apos;), 1000);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// }).catch(error =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got Error: ${error}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return LLJSPromise.resolve(&apos;recovered&apos;);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const firstPromiseRejected = promiseRejected.then(value =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got value: ${value}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return value + 1;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const secondPromiseRejected = promiseRejected.then(value =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got value: ${value}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return value + 1;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; fs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;fs&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;path&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;readFile&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;filename&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encoding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;resolve&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    fs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readFile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;filename&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encoding&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;delay&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;timeInMs&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; timeInMs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;readFile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__dirname&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;promise.js&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;utf8&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; characters read&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token regex&quot;&gt;/[aeiou]/g&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;newText&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;newText&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;slice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;An error occured!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;finally&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;--- All done! ---&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=4GpwM8FmVgQ&quot;&gt;https://www.youtube.com/watch?v=4GpwM8FmVgQ&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[webpack 基本原理]]></title><description><![CDATA[简介 现代化的前端应用离不开打包工具，从早期人们所熟知的 Grunt, Gulp 到现在炙手可热的 webpack, rollup 等，这些工具的崛起使得我们的代码构建更加方便，通过 Loader，插件等机制我们可以应用最新的技术，如新语法，预处理 CSS（Scss, Less…]]></description><link>https://www.keisei.top/webpack-behind-the-scene/</link><guid isPermaLink="false">https://www.keisei.top/webpack-behind-the-scene/</guid><pubDate>Wed, 04 Dec 2019 22:33:00 GMT</pubDate><content:encoded>&lt;h2&gt;简介&lt;/h2&gt;
&lt;p&gt;现代化的前端应用离不开打包工具，从早期人们所熟知的 Grunt, Gulp 到现在炙手可热的 webpack, rollup 等，这些工具的崛起使得我们的代码构建更加方便，通过 Loader，插件等机制我们可以应用最新的技术，如新语法，预处理 CSS（Scss, Less），热更新方便了开发体验，摇树（Tree Shaking）减少打包体积等。&lt;/p&gt;
&lt;p&gt;今天主要以 webpack 为例来了解打包工具发展至今是如何工作的，又通过哪些方式为我们提供了更多能力。以下图片简单描述了 webpack 的整个构建流程。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ab7934a1db677767b5369ef3963f3b9d/c1bb8/webpack-process.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.00942655145326%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAEDBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB4hJczk//xAAXEAEBAQEAAAAAAAAAAAAAAAABEAID/9oACAEBAAEFAodNBf/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAAEFAAAAAAAAAAAAAAAAAAEQESAhYf/aAAgBAQAGPwJAGFZD/8QAHRAAAgIBBQAAAAAAAAAAAAAAAAERUXEhMYGR4f/aAAgBAQABPyFKV4aVwJbAlBbrBZOOj//aAAwDAQACAAMAAAAQ0D//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QZH//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8QbX//xAAcEAEBAAICAwAAAAAAAAAAAAABEQAxIWFBcZH/2gAIAQEAAT8QkUNYZCiD2zhQgVmW+fecwQjWs1BrHp8M/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;webpack process&quot;
        title=&quot;webpack process&quot;
        src=&quot;/static/ab7934a1db677767b5369ef3963f3b9d/88218/webpack-process.jpg&quot;
        srcset=&quot;/static/ab7934a1db677767b5369ef3963f3b9d/7237a/webpack-process.jpg 148w,
/static/ab7934a1db677767b5369ef3963f3b9d/0cfdf/webpack-process.jpg 295w,
/static/ab7934a1db677767b5369ef3963f3b9d/88218/webpack-process.jpg 590w,
/static/ab7934a1db677767b5369ef3963f3b9d/77d57/webpack-process.jpg 885w,
/static/ab7934a1db677767b5369ef3963f3b9d/5a917/webpack-process.jpg 1180w,
/static/ab7934a1db677767b5369ef3963f3b9d/c1bb8/webpack-process.jpg 1273w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;工作原理&lt;/h2&gt;
&lt;p&gt;webpack 按其官方介绍，是一款静态资源打包器。在 webpack 的世界，所有的资源（JavaScript，图片，CSS，字体文件等）都是模块（module），在执行时，webpack 从&lt;a href=&quot;https://webpack.js.org/concepts/entry-points/&quot;&gt;入口&lt;/a&gt;开始分析所依赖的模块，然后递归处理依赖模块的依赖，最终生成一个&lt;a href=&quot;https://webpack.js.org/concepts/dependency-graph/&quot;&gt;依赖图&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;webpack 的 80%是由其插件组成，它自身也是事件驱动的架构。在 webpack 生态中，插件是关键的要素，并且为社区提供了强大的能力来进入 webpack 的编译过程中。插件通过 &lt;code class=&quot;language-text&quot;&gt;hook&lt;/code&gt; 方式对每次编译发出的事件做出响应。&lt;/p&gt;
&lt;p&gt;webpack 中一个核心模块是 &lt;code class=&quot;language-text&quot;&gt;Tapable&lt;/code&gt;，许多对象继承了 &lt;code class=&quot;language-text&quot;&gt;Tapable&lt;/code&gt; 类。该类暴露了 &lt;code class=&quot;language-text&quot;&gt;tap&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;tapAsync&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;tapPromise&lt;/code&gt; 方法，插件可以使用这些方法注入将在整个编译过程中触发的自定义构建过程。&lt;/p&gt;
&lt;p&gt;首先来看张图：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/91af4f4bbef2a30e532c68bc23a60b04/02420/webpack-build-process.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 86.0488798370672%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAABg0lEQVQ4y5VTy06DQBT1/z/GpXHhwoWPaG0XksZo0wihtLzmzcC88dKqSW0tenKZAOHMOfee4aw/QGtaInGjhLVWawPlve+P4ezwVcHy5zhKqoQxgQnBmBhjfiWHAf22Ajwq2xUol1r2Y9hTBjqsOdvMFrO4jMfJznkwVlQky1Fe4qpCvBGY4U53WmullB5goP8jZHAK/KRon16KRUq10kmdTJfTt/Ub9EwpY4xDSdmesj2IKAWzccZv7ff/69mHIZIVSievk2W+JITVNfREQZ8QijDhXIxExTuWlikWyDvvoKUBAa7tXRgh1xJF8TzFGSGCMg7SCA1pY0xBH3b7lWw1pzQr67hpCm9FCH6X/zdOKDuZ3aHXS53d9OjR5PdGi69TFPa3CEfIeH69vDrf3F2sby/c6pHTEiG6dY7BPMxv18Jucj/Ivivm7H3C4ydYuzJytvs8e3/5MXZfKW1DGA97nxxckAvHI7x6sDRy4sVZ9WdyH4wiStaC5l1T6RZDuifIH28q3kzIh/aOAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;webpack build process，https://miro.medium.com/max/982/1*NU-KdDY_WxCh3YcDGEbTiw.png&quot;
        title=&quot;webpack build process，https://miro.medium.com/max/982/1*NU-KdDY_WxCh3YcDGEbTiw.png&quot;
        src=&quot;/static/91af4f4bbef2a30e532c68bc23a60b04/799d3/webpack-build-process.png&quot;
        srcset=&quot;/static/91af4f4bbef2a30e532c68bc23a60b04/00d96/webpack-build-process.png 148w,
/static/91af4f4bbef2a30e532c68bc23a60b04/0b23c/webpack-build-process.png 295w,
/static/91af4f4bbef2a30e532c68bc23a60b04/799d3/webpack-build-process.png 590w,
/static/91af4f4bbef2a30e532c68bc23a60b04/2a3d6/webpack-build-process.png 885w,
/static/91af4f4bbef2a30e532c68bc23a60b04/02420/webpack-build-process.png 982w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;简而言之，当 webpack 载入一个模块时，&lt;code class=&quot;language-text&quot;&gt;compiler&lt;/code&gt; 把模块放入称为 &lt;code class=&quot;language-text&quot;&gt;chunk&lt;/code&gt; 的容器内，并在渲染到浏览器之前在它上面执行大量的插件逻辑。&lt;/p&gt;
&lt;p&gt;我们来根据上图一步步来详解：&lt;/p&gt;
&lt;h3&gt;1.编译器（Compiler）&lt;/h3&gt;
&lt;p&gt;当 webpack 载入一个新模块时，Compiler 会第一时间执行（在 webpack.js 中 &lt;code class=&quot;language-text&quot;&gt;compiler.run()&lt;/code&gt;），它本身为 &lt;code class=&quot;language-text&quot;&gt;tapable&lt;/code&gt; 的一个实例。它处于调用栈的最高层，为 webpack 分发事件。它支持注册 &lt;a href=&quot;https://webpack.js.org/api/compiler-hooks&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Hooks&lt;/code&gt;&lt;/a&gt;，可以控制 webpack 开始、停止、处理资源文件、监听模式等。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// node_modules/webpack/lib/webpack.js&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/**
 * @param {WebpackOptions} options options object
 * @param {function(Error=, Stats=): void=} callback callback
 * @returns {Compiler | MultiCompiler} the compiler object
 */&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;webpack&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;options&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; callback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; webpackOptionsValidationErrors &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;validateSchema&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    webpackOptionsSchema&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    options
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;webpackOptionsValidationErrors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebpackOptionsValidationError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;webpackOptionsValidationErrors&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    compiler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MultiCompiler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;webpack&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; options &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;object&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    options &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebpackOptionsDefaulter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    compiler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Compiler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;options &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;NodeEnvironmentPlugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      infrastructureLogging&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;infrastructureLogging&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;compiler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; plugin &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; plugin &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;compiler&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;compiler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hooks&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hooks&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;afterEnvironment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;options &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebpackOptionsApply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Invalid argument: options&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;callback&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; callback &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Invalid argument: callback&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watch &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;o&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; watchOptions &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;o&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watchOptions &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watchOptions &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;watch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;watchOptions&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; callback&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;callback&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// node_modules/webpack/lib/Compiler.js&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Compiler&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Tapable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hooks &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncBailHook&amp;lt;Compilation&gt;} */&lt;/span&gt;
      shouldEmit&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncBailHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Stats&gt;} */&lt;/span&gt;
      done&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;stats&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;&gt;} */&lt;/span&gt;
      additionalPass&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Compiler&gt;} */&lt;/span&gt;
      beforeRun&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compiler&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Compiler&gt;} */&lt;/span&gt;
      run&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compiler&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Compilation&gt;} */&lt;/span&gt;
      emit&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;string, Buffer&gt;} */&lt;/span&gt;
      assetEmitted&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Compilation&gt;} */&lt;/span&gt;
      afterEmit&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Compilation, CompilationParams&gt;} */&lt;/span&gt;
      thisCompilation&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;params&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Compilation, CompilationParams&gt;} */&lt;/span&gt;
      compilation&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;params&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;//...&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;2.编译/依赖图 （Compilation/Dependency Graph）&lt;/h3&gt;
&lt;p&gt;编译器接下来会创建编译对象（Compilation），&lt;code class=&quot;language-text&quot;&gt;Compilation&lt;/code&gt; 是 webpack 的核心，从编译对象开始构建依赖图，提升树并渲染成束（编译器和编译对象都继承自 Tapable 类）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// node_modules/webpack/lib/Compilation.js&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Compilation&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Tapable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
 &lt;span class=&quot;token comment&quot;&gt;/**
   * Creates an instance of Compilation.
   * @param {Compiler} compiler the compiler which created the compilation
   */&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;compiler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hooks &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Module&gt;} */&lt;/span&gt;
      buildModule&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Module&gt;} */&lt;/span&gt;
      rebuildModule&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Module, Error&gt;} */&lt;/span&gt;
      failedModule&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;error&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Module&gt;} */&lt;/span&gt;
      succeedModule&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Dependency, string&gt;} */&lt;/span&gt;
      addEntry&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;entry&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Dependency, string, Error&gt;} */&lt;/span&gt;
      failedEntry&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;entry&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;error&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Dependency, string, Module&gt;} */&lt;/span&gt;
      succeedEntry&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;entry&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/** @type {SyncWaterfallHook&amp;lt;DependencyReference, Dependency, Module&gt;} */&lt;/span&gt;
      dependencyReference&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncWaterfallHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;dependencyReference&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;dependency&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;3.分析器（Resolver）&lt;/h3&gt;
&lt;p&gt;当把入口文件传递给 webpack 时，会分发给解析器。解析器会判断给到的相对路径是否存在，并返回绝对路径和其他如上下文、请求、调用等额外信息。如，在 &lt;code class=&quot;language-text&quot;&gt;node&lt;/code&gt; 中 require 一个声明，它会被传入模块解析器来判断是否存在。（&lt;code class=&quot;language-text&quot;&gt;ResolverFactory.js&lt;/code&gt;）&lt;/p&gt;
&lt;h3&gt;4.模块工厂（Module Factories）&lt;/h3&gt;
&lt;p&gt;工厂方法通常用来创建对象或实例。webpack 中，模块工厂用来创建模块实例。模块工厂拿到从解析器正确解析返回的路径，去该路径的文件收集源码，然后创建一个模块对象/实例（&lt;code class=&quot;language-text&quot;&gt;NormalModuleFactory.js&lt;/code&gt; &amp;#x26; &lt;code class=&quot;language-text&quot;&gt;ContextModuleFactory.js&lt;/code&gt;）。&lt;/p&gt;
&lt;h3&gt;5.解析器（Parser）&lt;/h3&gt;
&lt;p&gt;解析器是把传入的字符串源码转换成&lt;a href=&quot;https://astexplorer.net/&quot;&gt;ATS（抽象语法树）&lt;/a&gt;。webpack 解析器类使用了 &lt;code class=&quot;language-text&quot;&gt;acron&lt;/code&gt; 解析器，接收模块对象（包含源码）参数，并返回 AST 对象。webpack 遍历整棵树找到所有的 require 和 import，并生成依赖图。解析器会把依赖附在模块上。注意我们会通过 &lt;code class=&quot;language-text&quot;&gt;loaders&lt;/code&gt; 注册一些 &lt;code class=&quot;language-text&quot;&gt;rules&lt;/code&gt;，当满足规则时对应的 loader 会转换代码至 JavaScript 中，然后解析器解析这些代码到 ATS 中。&lt;/p&gt;
&lt;h3&gt;6.模板（Templates ）&lt;/h3&gt;
&lt;p&gt;模板随后会把解析过的模块对象和生成的代码进行数据绑定。生成一个包含模块的 chunk 数组。整个模块可以分为三部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;块模板（Chunk Template）&lt;/li&gt;
&lt;li&gt;模块模板（Module Template）&lt;/li&gt;
&lt;li&gt;依赖模板（Dependency Templates）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个处理过程会重复执行直到处理完所有的依赖。webpack 的核心工作是解析文件并将所有内容捆绑到一个依赖图中。这使得 webpack 可以增量编译。&lt;/p&gt;
&lt;h2&gt;小结&lt;/h2&gt;
&lt;p&gt;webpack 的出现使前端工程化迈向了新的台阶，使我们开发更便捷。webpack 提供的能力也促进了社区的发展来完善构建流程。&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://medium.com/@imranhsayed/webpack-behind-the-scenes-85333a23c0f6&quot;&gt;https://medium.com/@imranhsayed/webpack-behind-the-scenes-85333a23c0f6&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[神奇的模板字符串]]></title><description><![CDATA[背景 最近在个人博客中采用了styled-components库来写组件的样式，在翻看文档时，发现用法： 这个用法引起了我的兴趣，这是如何 work 起来的？ 带标签的模板字符串（Tagged Template Literals…]]></description><link>https://www.keisei.top/tagged-template-literals/</link><guid isPermaLink="false">https://www.keisei.top/tagged-template-literals/</guid><pubDate>Sun, 01 Dec 2019 16:41:00 GMT</pubDate><content:encoded>&lt;h2&gt;背景&lt;/h2&gt;
&lt;p&gt;最近在个人博客中采用了&lt;a href=&quot;https://www.styled-components.com/&quot;&gt;styled-components&lt;/a&gt;库来写组件的样式，在翻看文档时，发现用法：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; styled &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;styled-components&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Title &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; styled&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;h1&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
  color: palevioletred;
  font-size: 18px;
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;App&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Title&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;Hello World!&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Title&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个用法引起了我的兴趣，这是如何 work 起来的？&lt;/p&gt;
&lt;h2&gt;带标签的模板字符串（Tagged Template Literals）&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;styled.h1&lt;/code&gt; 符号其实是模板字符串的一种高级用法，本质上它只是调用了一个函数即 &lt;code class=&quot;language-text&quot;&gt;styled.h1``\&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;styled.h1()&lt;/code&gt; 功能是同样的。不过差异在于两种写法的传参方式。&lt;/p&gt;
&lt;p&gt;我们来看下面简单的例子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;logArgs&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;logArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; a b&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;作为标签模板字符串来调用：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; [&apos;&apos;]&lt;/span&gt;

logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like pizza&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; [&apos;I like pizza&apos;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看出，模板字符串方式会把传入的参数以数组来包一层。&lt;/p&gt;
&lt;h3&gt;插值（Interpolations）&lt;/h3&gt;
&lt;p&gt;模板字符串中可以存在插值，如：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteFood &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pizza&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;logArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteFood&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; I like pizza.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到，JavaScript 执行时会把变量插入到传入函数参数的字符串中。那在带有标签的模板字符串中使用时有什么表现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteFood &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pizza&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteFood&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; [&apos;I like &apos;, &apos;.&apos;] &apos;pizza&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们从结果中看到第一个结果还是字符串的数组，里面的元素在插值处分割而插值的内容则作为第二个参数被传递。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/feb005bb1f6d4e45610502e668f9b3c9/5e17e/logargs-explanation.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 28.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3klEQVQY042Qy27CMBBF8/9/BggsUhWqEJLGJHbs+EWS/cGli+4KiyvNYu7RmSmEEHyeTghx5CBK9rsddV0xtRK3LQmXlhgj3geC94QQ/k3RdRJrNEvqWWLHGBKDS2gf6XNu/o6yGeQdPhf8C2ix2WxprjV3WxLHA602VNrzpSbOKlENkl7XxBCfsJfAdV1IaSbYKhskUi7OMZuEhZtuWN05w6an3VsnO+d+QWZP9CrPEZeLsz3S6SvfNv3ZvQEtjBnRekApiZQtxpr8U4UdPuh6xaVtMKPOy/HluT95ADwav9orQWJ1AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;logargs explanation&quot;
        title=&quot;logargs explanation&quot;
        src=&quot;/static/feb005bb1f6d4e45610502e668f9b3c9/799d3/logargs-explanation.png&quot;
        srcset=&quot;/static/feb005bb1f6d4e45610502e668f9b3c9/00d96/logargs-explanation.png 148w,
/static/feb005bb1f6d4e45610502e668f9b3c9/0b23c/logargs-explanation.png 295w,
/static/feb005bb1f6d4e45610502e668f9b3c9/799d3/logargs-explanation.png 590w,
/static/feb005bb1f6d4e45610502e668f9b3c9/5e17e/logargs-explanation.png 658w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;纯文本的字符串都被存放在第一个参数数组内，随后为插值内容。&lt;/p&gt;
&lt;p&gt;当多于一个插值时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteFood &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pizza&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteDrink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;cola&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteFood&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; and &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteDrink&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; [&apos;I like &apos;, &apos; and &apos;, &apos;.&apos;] &apos;pizza&apos; &apos;cola&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;每个插值都成为函数调用的下一个参数，我们可以有任意多个插值参数。&lt;/p&gt;
&lt;p&gt;与正常的函数调用相比：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteFood &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pizza&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteDrink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;cola&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;logArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteFood&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; and &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteDrink&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; I like pizza and cola.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;所有的插值都混为了一个大字符串。&lt;/p&gt;
&lt;h2&gt;优势&lt;/h2&gt;
&lt;p&gt;这种方式开启了新的探索。以 &lt;code class=&quot;language-text&quot;&gt;styled-components&lt;/code&gt; 为例，我们有一个 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;Button /&amp;gt;&lt;/code&gt; 组件，当 props 传入 &lt;code class=&quot;language-text&quot;&gt;primary&lt;/code&gt; 时期望按钮看起来更大，&lt;code class=&quot;language-text&quot;&gt;&amp;lt;Button primary /&amp;gt;&lt;/code&gt;。
我们可以如下来实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Button &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; styled&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;button&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
  font-size: &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;props&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;primary &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;2em&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;1em&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;得到的结果：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// font-size: 2em;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Button primary &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// font-size: 1em;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Button &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;让我们再回过来看 &lt;code class=&quot;language-text&quot;&gt;logArgs&lt;/code&gt; 函数。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;logArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Test &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;test&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; Test () =&gt; console.log(&apos;test&apos;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里注意得到的结果为整个字符串，而没有真正的函数。&lt;/p&gt;
&lt;p&gt;当以带标签的模板字符串调用时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Test &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;test&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// [&apos;Test&apos;, &apos;&apos;] () =&gt; console.log(&apos;test&apos;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;从结果上可能看不出，但这里得到了真正的函数（而不是字符串）。&lt;/p&gt;
&lt;p&gt;这意味着我们可以得到这个函数并且执行它。我们来看一个新的可以执行函数类型参数的函数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;execFuncArgs&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  args&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;arg&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; arg &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;arg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个函数执行时会执行类型为函数的参数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;execFuncArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; undefined&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;execFuncArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;this is a function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; this is a function&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;execFuncArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;another one&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; another one&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们再来看：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;execFuncArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Hi, &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Executed!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; undefined&lt;/span&gt;

execFuncArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Hi, &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Executed!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;Executed!&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在带标签的模板字符串中 execFuncArgs 的第二个参数传递的是实际函数，然后继续执行该函数。&lt;code class=&quot;language-text&quot;&gt;styled-components&lt;/code&gt; 底层的实现就是依赖这个特性，在渲染时传入插值函数的 props 可以帮用户来动态更新样式。&lt;/p&gt;
&lt;h2&gt;总结&lt;/h2&gt;
&lt;p&gt;可以看到，JavaScript 的一个新特性就可以实现一个强大的库，为我们的开发带来更好的体验，我们需要不断去探索去总结去实践 JavaScript 实现更多新的能力。&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://mxstbr.blog/2016/11/styled-components-magic-explained/&quot;&gt;https://mxstbr.blog/2016/11/styled-components-magic-explained/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[The WebSocket API]]></title><description><![CDATA[引言 WebSocket API 是一种较为高级的通信方式，它在客户端和服务端开启一条全双工的通道，可以从客户端发送消息至服务端并且可以接受事件驱动的响应而不需要主动去请求回复。简而言之，收发消息的两端一旦开启通道可相互自由通信。 WebSocket…]]></description><link>https://www.keisei.top/the-websocket-api/</link><guid isPermaLink="false">https://www.keisei.top/the-websocket-api/</guid><pubDate>Tue, 26 Nov 2019 23:21:00 GMT</pubDate><content:encoded>&lt;h2&gt;引言&lt;/h2&gt;
&lt;p&gt;WebSocket API 是一种较为高级的通信方式，它在客户端和服务端开启一条全双工的通道，可以从客户端发送消息至服务端并且可以接受事件驱动的响应而不需要主动去请求回复。简而言之，收发消息的两端一旦开启通道可相互自由通信。&lt;/p&gt;
&lt;h2&gt;WebSocket 客户端&lt;/h2&gt;
&lt;p&gt;为了使用 WebSocket 协议通信，需要创建 &lt;code class=&quot;language-text&quot;&gt;WebSocket&lt;/code&gt; 对象，会自动尝试创建到服务端的连接。&lt;/p&gt;
&lt;p&gt;WebSocket 构造函数接受两个参数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;websocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebSocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; protocols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;url&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;    指定要连接的服务器的 URL 地址，应该以 &lt;code class=&quot;language-text&quot;&gt;wss://&lt;/code&gt; 协议开头，不安全的地址以 &lt;code class=&quot;language-text&quot;&gt;ws://&lt;/code&gt; 开头。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;protocols&lt;/code&gt; (可选)&lt;/p&gt;
&lt;p&gt;    一个协议字符串或是多个协议字符串的数组。这些字符串用来指定子协议，可以让一个服务器实现多个 WebSocket 子协议（例如，可以通过不同的 &lt;code class=&quot;language-text&quot;&gt;protocol&lt;/code&gt; 来使服务器处理不同类型的交互）。如果没有指定该参数，默认为空字符串。&lt;/p&gt;
&lt;p&gt;如果地址不可访问，构造函数会抛出 &lt;code class=&quot;language-text&quot;&gt;SecurityError&lt;/code&gt;，通常会出现在连接不安全的地址（几乎所有的客户端都要求提供安全的 WebSocket 连接，除非在相同的设备上或在同一个网络下）。&lt;/p&gt;
&lt;h3&gt;建立连接&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; exampleSocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebSocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;wss://www.example.com/socketserver&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;protocolOne&apos;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 可以选择多个协议&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; exmapleSocket2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebSocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;wss://www.example.com/socketserver2&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;protocolOne&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;protocolTwo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;exampleSocket 此时的 readyState 是 &lt;code class=&quot;language-text&quot;&gt;CONNECTING&lt;/code&gt;，一旦握手成功可以传输数据时 &lt;code class=&quot;language-text&quot;&gt;readyState&lt;/code&gt; 的状态变为 &lt;code class=&quot;language-text&quot;&gt;OPEN&lt;/code&gt; 。 &lt;code class=&quot;language-text&quot;&gt;exampleSocket.protocol&lt;/code&gt; 属性可以得出服务端选择的协议是哪一个。&lt;/p&gt;
&lt;p&gt;建立 WebSocket 连接需要依赖&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism&quot;&gt;HTTP 升级机制&lt;/a&gt;，当我们通过 &lt;code class=&quot;language-text&quot;&gt;ws://www.example.com&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;wss://www.example.com&lt;/code&gt; 访问服务端时，实际上发生了隐式的请求升级。&lt;/p&gt;
&lt;h3&gt;发送数据至服务端&lt;/h3&gt;
&lt;p&gt;一旦建立连接，便可以通过 &lt;code class=&quot;language-text&quot;&gt;send()&lt;/code&gt; 方法向服务端发送 &lt;code class=&quot;language-text&quot;&gt;string&lt;/code&gt;， &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/Blob&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Blob&lt;/code&gt;&lt;/a&gt;，&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/ArrayBuffer&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;ArrayBuffer&lt;/code&gt;&lt;/a&gt; 格式的数据。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;一段发送至服务器的消息...&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;由于建立连接是异步并且可能会失败的，所以建立连接后立即调用 &lt;code class=&quot;language-text&quot;&gt;send()&lt;/code&gt; 方法是不能保证成功的。可以通过定义 &lt;code class=&quot;language-text&quot;&gt;onopen&lt;/code&gt; 监听函数来保证连接至少在开启后再去发送数据。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;onopen&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;一段发送至服务器的消息...&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;使用 JSON 传输对象&lt;/h4&gt;
&lt;p&gt;当需要向服务端传输复杂的数据时可以用&lt;a href=&quot;https://developer.mozilla.org/en/JSON&quot;&gt;JSON&lt;/a&gt;包装为字符串：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sendText&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 构造服务端处理数据所需的对象结构&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; msg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    type&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    text&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;text&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    id&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; clientID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    date&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Date&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 发送JSON字符串&lt;/span&gt;
  exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stringify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;msg&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;从服务端接收消息&lt;/h3&gt;
&lt;p&gt;WebSocket 是事件驱动的 API，当接收到消息，一个 &lt;code class=&quot;language-text&quot;&gt;message&lt;/code&gt; 事件会发送至 &lt;code class=&quot;language-text&quot;&gt;WebSocket&lt;/code&gt; 对象。可通过监听 &lt;code class=&quot;language-text&quot;&gt;message&lt;/code&gt; 事件或者定义 &lt;code class=&quot;language-text&quot;&gt;onmessage&lt;/code&gt; 事件句柄。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;onmessage&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;接收并解析数据&lt;/h4&gt;
&lt;p&gt;以聊天工具来说，客户端需要接收的数据包类型有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;登录握手&lt;/li&gt;
&lt;li&gt;消息文本&lt;/li&gt;
&lt;li&gt;用户列表更新&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以下为解析即将到来的数据：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;onmessage&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; f &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;chatbox&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contentDocument&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; msg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; time &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;date&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; timeStr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toLocaleTimeString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;id&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      clientID &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;setUsername&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;username&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;b&gt;User &amp;lt;em&gt;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;/em&gt; signed in at &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        timeStr &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;/b&gt;&amp;lt;br&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;(&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; timeStr &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;) &amp;lt;b&gt;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;/b&gt;: &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;br&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;rejectusername&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;b&gt;Your username has been set to &amp;lt;em&gt;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;/em&gt; because the name you chose is in use.&amp;lt;/b&gt;&amp;lt;br&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;userlist&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; ul &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;users&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        ul &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;users&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;br&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;userlistbox&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;innerHTML &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ul&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;chatbox&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contentWindow&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;scrollByPages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里我们通过 &lt;code class=&quot;language-text&quot;&gt;JSON.parse()&lt;/code&gt; 来将字符串数据解析为对象格式，并执行对应逻辑。&lt;/p&gt;
&lt;h4&gt;文本格式&lt;/h4&gt;
&lt;p&gt;通过 WebSocket 接收的文本为 UTF-8 格式。&lt;/p&gt;
&lt;h3&gt;关闭连接&lt;/h3&gt;
&lt;p&gt;当完成通信断开连接时通过调用 &lt;code class=&quot;language-text&quot;&gt;close()&lt;/code&gt; 方法来实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在关闭连接时最好检查 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/bufferedAmount&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;bufferedAmount&lt;/code&gt;&lt;/a&gt; 在网路中是否还有未传输的数据。如果值不为 0，说明还有数据待处理，所以需要处理完成再关闭。&lt;/p&gt;
&lt;h3&gt;安全事项&lt;/h3&gt;
&lt;p&gt;WebSocket 不应该在混合环境中使用。即不能在 HTTPS 中建立不安全的 WebSocket，反之亦然。
现在大多数浏览器厂商只允许安全的 WebSocket 连接，不再支持在不安全的环境下使用。&lt;/p&gt;
&lt;h2&gt;WebSocket 服务端&lt;/h2&gt;
&lt;p&gt;简单来说一个 WebSocket 服务器是监听任何 TCP 服务器端口的应用程序。实现一个自定义的服务器听起来让人畏却，但实际上实现一个简单的 WebSocket 是非常容易的。&lt;/p&gt;
&lt;p&gt;可以使用任何支持&lt;a href=&quot;https://en.wikipedia.org/wiki/Berkeley_sockets&quot;&gt;Berkeley sockets&lt;/a&gt;的服务端语言来编写一个 WebSocket 服务器，例如 C(++)，Python，PHP，或者&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Server-Side_JavaScript&quot;&gt;服务端 JavaScript&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;WebSocket 服务器通常是独立的专门的服务器（为了负载均衡或其他实际的原因），所以需要使用&lt;a href=&quot;https://en.wikipedia.org/wiki/Reverse_proxy&quot;&gt;反向代理&lt;/a&gt;来检测 WebSocket 握手，预处理，并将客户端发送至真正的 WebSocket 服务器。这意味着不需要在服务器程序中处理 cookie 和鉴权等操作。&lt;/p&gt;
&lt;h3&gt;WebSocket 握手&lt;/h3&gt;
&lt;p&gt;首先，服务器必须使用一个标准的 TCP 套接字来监听即将到来的 socket 连接。在 WebSocket 中握手就是 &lt;code class=&quot;language-text&quot;&gt;Web&lt;/code&gt; 。它是从 HTTP 到 WebSockets 的桥梁。在握手过程中，连接协商过程中，如果条款是有问题的，任何一方都可以在连接成功之前退出。服务器必须小心理解任何客户端的请求，否则就会出现安全问题。&lt;/p&gt;
&lt;h4&gt;客户端握手请求&lt;/h4&gt;
&lt;p&gt;客户端握手过程通过连接服务器并且发送一个 WebSocket 连接请求。&lt;code class=&quot;language-text&quot;&gt;client&lt;/code&gt; 会发送一个标准的带有头部的 HTTP 请求（HTTP 版本必须 1.1 或更高，方法必须是 &lt;code class=&quot;language-text&quot;&gt;GET&lt;/code&gt; 请求）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;GET /chat HTTP/1.1
Host: example.com:8000
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;客户端可以征求扩展或子协议。一些其他常见的头信息&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent&quot;&gt;User-Agent&lt;/a&gt;，&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer&quot;&gt;Referer&lt;/a&gt;，&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cookie&quot;&gt;Cookie&lt;/a&gt; 或权限校验等也需要发送。它们并非与 WebSocket 直接关联，并且可以安全地忽略。通常来说反向代理会首先处理这些头信息。&lt;/p&gt;
&lt;p&gt;如果 header 中有任一信息有误，服务器会发出 &lt;code class=&quot;language-text&quot;&gt;400&lt;/code&gt; 的状态码并立即关闭 socket。&lt;/p&gt;
&lt;h4&gt;服务器握手响应&lt;/h4&gt;
&lt;p&gt;当服务器收到握手请求，会返回一个特殊的响应来指明协议会从 HTTP 变更为 WebSocket。头信息大致如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;此外，服务器可以决定扩展/子协议的请求。&lt;code class=&quot;language-text&quot;&gt;Sec-WebSocket-Accept&lt;/code&gt; 是根据从客户端的 &lt;code class=&quot;language-text&quot;&gt;Sec-WebSocket-Key&lt;/code&gt; 来生成的。具体规则为将 &lt;code class=&quot;language-text&quot;&gt;Sec-WebSocket-Key&lt;/code&gt; 和&lt;a href=&quot;https://en.wikipedia.org/wiki/Magic_string&quot;&gt;魔法字符串&lt;/a&gt; &lt;code class=&quot;language-text&quot;&gt;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&lt;/code&gt; 拼接至一起，然后执行 &lt;a href=&quot;https://en.wikipedia.org/wiki/SHA-1&quot;&gt;SHA-1 hash&lt;/a&gt;，最后返回该哈希 &lt;a href=&quot;https://en.wikipedia.org/wiki/Base64&quot;&gt;base64&lt;/a&gt;的编码格式。&lt;/p&gt;
&lt;p&gt;一旦服务端发送这些头信息，说明握手已经成功，可以交换数据。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;在发送握手的响应之前服务器可以发送其他头信息，或要求鉴权，或者通过其他状态码重定向到其他服务器。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;保持客户端连接&lt;/h4&gt;
&lt;p&gt;这并不直接与 WebSocket 协议关联，但值得提出：服务器需要保持客户端 socket 的连接，这样就不需要在完成握手后再次握手。&lt;/p&gt;
&lt;h3&gt;交换数据帧&lt;/h3&gt;
&lt;p&gt;服务端和客户端任一者可以选择在任何时候发送消息。&lt;/p&gt;
&lt;h4&gt;格式化&lt;/h4&gt;
&lt;p&gt;每个数据帧都需要遵循如下格式：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Frame format:
​​
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-------+-+-------------+-------------------------------+
    |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
    |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
    |N|V|V|V|       |S|             |   (if payload len==126/127)   |
    | |1|2|3|       |K|             |                               |
    +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
    |     Extended payload length continuedundefined if payload len == 127  |
    + - - - - - - - - - - - - - - - +-------------------------------+
    |                               |Masking-keyundefined if MASK set to 1  |
    +-------------------------------+-------------------------------+
    | Masking-key (continued)       |          Payload Data         |
    +-------------------------------- - - - - - - - - - - - - - - - +
    :                     Payload Data continued ...                :
    + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
    |                     Payload Data continued ...                |
    +---------------------------------------------------------------+&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;MASK 位表明了信息是否是编码的。信息从客户端发出时必须是加密的，服务端期望收到的值为 1，而服务端发送的数据不会加密，也不会设置 MASK 位。&lt;/p&gt;
&lt;p&gt;opcode 字段定义了如何解析数据载荷：0x0 表示继续，0x1 表示 UTF-8 格式的文本，0x2 表示二进制等。&lt;/p&gt;
&lt;p&gt;FIN 位表明是否是该数据流的最后一条信息。如果为 0，服务器会保持收听信息的其他部分，如果为 1 则认为信息已送达。&lt;/p&gt;
&lt;h4&gt;解码载荷长度&lt;/h4&gt;
&lt;p&gt;为了读取载荷数据需要知道何时停止读取，所以知道载荷长度非常重要：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;读取 9-15 位并解析为无符号整数。如果小于等于 125，那么该值就是数据长度。如果等于 126，执行第二步。如果等于 127，执行第三步。&lt;/li&gt;
&lt;li&gt;读取接下来的 16 位并解析为无符号整数，完成。&lt;/li&gt;
&lt;li&gt;读取接下来 64 位解析为无符号整数（最高位必须位 0），完成。&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;读取并解密数据&lt;/h4&gt;
&lt;p&gt;如果设置了 MASK 位，需要读后面 4 组 8 位，这是编码的 key。一旦载荷长度和编码 key 解析完成，可以继续从 socket 中读取该长度的字节数。为了解码，循环遍历加密数据的八位字节（文本数据的字节），然后将八位字节与 MASK 的第（i 模 4）个八位字节进行 XOR 运算。伪代码如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;DECODED&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ENCODED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;DECODED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ENCODED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;MASK&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;消息片段&lt;/h4&gt;
&lt;p&gt;FIN 和 opcode 字段在一起将发送的一条信息拆分为多个单独的帧。被称为&lt;code class=&quot;language-text&quot;&gt;message fragmentation&lt;/code&gt;。碎片化（Fragmentation）只在 opcode 的 &lt;code class=&quot;language-text&quot;&gt;0x0&lt;/code&gt; 至 &lt;code class=&quot;language-text&quot;&gt;0x2&lt;/code&gt; 有效。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;0x0：代表一个连续帧，意味着需要把该帧的数据载荷和上一帧的载荷连接在一起&lt;/li&gt;
&lt;li&gt;0x1：代表载荷为文本格式&lt;/li&gt;
&lt;li&gt;0x2：代表载荷为二进制格式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下面是一个简单的例子来说明服务端是如何响应客户端信息的：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Client: FIN=1undefined opcode=0x1undefined msg=&amp;quot;hello&amp;quot;
Server: (process complete message immediately) Hi.
Client: FIN=0undefined opcode=0x1undefined msg=&amp;quot;and a&amp;quot;
Server: (listeningundefined new message containing text started)
Client: FIN=0undefined opcode=0x0undefined msg=&amp;quot;happy new&amp;quot;
Server: (listeningundefined payload concatenated to previous message)
Client: FIN=1undefined opcode=0x0undefined msg=&amp;quot;year!&amp;quot;
Server: (process complete message) Happy new year to you too!&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;第一帧包含了全部的消息，所以服务端可以处理并响应。第二帧客户端发送了文本载荷但整个信息并没有完全送达，其他剩余部分通过连接帧来发送，通过标记&lt;code class=&quot;language-text&quot;&gt;FIN=1&lt;/code&gt;指明了最后一帧。&lt;/p&gt;
&lt;h3&gt;Pings and Pongs: WebSocket 心跳检测&lt;/h3&gt;
&lt;p&gt;在握手完成后，客户端或服务端都可以选择发送一个 ping 至对方，当 ping 收到时，接收方必须尽快发送一个 pong 给对方。可以通过这个机制来确认对方是否仍在连接。&lt;/p&gt;
&lt;p&gt;一个 ping 或 pong 只是一个普通的控制帧，Pings 的 opcode 为 &lt;code class=&quot;language-text&quot;&gt;0x9&lt;/code&gt; ，pongs 的 opcode 为 &lt;code class=&quot;language-text&quot;&gt;0xA&lt;/code&gt;。当收到一个 ping，发送 pong 时携带 ping 发送的一致的数据载荷（最大载荷长度为 125）。&lt;/p&gt;
&lt;h3&gt;关闭连接&lt;/h3&gt;
&lt;p&gt;客户端或服务端关闭连接可以发送一个带有包含一个特殊控制序列数据的控制帧来开启关闭握手。接收到此帧后，另一方会发送一个结束帧作为响应。先前的一方会关闭连接。关闭连接后收到的任何其他数据都会被丢掉。&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/Websockets_API&quot;&gt;https://developer.mozilla.org/en-US/docs/Web/API/Websockets_API&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[React Fiber 架构]]></title><description><![CDATA[介绍 React Fiber 是当前开发中的最新版 React…]]></description><link>https://www.keisei.top/react-fiber-architecture/</link><guid isPermaLink="false">https://www.keisei.top/react-fiber-architecture/</guid><pubDate>Fri, 22 Nov 2019 23:08:00 GMT</pubDate><content:encoded>&lt;h2&gt;介绍&lt;/h2&gt;
&lt;hr&gt;
&lt;p&gt;React Fiber 是当前开发中的最新版 React 的核心算法的实现。它的主要目标是提高动画、布局、手势等操作的响应速度。最大的功能就是增强渲染：有能力将渲染工作分割成多块，并将它们分散到多个帧中去渲染。&lt;/p&gt;
&lt;p&gt;其他关键功能包括有能力暂停、渲染，有新的更新时可以重复使用；有能力对不同的更新增加优先级；新的并发模式。&lt;/p&gt;
&lt;h3&gt;前置条件&lt;/h3&gt;
&lt;p&gt;在继续本文之前建议首先了解如下内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://facebook.github.io/react/blog/2015/12/18/react-components-elements-and-instances.html&quot;&gt;React Components, Elements, and Instances&lt;/a&gt; 掌握 React 中的一些基本术语&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://facebook.github.io/react/docs/reconciliation.html&quot;&gt;Reconciliation&lt;/a&gt; 对 React 协调算法的概括性描述&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/reactjs/react-basic&quot;&gt;React Basic Theoretical Concepts&lt;/a&gt; React 基本的理论性的概念描述。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://facebook.github.io/react/contributing/design-principles.html&quot;&gt;React Design Principles&lt;/a&gt; React 的设计准则很好的解释了 React Fiber 的出现。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;回顾&lt;/h2&gt;
&lt;hr&gt;
&lt;p&gt;在我们继续深入以前先来回顾一些新的概念。&lt;/p&gt;
&lt;h3&gt;什么是协调（Reconciliation）&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;reconciliation&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;    这是 React 用来对两棵树 diff 来决定要更新哪部分的算法。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;update&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;    React 应用中渲染数据的一次变化，通常是由 &lt;code class=&quot;language-text&quot;&gt;setState&lt;/code&gt; 触发的。最终结果是触发一次重新渲染。&lt;/p&gt;
&lt;p&gt;React API 的中心思想是如何更新，因为这会造成整个 APP 的重新渲染。这允许开发者可以声明式的推理，而不需要关心怎样有效地将 APP 从任何特定状态转换为另一种状态（A 到 B，B 到 C，C 到 A，以此类推）。&lt;/p&gt;
&lt;p&gt;实际上每次数据变化都要重新渲染整个应用只适用于最琐碎的一些应用。在现实世界中，就性能而言开销是非常巨大的。React 的优化做到了即便重新渲染整个应用依然能保证很高的性能。优化过程的大部分工作被称作 &lt;strong&gt;reconciliation&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;Reconciliation 是已经被人熟知的虚拟 DOM 背后的算法。从一个高度概括的角度来说：当你渲染一个 React 应用时，树上描述这个应用的所有节点被生成并保存在内存中，这棵树被刷新至渲染环境，如果是浏览器应用，则会转化成 DOM 节点的集合。当应用更新时（通常通过 &lt;code class=&quot;language-text&quot;&gt;setState&lt;/code&gt; ），一颗新树产生了，通过与之前的树进行比较计算出已渲染的应用哪部分需要更新。&lt;/p&gt;
&lt;p&gt;更加详细的描述可以在&lt;a href=&quot;https://facebook.github.io/react/docs/reconciliation.html&quot;&gt;文档&lt;/a&gt;中找到。关键点如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不同组件类型被认为是生成了不同的树。React 不会去 diff，而是直接将这部分旧节点替换掉。&lt;/li&gt;
&lt;li&gt;列表是通过 keys 来做 diff 的。Keys 应该是稳定的，可预见的，唯一的。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;协调与渲染&lt;/h3&gt;
&lt;p&gt;DOM 只是 React 能渲染的一种渲染环境。其他主要的原生系统 IOS 和 Android 也可以通过 React Native 来进行渲染。&lt;/p&gt;
&lt;p&gt;React 能支持多环境渲染的原因是，它被设计为协调和渲染过程分离。协调器计算树的哪部分被改变了，渲染器再根据得到的信息去真正渲染应用。&lt;/p&gt;
&lt;p&gt;分离意味着 React DOM 和 React Native 有各自的渲染器但是可以共享 React 核心提供的协调器。&lt;/p&gt;
&lt;p&gt;Fiber 重新实现了协调器，它原则上不关心渲染， 但渲染器仍然需要做出改变来支持并利用新的架构。&lt;/p&gt;
&lt;h3&gt;调度&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;scheduling&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;    决定何时执行工作的过程&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;work&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;    任何计算都应该被执行。&lt;code class=&quot;language-text&quot;&gt;Work&lt;/code&gt; 通常是一次更新的结果（通过 &lt;code class=&quot;language-text&quot;&gt;setState&lt;/code&gt; ）。&lt;/p&gt;
&lt;p&gt;React 的&lt;a href=&quot;https://facebook.github.io/react/contributing/design-principles.html#scheduling&quot;&gt;设计原则 &lt;/a&gt;中很好的描述了这部分主题：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;当前 React 的实现中，在一个时钟周期内 React 会遍历这棵更新过的树并且调用渲染函数渲染。在将来它会延迟某部分更新来保证不会掉帧。&lt;/p&gt;
&lt;p&gt;这在 React 设计中是一个常见的思想。一些流行的库的采用了 push 的方式，当有数据更新时，计算函数会执行。React 坚持 pull 的方式，计算函数除非必须否则可以延迟执行。&lt;/p&gt;
&lt;p&gt;React 不是一个通用的数据处理库。它是负责构建用户界面的。它处在应用中一块独立的位置来获取哪些计算是需要立即执行的，哪些是不必要的。&lt;/p&gt;
&lt;p&gt;如果一些内容用户是看不到的，React 可以延迟执行这部分任何的逻辑。如果数据更新的频率高于帧率，可以合并这些改变并批量更新。我们能对用户交互的部分工作（如按钮按下触发的动画）增加高优先级，对一些不重要的后台工作（如呈现刚从网络加载的新内容）延后执行来避免掉帧的现象。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;关键点在于：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在用户界面，每次数据更新没有必要立即渲染。实际上，这样会浪费性能造成丢帧降低用户的体验。&lt;/li&gt;
&lt;li&gt;不同的更新类型有不同的优先级—动画的更新需要比数据中心更新更快。&lt;/li&gt;
&lt;li&gt;基于 push 的方式需要开发者来决定如何调度工作。基于 pull 的方式允许库（React）更加智能的帮我们做出决定。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;React 目前还没有充分利用调度的优势，子树上数据的一次更新还是会立即渲染。彻底修改 React 核心算法以利用调用是 Fiber 背后的驱动思想。&lt;/p&gt;
&lt;h2&gt;什么是 Fiber&lt;/h2&gt;
&lt;hr&gt;
&lt;p&gt;我们现在来讨论 React Fiber 架构的核心。Fibers 是一个非常底层的抽象描述。&lt;/p&gt;
&lt;p&gt;我们已经建立了 Fiber 为 React 提供调度能力的主要目标，需要实现以下的能力：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;暂停工作并在一段时间后恢复&lt;/li&gt;
&lt;li&gt;对不同类型的工作提供优先级&lt;/li&gt;
&lt;li&gt;再利用先前已经完成的工作&lt;/li&gt;
&lt;li&gt;如果不需要则可以停止工作&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为了实现以上目标，我们首先需要找到一种方式将工作切分成多个单位。一个 fiber 就代表了一个工作单元。&lt;/p&gt;
&lt;p&gt;为了更近一步，我们回到之前的概念 &lt;a href=&quot;https://github.com/reactjs/react-basic#transformation&quot;&gt;React 组件就是 data 的函数映射&lt;/a&gt;，通常可以表示为：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;d&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;渲染一个 React 应用本质上就是调用一个函数，这个函数体中包含了调用其他的函数，以此类推。这种类比在思考 fiber 时非常有用。&lt;/p&gt;
&lt;p&gt;计算机追踪一个程序的执行通常的方式是采用&lt;a href=&quot;https://en.wikipedia.org/wiki/Call_stack&quot;&gt;调用栈&lt;/a&gt;。当一个函数被执行，一个新的栈帧被加入该栈。这个栈帧代表函数执行的位置。&lt;/p&gt;
&lt;p&gt;当处理 UI 时，一个问题是如果一次执行太多的函数会导致动画的丢帧，看起来断断续续。而且，如果有新的变动取代旧的，那么之前的工作实际上不是必须的。这就是 UI 组件和函数之间比较不同的地方，UI 组件有着比函数更多需要特殊关注的地方。&lt;/p&gt;
&lt;p&gt;最近新的浏览器（和 React Native）实现了帮助解决这个问题的 APIs：&lt;code class=&quot;language-text&quot;&gt;requestIdleCallback&lt;/code&gt; 安排一个在程序空闲期被调用的低优先级函数，&lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame&lt;/code&gt; 安排一个在下个动画帧中被调用的高优先级函数。问题在于，为了使用这些 APIs，我们需要将渲染工作切分成多个单元。如果只依靠调用栈，它会一直运行直到栈为空。&lt;/p&gt;
&lt;p&gt;有没有办法来定制调用栈的行为来优化渲染 UIs？有没有办法能够中断调用并且手动操作栈帧呢？&lt;/p&gt;
&lt;p&gt;这就是 React Fiber 的目的，Fiber 为 React 组件重新实现了栈。可以认为一个 fiber 就是一个&lt;strong&gt;虚拟的栈帧&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;重新实现栈的好处是能在&lt;a href=&quot;https://www.facebook.com/groups/2003630259862046/permalink/2054053404819731/&quot;&gt;内存中保存栈帧&lt;/a&gt;，并且可以随时以任何方式去执行。这是实现调度至关重要的。&lt;/p&gt;
&lt;p&gt;除了调度之外，手动处理栈帧还可以实现并发和错误边界等功能。&lt;/p&gt;
&lt;h3&gt;Fiber 的结构&lt;/h3&gt;
&lt;p&gt;具体来说，一个 fiber 是一个包含组件信息，它的输入、输出的 JavaScript 对象。&lt;/p&gt;
&lt;p&gt;一个 fiber 对应一个栈帧，也对应一个组件的实例。&lt;/p&gt;
&lt;p&gt;这里有一些 fiber 比较重要的字段（非完整的列表）：&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;type&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;key&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;fiber 的 type 和 key 对 React 元素起着同样的作用（实际上，fiber 从一个元素创建时，这两个属性直接被复制过来）。&lt;/p&gt;
&lt;p&gt;fiber 的 type 描述了它对应的组件。对于合成组件，type 是一个函数或者类组件本身。对于原生元素（&lt;code class=&quot;language-text&quot;&gt;div&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;span&lt;/code&gt; 等），type 是一个字符串。&lt;/p&gt;
&lt;p&gt;从概念上来说，type 是在执行时被栈帧追踪的函数（如在 &lt;code class=&quot;language-text&quot;&gt;v = f(d)&lt;/code&gt; 中）。&lt;/p&gt;
&lt;p&gt;与 type 一起的 key，被用来在协调过程中决定 fiber 是否可以再利用。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;child&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;sibling&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;这两个字段指向其他的 fibers，描述一个 fiber 的递归树结构。&lt;/p&gt;
&lt;p&gt;child 字段对应组件 &lt;code class=&quot;language-text&quot;&gt;render&lt;/code&gt; 方法的返回值。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Child &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Parent&lt;/code&gt; 的子 fiber 对应着 &lt;code class=&quot;language-text&quot;&gt;Child&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;sibling 字段对应 &lt;code class=&quot;language-text&quot;&gt;render&lt;/code&gt; 返回多个孩子节点（Fiber 的新特性！）的情况：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Child1 &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Child2 &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;child fibers 组成了一个单链表，head 指针指向第一个孩子节点。所以在上例中， &lt;code class=&quot;language-text&quot;&gt;Parent&lt;/code&gt; 的孩子节点是 &lt;code class=&quot;language-text&quot;&gt;Child1&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;Child1&lt;/code&gt; 的兄弟节点是 &lt;code class=&quot;language-text&quot;&gt;Child2&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;回到我们的函数类比，可以认为一个孩子 fiber 是一个尾调用函数。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;return&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;return fiber 是当前 fiber 处理完成后需要返回的 fiber。从概念上来说它对应栈帧返回的地址。也可以理解为父 fiber。&lt;/p&gt;
&lt;p&gt;如果一个 fiber 有多个子 fiber，每个子 fiber 返回的 fiber 都是它的父 fiber。在前一个例子中，&lt;code class=&quot;language-text&quot;&gt;Child1&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;Child2&lt;/code&gt; 的 return fiber 是 &lt;code class=&quot;language-text&quot;&gt;Parent&lt;/code&gt;。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;pendingProps&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;memoizedProps&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;从概念上来说，props 是一个函数的参数。一个 fiber 的 &lt;code class=&quot;language-text&quot;&gt;pendingProps&lt;/code&gt; 是开始执行时被赋值，&lt;code class=&quot;language-text&quot;&gt;memoizedProps&lt;/code&gt; 是结束时被赋值。&lt;/p&gt;
&lt;p&gt;当即将到来的 &lt;code class=&quot;language-text&quot;&gt;pendingProps&lt;/code&gt; 和当前 &lt;code class=&quot;language-text&quot;&gt;memoizedProps&lt;/code&gt; 一致时，表明了 fiber 的前一次输出可以被重新使用，省去了不必要的工作。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;pendingWorkPriority&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;一个数字标识 fiber 工作的优先级。&lt;a href=&quot;https://github.com/facebook/react/blob/master/packages/react-reconciler/src/SchedulerWithReactIntegration.js&quot;&gt;ReactPriorityLevel&lt;/a&gt;模块中列出来不同的优先级和所对应的含义。&lt;/p&gt;
&lt;p&gt;除了一个特殊的例外 &lt;code class=&quot;language-text&quot;&gt;NoWork = 0&lt;/code&gt;，越大的数字代表了越低的优先级。例如，可以通过如下函数来验证一个 fiber 的优先级是否比给到的优先级相等或更高：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;matchesPriority&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;fiber&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; priority&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    fiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pendingWorkPriority &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; fiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pendingWorkPriority &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; priority
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;这个函数只是用来说明，并不是真正的 React Fiber 代码的一部分。&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;调度器使用优先级字段寻找下一个工作的单元，算法部分会在 future 部分讨论。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;alternate&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;flush&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;    刷新一个 fiber 就是渲染它的输出至屏幕。&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;work-in-progress&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;    一个 fiber 还未完成，即相对应的一个栈帧还没有被返回。&lt;/p&gt;
&lt;p&gt;在任何时候，一个组件实例至多有两个 fibers 与之对应：当前 fiber，刷新过的 fiber 和工作中的 fiber。&lt;/p&gt;
&lt;p&gt;当前 fiber 的交替是工作中的 fiber，反之亦然。&lt;/p&gt;
&lt;p&gt;一个 fiber 的交替是通过调用 &lt;code class=&quot;language-text&quot;&gt;cloneFiber&lt;/code&gt; 惰性创建的。并非总是会创建新的对象，&lt;code class=&quot;language-text&quot;&gt;cloneFiber&lt;/code&gt; 会尝试再利用存在的 fiber 的交替，减少内存占用。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;output&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;host component&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;    一个 React 应用的叶子节点。它们是渲染环境特有的（即在浏览器中，它们是 &lt;code class=&quot;language-text&quot;&gt;div&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;span&lt;/code&gt; 等）。在 JSX 中，它们使用小写标签名表示。&lt;/p&gt;
&lt;p&gt;从概念上来说，fiber 的输出就是一个函数的返回值。&lt;/p&gt;
&lt;p&gt;每个 fiber 最终都会有输出，但是输出只由宿主组件在叶子节点创建。输出随后在树上被传递。&lt;/p&gt;
&lt;p&gt;输出最终都会传送至渲染器，所以能够刷新这些变化至渲染环境。定义如何创建和更新输出内容是渲染器的责任。&lt;/p&gt;
&lt;h2&gt;未来&lt;/h2&gt;
&lt;p&gt;以上就是目前的全部内容，但这篇文章还远远不够。未来还将讨论一次更新在生命周期中采用的算法。话题包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调度器是如何找到下一个工作单元去执行的&lt;/li&gt;
&lt;li&gt;优先级是如何追踪的，又如何在 fiber 树中传播的&lt;/li&gt;
&lt;li&gt;调度器是怎样知道何时停止和恢复工作的&lt;/li&gt;
&lt;li&gt;刷新（flush）是如何工作的和如何标记为完成的&lt;/li&gt;
&lt;li&gt;副作用是如何工作的（例如生命周期函数）&lt;/li&gt;
&lt;li&gt;协程是什么，如何用来实现 context 和 layout 的&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/acdlite/react-fiber-architecture/&quot;&gt;https://github.com/acdlite/react-fiber-architecture/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 引擎基础：Shapes 和 Inline Caches]]></title><description><![CDATA[JavaScript 引擎管道 当加载到我们所写的 JavaScript 代码，JavaScript 引擎开始解析源代码，并把它转换成抽象语法树（AST）。基于 AST，解释器开始工作并转换成字节码。此时引擎开始真正执行我们的 JavaScript 代码。 js engine…]]></description><link>https://www.keisei.top/V8-shapes-and-inline-cache/</link><guid isPermaLink="false">https://www.keisei.top/V8-shapes-and-inline-cache/</guid><pubDate>Mon, 18 Nov 2019 22:51:00 GMT</pubDate><content:encoded>&lt;h2&gt;JavaScript 引擎管道&lt;/h2&gt;
&lt;p&gt;当加载到我们所写的 JavaScript 代码，JavaScript 引擎开始解析源代码，并把它转换成抽象语法树（AST）。基于 AST，解释器开始工作并转换成字节码。此时引擎开始真正执行我们的 JavaScript 代码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/55263e94b3250c77560ffe9770630a34/js-engine-pipeline.svg&quot; alt=&quot;js engine pipeline&quot;&gt;&lt;/p&gt;
&lt;p&gt;为了让代码运行得更快，字节码可以与分析数据一起发送到优化编译器，基于分析到的数据做出一些假设，然后编译出高度优化的机器码。&lt;/p&gt;
&lt;p&gt;如果在某个节点的假设出错，优化编译器会造成负优化，并回退到解释器。&lt;/p&gt;
&lt;h3&gt;解释器/编译器 在 JavaScript 引擎中的管道&lt;/h3&gt;
&lt;p&gt;我们来放大管道流中真正执行 JavaScript 代码的部分，即代码被解释和优化，并解决主要引擎中存在的差异的地方。简单来讲，这里管道流包含解释器和优化编译器。解释器快速将源码生成未优化的字节码，优化编译器花更多一点的时间生成高度优化的机器码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/986a5bf438f0396c4d357fbe6823bfaa/interpreter-optimizing-compiler.svg&quot; alt=&quot;interpreter optimizing compiler&quot;&gt;&lt;/p&gt;
&lt;p&gt;这种通用的管道流 V8 在 Chrome 和 Node.js 中是如何工作的：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/8a9c248062e5984da280e1e128baf314/interpreter-optimizing-compiler-v8.svg&quot; alt=&quot;interpreter optimizing compiler v8&quot;&gt;&lt;/p&gt;
&lt;p&gt;解释器在 V8 中被称作点火器，它的作用是生成和执行字节码。当开始执行字节码时，它会收集分析的数据，用来加速未来的执行速度。当一个函数经常被执行，就会变成一个热函数，这部分字节码和分析的数据会被传递给涡轮风扇—我们的优化编译器，基于分析的数据来生成高度优化的机器码。&lt;/p&gt;
&lt;h2&gt;JavaScript 对象模型&lt;/h2&gt;
&lt;p&gt;让我们来看一下 JavaScript 引擎共性的方面是如何实现的。例如，JavaScript 对象模型是如何实现的，有哪些方式来加快属性的访问。&lt;/p&gt;
&lt;p&gt;ECMAScript 规范定义了所有对象都是字典，&lt;a href=&quot;https://tc39.es/ecma262/#sec-property-attributes&quot;&gt;属性的键值&lt;/a&gt;都是字符串类型。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2ad718f2149bab498cd22aa53c67ac6f/object-model.svg&quot; alt=&quot;object model&quot;&gt;&lt;/p&gt;
&lt;p&gt;除了 &lt;code class=&quot;language-text&quot;&gt;[[Value]]&lt;/code&gt; 以外，规范还定义了如下属性：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;[[Writable]]&lt;/code&gt; 决定了属性可以重新赋值，&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;[[Enumerable]]&lt;/code&gt; 决定了属性可以通过 &lt;code class=&quot;language-text&quot;&gt;for-in&lt;/code&gt; 枚举，&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;[[Configurable]]&lt;/code&gt; 决定了属性可以被删除。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;双方括号看起来新颖，这是规范用来表示属性的并且不直接暴露给 JavaScript。可以通过 &lt;code class=&quot;language-text&quot;&gt;Object.getOwnPropertyDescriptor&lt;/code&gt; API 来获取对象的属性描述符。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; foo&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getOwnPropertyDescriptor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; { value: 42, writable: true, enumerable: true, configurable: true }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;数组又是如何定义的呢？可以把数组理解为一种特殊的对象。其中一个不同点是数组对索引有特殊的处理逻辑。数组索引在 ECMAScript 规范中是特殊术语。数组在 JavaScript 中允许最多 2³²−1 个元素。数组索引是在 0 至 2³²−2 的任意有效的整数。&lt;/p&gt;
&lt;p&gt;另一个不同点是数组有一个魔法的&lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt;属性。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; array &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// -&gt; 2&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;c&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// -&gt; 3&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在这个例子中数组创建时 &lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 为 &lt;code class=&quot;language-text&quot;&gt;2&lt;/code&gt;，当我们给索引 &lt;code class=&quot;language-text&quot;&gt;2&lt;/code&gt; 赋值时，&lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 属性自动更新了。&lt;/p&gt;
&lt;p&gt;JavaScript 定义数组和定义对象相似，所有键值包括索引值都是明确的字符串类型。数组的第一个元素存在键 &lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; 的下面。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/6d34cbceadebfc3ccb045d3eb16eba87/array-1.svg&quot; alt=&quot;array 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 只是另一个不可枚举不可删除的属性而已。&lt;/p&gt;
&lt;p&gt;一旦一个元素加入数组，JavaScript 会自动更新 &lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 属性的 &lt;code class=&quot;language-text&quot;&gt;[[Value]]&lt;/code&gt; 值。&lt;/p&gt;
&lt;p&gt;一般来说，数组的行为与对象非常相似。&lt;/p&gt;
&lt;h2&gt;优化属性访问&lt;/h2&gt;
&lt;p&gt;现在让我们来看一下引擎如何让对象工作的高效。&lt;/p&gt;
&lt;p&gt;在 JavaScript 程序中，访问对象属性是最常见的操作。对于引擎来说让属性更快访问至关重要。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  foo&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;bar&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  baz&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;qux&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 这里我们访问 object 的 foo 属性。&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;foo&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Shapes&lt;/h3&gt;
&lt;p&gt;在 JavaScript 程序中，多个对象拥有相同的属性是非常常见的。这样的对象有相同的形状（shape）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// object1 和 object2 有同样的 shape&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对同样 shape 的对象访问同一属性也是很常见的。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;logX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;logX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;logX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;考虑到这一点，JavaScript 引擎可以基于对象的 shape 来优化对象属性的访问速度。&lt;/p&gt;
&lt;p&gt;假设一个对象上有属性 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; ，它用之前讨论过的字典数据结构表示：包含了字符串的 key，这些 key 的指针指向对应的元属性。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2ad718f2149bab498cd22aa53c67ac6f/object-model-1.svg&quot; alt=&quot;object model&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果访问 &lt;code class=&quot;language-text&quot;&gt;object.y&lt;/code&gt; ，引擎会在 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 中寻找键 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; ，然后加载对应的属性元数据，最后返回 &lt;code class=&quot;language-text&quot;&gt;[[Value]]&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;属性元数据在内存中是怎么存储的呢？我们应该把它们作为 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 的一部分存储呢？如果我们在将来会有更多的同 shape 的对象，那么作为 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 的一部分保存全部的字典数据是浪费的。作为优化，引擎会单独保存对象的 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/e961dd07670fe48f1d6154fcb05bfc42/shape-1.svg&quot; alt=&quot;shape 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 包含除了 &lt;code class=&quot;language-text&quot;&gt;[[Value]]&lt;/code&gt; 之外的所有的元属性数据，并且 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 会保存属性值在 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 中的偏移量，因此 JavaScript 引擎知道去哪里找到这些值。每个同一 shape 的 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 指向这个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 实例。现在每个 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 只需要保存对对象唯一的属性值。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/836c5d03087c8fd4323793df862ddeb6/shape-2.svg&quot; alt=&quot;shape 2&quot;&gt;&lt;/p&gt;
&lt;p&gt;当我们有多个对象时好处显而易见，无论有多少对象，只要它们拥有同样的 shape，我们只需要保存一次 shape 和属性信息。&lt;/p&gt;
&lt;h3&gt;过渡链和树（Transition chains and trees）&lt;/h3&gt;
&lt;p&gt;假设现在一个对象有一个确定的 shape，当我们此时在该对象上新增一个属性时，引擎该如何找到新的 shape？&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种 shape 形式在引擎中称为过渡链（transition chains）感觉这里还是原生比较直观。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/b32af721e8b02099051effa12ced05ac/shape-chain-1.svg&quot; alt=&quot;shape chain 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;对象 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 开始时没有任何属性，所以最初指向空 shape。第二步将值为 &lt;code class=&quot;language-text&quot;&gt;5&lt;/code&gt; 的 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性添加到对象 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 时，JavaScript 引擎会过渡到一个包含属性 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape，并且值 &lt;code class=&quot;language-text&quot;&gt;5&lt;/code&gt; 会添加到 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 偏移量 &lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; 的位置。同理，当新增 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 属性时，引擎会过渡到包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 的另一个 shape，并将 &lt;code class=&quot;language-text&quot;&gt;6&lt;/code&gt; 添加到 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 偏移量 &lt;code class=&quot;language-text&quot;&gt;1&lt;/code&gt; 的位置。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;注意：属性添加的顺序会影响shape。如 { x: 4undefined y: 5 } 和 { y: 5undefined x: 4 } 的 shape 不同。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们不需要为每个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 保存全部的属性。相反，每个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 只需要知道它自己新的属性。例如，我们不需要在最后一个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 中存储 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性，因为它可以在之前的链上找到。为了达到这个目的，每个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 需要指回之前的 shape ：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/84acac33e689906b5eafed489f5fe68f/shape-chain-2.svg&quot; alt=&quot;shape chain 2&quot;&gt;&lt;/p&gt;
&lt;p&gt;当代码中访问 &lt;code class=&quot;language-text&quot;&gt;o.x&lt;/code&gt; 时，引擎会向上遍历 transition chain 直到找到拥有 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;如果此时有两个空对象，我们分别向对象中添加不同的属性：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种情况我们会将树进行分叉形成 transition tree 而不再是一条链。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7285fe16e0ded670a519bd0470c3a3d6/shape-tree.svg&quot; alt=&quot;shape tree&quot;&gt;&lt;/p&gt;
&lt;p&gt;这里我们创建了空对象 &lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt; ， 并且向其添加了 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性。最终创建了包含一个值的 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 和 两个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s ：一个空 shape 和一个仅包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性信息的 shape。&lt;/p&gt;
&lt;p&gt;我们也创建了对象 &lt;code class=&quot;language-text&quot;&gt;b&lt;/code&gt; ，并增加了属性 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt;。结果产生了两条 shape 链，总共三个 shape。&lt;/p&gt;
&lt;p&gt;这是否意味着我们总是从空 shape 开始？并非如此。引擎会对已经拥有属性的对象字面量做优化。我们要么从空对象增加 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性，要么有对象已经存在 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在对象 &lt;code class=&quot;language-text&quot;&gt;object1&lt;/code&gt; 中，我们首先创建空 shape，并过渡到拥有 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的 shape。
对象 &lt;code class=&quot;language-text&quot;&gt;object2&lt;/code&gt; 可以直接从之前已经包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape 创建，不需要从空对象开始然后过渡。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/14f49d5717ffc330ab2e9f9e47faa16c/empty-shape-bypass.svg&quot; alt=&quot;empty shape bypass&quot;&gt;&lt;/p&gt;
&lt;p&gt;包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的对象从包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape 开始，高效的跳过了空 shape。这个优化缩短了过渡链并使字面构造对象更加高效。&lt;/p&gt;
&lt;p&gt;下面是一个三维点对象的表示：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; point &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
point&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
point&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
point&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;z &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;根据我们前面所讲的，这会在内存中创建 3 个 shape（不包括空 shape）。为了访问 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性，必须从链尾开始遍历寻找包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/1069bb39d70e1f1270fe887fb1637a06/shapetable-1.svg&quot; alt=&quot;shapetable&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果我们经常作此操作，会变得很慢，尤其是当对象有很多属性时。寻找属性的时间复杂度是 O（n）,即线性的复杂度。为了加快查询效率，JavaScript 引擎增加了一个 &lt;code class=&quot;language-text&quot;&gt;ShapeTable&lt;/code&gt; 的数据结构。这个 &lt;code class=&quot;language-text&quot;&gt;ShapeTable&lt;/code&gt; 是一个字典，匹配键值和对应的 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s 。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/5185c0139aa8e3cc3055648ef526d2e5/shapetable-2.svg&quot; alt=&quot;shapetable-2&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在我们又回到了字典表查找。这是我们开始添加 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s 的地方。所以我们为什么还要&lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s ？&lt;/p&gt;
&lt;p&gt;原因是 shapes 可以启用另一个优化方案：&lt;code class=&quot;language-text&quot;&gt;Inline Caches&lt;/code&gt;。&lt;/p&gt;
&lt;h3&gt;Inline Caches (ICs)&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s 背后真正的目的是内联缓存（ICs）。ICs 是使 JavaScript 快速运行的关键因素。JavaScript 引擎使用 ICs 来记录去哪里找对象的属性的信息，减少查询次数的开销。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当我们在编译器中执行时，生成如下的字节码：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/40a0bcd658e50b7512132eabe579f0bd/ic-1.svg&quot; alt=&quot;ic 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;get_by_id&lt;/code&gt; 指令从第一个参数 &lt;code class=&quot;language-text&quot;&gt;arg1&lt;/code&gt; 加载 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性，并将结果保存在 &lt;code class=&quot;language-text&quot;&gt;loc0&lt;/code&gt; 位置。第二条指令返回我们存在 &lt;code class=&quot;language-text&quot;&gt;loc0&lt;/code&gt; 中的数据。&lt;/p&gt;
&lt;p&gt;JSC 还将内联缓存嵌入包含两个未初始化插槽的 &lt;code class=&quot;language-text&quot;&gt;get_by_id&lt;/code&gt; 指令中。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7f8e0551ee220f9a9c850ddc7731fe0c/ic-2.svg&quot; alt=&quot;ic 2&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在我们调用&lt;code class=&quot;language-text&quot;&gt;getX&lt;/code&gt; 函数，并传参 &lt;code class=&quot;language-text&quot;&gt;{ x: &amp;#39;a&amp;#39; }&lt;/code&gt; ，这个对象有一个拥有 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的 shape，并且该 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 保存了偏移量和 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的元属性数据。当首次执行这个函数时，&lt;code class=&quot;language-text&quot;&gt;get_by_id&lt;/code&gt; 指令开始查找属性 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt;，最终找到该值保存在偏移量 &lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; 的位置。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/bfc0cd727c60f503382d21c0fe236545/ic-3.svg&quot; alt=&quot;ic 3&quot;&gt;&lt;/p&gt;
&lt;p&gt;嵌入 &lt;code class=&quot;language-text&quot;&gt;get_by_id&lt;/code&gt; 指令的内联缓存会记录 shape 和属性被查到的偏移量：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7eb62f1dfed740115e04ffcef6788128/ic-4.svg&quot; alt=&quot;ic 4&quot;&gt;&lt;/p&gt;
&lt;p&gt;在随后的运行，内联缓存只需要比较 shape，如果相同就会直接返回记录的偏移量的值。特别是如果 JavaScript 引擎发现对象的 shape 在内联缓存中已经记录，不再需要去查询属性信息，这步耗时的操作会完全跳过。&lt;/p&gt;
&lt;h2&gt;高效存储数组&lt;/h2&gt;
&lt;p&gt;数组保存的属性又称为索引，对应的值称为数组元素。在每个单个数组中保存每个数组元素的属性信息是浪费内存的，JavaScript 引擎默认情况下索引值的属性是可写、可遍历、可删除，并且将数组元素和其他命名属性分开存储。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; array &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;#jsconfeu&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;引擎保存了数组长度 &lt;code class=&quot;language-text&quot;&gt;1&lt;/code&gt;，并指向包含偏移量和 &lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 属性的 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/59616921d42c4e5b04c71f3f6887b9de/array-shape.svg&quot; alt=&quot;array shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;和之前看到的一样，但是数组的元素值存在哪里呢？&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/0d617beeb57476b7d2867dada081498e/array-elements.svg&quot; alt=&quot;array elements&quot;&gt;&lt;/p&gt;
&lt;p&gt;每个数组都有一个单独的元素备份库，包含了所有元素的值。JavaScript 引擎不需要为数组元素保存任何属性信息，因为通常它们都是可写、可枚举、可删除的。&lt;/p&gt;
&lt;h2&gt;收获与总结&lt;/h2&gt;
&lt;p&gt;我们学习到了 JavaScript 引擎是如何存储对象和数组的，&lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s 和 &lt;code class=&quot;language-text&quot;&gt;ICs&lt;/code&gt; 是如何对它们常用的操作做出优化的。基于这些知识，我们总结了以下可以提高性能的代码：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;总是按同一种方式初始化对象，这样就不会产生多种不同的 shape；&lt;/li&gt;
&lt;li&gt;不要试图修改数组的属性信息，否则存储和操作会降低性能。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://mathiasbynens.be/notes/shapes-ics&quot;&gt;https://mathiasbynens.be/notes/shapes-ics&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[React源码中导致V8性能断崖下滑的真相]]></title><description><![CDATA[JavaScript 类型 JavaScript 的值总共具有 8 种不同的类型： 可以通过  关键字来校验值的类型。 尽管  有着它自身的一种类型，但  却返回  而不是  。为了理解原因，我们首先把所有的类型分为两组： object (即  类型) primitives…]]></description><link>https://www.keisei.top/V8-performance-cliff/</link><guid isPermaLink="false">https://www.keisei.top/V8-performance-cliff/</guid><pubDate>Thu, 14 Nov 2019 22:42:00 GMT</pubDate><content:encoded>&lt;h2&gt;JavaScript 类型&lt;/h2&gt;
&lt;p&gt;JavaScript 的值总共具有 8 种不同的类型：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;Number&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Symbol&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BigInt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Boolean&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Null&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以通过 &lt;code class=&quot;language-text&quot;&gt;typeof&lt;/code&gt; 关键字来校验值的类型。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;number&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;string&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;bar&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;symbol&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42n&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;bigint&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;boolean&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;undefined&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;object&apos; wtf?&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;object&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;尽管 &lt;code class=&quot;language-text&quot;&gt;Null&lt;/code&gt; 有着它自身的一种类型，但 &lt;code class=&quot;language-text&quot;&gt;typeof null&lt;/code&gt; 却返回 &lt;code class=&quot;language-text&quot;&gt;object&lt;/code&gt; 而不是 &lt;code class=&quot;language-text&quot;&gt;null&lt;/code&gt; 。为了理解原因，我们首先把所有的类型分为两组：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;object (即 &lt;code class=&quot;language-text&quot;&gt;Object&lt;/code&gt; 类型)&lt;/li&gt;
&lt;li&gt;primitives (任何非 object 类型)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;null&lt;/code&gt; 表示 &lt;code class=&quot;language-text&quot;&gt;no object value&lt;/code&gt; ，&lt;code class=&quot;language-text&quot;&gt;undefined&lt;/code&gt; 表示 &lt;code class=&quot;language-text&quot;&gt;no value&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/d52963211bf54974552289fe7b64ec43/primitives-objects.svg&quot; alt=&quot;类型表示&quot;&gt;&lt;/p&gt;
&lt;p&gt;根据这条思路，Brendan Eich 在设计 JavaScript 语言时，使 &lt;code class=&quot;language-text&quot;&gt;typeof&lt;/code&gt; 所有右侧的值都返回 &lt;code class=&quot;language-text&quot;&gt;object&lt;/code&gt; ，即所有 object 和 null 的值，这也是 Java 的特点之一。尽管规范中存在 &lt;code class=&quot;language-text&quot;&gt;Null&lt;/code&gt; 类型，但这就是 &lt;code class=&quot;language-text&quot;&gt;typeof null === &amp;#39;object&amp;#39;&lt;/code&gt; 的原因。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/5aca2330406be983d35ab591cfd76890/primitives-objects-typeof.svg&quot; alt=&quot;typeof 对象&quot;&gt;&lt;/p&gt;
&lt;h2&gt;值的表示&lt;/h2&gt;
&lt;p&gt;JavaScript 引擎必须能够在内存中对任意类型的 JavaScript 值进行表示，并且不同类型的值的表示方式不同。&lt;/p&gt;
&lt;p&gt;举例来说，&lt;code class=&quot;language-text&quot;&gt;42&lt;/code&gt; 是一个 &lt;code class=&quot;language-text&quot;&gt;number&lt;/code&gt; 类型，在内存中就有多种表示整型数字的方式：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;表示&lt;/th&gt;
&lt;th&gt;位&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;8 位&lt;/td&gt;
&lt;td&gt;0010 1010&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;32 位&lt;/td&gt;
&lt;td&gt;0000 0000 0000 0000 0000 0000 0010 1010&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;32 位 IEEE-754 浮点&lt;/td&gt;
&lt;td&gt;0100 0010 0010 1000 0000 0000 0000 0000&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;64 位 IEEE-754 浮点&lt;/td&gt;
&lt;td&gt;0100 0000 0100 0101 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;ECMAScript 标准中数字采用 64 位浮点数表示，即双精度浮点数或 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 。但考虑到性能问题，JavaScript 引擎并不会在任何时候都以 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 表示数字。只要外部表现的行为与 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 一致，引擎在内部可以选择其他的表示方式。&lt;/p&gt;
&lt;p&gt;在现实世界中，JavaScript 应用中大部分的整数数字类型都在 0 - 2³²−2 范围内，这个范围也是&lt;a href=&quot;https://tc39.es/ecma262/#array-index&quot;&gt;有效的数字索引值&lt;/a&gt;的范围。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 最小的有效索引值&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 最大的有效索引值&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;JavaScript 引擎对这类整数可以选择一种最佳的内存表示方式来优化通过索引访问数组元素的代码。处理器在做内存读取操作时，数组索引必须为二级制补码。&lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 来表示索引显然是浪费的，并且引擎不得不在每次访问数组元素时来回切换 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 和二进制补码形式。&lt;/p&gt;
&lt;p&gt;32 位二进制补码表示并不止对数组操作有帮助，实际上处理器在对整数操作时会比对浮点数操作更快。下面例子中第一个循环会是第二个循环的二倍之快：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再比如做模运算时，&lt;code class=&quot;language-text&quot;&gt;const remainder = value % divisor;&lt;/code&gt; 如果 &lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;divisor&lt;/code&gt; 都为整数时会比不是整数要快很多。如果操作数都是整数，CPU 在计算时会非常高效，对于 &lt;code class=&quot;language-text&quot;&gt;divisor&lt;/code&gt; 是 2 的幂的情况，V8 还有其他更快的计算方式。但如果出现了浮点数，那计算过程会变得复杂，花费的时间也会上升。&lt;/p&gt;
&lt;p&gt;由于整数运算的执行速度通常比浮点运算快得多，因此看来，引擎可以始终对所有整数和整数运算的所有结果使用二进制补码。但 ECMAScript 在 Float64 上实现了标准化，因此某些整数运算实际上会产生浮点数。 在这种情况下，JS 引擎产生正确的结果非常重要。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Float64具有53位的安全整数范围。超出这个范围就会失去精度。&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;53&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;53&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// → true&lt;/span&gt;

&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// → true&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// → true&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// → true&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;NaN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;即使左侧的值为整数，右侧的所有值为浮点数。使用 32 位二进制补码无法正确执行上述操作。 JavaScript 引擎需要确保整数运算能匹配 Float64 的结果。&lt;/p&gt;
&lt;p&gt;对于 31 位有符号整数范围内的小整数，V8 使用一种称为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 的特殊表示形式。 任何不是 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 的东西都表示为 &lt;code class=&quot;language-text&quot;&gt;HeapObject&lt;/code&gt;，这是内存中某个实体的地址。 对于数字，我们使用一种特殊的 &lt;code class=&quot;language-text&quot;&gt;HeapObject&lt;/code&gt;（即 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt;）来表示不在 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 范围内的数字。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;4.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;NaN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如上面的示例所示，一些 JavaScript 数字表示为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; s，而其他 JavaScript 数字表示为 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt;s。 V8 特别针对 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt;s 进行了优化，因为小整数在现实世界的 JavaScript 程序中非常常见。 不需要为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt;s 在内存中分配特殊块，并且通常整数运算会更快。&lt;/p&gt;
&lt;p&gt;这里重要的一点是，即使是具有相同 JavaScript 类型的值，作为优化在后台可能会以完全不同的方式表示。&lt;/p&gt;
&lt;h2&gt;Smi vs. HeapNumber vs. MutableHeapNumber&lt;/h2&gt;
&lt;p&gt;下面我们来看一下底层的实现。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//Smi&lt;/span&gt;
  y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;42&lt;/code&gt; 可以通过 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 来表示，它可以直接存在 object 中，而 &lt;code class=&quot;language-text&quot;&gt;4.2&lt;/code&gt; 需要一个独立的实体来保存，object 指向那个实体。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ee34e425c3e1fbf1c1fc1ffecf23ef7d/smi-vs-heapnumber.svg&quot; alt=&quot;smi vs heapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;当我们执行以下代码时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; o.x = 52&lt;/span&gt;
o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; o.y = 5.2&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;因为新值 &lt;code class=&quot;language-text&quot;&gt;52&lt;/code&gt; 仍满足 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示的范围，所以 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 值会在原位置更新。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/12759730c985a0bca1d3c3238f6b762f/update-smi.svg&quot; alt=&quot;update smi&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;y = 5.2&lt;/code&gt; 不能用 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示，并且与 &lt;code class=&quot;language-text&quot;&gt;4.2&lt;/code&gt; 不同，所以 V8 只好分配一份新的 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; 实体给到 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/8cb79b00f2ac6201641f665825860cae/update-heapnumber.svg&quot; alt=&quot;update heapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt;s 是不可变的，这可以带来一些明显的优化。如 &lt;code class=&quot;language-text&quot;&gt;o.x = o.y&lt;/code&gt; 操作，实际上只是将 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的指针指向 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 指向的实体 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; ，而不需要重新创建。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/42fbb18915e39e9f044fcfb2ad35c9c0/heapnumbers.svg&quot; alt=&quot;update heapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; 的一个劣势是更新数据会比 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 慢，考虑以下代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 创建`HeapNumber` 实体&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 创建一个新 `HeapNumber` 实体&lt;/span&gt;
  o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这段代码总共生成了 6 个 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; 实体，但其中 5 个是没有必要的。为了避免这种情况， V8 将这种数据标记为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 字段，提供了一种原地更新非 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 的类型 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 来存储 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ec93b06346d3c327811c0b3a4bfb9cfe/mutableheapnumber.svg&quot; alt=&quot;mutableheapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;当值更新时，V8 会简单原地更新 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 的数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/fb55956decd70357d3727da027d6a8c0/update-mutableheapnumber.svg&quot; alt=&quot;update mutableheapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;但这中也有陷阱，当&lt;code class=&quot;language-text&quot;&gt;y = o.x&lt;/code&gt; 时，如果 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 也指向同一 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 那么下次 &lt;code class=&quot;language-text&quot;&gt;o.x&lt;/code&gt; 的值更新， &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 也会跟着更新，这显然是违背 JavaScript 规范的。所以当 &lt;code class=&quot;language-text&quot;&gt;o.x&lt;/code&gt; 被访问时，首先需要将值转换为正常的 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; 。&lt;/p&gt;
&lt;h2&gt;Shape 弃用和迁移&lt;/h2&gt;
&lt;p&gt;如果一个字段初始时是 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 后来变更为非 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 类型，底层是如何变更呢？&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; 两个对象的 x 是 Smi 类型&lt;/span&gt;
b&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; b.x 现在是 Double 类型&lt;/span&gt;
y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/42568b32a305e7779c0b3529dc19a3c9/shape.svg&quot; alt=&quot;shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;当 &lt;code class=&quot;language-text&quot;&gt;b.x&lt;/code&gt; 变为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示时，V8 分配了一个新的空 shape，并指向 x，也创建了一个 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 来存储新值 &lt;code class=&quot;language-text&quot;&gt;0.2&lt;/code&gt;。然后对象 &lt;code class=&quot;language-text&quot;&gt;b&lt;/code&gt; 指向新 shape ，对象的值指向偏移量为 0 的 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt;。最后把旧 shape 标记为弃用的，断开 transition 树。&lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 完成了从空 shape 到新创建的 shape 的过渡。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2c4e36b13eb8bbfed1ef427981c82b84/shape-transition.svg&quot; alt=&quot;shape transition&quot;&gt;&lt;/p&gt;
&lt;p&gt;由于 a 对象还在指向旧的 shape，所以不能移除。V8 定义了任何取 a 中的属性或对 a 赋值之前先将 a 迁移至新的 shape。这样最终会使得标记为弃用的 shape 不可访问， 这时垃圾回收就可以释放这段内存了。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ce3cd892ec50b10c31df5a0b7360addb/shape-deprecation.svg&quot; alt=&quot;shape deprecation&quot;&gt;&lt;/p&gt;
&lt;p&gt;还有另一种情况：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  z&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这时 V8 需要找到这条链路上 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 之前的 shape，即 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/be221219de8e08427e540e2c91fb95fb/split-shape.svg&quot; alt=&quot;split shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;从分离的 shape 开始，我们创建了新的过渡链，并标记 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 类型，旧的子树弃用。最后一步迁移对象 o 至新的 shape，&lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 的值保存在 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 中。一旦所有旧 shape 的引用全都消失，那这棵树上所有旧的 shape 也会被回收。&lt;/p&gt;
&lt;h2&gt;可扩展性和完整过渡&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Object.preventExtensions()&lt;/code&gt; 可以阻止新的属性添加至一个对象中。
&lt;code class=&quot;language-text&quot;&gt;Object.seal&lt;/code&gt; 包含了 &lt;code class=&quot;language-text&quot;&gt;Object.preventExtensions()&lt;/code&gt; 的功能，并且它会标记所有属性为不可配置。
&lt;code class=&quot;language-text&quot;&gt;Object.freeze&lt;/code&gt; 与 &lt;code class=&quot;language-text&quot;&gt;Object.seal&lt;/code&gt; 类似，同时所有属性值不能更改。&lt;/p&gt;
&lt;p&gt;考虑一个具体的情况：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;preventExtensions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;像之前一样，从空 shape 过渡到新的存有 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的 shape。当我们执行 &lt;code class=&quot;language-text&quot;&gt;Object.preventExtensions()&lt;/code&gt; 时，执行了一个特殊过渡至被标记为不可扩展的新 shape。这个过渡并不是因为新的属性，只是进行了标记。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/06702e6d19b4d30aecc4aef008062f71/shape-nonextensible.svg&quot; alt=&quot;shape nonextensible&quot;&gt;&lt;/p&gt;
&lt;p&gt;注意我们不能直接在原地更新 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape，原因是对象 &lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt; 仍然是可扩展的。&lt;/p&gt;
&lt;h2&gt;React 性能问题&lt;/h2&gt;
&lt;p&gt;让我们最终来看一个真实的问题，&lt;a href=&quot;https://github.com/facebook/react/issues/14365&quot;&gt;react issue #14365&lt;/a&gt;。当 React 团队对一个现实的程序执行 profile 时，他们发现了 V8 一个奇怪的性能问题影响了 React 核心代码。下面是简化过的代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;preventExtensions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对象 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 有两个值为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示的属性，然后禁用了 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 的扩展性，并强制将第二个属性转换为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示。
根据前面的知识，代码的运行步骤如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/909307edf284801f22671924a8ec2426/repro-shape-setup.svg&quot; alt=&quot;repro shape setup&quot;&gt;&lt;/p&gt;
&lt;p&gt;两个属性为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示，对象 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 指向最终过渡到 non-extensible 的 shape。&lt;/p&gt;
&lt;p&gt;现在我们将 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 更新为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示，意味着我们需要从头开始找到分离的 shape &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt;，但是 V8 出现了分歧，分离的 shape 是可扩展的，但是当前的 shape 被标记为非扩展的，V8 不知道如何正确进行过渡，实际上创建了一个独立的 shape。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/530393c2bda11d260c7770f2c628d46c/orphaned-shape.svg&quot; alt=&quot;orphaned shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;可以想象当有很多这种对象时，会多糟糕。React 核心代码就产生了这一问题，&lt;code class=&quot;language-text&quot;&gt;FiberNode&lt;/code&gt; 有几个开启 profile 操作时记录时间戳的字段。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;actualStartTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;preventExtensions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; node1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; node2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这些字段如 &lt;code class=&quot;language-text&quot;&gt;actualStartTime&lt;/code&gt; 初始时赋值为 0 或 -1，即初始以 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示。但是后来执行&lt;a href=&quot;https://w3c.github.io/hr-time/#dom-performance-now&quot;&gt;performance.now()&lt;/a&gt;时返回的浮点数的时间戳保存至这些字段中，即变更为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示。&lt;/p&gt;
&lt;p&gt;最初的表示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/4e86dcfaefd0c365f5765f0373ceef9f/fibernode-shape.svg&quot; alt=&quot;fibernode shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;当存储时间戳时，V8 产生了矛盾：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/6d567cf6c6e15c4c00673566132faa72/orphan-islands.svg&quot; alt=&quot;orphan islands&quot;&gt;&lt;/p&gt;
&lt;p&gt;V8 为 node1 生成了 orphaned shape，在随后的某个节点为 node2 生成了不相交的另一个 orphaned shape。现实中 React 应用中 &lt;code class=&quot;language-text&quot;&gt;FiberNode&lt;/code&gt; 不止一两个，所以可想而知严重降低了 V8 的性能。&lt;/p&gt;
&lt;p&gt;现在 V8 v7.4 版本已经修复了这个问题，并且使得字段表示的更新成本更低。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/001011f0d3562e81e060befdf21d6b41/fix-fibernode-shape-2.svg&quot; alt=&quot;fix fibernode shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在当 &lt;code class=&quot;language-text&quot;&gt;actualStartTime&lt;/code&gt; 赋值为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示时，会正确的产生一条新的过渡链，并将之前的标记为弃用，在未来的某个时间点回收。&lt;/p&gt;
&lt;p&gt;React 团队的&lt;a href=&quot;https://github.com/facebook/react/pull/14383&quot;&gt;解决方式&lt;/a&gt;是初始化时将所有的 time 和 duration 字段以 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 强制以 Double 表示&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;actualStartTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Number&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;NaN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 随后可以以 Smi 来真正初始化值&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;actualStartTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;preventExtensions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; node1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; node2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以使用任何不符合 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 范围的浮点值来代替 Number.NaN，如 &lt;code class=&quot;language-text&quot;&gt;0.000001&lt;/code&gt;， &lt;code class=&quot;language-text&quot;&gt;Number.MIN_VALUE&lt;/code&gt;， &lt;code class=&quot;language-text&quot;&gt;-0&lt;/code&gt;和 &lt;code class=&quot;language-text&quot;&gt;Infinity&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;JavaScript 引擎在底层做了哪些神奇的操作，我们不得而知，但是记住不要混用类型，这样可以提交 V8 的性能。例如不要给数字类型的字段初始化 &lt;code class=&quot;language-text&quot;&gt;null&lt;/code&gt; 值，这会失去字段表示的优势，并且代码更易读：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 不要这么写!&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Point&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Point&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;402&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;换句话说，&lt;strong&gt;可读性高的代码性能更好！&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;收获与总结&lt;/h2&gt;
&lt;p&gt;本文主要深入了以下内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;JavaScript 类型分为基本类型和引用类型，&lt;code class=&quot;language-text&quot;&gt;typeof&lt;/code&gt; 会有误导性；&lt;/li&gt;
&lt;li&gt;即便是同一种数据类型，它背后的表示形式可能不同；&lt;/li&gt;
&lt;li&gt;V8 尽可能去寻找 JavaScript 应用中每个字段的最佳表示形式；&lt;/li&gt;
&lt;li&gt;V8 如何处理 shape 弃用和迁移，包括扩展性过渡。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;基于以上知识，在编写 JavaScript 代码时以下注意事项可以提高性能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;总是以同一种方式初始化对象，shape 可以变得高效；&lt;/li&gt;
&lt;li&gt;选择对字段类型合适的初始值来帮助 JavaScript 引擎选择表示形式。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://v8.dev/blog/react-cliff&quot;&gt;https://v8.dev/blog/react-cliff&lt;/a&gt;&lt;/p&gt;</content:encoded></item></channel></rss>