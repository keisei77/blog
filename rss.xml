<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[学习随笔]]></title><description><![CDATA[日常学习之互联网技术]]></description><link>https://www.keisei.top</link><generator>GatsbyJS</generator><lastBuildDate>Thu, 26 Dec 2019 15:24:22 GMT</lastBuildDate><item><title><![CDATA[迷你打包工具]]></title><description><![CDATA[模板打包器把小的代码片段编译成可在浏览器中运行的更大更复杂的文件。这些代码片段都是 JavaScript 文件，所有代码间的依赖都由模块系统来表示（https://webpack.js.org/concepts/modules…]]></description><link>https://www.keisei.top/minipack/</link><guid isPermaLink="false">https://www.keisei.top/minipack/</guid><pubDate>Wed, 25 Dec 2019 14:24:00 GMT</pubDate><content:encoded>&lt;p&gt;模板打包器把小的代码片段编译成可在浏览器中运行的更大更复杂的文件。这些代码片段都是 JavaScript 文件，所有代码间的依赖都由模块系统来表示（&lt;a href=&quot;https://webpack.js.org/concepts/modules&quot;&gt;https://webpack.js.org/concepts/modules&lt;/a&gt;）。&lt;/p&gt;
&lt;p&gt;模板打包器需要一个入口文件。我们不需要在 HTML 中插入多个 script 标签并执行，而是将该文件为我们应用的主入口文件来启动。&lt;/p&gt;
&lt;p&gt;打包器会从入口文件开始，寻找它依赖哪些文件，接着寻找依赖文件的依赖文件。就这样一直递归下去直到找出所有模块。这个过程所构成的依赖关系被称作依赖图。&lt;/p&gt;
&lt;p&gt;本文将来创建一个依赖图并通过它来将所有的模块都打包到一个文件中。&lt;/p&gt;
&lt;p&gt;注意：本文只是一个简单的来理解打包工具的例子，解决循环依赖，缓存模块导出，每个模块只解析一次等特性本文将跳过来保证简单化。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; fs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;fs&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;path&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; babylon &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;babylon&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; traverse &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;babel-traverse&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;default&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; transformFromAst &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;babel-core&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createAsset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; content &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; fs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readFileSync&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;filename&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;utf-8&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; ast &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; babylon&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    sourceType&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;module&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dependencies &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;traverse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function-variable function&quot;&gt;ImportDeclaration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; node &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      dependencies&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;source&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; code &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;transformFromAst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    presets&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;env&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    filename&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    dependencies&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    code&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createGraph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; mainAsset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createAsset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; queue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;mainAsset&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; asset &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    asset&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mapping &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dirname &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;dirname&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;asset&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;filename&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    asset&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dependencies&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;relativePath&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; absolutePath &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dirname&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; relativePath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; child &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createAsset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;absolutePath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      asset&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mapping&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;relativePath&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; child&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      queue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;child&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; queue&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bundle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;graph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; modules &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  graph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;mod&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    modules &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;mod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;: [
      function (require, module, exports) {
        &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;mod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
      },
      &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stringify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mapping&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;,
    ],&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
  (function (modules) {
    function require(id) {
      const [fn, mapping] = modules[id];

      function localRequire(name) {
        return require(mapping[name]);
      }

      const module = { exports: {} };

      fn(localRequire, module, module.exports);

      return module.exports;
    }

    require(0);
  })({&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;modules&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;})
  &lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; graph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createGraph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;./example/entry.js&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bundle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;graph&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[渲染器进程的内部执行]]></title><description><![CDATA[简介 前一节我们介绍了浏览器从地址栏输入 URL 开始内部是如何工作的。本文来看一下渲染器进程内部是如何工作的，由于该部分涉及到了 web 优化的众多方面，本文尽量以高度概括的方式进行讲解，如需进一步学习可访问 Web 基础之性能优化。 渲染器进程处理 web…]]></description><link>https://www.keisei.top/web-browser-render/</link><guid isPermaLink="false">https://www.keisei.top/web-browser-render/</guid><pubDate>Wed, 18 Dec 2019 15:38:00 GMT</pubDate><content:encoded>&lt;!-- https://developers.google.com/web/updates/2018/09/inside-browser-part3 --&gt;
&lt;h2&gt;简介&lt;/h2&gt;
&lt;p&gt;前一节我们介绍了&lt;a href=&quot;/web-browser-happen-in-navigation&quot;&gt;浏览器从地址栏输入 URL&lt;/a&gt; 开始内部是如何工作的。本文来看一下渲染器进程内部是如何工作的，由于该部分涉及到了 web 优化的众多方面，本文尽量以高度概括的方式进行讲解，如需进一步学习可访问 &lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/why-performance-matters/&quot;&gt;Web 基础之性能优化&lt;/a&gt;。&lt;/p&gt;
&lt;h2&gt;渲染器进程处理 web 内容&lt;/h2&gt;
&lt;p&gt;渲染器进程负责任何发生在一个 tab 下的事件。在一个渲染器进程中，主线程处理了大部分发送给用户的代码。如果有 JavaScript 代码是 web worker 或 service worker，那么会由 worker 线程来处理该部分代码。合成器线程和栅格线程也在一个渲染器进程内部执行，来保证渲染页面平滑、高效。&lt;/p&gt;
&lt;p&gt;渲染器进程的核心工作是把 HTML、CSS 和 JavaScript 加载至一个 web 页面中来供用户使用。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/126df/renderer.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbklEQVQoz2WRyXLCQAxE/f9/w5EqDgQ4kIrBG3ghBuxiD2CzQ9jMY0QoV6UPY02P1GrJWpZlcRx/fum22+l0gjAMPc/zfZ9LW4Gr67q2bf8oWJY1m82out/vGp/RaOT5gem0PxTK5bJhGCTput5sNk3T5Fqr1RBCtNvtIvEqHgwGnoLjOJZtkxEEwfcfQgWCXq+HFyFxOp1O9/u9BoUl0qIoJu73+1kOyN9uNwnkvF6vBGmaJkminc9nqNPp9C7YbreHw0EmvFwuML8KURSt12vJ2e121GubzWaxWGCjUChUKhWEYJkNezwhj/p8Pl+tVsVi8e2LBs9iZk4U6vV6tVoliTe06LNcLo/HI1fIVqvF8MPhkO1OJhOqcKFhjIdSqcQPECHxiXPkxSdXfLIa1i5yr87sAyX08uuRJVMvWoA9NRoN/gWOSB6Px8/OqGb/QCqjYkqWLIz0FOa1MJbBh/HSHBgSYc48CfMOMMvrA+t4W7C5eyUwAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;renderer process&quot;
        title=&quot;renderer process&quot;
        src=&quot;/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/799d3/renderer.png&quot;
        srcset=&quot;/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/00d96/renderer.png 148w,
/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/0b23c/renderer.png 295w,
/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/799d3/renderer.png 590w,
/static/bdfa66a4ef1fbd2805797bc4cd90f8d8/126df/renderer.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;解析&lt;/h2&gt;
&lt;h3&gt;DOM 的构建&lt;/h3&gt;
&lt;p&gt;当渲染器进程接收到导航的信息并开始接收 HTML 数据时，主线程就会开始解析文本字符（HTML）并把它转换成文档对象模型（DOM）。&lt;/p&gt;
&lt;p&gt;DOM 是一个页面在浏览器内部的表示形式，也是一种 web 开发者可以通过 JavaScript 来操作的数据结构。&lt;/p&gt;
&lt;p&gt;解析 HTML 文档为 DOM 是 &lt;a href=&quot;https://html.spec.whatwg.org/&quot;&gt;HTML 标准&lt;/a&gt;定义的。你或许发现 HTML 传递到浏览器时从不会产生异常。例如丢失一个 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;/p&amp;gt;&lt;/code&gt; 标签是有效的 HTML 文档。再比如 &lt;code class=&quot;language-text&quot;&gt;Hi! &amp;lt;b&amp;gt;I&amp;#39;m &amp;lt;i&amp;gt;Chrome&amp;lt;/b&amp;gt;!&amp;lt;/i&amp;gt;&lt;/code&gt; (b 标签先于 i 标签关闭) 会被处理为 &lt;code class=&quot;language-text&quot;&gt;Hi! &amp;lt;b&amp;gt;I&amp;#39;m &amp;lt;i&amp;gt;Chrome&amp;lt;/i&amp;gt;&amp;lt;/b&amp;gt;&amp;lt;i&amp;gt;!&amp;lt;/i&amp;gt;&lt;/code&gt;。这是因为 HTML 规范专门有对这些错误设计了兼容。如果好奇这部分是如何实现的，可通过 HTML 规范中的&lt;a href=&quot;https://html.spec.whatwg.org/multipage/parsing.html#an-introduction-to-error-handling-and-strange-cases-in-the-parser&quot;&gt;在解析器中处理异常和特殊场景&lt;/a&gt;部分来了解。&lt;/p&gt;
&lt;h3&gt;子资源加载&lt;/h3&gt;
&lt;p&gt;一个网站通常会加载外部资源，如图片、CSS 和 JavaScript。这些文件需要从网络或缓存中读取。主线程在解析构建 DOM 时会在发现这些资源时一个个去请求，同时为了加快速度，“预加载扫描器”会并行运行。如果在 HTML 文档中有 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;img&amp;gt;&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;link&amp;gt;&lt;/code&gt; 存在，预加载扫描器会查看在 HTML 解析器生成的令牌，并向浏览器进程中的网络线程发出请求。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fa689d6a31b8687522c58774c8d9d064/126df/dom.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABc0lEQVQoz22S2XKCUAyGef+namecYZi2FJFNAXfZioqK4lKgH8Txqrk45OTkXxJV2rZdLBbax6fp+YHvh2Hoed54PA6CwHEc13V936cyGo1++hgOh2magmqaRuGzXq8dzzNM6/3tGbqu0/TVx3cfg8HAsixY4Mqy7AkGic5kMrFtG3rU0ERfzldMp1OpzGazzWaTJMn5fFaAGYZhmiasqAG+XC5VVUFc1zUdXG+32+PxIN9ut5qmIV6W5W63U6je73fwsM7n8zzP6cAOxgDDSB2fIPf7fRzHqqoyFMpcFaqn0wllzPz2AUZWQoVZcAv4er1SZwXgj8fjcrnslOFASjYEGcqHw0EUQHKFl1l4avtgHE5sd8oQ8GEN0ENJN0OS88xEsideV6sV4qyWnB8Msx2YqcDThFUskAPGDvSciAPgjyAnQQNtyHRgPiyTVYFHFjWuAkYh74NuvJD8Y5sqxPIHIMQbb0VRyCkJuxBZ8iiKKP4Bs75RmkY8U9EAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;dom&quot;
        title=&quot;dom&quot;
        src=&quot;/static/fa689d6a31b8687522c58774c8d9d064/799d3/dom.png&quot;
        srcset=&quot;/static/fa689d6a31b8687522c58774c8d9d064/00d96/dom.png 148w,
/static/fa689d6a31b8687522c58774c8d9d064/0b23c/dom.png 295w,
/static/fa689d6a31b8687522c58774c8d9d064/799d3/dom.png 590w,
/static/fa689d6a31b8687522c58774c8d9d064/126df/dom.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;JavaScript 会阻塞解析&lt;/h3&gt;
&lt;p&gt;当 HTML 解析器遇到 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;script&amp;gt;&lt;/code&gt; 标签时，它会暂停解析 HTML 文档并开始加载，解析，执行 JavaScript 代码。为什么呢？因为 JavaScript 能够通过 &lt;code class=&quot;language-text&quot;&gt;document.write()&lt;/code&gt; （该方法会改变整个 DOM 树结构，如下图）等方式来改变文档的内容。这就是 HTML 解析器为什么暂停并等待 JavaScript 执行后再恢复解析文档。如果对 JavaScript 执行过程好奇，可查看&lt;a href=&quot;/V8-shapes-and-inline-cache&quot;&gt;JavaScript 引擎基础：Shapes 和 Inline Caches&lt;/a&gt;。&lt;/p&gt;
&lt;h2&gt;提示浏览器如何加载资源&lt;/h2&gt;
&lt;p&gt;目前有许多方法帮助开发者提示浏览器如何加载资源更优雅。如果 JavaScript 代码中没有使用 &lt;code class=&quot;language-text&quot;&gt;document.write()&lt;/code&gt;，可以在 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;script&amp;gt;&lt;/code&gt; 标签中添加 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#attr-async&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;async&lt;/code&gt;&lt;/a&gt; 或 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#attr-defer&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;defer&lt;/code&gt;&lt;/a&gt; 属性。浏览器会异步去加载、执行 Javscript 代码而不会阻塞解析 HTML。如果合适还可以使用 &lt;a href=&quot;https://developers.google.com/web/fundamentals/primers/modules&quot;&gt;JavaScript module&lt;/a&gt;。&lt;code class=&quot;language-text&quot;&gt;&amp;lt;link rel=&amp;quot;preload&amp;quot;&amp;gt;&lt;/code&gt; 会告诉浏览器这个资源在当前页面是绝对需要的，最好尽快下载下来。更多信息可查看&lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/resource-prioritization&quot;&gt;资源优先级加载&lt;/a&gt;。&lt;/p&gt;
&lt;h2&gt;样式计算&lt;/h2&gt;
&lt;p&gt;只有 DOM 是不够知道页面究竟展示的样子的，因为我们可以对页面元素通过 CSS 来修饰。
主线程解析 CSS 并确定每一个 DOM 节点计算后的样式。每个节点的样式是通过 CSS 选择器来确定的。可以在开发者工具 &lt;code class=&quot;language-text&quot;&gt;computed&lt;/code&gt; 一栏查看每个节点的样式。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fb7d195814a04c6ed98eab8dbda477c6/126df/computedstyle.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABiklEQVQoz1WRWY+CQBCE+f//xsRolBfXI2YDKiKKgujiiYrifUVlP2YS3e2Hoafpqq7qUeI49v2fb003bcd1HM/zuiIcx7Esq91uk3c6HdM0l8vlarVqNpuLxQLU6/VS+EwmE7vbM1rWF1EsFgqFRqNBk67r9XrdMAzOcrksiVzX/YDH47Ft21RbpgmAabKD6Pf78kTOcDj0RJBMp9P5fH46nRTkwQ3a931yTsn6EPF8Pu/3+/V6vd1u+/1+vV5Xq1UYj8cjuULHZrPhLi1FURSG4WAwqNVq6NQ0DTqK9MxmMwYCxlQQBBQVOEDSB5IcMefzmUo2m8VnJpMBjE7+giyVSsxAwmg0SsDw8ZsLK5V4KjjP5/OVSiWXy7EexCMQDKJiEbQlYMwcDoeeCFjkZFaYSqVUVU2n0/Bib7vd4vwNBpKAL5cLqnhGHgzxu92OCawUPLtll+QMD0Sg+R8YVgbih5N/PAwVdNKBVE6kyW0zRtY/soFhErfvrbDYUARXzuhPwEuRBpox8gsmH01pB0VyDQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;computed style&quot;
        title=&quot;computed style&quot;
        src=&quot;/static/fb7d195814a04c6ed98eab8dbda477c6/799d3/computedstyle.png&quot;
        srcset=&quot;/static/fb7d195814a04c6ed98eab8dbda477c6/00d96/computedstyle.png 148w,
/static/fb7d195814a04c6ed98eab8dbda477c6/0b23c/computedstyle.png 295w,
/static/fb7d195814a04c6ed98eab8dbda477c6/799d3/computedstyle.png 590w,
/static/fb7d195814a04c6ed98eab8dbda477c6/126df/computedstyle.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;即使没有提供任何的 CSS，每个 DOM 节点还是会有一个计算过的样式。&lt;code class=&quot;language-text&quot;&gt;&amp;lt;h1&amp;gt;&lt;/code&gt; 标签会显示地比&lt;code class=&quot;language-text&quot;&gt;&amp;lt;h2&amp;gt;&lt;/code&gt; 标签更大，每个元素地 margin 也有定义。这是因为浏览器本身有一套默认地样式表。&lt;/p&gt;
&lt;h2&gt;布局&lt;/h2&gt;
&lt;p&gt;现在渲染器进程知道文档的结构和每个节点的样式，但是仍然不够渲染出一个页面。想象一下通过给朋友打电话描述一幅画。“有一个大的红色圆形和一个小的蓝色方形”并不能够准确描述这幅画究竟长什么样子。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0658494542e14f7db66b913c02c03202/126df/tellgame.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.294797687861276%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB10lEQVQoz21Su47TQBQdim0QEgUUQLESP7D8AtI2iHYrOkRBS02zH4D4AUo6N2ELQrTtJqFIsnlY5GEltmfs8dqOTZLNy3b8iPfEXu1D2iv7auy555x7zwzhnHuel6ZpkiRBECyXy/V6PZ/PF4vFarXCZxiG2+0WBXEcp/eDMMYkSQIFkGCJwjD2/RTlqI2iTRjmFFEUVatVy7LGWWAfYsQwDNM0S6XSdDrFAizm5fxCY1TnoiTZlmXbNtgLhUKr1apUKr1er1gslstldERAAwxowM0oRX/ezx+ztwfu0WH7z+8w69b3fVEUkQeDAbpDFgSh0WgQWZYnk0maDc3ssf+v7e4//v9qjz4h/Q/vd7+zgTEdZJrNJpSHwyEgAJLRaASHcgPEkSwXhPPnjzqvn7Zf7n38/P3NSSAoO59klf7NQlGUWq2We0y63W6+gkkYGHnx5ZP7jKwPXrw7PiVf6bezMTb5hQmNTqeDNbLrujvwXeupqkZJEm8CX2xGmvJL2x63kto4TuMN1TQUoGHHcaBPKb0F5ycJZY0xzg1jOjMcZ2bqnsNdkzOm2baVgyGrqup12+mDsePK3uy5CUwLw/r9/vUluQ95OHCQ2IVavV7XdR2e57ftCp5ZSInelRfHAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;tell game&quot;
        title=&quot;tell game&quot;
        src=&quot;/static/0658494542e14f7db66b913c02c03202/799d3/tellgame.png&quot;
        srcset=&quot;/static/0658494542e14f7db66b913c02c03202/00d96/tellgame.png 148w,
/static/0658494542e14f7db66b913c02c03202/0b23c/tellgame.png 295w,
/static/0658494542e14f7db66b913c02c03202/799d3/tellgame.png 590w,
/static/0658494542e14f7db66b913c02c03202/126df/tellgame.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;布局是寻找元素几何的过程。主线程遍历 DOM 树和样式来创建一个包含 x,y 轴和边框尺寸的布局树。布局树或许和 DOM 树很像，但是只包含在页面上显示的元素。如果有 &lt;code class=&quot;language-text&quot;&gt;display: none&lt;/code&gt; 的元素，那么不会存在于布局树（但 &lt;code class=&quot;language-text&quot;&gt;visibility: hidden&lt;/code&gt; 的元素会存在）。同样，如果有伪类如 &lt;code class=&quot;language-text&quot;&gt;p::before{content: &amp;#39;Hi!&amp;#39;}&lt;/code&gt; 会出现在布局树中，尽管它不存在于 DOM 树。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0c1de85206f0d177f93a70931a0f8272/126df/layout.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVQoz1WS6Y6CQBCEef/30QR/aUTiZlmN3AoeCCqCovG+Vvyc2d1kO2bohqqumm6Vsiwnk8nHp2H5QRgGw+HQ9/1+vx+Goeu65EEQeJ5nWVae56vVqtfrLZdLWM/nU+GRxLHr+V3TbjQa9Tq/eqfTAfQloitC0zTbtulC0yzLfshJkvAKKduyTNN0HGcwGIQicPGXjEYjmYzH49lslqbp8XhUoNEYe3ygNwjZ9X6/Xy6XbxGPx4MT9Hq9brfbYA6HA1dQAPGgRh+3zWaTEv58PkftdrvJXpwwF4uFruuIoVwUhbLf7xkJN+SqrVarUqlAA3o+n7FDI/hgOJGhOzTKKIre5EQEfMhYUlWVz4ZhIIIyfJLNZkOvUoR0Af9N5mK73Y5N1Go1mNVqFTQ60+mUFaJAiWGgwKBxeU7yN/l0OsVxzDWYliGCwTAhSjlSZkEXJoQau2D52MTUdrtVWBrTZ+8gQJNLV2her1dyPDMFANL5P9upCAaDPf5DcoyyJIFJd16iU/wGOe04XwjcTY6e4hgvAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;layout&quot;
        title=&quot;layout&quot;
        src=&quot;/static/0c1de85206f0d177f93a70931a0f8272/799d3/layout.png&quot;
        srcset=&quot;/static/0c1de85206f0d177f93a70931a0f8272/00d96/layout.png 148w,
/static/0c1de85206f0d177f93a70931a0f8272/0b23c/layout.png 295w,
/static/0c1de85206f0d177f93a70931a0f8272/799d3/layout.png 590w,
/static/0c1de85206f0d177f93a70931a0f8272/126df/layout.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;决定页面的布局是一件很有挑战性的任务。尽管最简单的页面如一个块结构从上至下布局仍然需要考虑字体大小，从哪里断行因为这会影响段落的大小和形状，进而影响接下来的段落的布局。&lt;/p&gt;
&lt;p&gt;CSS 可以使元素浮动至一侧，遮盖溢出的元素，改变文档的方向。可以想象布局过程有着大量的工作。&lt;/p&gt;
&lt;h2&gt;绘制&lt;/h2&gt;
&lt;p&gt;有了 DOM，样式，布局还是不能渲染一个页面。让我们来尝试创建一副画，我们知道了尺寸，形状和元素的位置，但是仍然需要知道以何种顺序来绘制它们。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d8fe81b968531c8b3d4767006ea9725d/126df/drawgame.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 37.45664739884393%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABL0lEQVQY05VPPU+DUBR9iZOrcTBODk6auDv4M5z7cxydjXFxMsbJ0YnNpBKIaYSQgnyWPngUXvkoUAh4oEtXz3bPveeec4jrOCzLqaFT16HrbLmkjEWmabquG8dxtAfHcZqm8X3/Z0RZliRIs1744Fen2c1Fr8pdP2A+n6dpWlXVZkSe513XQb8YgZUgCLIsk4Cvs8ktOyL05ODl7uk9GsS6YeAiSRJKqWVZQRBAzxhTFEXTNFVVPc8Lw5CwvGhen9dnh4vry+P74PxtEBvGL67rurZtG3d4AZJzruu6KIowRzQwBE3qvs++PpPZ94O6fZwV7baGA9wQGOa7CKiAL3iHRxglSUJ/slqtkjjGkm/KLo/bAisOEg35HsCCadsWaafTKboMzv1/ADdtxK7IHzccdTm16O1FAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;draw game&quot;
        title=&quot;draw game&quot;
        src=&quot;/static/d8fe81b968531c8b3d4767006ea9725d/799d3/drawgame.png&quot;
        srcset=&quot;/static/d8fe81b968531c8b3d4767006ea9725d/00d96/drawgame.png 148w,
/static/d8fe81b968531c8b3d4767006ea9725d/0b23c/drawgame.png 295w,
/static/d8fe81b968531c8b3d4767006ea9725d/799d3/drawgame.png 590w,
/static/d8fe81b968531c8b3d4767006ea9725d/126df/drawgame.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;例如，&lt;code class=&quot;language-text&quot;&gt;z-index&lt;/code&gt; 可能在某些元素上被设置，如果按元素在 HTML 中的顺序来绘制会导致不正确的渲染。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/785924a8744dfda1428cc692e2c3f411/aa667/zindex.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.44062153163153%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABa0lEQVQoz32S/W6CQBDE7/2fo3/1KUxM1JgQg5CqIKJyIigfIgpYRforV02bmG7iZW93bmdmUfR6vclkYhjGbDYzTdP3/SiK9vv9brcLw9BxHNd1pZQkm81msVhYlrVer5fLZZqmQtf14XA4GAw0Tev3+5wfbVAHCojT8zwIbNtmChwkx+Pxer2Ky+UCCYNpMBvcdDo1DQNCT0pegp7P50gbjUbookJ+u92aphHc6fEGPbCNx2NUUKSXhKGaKB9TsMMV/M9jqnir61r5oVQU5yiOA9+X729VnpPTbV6FiONYZeiHAZPb7ZbxnI5tIwGHcK5WK5D3+/3PYwwHQcAJDjNssiiKJEnYfHo4gEZOt9vtdDrsBdvUWYrSIvjVbZAwBf7PNsj5ZmVZslhaVMCUbTBdSfjeNhdKVVWBhhnx7A/ZyKHLerIse+05+xV5np8foXIY8Mz3xxFD1YKezkXzbyDqdDqR8Jd4unvGF3HhXceMYMsUAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;z-index&quot;
        title=&quot;z-index&quot;
        src=&quot;/static/785924a8744dfda1428cc692e2c3f411/799d3/zindex.png&quot;
        srcset=&quot;/static/785924a8744dfda1428cc692e2c3f411/00d96/zindex.png 148w,
/static/785924a8744dfda1428cc692e2c3f411/0b23c/zindex.png 295w,
/static/785924a8744dfda1428cc692e2c3f411/799d3/zindex.png 590w,
/static/785924a8744dfda1428cc692e2c3f411/2a3d6/zindex.png 885w,
/static/785924a8744dfda1428cc692e2c3f411/ae92f/zindex.png 1180w,
/static/785924a8744dfda1428cc692e2c3f411/aa667/zindex.png 1802w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;在绘制这一步，主线程遍历布局树来生成绘制记录。绘制记录时绘制过程的记录如“先绘制背景，接着文本，然后是矩形”。如果有使用 JavaScript 在 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;canvas&amp;gt;&lt;/code&gt; 元素上绘制过，这个过程会比较熟悉。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a68fd128fc59b9b2bed3511fcf223c94/126df/paint.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVQoz22R23KCQBBE+f+v0iq1jFFQQECBCOJdQfGKaCQHpqzkIfOwO9U7090zqxRFEYbBx2fXsF3PdX3fdxxnPB57nmdZFrnrurZtG4ax3W53u12/31+v13S9Xi+FazabWbaj6Wa9VqvXOWqqqg4Gg24V5JqmNRoN0zRhgeu3mU6RMg1D1/XhcCiyxGQy+foTIPgCnM/nq9XqcrkolCICaxAE5JywfleBwnK5XCwWaZoCns/nOI7b7TbikivP55MLvizLxExRRZ7nEKEWhiE6IJTB1Wq1GARkv98rFN3v99FoxD6ogAtNSTDJzKxqs9kIXa/Xw8jxeJxOp2WzCALhGZ9Qgsh6yUnAhVdMyYntsvnxeHDJGnGYVsGXnE4n7DSbzU6nA7UMT0EURXSyrSRJlOv1KrMB8bG80ckbpHgD4QllSjGPF1Z9u90oKJUpZVuMgRmK4MY8RExOG+bRl4X9Y1v+g03CTTPekipAoirQFzB+B20gh8PhB0XOU3hbyxq5AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;paint&quot;
        title=&quot;paint&quot;
        src=&quot;/static/a68fd128fc59b9b2bed3511fcf223c94/799d3/paint.png&quot;
        srcset=&quot;/static/a68fd128fc59b9b2bed3511fcf223c94/00d96/paint.png 148w,
/static/a68fd128fc59b9b2bed3511fcf223c94/0b23c/paint.png 295w,
/static/a68fd128fc59b9b2bed3511fcf223c94/799d3/paint.png 590w,
/static/a68fd128fc59b9b2bed3511fcf223c94/126df/paint.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;更新渲染流的开销很大&lt;/h3&gt;
&lt;p&gt;在渲染流中最重要的是要知道每一步都会使用前一步操作的结果来生成新的数据。例如，如果在布局树上有一些变更，在文档流中被影响到的部分的绘制顺序需要重新生成。&lt;/p&gt;
&lt;h2&gt;合成&lt;/h2&gt;
&lt;h3&gt;如何绘制一个页面&lt;/h3&gt;
&lt;p&gt;在浏览器知道了文档结构，每个元素的样式，页面的坐标，绘制顺序，那么是如何生成一个页面呢？将这些信息生成屏幕上的像素被称为光栅化（rasterizing）。&lt;/p&gt;
&lt;h3&gt;什么是合成&lt;/h3&gt;
&lt;p&gt;合成是将一个页面分为许多层级，每层独立进行栅格化、再合成的技术。合成再合成器线程中执行。&lt;/p&gt;
&lt;h3&gt;分成多层&lt;/h3&gt;
&lt;p&gt;为了找到哪些元素需要位于哪些层，主线程遍历布局树来创建层级树。如果页面的某部分应该是单独层（像抽屉菜单），可以通过 CSS &lt;code class=&quot;language-text&quot;&gt;will-change&lt;/code&gt; 属性告知浏览器。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b08901dee7af151982f600e6a7a6ba43/126df/layer.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABcElEQVQoz0WR6XKCMBSFef+36ugM02kFRMomoCK4ICigjgsW+pmIPT/gJrlnyY3Sdd18Pv/8+jYdfzr1wzB0HMd1Xd/3fwSobds2TTPLst1uNx6Pt9strLZtFX5JkjiuZ5jWRw9d12kajUaaphmGwXc4HEqhIAhQeZGXy6WwcqzJBIJlWXgGAqSYClBHURQKzGazNE3X6/X5fFYQQ1s2obJYLFD97dEJUOBzOp3yPFdVFa3j8UitXK9Xju/3exzHXEnm6XqUZSlDgqIoVqsVZMw2m81+v1fQeDweqELGnBofvlKC2TCt2+1G3TQNs4BW1zUBn2RfgAW3gswI8OegqqrBYIAQ8bga0aS/FMXySZaxUWUYnuchQU60D4cDxzIt+wRGWo4QxRf5crnQQSsvyRbOtJKW2xKeu5CLBmjotgIsUf93TgQoWELgMTjDQT4M+zjDfw/y5cyL8eOMSZCQG6JC8kIAptynjToXoJ8eov0ByrBXoF/rSx8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;layer&quot;
        title=&quot;layer&quot;
        src=&quot;/static/b08901dee7af151982f600e6a7a6ba43/799d3/layer.png&quot;
        srcset=&quot;/static/b08901dee7af151982f600e6a7a6ba43/00d96/layer.png 148w,
/static/b08901dee7af151982f600e6a7a6ba43/0b23c/layer.png 295w,
/static/b08901dee7af151982f600e6a7a6ba43/799d3/layer.png 590w,
/static/b08901dee7af151982f600e6a7a6ba43/126df/layer.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;主线程的栅格化和合成&lt;/h3&gt;
&lt;p&gt;一旦层级数创建好，绘制顺序也已确定，主线程就会提交信息到合成器线程。合成器线程对每层做栅格化操作。一个层可能像整个页面那么大，所以合成器线程会把每层都切分成方块，并把每块都发送至光栅线程。光栅线程栅格化每块方块并把它们存放在 GPU 内存中。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/371b5fa654d59f0c8ccb2f4f0658c20a/126df/raster.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0UlEQVQoz01Sy5KbMBDk//8ktxySVPaQKpulYnaNMWCe4ikQIDAE2+W3DU4b55A5iJFQd8/0SHg8HpQmH3PFcIhPSBiG7hiEENM0LctCbtu2YRh1Xa/Xa13Xq6oCahgGAR/GmON62sqcIkRxMpksl0tN0xRFUVUVOVZJkkDkeR7YwfIPnGUZuD3PtVbPsMcbkE3GCIIgiiIA4jj2fR9brJRSzvnhcBBw8+NzDhgQKMkjfj8MIIYOrl4ul7ZtT6fT+Xy+3+99399uN2h2XYdz4U9TRcSxlYltLMLVzNIUmkRFUYAIlUMELNABGBTDyIuA7GazEeqSpZHH3HnoGLvS5ywmrr3f70VRBPdut0OH2+0WOXxqmga/gEQOp4R2XenqfPH+MwmcX9++vH3/Gng2XBCnU5SdpulLHG5jCxcABiPoULlQ8zKLffX9x2oha7/fAsdo67LrNsfjsR/jer3CJLQAFwFAtaAD6RPMC9Y1nDqfEbEiU962vKmKYZzEqz3goYkRQB+asBazlGUZJ0JVZIwGoS75jh7oUp6QqmSP/wImoz3gMXaUjZeD1zCbzZ7goixZXuRZwvI8z2iaMc4r1NaNgQSGvdyG/0jQLVY8Nfz6CxoTRqDyXR/aAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;raster&quot;
        title=&quot;raster&quot;
        src=&quot;/static/371b5fa654d59f0c8ccb2f4f0658c20a/799d3/raster.png&quot;
        srcset=&quot;/static/371b5fa654d59f0c8ccb2f4f0658c20a/00d96/raster.png 148w,
/static/371b5fa654d59f0c8ccb2f4f0658c20a/0b23c/raster.png 295w,
/static/371b5fa654d59f0c8ccb2f4f0658c20a/799d3/raster.png 590w,
/static/371b5fa654d59f0c8ccb2f4f0658c20a/126df/raster.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;合成器线程可以对不同的栅格线程定义优先级，所以在视窗中（或靠近视窗）的部分可以先进行栅格化。&lt;/p&gt;
&lt;p&gt;一旦方块都被栅格化，合成器线程收集称为 &lt;strong&gt;draw quads&lt;/strong&gt; 的方块信息来创建一个 &lt;strong&gt;Compositor frame&lt;/strong&gt;（合成帧）。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Draw quads&lt;/td&gt;
&lt;td&gt;包含诸如方块在内存中的位置以及在考虑页面合成的情况下在页面中绘制方块的位置之类的信息。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Compositor frame&lt;/td&gt;
&lt;td&gt;表示页面框架的四边形的集合。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;一个合成帧随后通过 IPC 被提交至浏览器进程。此时，另一个合成帧可能由于浏览器 UI 的改变从 UI 线程被添加或从扩展的其他渲染器进程中添加。这些合成帧被发送至 GPU 来呈现到屏幕上。如果触发了一个滚动事件，合成器线程会创建另一个合成帧至 GPU。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/397d4949099dd6d1aaffcb55e8678e37/126df/composit.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.601156069364166%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkElEQVQoz1WS127CQBRE9///hiceQIJgJHABI3fjgg0WHdGCKKHkyBsS5Uos17szc8ezFq/XK88zVTdsP4qjKEmSIAiGw2Ecx57n0UdR5Pu+bdur1Wq9Xg8Gg8ViAevxeAj+isnEC0LTcprN5kdZpmlaltXv92lAs7bbbcdx0EJ0uVzCej6foigK5jDEc13kwzBklFcWA13XZQWQpilrVFaWZVhgvuAMMZ6TNEVov9+DG41GTAZNA4D917twe7/fv8oS1+v1eDzebrfz+cwZPRzpSqJlA/RyuYCB/CskTqfTbrfDsGEYzNxsNmTGfLzM53MIEoeopmm9Xk/uSEUxHo+JoVqtVioVVVUJI02SPM8bjQYhoYtnmTOATqfzj4xJEBwTAN6YQFRIsK/rOvPlEQan0ylxHg6HPzI/nmu1GjcEwdB1pdXikjCp4aTb5YYkn3ep1+ukDYXMfu4ZVUVRmAMIwzTyJmazGdN4c+zgTl4eAHY4JR3BN0BahAQTC9vtlhSQg/D5LnoZJBgaLKAF8hvmbE0ktc1lqQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;composit&quot;
        title=&quot;composit&quot;
        src=&quot;/static/397d4949099dd6d1aaffcb55e8678e37/799d3/composit.png&quot;
        srcset=&quot;/static/397d4949099dd6d1aaffcb55e8678e37/00d96/composit.png 148w,
/static/397d4949099dd6d1aaffcb55e8678e37/0b23c/composit.png 295w,
/static/397d4949099dd6d1aaffcb55e8678e37/799d3/composit.png 590w,
/static/397d4949099dd6d1aaffcb55e8678e37/126df/composit.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;合成的好处是不需要涉及到主线程。合成器线程不需要等待样式计算或 JavaScript 执行。如果布局或绘制需要重新计算就会涉及到主进程。&lt;/p&gt;
&lt;h2&gt;总结&lt;/h2&gt;
&lt;p&gt;本文主要了解了渲染的流程，从解析到合成的过程。希望在阅读更深入的性能优化时能够有一些帮助。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[浏览器输入URL...]]></title><description><![CDATA[前言 我们知道现在市场上大多数浏览器是多进程多线程的方式来处理不同的任务。我们今天来看一下进程和线程是如何合作来呈现一个网站的。 我们以简单的浏览网页为例：从地址栏中输入 URL…]]></description><link>https://www.keisei.top/web-browser-happen-in-navigation/</link><guid isPermaLink="false">https://www.keisei.top/web-browser-happen-in-navigation/</guid><pubDate>Sun, 15 Dec 2019 15:35:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;我们知道现在市场上大多数浏览器是&lt;a href=&quot;https://developers.google.com/web/updates/2018/09/inside-browser-part1&quot;&gt;多进程多线程的方式来处理不同的任务&lt;/a&gt;。我们今天来看一下进程和线程是如何合作来呈现一个网站的。&lt;/p&gt;
&lt;p&gt;我们以简单的浏览网页为例：从地址栏中输入 URL 开始，浏览器从网络请求数据并展示内容。我们重点关注用户请求网站数据和浏览器准备渲染一个页面。（如无特殊说明，以下均以 Chrome 浏览器为例）&lt;/p&gt;
&lt;h2&gt;从浏览器一个进程开始&lt;/h2&gt;
&lt;p&gt;浏览器选项卡之外的任何事情都是由浏览器进程来处理的。浏览器进程由绘制按钮和输入框的 UI 线程，处理从浏览器请求数据的网络线程，控制文件访问的存储线程等组成。当向地址栏输入 URL 时，首先会由浏览器进程的 UI 线程来处理输入内容。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4006973a23f68ec28402353d48f91a57/126df/browserprocesses.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhklEQVQoz2WSSY+CYAyG+f//QePZg0evKNGYaIy4RHFDcUNlcINB3IZ5pOMysYcv/dq+fbsp8/m8Wq32+/3hcGhZVrfbRR8MBnzb7bYoWFqt1nK53O120+m0Xq+fTqcoipTRaFSpVPCpqlosFvP5PL5ardbpdHRdR280GuilUomXXMT3er0gCO5gmG3bnkwmEifSbDblFUGnCghIShWmaTqOcz6flUKhUC6X8QnheDwOw9D3/e+HBLF8xeJ5HpbD4bDZbAhWqJ5QPvBTBXr0Iev1OplMQrDf74/HI5br9QqZgubFQpbtdks9t9sN489DcJE3nU6TGu9sNrtcLi8w+agkk8mkUqlEIqFpGpgnbS6XY+D0SfOGYTCd1Wr1B6ZDJsxI2BPzxEQL+CBhMSSFkFzC9sz4YiaIUp9s6NQJDAARrutKF+IV5QWWv7wMLJvNAuYYGCz8NIUiVyFTQJG8yntWoWUlckkcA5tj1J9bgPm+Ko7O/i+AeZkqGJBOLAzpPWaxWHAtv3nWjGZFYrbhAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;browser processes&quot;
        title=&quot;browser processes&quot;
        src=&quot;/static/4006973a23f68ec28402353d48f91a57/799d3/browserprocesses.png&quot;
        srcset=&quot;/static/4006973a23f68ec28402353d48f91a57/00d96/browserprocesses.png 148w,
/static/4006973a23f68ec28402353d48f91a57/0b23c/browserprocesses.png 295w,
/static/4006973a23f68ec28402353d48f91a57/799d3/browserprocesses.png 590w,
/static/4006973a23f68ec28402353d48f91a57/126df/browserprocesses.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;简单的导航&lt;/h3&gt;
&lt;h4&gt;第一步：处理输入&lt;/h4&gt;
&lt;p&gt;当用户向地址栏输入时，UI 线程首先会考虑这是“搜索还是 URL？”。Chrome 浏览器地址栏同时也是搜索栏，所以 UI 线程需要解析并决定是把内容发送给搜索引擎还是真的请求一个网站。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d619ac67749e633ae020812aa0b09bdd/126df/input.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjklEQVQoz51S226CQBTk///ERL/B2CiaiLBABMNFAdGiKGC5LqB0AG3avrXzwrnsmZk9C+O67mq1MgzDNE3btjebjaa1mWFu12tF13UkmqbJsux5XhRFjuPwPF+WZdM0zG63Wy6X6I3H49lsNplMJJ4l3JsqLwi/EEVJFEVFUViWVVUVRDgPrjzP2+H9fn84HCzLIoTgHBEIETiR8JiUhSkRZZG0kKSWheM4rTN2Pp8hzszncyiDG21BEMBSVVWWF3mWZLGf5zT7BgimaZokCfzjMFMUBRI0wjC83W6UUvip7/d7TZsqfCBpHsDz8wrquoYRBgn4MAYWUPTtglaeq5vq1D85lu0cj0fc7r0DPEMG7p7DSCC+3W7hBNtGXFV18nGNrm4SB0mSnjzvcrmgDs+QgRgu3A4jx2shGg6Hg8FgNBpBpDfWdAiCAAewJ/jqK2jhdu0w3hYL830flNghNoE2iHGLklIEaYc4jntBgHb1p+12Oy+dr8X0RQDBr8qPhfVL+hMw3D6V+1/gz/0EToqR/tDWRRIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;input&quot;
        title=&quot;input&quot;
        src=&quot;/static/d619ac67749e633ae020812aa0b09bdd/799d3/input.png&quot;
        srcset=&quot;/static/d619ac67749e633ae020812aa0b09bdd/00d96/input.png 148w,
/static/d619ac67749e633ae020812aa0b09bdd/0b23c/input.png 295w,
/static/d619ac67749e633ae020812aa0b09bdd/799d3/input.png 590w,
/static/d619ac67749e633ae020812aa0b09bdd/126df/input.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;第二步：开始导航&lt;/h4&gt;
&lt;p&gt;当用户按下回车键，UI 线程开始发起网络请求获取网站内容。首先在 Tab 左边会出现加载的标识，网络线程开始通过 DNS 查找并建立 TLS 连接。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/749ccda4aca068ed34465407973dc3f9/126df/navstart.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqklEQVQoz3WS2XKCUBBE+f8/8cnyLSFRAkatuBKJSFQiCrhF3MVdcoBsL05Z2HfuLN0Ngus4pXJFM9ofptnr9QzDaLVa7Xa70+k0Go0YkNE0bTQaLRaLfr9frVaPx2MQBIJldV9KpZKqPUlSLpeTZbler6uq2mw2eb5Goet6Pp8nw6But8us3W4XNtu27bpuv2fFpWoUMXj9CTATAeVymU5GTCYTlguFQoHFut7krlarwZys7/u7KPwf5Eex3++32+1ms4E/xQJnDlzM5/PlcskRPsH1GtyIa3R1Pp9ZJoBoWK/Xh8PhdDo5tp1+fJQymedsluf93V1WUfiJoqjIMlcYTAuV381wYDnGoq1aqbwbxngSBvZixy8Yj8fD4RDaf5shTAo/kslkIpFIpVKDwYBrdCIeOgD2xBmeq9WKJOTZFLrNH4JhPp1OkU3FzPMy6fSDKEqSpCjKwHWZiDpYvGkasy6XS9hMKQga/11hJ1o8z4MXrhaLRY7sRJ3jOFCA/Lfm6w1v4/xsNqOBnbxFABo/owhflXMj7Cj4GKnGMDpN07QsC0wGFRj8BRL9hPf//QcyAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;nav start&quot;
        title=&quot;nav start&quot;
        src=&quot;/static/749ccda4aca068ed34465407973dc3f9/799d3/navstart.png&quot;
        srcset=&quot;/static/749ccda4aca068ed34465407973dc3f9/00d96/navstart.png 148w,
/static/749ccda4aca068ed34465407973dc3f9/0b23c/navstart.png 295w,
/static/749ccda4aca068ed34465407973dc3f9/799d3/navstart.png 590w,
/static/749ccda4aca068ed34465407973dc3f9/126df/navstart.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;在此时，网络线程或许会收到服务器重定向的头信息，如 HTTP301。在这种情况下，网络线程会通知 UI 线程服务器请求重定向。随后另一个 URL 请求会被初始化。&lt;/p&gt;
&lt;h4&gt;第三步：读取响应&lt;/h4&gt;
&lt;p&gt;一旦收到响应体（数据载荷），网络线程会首先查看数据流的前几个字节。响应的 Content-Type 头信息会返回数据的类型，但是这个信息有可能会丢失或错误，所以&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types&quot;&gt;MIME 类型嗅探&lt;/a&gt;会帮助识别数据类型。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a049bd54e903004676c6f75ec11d373b/91043/response.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABM0lEQVQoz4WSbYuCUBCF/f9/SRDRFgKJEE0jy/I9NYpSW7Va91HZZdmCzofh3vGeM2dmFLIs2263URQlSbLf75MBZOq67v7g6wkkhd1uN5vNTNM8n89FURCbpvF9nzOfH4/HyOxeQYjj2HEcJFzXJVqWBe14PHqeh4Qsy5qmzedz8qqqUsYwjOl0OplMTqeTEA3APISqqi6Xy+12OxwOkIMgkCTpYwA0RVFEUUQLm2VZ8qwnLxaL1WqFYeyRwmqapgg9+/znXwjDEDKuNpuNbduo0gW9LJdLbOu6ju56vcYFGQbJlQav12tPpnKe58UAzBDbtk0H0AKvoaGFEGTOtEO9cRf9wCCMhu/3O0zOjACh7h0ExJgb68HJ5wDIrJqyL9f7u+SejL3xJwl/gBf6R+Vt5W949SycsWYyRgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;response&quot;
        title=&quot;response&quot;
        src=&quot;/static/a049bd54e903004676c6f75ec11d373b/799d3/response.png&quot;
        srcset=&quot;/static/a049bd54e903004676c6f75ec11d373b/00d96/response.png 148w,
/static/a049bd54e903004676c6f75ec11d373b/0b23c/response.png 295w,
/static/a049bd54e903004676c6f75ec11d373b/799d3/response.png 590w,
/static/a049bd54e903004676c6f75ec11d373b/91043/response.png 720w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;如果返回的是 HTML 文件，下一步就是把文件传递给渲染器进程。如果是 zip 文件或其他的需要下载的文件，那么这些数据就会被传到下载管理器。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b4797a3b5023a9de4ac03ad174e9bd3f/126df/sniff.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlklEQVQoz02SyZKCQBBE+f8/8aKf4HhQYwJGURRRZBVGQ8INcXBD5tGthnnoSGrJqs5GiaNI1X4My3YdJwgCy7Jms5lt2/P5fDweS0LEMIzVarXf78Mw7PV61+u1LEvF971vVVV146vZbLfbrVZrOBzquj6ZTDgHAqZpdjodIgh5nodWnudV82KxiOM4DHxZqgtIMvgAkzk1TaPTcZz1es1wpdvtMtg0J+T6/b7v+7fb7XQ6of0nIEkucD6fSWVZxv4UK3zzQXq32x0Oh8vlUr4AzwTIpml6PB7hqQARhikU0U+CNSDlB5CzBFzXpRSChYHAZrN5NrMDkhiLjdPpFCGCj8eDRfA2iqJfAdymjThZrlCtzR1I4HC9Xq/Vao1Gg2rZfL/fOYuigLAXWpxJksg1q8m4TScbMny73b7Hygm0yXuhiAV0jkYjHEWR51CktwAPSEMoXS6XLMyrsBRFUh2fGIAKO1P2vHPxAkKMgpCjlEWopp8GHpYLQ9BNBKo784cQigUkeTtEnfRJWsW/wV8Al3EM/geRPYpQ2NqBqgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;sniff&quot;
        title=&quot;sniff&quot;
        src=&quot;/static/b4797a3b5023a9de4ac03ad174e9bd3f/799d3/sniff.png&quot;
        srcset=&quot;/static/b4797a3b5023a9de4ac03ad174e9bd3f/00d96/sniff.png 148w,
/static/b4797a3b5023a9de4ac03ad174e9bd3f/0b23c/sniff.png 295w,
/static/b4797a3b5023a9de4ac03ad174e9bd3f/799d3/sniff.png 590w,
/static/b4797a3b5023a9de4ac03ad174e9bd3f/126df/sniff.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;第四步：找到渲染器进程&lt;/h4&gt;
&lt;p&gt;一旦确认所有的检查，网络线程确定浏览器可以跳转到请求的网站，该线程就会通知 UI 线程数据已经准备就绪。UI 线程会找到渲染器进程来渲染网页。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/320ebdce97d9fb29329fd47c0c5f0c07/126df/findrenderer.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQoz22SyXKCYBCEef838aKPYDwIUiAQkEWRsAhomSr3LSqajx/jKV3W1DBOT880SEWea/rQCcKvKErTNAiCyWQShuF0OnVdt0moOI6zWCw2m02WZYZhXK/X5/MpJUmsappmOR/dbr/f7/V6tm1bluX7PvFTwPM8WZapMCiOY2adz+eaPJvNiqLI0qRptQTeyRtMpKjrOkxGLJdLxCVFURD2PJ//TNNkq6qqLpfLjwAddfx5AcHj8Xg4HNifZok+Hk6nE8/b7ZbdkODnjkaom4ZBtMUmvuc9Ho+nwP1+pyaRwd/v94iQsNLIcXRNg+BwvGlCC7jfNP8no4k4xmIjkZzivCw1VR0CXTeGQ5YkUWSZCJPTMELihrIs8aPdbrdarU6ng4WQsQTlyXjsC2C4OhjYwjMorFCTaYW5Xq8RXK1W7N8s9t4QcBGzqLAjH8Ltdnspkx0F8Aw/Sbh8Pp9jO2+Ft8jCnMfc3W6HQJ7njeevm6s/MKi5h/9ohUA3R0FAme+PhLnfAvWrYjalQqBJiKUAfcSFAMwoipIkIW/qWPsLJiB+zDhRHpgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;find renderer&quot;
        title=&quot;find renderer&quot;
        src=&quot;/static/320ebdce97d9fb29329fd47c0c5f0c07/799d3/findrenderer.png&quot;
        srcset=&quot;/static/320ebdce97d9fb29329fd47c0c5f0c07/00d96/findrenderer.png 148w,
/static/320ebdce97d9fb29329fd47c0c5f0c07/0b23c/findrenderer.png 295w,
/static/320ebdce97d9fb29329fd47c0c5f0c07/799d3/findrenderer.png 590w,
/static/320ebdce97d9fb29329fd47c0c5f0c07/126df/findrenderer.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;由于网络线程可能会花费数百毫秒去请求响应，UI 线程会平行地尝试主动找到或开启一个渲染器进程。如果一切按预料的，当网络线程获取到数据时，渲染器进程就已经准备就绪。&lt;/p&gt;
&lt;h4&gt;第五步：准备跳转&lt;/h4&gt;
&lt;p&gt;一旦数据和渲染器进程准备好，一个 IPC（interprocess communication）会从浏览器进程发送到渲染器进程来提交导航。同时也会把数据流传送到渲染器进程保持继续接收 HTML 数据。一旦浏览器进程接收到渲染器进程跳转开始的信息，导航完成，开始文档加载的阶段。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b9882cfdfbc700b2698116669bf40d4e/126df/commit.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABr0lEQVQoz12S6Y6CQBCEef/3MWqMrPEEFBBdxbAaEJT1iAfiGa/9GHaN2f5Beqa7qmuqkYLAVzTNsp3hcOi67mAw+BIxGo16vR4J947jWJY1m802m814PNZ1/Xq9Pp9PCYDWbKmG9SHLtVpNluVWq2WaJkhTRLvdJq/X6/1+HyLP82zbPp/PCXgymYRhOPY8+qA3RFgiOp0OSDAknyLoQQvzVqsVKqRqtYoM1NJNDa7H43E8HndxHG23JL7vU6WkKEqqQlVVmqMokg6HAzTz+Rym3W5Hwgvh9jHD9+FCiGkYVA8iEBzH8el0SmTv93voyUB+E2HY1DQmIMfQdSaUy2W8oBvk/X5/vkUymWm5XC6TyeTzeaa9aujny/DpdEqOVVjdaDRwNC1J2MBWOJdKpUqlsl6voUcb35NQhH4w7CkdUywWs9nscrlMwLAi6Xa7pdN4AgVexRwWw00gwNyzFGzHfI6gEnA6B/zlcuGW1sViQStgEnxiwzjMsVAoYEHaTAPKJQjuIkhYRvBnMkR8eRG75Mti/rn1+5O8AsEg+YHQ1u12XREg0c+baQjeguMP44d+2mnAJh0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;commit&quot;
        title=&quot;commit&quot;
        src=&quot;/static/b9882cfdfbc700b2698116669bf40d4e/799d3/commit.png&quot;
        srcset=&quot;/static/b9882cfdfbc700b2698116669bf40d4e/00d96/commit.png 148w,
/static/b9882cfdfbc700b2698116669bf40d4e/0b23c/commit.png 295w,
/static/b9882cfdfbc700b2698116669bf40d4e/799d3/commit.png 590w,
/static/b9882cfdfbc700b2698116669bf40d4e/126df/commit.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;额外步骤：初始加载完成&lt;/h4&gt;
&lt;p&gt;当跳转后，渲染器进程会加载资源并渲染页面。一旦渲染器进程结束渲染，它会向浏览器进程返回一个 IPC（当前网站的所有页面 &lt;code class=&quot;language-text&quot;&gt;onload&lt;/code&gt; 事件已经触发并执行完成），UI 线程停止 Tab 上的加载标识。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b93f199ad2138be6e445d1ceb4416033/126df/loaded.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABrklEQVQoz2WS2W6CQBSGef/3afRGJKkbFNyqYiwIAuKGC3VH1H44qanpuZjMMOdfzj9Inu9ranVgGpZlO47T7/e/HmXbdrfbZWNZ1mAwaLVa0+l0vV6PRiPDMC6Xy/1+lxzH1T/UpvEuy8VyuSTLsq7rjUaj1+s1HtVsNmGpVCp8gch1XdM0T6dTBg6CIAwnruvRBz1rvV4XG2CsINvtdufzs9PpcMQLBpfLJS6kUqmEDdwCAIYrLB0Oh3OSpGkKfRiG2IaoVqsJF6qq0hzHsbTf76GZzWar1Yr9+Xy+3W6XNF1GUd80h7aNk1q1CsV2u93tdhhmczweM9uc0WHHJyh2j4LiO47xyZyapinFImnd/1WmDCafz789ajgcPu+wwOr7/mQyiaII/Hg8JjkSFVcS9AAYW1EU5sd8kiS4YHLGEWCCWCwWQqZQKORyOY4ZmDtsk40g22w2KIAkVV5FgClmQZ/YGQQuLGTgvw7xAwBBZkYE+uv1ii/P87jlFyBtAiMt9IC8gMUD8vKIwDKfzxmVV0T52fMSWPBbdNCNH2D8SYICfRgZgacSPc/i+AP8S4QCP7TplQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;loaded&quot;
        title=&quot;loaded&quot;
        src=&quot;/static/b93f199ad2138be6e445d1ceb4416033/799d3/loaded.png&quot;
        srcset=&quot;/static/b93f199ad2138be6e445d1ceb4416033/00d96/loaded.png 148w,
/static/b93f199ad2138be6e445d1ceb4416033/0b23c/loaded.png 295w,
/static/b93f199ad2138be6e445d1ceb4416033/799d3/loaded.png 590w,
/static/b93f199ad2138be6e445d1ceb4416033/126df/loaded.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;跳转至其他网站&lt;/h3&gt;
&lt;p&gt;当用户再次输入不同的 URL 时会发生什么？浏览器进程实际会按之前的步骤执行。不过在此之前，需要确认渲染好的页面是否绑定了 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/Events/beforeunload&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;beforeunload&lt;/code&gt;&lt;/a&gt; 事件。Tab 下的任何事情和 JavaScript 代码都由渲染器进程来处理，所以当新的跳转请求时浏览器进程需要检查渲染器进程。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/71402d5b3a3f7d5629a242727e606079/126df/beforeunload.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABv0lEQVQoz1WSWW+CQBSF+f8/wjfjiy9tapNaE7QxGjSiBRd0REUFMY0o7rv9YNKmvdHhzMw9dzl3lOl0Wq1qoqPb9sBxnG63K4To9/u2bbdaLQl6vZ5pmr7vr1YrfGq12uVyeTweChu9VjUbJVXNl0qlfF7Vdb3RaHQ6HdbP2Nrtdrlc5oRYo9HIsqzT6RSRyey6nuNMpCtrvV43DAMgV5gAqmg2m1xR13A4XCwWy+VSKRaLpCIYHtxRyPl83u12h8Nhv9+Dx+MxfErVNA0fcKVSAYRhqGw2m/l8/hUb++Px+Pix+/3OCllGXMa2Xq9JK90i8jE2jiD/cv6SaQ1MjiAIcrlcMpmk84hMbZPJJJVKJRIJTlHler3uYttutyREJBxkQrZ0jvIMhXAKnTAMrgeDAaowD8h/MyMPfEpjYKSFRi1UEfVM+NvtxopCARoGAY0FcQvgdRgKSELgwBe1CIe/TKDwp8K6rudV9TWTec9mMy8v/LJvb89PT+l0GsD5R6HQNIxbzLn/mCIjoWf0noQwDaNrWWRjGMwPXNE0XggY2X47khY9EszzvJnvezMWfxabBPSGsMgBcF13+t++AR7AfLjknAObAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;beforeunload&quot;
        title=&quot;beforeunload&quot;
        src=&quot;/static/71402d5b3a3f7d5629a242727e606079/799d3/beforeunload.png&quot;
        srcset=&quot;/static/71402d5b3a3f7d5629a242727e606079/00d96/beforeunload.png 148w,
/static/71402d5b3a3f7d5629a242727e606079/0b23c/beforeunload.png 295w,
/static/71402d5b3a3f7d5629a242727e606079/799d3/beforeunload.png 590w,
/static/71402d5b3a3f7d5629a242727e606079/126df/beforeunload.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;当新的导航与当前渲染的站点不在同一个站点上时，将调用一个单独的渲染进程来处理新的导航，而当前的渲染进程将保留下来以处理诸如卸载之类的事件。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e074926b6b24cae624f6c1c906c16616/126df/unload.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.26589595375723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvUlEQVQoz1WS2XKCQBBF5/+/wSf/wfhAqlxLRBYVyxVxhxL3La4YcmAqVUk/NA3T9/btO4jFYqHput11Rq47nU77/b7jOMPh0HXddrsti8Fg0Gq1lsvl4XCgxzTN1+sVRZHgxTAtvdHK53KVSiWfz1uW1Wg0ut0uuZkELKqq8gWuyWTS6/Uej0cMZrLnefPZlCa72QRQr9dt26Ygxx9tu9PpgKeAF11o2W63x+NRlMtlwzA4ricB8f1+v359Xa+kOM7nc61W44jJ4AEzGWpUCNn0SOJ2uwGGTtf1qqpqmmYkxaeisO1ut+O0VCrN5/MwDFlbMAcwMJRsNpvT6cQjCAJqWnEEqz4yGcBBEoDx7zsJQfflcgE5Go3ICJES4KYVh9mwUCjABQbbfN+HdDweMzKWDVk6nU6lUtlsdr/fYyOs0W+83281Ce6CjdgWj3CB/QV8uL1er7EEkRIpwTIjpFqtytvGM/ynmM1mkAr25iEBqOACns9nPDAMJZiPANgCUUhVFIXhklpE/8P3POShCp9rmoZWNkQzvuAON8ork1erVbzz4k9wBziBNn4JmbEawfyz+MRRsVjEVycJih8hjXjGFlTEFQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;unload&quot;
        title=&quot;unload&quot;
        src=&quot;/static/e074926b6b24cae624f6c1c906c16616/799d3/unload.png&quot;
        srcset=&quot;/static/e074926b6b24cae624f6c1c906c16616/00d96/unload.png 148w,
/static/e074926b6b24cae624f6c1c906c16616/0b23c/unload.png 295w,
/static/e074926b6b24cae624f6c1c906c16616/799d3/unload.png 590w,
/static/e074926b6b24cae624f6c1c906c16616/126df/unload.png 865w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[区分CSS 分辨率和设备分辨率]]></title><description><![CDATA[前言 作为 Web 开发人员，我们在工作中可能会接触移动端 Web…]]></description><link>https://www.keisei.top/css-resolution-vs-device-resolution/</link><guid isPermaLink="false">https://www.keisei.top/css-resolution-vs-device-resolution/</guid><pubDate>Sat, 14 Dec 2019 13:33:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;作为 Web 开发人员，我们在工作中可能会接触移动端 Web 应用的开发。近年来移动端设备都是高分屏/视网膜屏，而且我们有各种尺寸的屏幕需要兼容：手机，平板，桌面端。在我们面前需要理解并运用的就是分辨率这个关键问题。
我们需要处理两种分辨率：一个是真正的设备屏幕分辨率，另一个便是 CSS 可测量的分辨率。&lt;/p&gt;
&lt;h2&gt;高分屏的新时代&lt;/h2&gt;
&lt;p&gt;在过去，这两种分辨率本质上是一致的。在现在，越来越多的手机、平板，甚至桌面端都采用了高分辨率的屏幕。CSS 分辨率和设备分辨率开始出现认知上的差异。&lt;/p&gt;
&lt;h3&gt;真正的不同之处&lt;/h3&gt;
&lt;p&gt;CSS 分辨率是在 CSS 样式中用来测量的单位，屏幕设备分辨率是实际的屏幕像素的数量。&lt;/p&gt;
&lt;p&gt;除了两种分辨率的不同，还有密度显示比（DPR）—屏幕分辨率/CSS 分辨率，如：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;iPhone 11，每个 CSS 像素有 2 个设备像素，即 DPR 是 2x&lt;/li&gt;
&lt;li&gt;iPhone 11 Pro，每个 CSS 像素有 3 个设备像素，DPR 为 3x&lt;/li&gt;
&lt;li&gt;三星 Galaxy S10，每个 CSS 像素有 4 个设备像素，DPR 为 4x&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;三星 Galaxy S10 的分辨率：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;设备分辨率&lt;/strong&gt;：1440px × 3040px&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CSS 分辨率&lt;/strong&gt;：360px × 760px&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;密度显示比&lt;/strong&gt;：4x&lt;/p&gt;
&lt;h3&gt;为什么 CSS 像素与设备像素不同&lt;/h3&gt;
&lt;p&gt;为什么 Web 会出现两种不同的分辨率？答案其实是不得不这么做。&lt;/p&gt;
&lt;p&gt;我们继续以 Galaxy S10 为例，它的屏幕分辨率为 1440px × 3040px。这个分辨率大小已经超过了部分桌面版的屏幕分辨率，而却被塞入非常小的设备中。如果不区分 CSS 分辨率和设备分辨率，桌面端的网站在手机上显示就会展现真实的宽度，我们就没有办法来创造手机和电脑不同样式的响应式网站。&lt;/p&gt;
&lt;h3&gt;设备分辨率的目的是什么&lt;/h3&gt;
&lt;p&gt;设备分辨率的主要针对的是多媒体，即图片，视频。在高分屏下，我们可以提供更清晰的图片和视频。如在 Galaxy S10 中，我们在 CSS 分辨率 300 像素下，可以加载宽度 1200 像素的图片：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;img&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;image-size-1200px&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;300&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;我们如何知道 CSS 分辨率是多少&lt;/h3&gt;
&lt;p&gt;我们可以通过 &lt;a href=&quot;https://yesviz.com/&quot;&gt;yesviz&lt;/a&gt; 来获取某一设备的具体分辨率信息。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c3dac69b18fdacef4896fb5dcf58b952/50334/google-pixel-4xl.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.48381601362861%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACnUlEQVQ4y5VTaU8aURSdxKQSW9wqIFQKU1ncULDBfjDpB7smlk1Tq6jxJ9TGVsUBjU3/pxFSBQaQnWGY4XjfIKT2Q2NfcnK388689+4dTpVbuClUUa83IUkSSqUyoaT5jUaD8nW0222oqqrZrt9qtQgKZFlGpVLpWW4nuoHo5mfsRjextxvF3s4Wdre3sL31BRvrYayHVrH26QPCwQACwQhWVwN48/Y9gqEIwuEwIpE1hMIdPxgIgXO/sMJhf4ZXLxfw8d0KVl4vY3lpEf75acy7ecxQ3TzyGCajAfoRA/p1AzAYTHC5p+B0OuEgTDLrcMEx6QTnnXXDOzcNn2cafp8Hi3MuzExOkFAHbpsFDqsZUy4n+Oc2WM1meDwe+P1L8PkWMTszBc/cLLxeLxYIHG+1gLdZoVnzKHjjIPjRJ5gYHsCYXoex4UHYxo0YH9JD39eHIZ0O+kf9MI4+Bc/zsNvtsNvssJhMmLBYwJ0KMSSEY5yfCvh1JuCncITzwwPED7/j+Jhq8TjOhBP82P+Kg/19xAUBscMjHHwjDuUTFCfiCZzEYjhNxMGxTkpSE8ViEZlsFmIuhzp1uEbdzZEvUq5araHZbKJwU0A2K6JSrWpdZdOQpbo2FVRnWpwoitrGq6s0kskkrq+vkaMc23hxcYlUKoUuJ5n6rXEymUxvzyXF6XS683Hicfl8AYVCgRJ57Wssmc/nNTBRlmNkxhHFXI/z9x4WM3CdAe1AlpmVoSgKDa+CtjbMqhazOrNddOLWvZiBw91qtdooV2R6xwpKZYneTEFDUlBvEFFR8dDFsV+JLVlWSZCaU5KQFWvUnJpmWU65E+z+ev/CPcFSuUknrGpi7JQ3xQZ1uNkT+68Tqmpbuxq7KvP/XF3OQ0RvAXxqZb8S75FnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;谷歌Pixel 4XL&quot;
        title=&quot;谷歌Pixel 4XL&quot;
        src=&quot;/static/c3dac69b18fdacef4896fb5dcf58b952/799d3/google-pixel-4xl.png&quot;
        srcset=&quot;/static/c3dac69b18fdacef4896fb5dcf58b952/00d96/google-pixel-4xl.png 148w,
/static/c3dac69b18fdacef4896fb5dcf58b952/0b23c/google-pixel-4xl.png 295w,
/static/c3dac69b18fdacef4896fb5dcf58b952/799d3/google-pixel-4xl.png 590w,
/static/c3dac69b18fdacef4896fb5dcf58b952/2a3d6/google-pixel-4xl.png 885w,
/static/c3dac69b18fdacef4896fb5dcf58b952/50334/google-pixel-4xl.png 1174w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;写在最后&lt;/h2&gt;
&lt;p&gt;了解 CSS 分辨率和设备分辨率的区别可以让我们更好地理解响应式，针对不同分辨率提供不同尺寸地图片、视频充分发挥高分辨率地优势，为用户带来更好的体验。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[简单的Promise实现]]></title><link>https://www.keisei.top/promise-from-scratch/</link><guid isPermaLink="false">https://www.keisei.top/promise-from-scratch/</guid><pubDate>Sun, 08 Dec 2019 11:30:00 GMT</pubDate><content:encoded>&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// https://www.youtube.com/watch?v=4GpwM8FmVgQ&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; states &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pending&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;FULFILLED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;fulfilled&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;REJECTED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;rejected&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;isThenable&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;maybePromise&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  maybePromise &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; maybePromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;then &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;computation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; computation &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;computation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bind&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bind&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ex&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ex&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;fulfilledFn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; catchFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; controlledPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fulfilledFn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; catchFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;FULFILLED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_propagateFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;REJECTED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_propagateRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;catchFn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; catchFn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;finally&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sideEffectFn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sideEffectFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;FULFILLED&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; LLJSPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; LLJSPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; controlledPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sideEffectFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;_propagateFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fulfilledFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; fulfilledFn &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; valueOrPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fulfilledFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isThenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token parameter&quot;&gt;reason&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sideEffectFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sideEffectFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;_propagateRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; catchFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; catchFn &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; valueOrPromise &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;catchFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isThenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token parameter&quot;&gt;reason&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;valueOrPromise&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sideEffectFn&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sideEffectFn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      controlledPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_thenQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_finallyQueue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;_onFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;FULFILLED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_propagateFulfilled&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;_onRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;reason&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PENDING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; states&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;REJECTED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_reason &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; reason&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_propagateRejected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

LLJSPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
LLJSPromise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;reject&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;_&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const promise = new LLJSPromise((resolve, reject) =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   setTimeout(() =&gt; resolve(42), 1000);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const firstPromise = promise.then(value =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got value: ${value}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return value + 1;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const secondPromise = firstPromise.then(value =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got value: ${value}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return value + 1;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const promiseRejected = new LLJSPromise((resolve, reject) =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   setTimeout(() =&gt; reject(&apos;Something went wrong&apos;), 1000);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// }).catch(error =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got Error: ${error}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return LLJSPromise.resolve(&apos;recovered&apos;);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const firstPromiseRejected = promiseRejected.then(value =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got value: ${value}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return value + 1;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// const secondPromiseRejected = promiseRejected.then(value =&gt; {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   console.log(`Got value: ${value}`);&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   return value + 1;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// });&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; fs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;fs&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;path&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;readFile&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;filename&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encoding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;resolve&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    fs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readFile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;filename&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encoding&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;delay&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;timeInMs&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LLJSPromise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; timeInMs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;readFile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__dirname&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;promise.js&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;utf8&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; characters read&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token regex&quot;&gt;/[aeiou]/g&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;newText&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;newText&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;slice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;An error occured!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;finally&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;--- All done! ---&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[webpack 基本原理]]></title><description><![CDATA[简介 现代化的前端应用离不开打包工具，从早期人们所熟知的 Grunt, Gulp 到现在炙手可热的 webpack, rollup 等，这些工具的崛起使得我们的代码构建更加方便，通过 Loader，插件等机制我们可以应用最新的技术，如新语法，预处理 CSS（Scss, Less…]]></description><link>https://www.keisei.top/webpack-behind-the-scene/</link><guid isPermaLink="false">https://www.keisei.top/webpack-behind-the-scene/</guid><pubDate>Wed, 04 Dec 2019 14:33:00 GMT</pubDate><content:encoded>&lt;h2&gt;简介&lt;/h2&gt;
&lt;p&gt;现代化的前端应用离不开打包工具，从早期人们所熟知的 Grunt, Gulp 到现在炙手可热的 webpack, rollup 等，这些工具的崛起使得我们的代码构建更加方便，通过 Loader，插件等机制我们可以应用最新的技术，如新语法，预处理 CSS（Scss, Less），热更新方便了开发体验，摇树（Tree Shaking）减少打包体积等。&lt;/p&gt;
&lt;p&gt;今天主要以 webpack 为例来了解打包工具发展至今是如何工作的，又通过哪些方式为我们提供了更多能力。以下图片简单描述了 webpack 的整个构建流程。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ab7934a1db677767b5369ef3963f3b9d/c1bb8/webpack-process.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.00942655145326%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAEDBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB4hJczk//xAAXEAEBAQEAAAAAAAAAAAAAAAABEAID/9oACAEBAAEFAodNBf/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAAEFAAAAAAAAAAAAAAAAAAEQESAhYf/aAAgBAQAGPwJAGFZD/8QAHRAAAgIBBQAAAAAAAAAAAAAAAAERUXEhMYGR4f/aAAgBAQABPyFKV4aVwJbAlBbrBZOOj//aAAwDAQACAAMAAAAQ0D//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QZH//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8QbX//xAAcEAEBAAICAwAAAAAAAAAAAAABEQAxIWFBcZH/2gAIAQEAAT8QkUNYZCiD2zhQgVmW+fecwQjWs1BrHp8M/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;webpack process&quot;
        title=&quot;webpack process&quot;
        src=&quot;/static/ab7934a1db677767b5369ef3963f3b9d/88218/webpack-process.jpg&quot;
        srcset=&quot;/static/ab7934a1db677767b5369ef3963f3b9d/7237a/webpack-process.jpg 148w,
/static/ab7934a1db677767b5369ef3963f3b9d/0cfdf/webpack-process.jpg 295w,
/static/ab7934a1db677767b5369ef3963f3b9d/88218/webpack-process.jpg 590w,
/static/ab7934a1db677767b5369ef3963f3b9d/77d57/webpack-process.jpg 885w,
/static/ab7934a1db677767b5369ef3963f3b9d/5a917/webpack-process.jpg 1180w,
/static/ab7934a1db677767b5369ef3963f3b9d/c1bb8/webpack-process.jpg 1273w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;工作原理&lt;/h2&gt;
&lt;p&gt;webpack 按其官方介绍，是一款静态资源打包器。在 webpack 的世界，所有的资源（JavaScript，图片，CSS，字体文件等）都是模块（module），在执行时，webpack 从&lt;a href=&quot;https://webpack.js.org/concepts/entry-points/&quot;&gt;入口&lt;/a&gt;开始分析所依赖的模块，然后递归处理依赖模块的依赖，最终生成一个&lt;a href=&quot;https://webpack.js.org/concepts/dependency-graph/&quot;&gt;依赖图&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;webpack 的 80%是由其插件组成，它自身也是事件驱动的架构。在 webpack 生态中，插件是关键的要素，并且为社区提供了强大的能力来进入 webpack 的编译过程中。插件通过 &lt;code class=&quot;language-text&quot;&gt;hook&lt;/code&gt; 方式对每次编译发出的事件做出响应。&lt;/p&gt;
&lt;p&gt;webpack 中一个核心模块是 &lt;code class=&quot;language-text&quot;&gt;Tapable&lt;/code&gt;，许多对象继承了 &lt;code class=&quot;language-text&quot;&gt;Tapable&lt;/code&gt; 类。该类暴露了 &lt;code class=&quot;language-text&quot;&gt;tap&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;tapAsync&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;tapPromise&lt;/code&gt; 方法，插件可以使用这些方法注入将在整个编译过程中触发的自定义构建过程。&lt;/p&gt;
&lt;p&gt;首先来看张图：&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/91af4f4bbef2a30e532c68bc23a60b04/02420/webpack-build-process.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 86.0488798370672%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAABg0lEQVQ4y5VTy06DQBT1/z/GpXHhwoWPaG0XksZo0wihtLzmzcC88dKqSW0tenKZAOHMOfee4aw/QGtaInGjhLVWawPlve+P4ezwVcHy5zhKqoQxgQnBmBhjfiWHAf22Ajwq2xUol1r2Y9hTBjqsOdvMFrO4jMfJznkwVlQky1Fe4qpCvBGY4U53WmullB5goP8jZHAK/KRon16KRUq10kmdTJfTt/Ub9EwpY4xDSdmesj2IKAWzccZv7ff/69mHIZIVSievk2W+JITVNfREQZ8QijDhXIxExTuWlikWyDvvoKUBAa7tXRgh1xJF8TzFGSGCMg7SCA1pY0xBH3b7lWw1pzQr67hpCm9FCH6X/zdOKDuZ3aHXS53d9OjR5PdGi69TFPa3CEfIeH69vDrf3F2sby/c6pHTEiG6dY7BPMxv18Jucj/Ivivm7H3C4ydYuzJytvs8e3/5MXZfKW1DGA97nxxckAvHI7x6sDRy4sVZ9WdyH4wiStaC5l1T6RZDuifIH28q3kzIh/aOAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;webpack build process，https://miro.medium.com/max/982/1*NU-KdDY_WxCh3YcDGEbTiw.png&quot;
        title=&quot;webpack build process，https://miro.medium.com/max/982/1*NU-KdDY_WxCh3YcDGEbTiw.png&quot;
        src=&quot;/static/91af4f4bbef2a30e532c68bc23a60b04/799d3/webpack-build-process.png&quot;
        srcset=&quot;/static/91af4f4bbef2a30e532c68bc23a60b04/00d96/webpack-build-process.png 148w,
/static/91af4f4bbef2a30e532c68bc23a60b04/0b23c/webpack-build-process.png 295w,
/static/91af4f4bbef2a30e532c68bc23a60b04/799d3/webpack-build-process.png 590w,
/static/91af4f4bbef2a30e532c68bc23a60b04/2a3d6/webpack-build-process.png 885w,
/static/91af4f4bbef2a30e532c68bc23a60b04/02420/webpack-build-process.png 982w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;简而言之，当 webpack 载入一个模块时，&lt;code class=&quot;language-text&quot;&gt;compiler&lt;/code&gt; 把模块放入称为 &lt;code class=&quot;language-text&quot;&gt;chunk&lt;/code&gt; 的容器内，并在渲染到浏览器之前在它上面执行大量的插件逻辑。&lt;/p&gt;
&lt;p&gt;我们来根据上图一步步来详解：&lt;/p&gt;
&lt;h3&gt;1.编译器（Compiler）&lt;/h3&gt;
&lt;p&gt;当 webpack 载入一个新模块时，Compiler 会第一时间执行（在 webpack.js 中 &lt;code class=&quot;language-text&quot;&gt;compiler.run()&lt;/code&gt;），它本身为 &lt;code class=&quot;language-text&quot;&gt;tapable&lt;/code&gt; 的一个实例。它处于调用栈的最高层，为 webpack 分发事件。它支持注册 &lt;a href=&quot;https://webpack.js.org/api/compiler-hooks&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Hooks&lt;/code&gt;&lt;/a&gt;，可以控制 webpack 开始、停止、处理资源文件、监听模式等。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// node_modules/webpack/lib/webpack.js&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/**
 * @param {WebpackOptions} options options object
 * @param {function(Error=, Stats=): void=} callback callback
 * @returns {Compiler | MultiCompiler} the compiler object
 */&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;webpack&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;options&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; callback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; webpackOptionsValidationErrors &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;validateSchema&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    webpackOptionsSchema&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    options
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;webpackOptionsValidationErrors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebpackOptionsValidationError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;webpackOptionsValidationErrors&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    compiler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MultiCompiler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;webpack&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; options &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;object&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    options &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebpackOptionsDefaulter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    compiler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Compiler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;options &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;NodeEnvironmentPlugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      infrastructureLogging&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;infrastructureLogging&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;compiler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; plugin &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; plugin &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;compiler&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;compiler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hooks&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hooks&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;afterEnvironment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;options &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebpackOptionsApply&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Invalid argument: options&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;callback&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; callback &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Invalid argument: callback&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watch &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;o&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; watchOptions &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;o&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watchOptions &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;watchOptions &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;watch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;watchOptions&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; callback&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    compiler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;callback&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// node_modules/webpack/lib/Compiler.js&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Compiler&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Tapable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hooks &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncBailHook&amp;lt;Compilation&gt;} */&lt;/span&gt;
			shouldEmit&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncBailHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Stats&gt;} */&lt;/span&gt;
			done&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;stats&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;&gt;} */&lt;/span&gt;
			additionalPass&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Compiler&gt;} */&lt;/span&gt;
			beforeRun&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compiler&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Compiler&gt;} */&lt;/span&gt;
			run&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compiler&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Compilation&gt;} */&lt;/span&gt;
			emit&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;string, Buffer&gt;} */&lt;/span&gt;
			assetEmitted&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {AsyncSeriesHook&amp;lt;Compilation&gt;} */&lt;/span&gt;
			afterEmit&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AsyncSeriesHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Compilation, CompilationParams&gt;} */&lt;/span&gt;
			thisCompilation&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;params&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Compilation, CompilationParams&gt;} */&lt;/span&gt;
			compilation&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;compilation&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;params&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;//...&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;2.编译/依赖图 （Compilation/Dependency Graph）&lt;/h3&gt;
&lt;p&gt;编译器接下来会创建编译对象（Compilation），&lt;code class=&quot;language-text&quot;&gt;Compilation&lt;/code&gt; 是 webpack 的核心，从编译对象开始构建依赖图，提升树并渲染成束（编译器和编译对象都继承自 Tapable 类）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// node_modules/webpack/lib/Compilation.js&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Compilation&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Tapable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;/**
	 * Creates an instance of Compilation.
	 * @param {Compiler} compiler the compiler which created the compilation
	 */&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;compiler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hooks &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Module&gt;} */&lt;/span&gt;
			buildModule&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Module&gt;} */&lt;/span&gt;
			rebuildModule&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Module, Error&gt;} */&lt;/span&gt;
			failedModule&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;error&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Module&gt;} */&lt;/span&gt;
			succeedModule&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Dependency, string&gt;} */&lt;/span&gt;
			addEntry&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;entry&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Dependency, string, Error&gt;} */&lt;/span&gt;
			failedEntry&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;entry&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;error&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncHook&amp;lt;Dependency, string, Module&gt;} */&lt;/span&gt;
			succeedEntry&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;entry&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

			&lt;span class=&quot;token comment&quot;&gt;/** @type {SyncWaterfallHook&amp;lt;DependencyReference, Dependency, Module&gt;} */&lt;/span&gt;
			dependencyReference&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SyncWaterfallHook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;dependencyReference&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;dependency&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;module&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;3.分析器（Resolver）&lt;/h3&gt;
&lt;p&gt;当把入口文件传递给 webpack 时，会分发给解析器。解析器会判断给到的相对路径是否存在，并返回绝对路径和其他如上下文、请求、调用等额外信息。如，在 &lt;code class=&quot;language-text&quot;&gt;node&lt;/code&gt; 中 require 一个声明，它会被传入模块解析器来判断是否存在。（&lt;code class=&quot;language-text&quot;&gt;ResolverFactory.js&lt;/code&gt;）&lt;/p&gt;
&lt;h3&gt;4.模块工厂（Module Factories）&lt;/h3&gt;
&lt;p&gt;工厂方法通常用来创建对象或实例。webpack 中，模块工厂用来创建模块实例。模块工厂拿到从解析器正确解析返回的路径，去该路径的文件收集源码，然后创建一个模块对象/实例（&lt;code class=&quot;language-text&quot;&gt;NormalModuleFactory.js&lt;/code&gt; &amp;#x26; &lt;code class=&quot;language-text&quot;&gt;ContextModuleFactory.js&lt;/code&gt;）。&lt;/p&gt;
&lt;h3&gt;5.解析器（Parser）&lt;/h3&gt;
&lt;p&gt;解析器是把传入的字符串源码转换成&lt;a href=&quot;https://astexplorer.net/&quot;&gt;ATS（抽象语法树）&lt;/a&gt;。webpack 解析器类使用了 &lt;code class=&quot;language-text&quot;&gt;acron&lt;/code&gt; 解析器，接收模块对象（包含源码）参数，并返回 AST 对象。webpack 遍历整棵树找到所有的 require 和 import，并生成依赖图。解析器会把依赖附在模块上。注意我们会通过 &lt;code class=&quot;language-text&quot;&gt;loaders&lt;/code&gt; 注册一些 &lt;code class=&quot;language-text&quot;&gt;rules&lt;/code&gt;，当满足规则时对应的 loader 会转换代码至 JavaScript 中，然后解析器解析这些代码到 ATS 中。&lt;/p&gt;
&lt;h3&gt;6.模板（Templates ）&lt;/h3&gt;
&lt;p&gt;模板随后会把解析过的模块对象和生成的代码进行数据绑定。生成一个包含模块的 chunk 数组。整个模块可以分为三部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;块模板（Chunk Template）&lt;/li&gt;
&lt;li&gt;模块模板（Module Template）&lt;/li&gt;
&lt;li&gt;依赖模板（Dependency Templates）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个处理过程会重复执行直到处理完所有的依赖。webpack 的核心工作是解析文件并将所有内容捆绑到一个依赖图中。这使得 webpack 可以增量编译。&lt;/p&gt;
&lt;h2&gt;小结&lt;/h2&gt;
&lt;p&gt;webpack 的出现使前端工程化迈向了新的台阶，使我们开发更便捷。webpack 提供的能力也促进了社区的发展来完善构建流程。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[神奇的模板字符串]]></title><description><![CDATA[背景 最近在个人博客中采用了styled-components库来写组件的样式，在翻看文档时，发现用法： 这个用法引起了我的兴趣，这是如何 work 起来的？ 带标签的模板字符串（Tagged Template Literals…]]></description><link>https://www.keisei.top/tagged-template-literals/</link><guid isPermaLink="false">https://www.keisei.top/tagged-template-literals/</guid><pubDate>Sun, 01 Dec 2019 08:41:00 GMT</pubDate><content:encoded>&lt;h2&gt;背景&lt;/h2&gt;
&lt;p&gt;最近在个人博客中采用了&lt;a href=&quot;https://www.styled-components.com/&quot;&gt;styled-components&lt;/a&gt;库来写组件的样式，在翻看文档时，发现用法：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; styled &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;styled-components&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Title &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; styled&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;h1&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
  color: palevioletred;
  font-size: 18px;
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;App&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Title&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;Hello World!&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Title&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个用法引起了我的兴趣，这是如何 work 起来的？&lt;/p&gt;
&lt;h2&gt;带标签的模板字符串（Tagged Template Literals）&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;styled.h1&lt;/code&gt; 符号其实是模板字符串的一种高级用法，本质上它只是调用了一个函数即 &lt;code class=&quot;language-text&quot;&gt;styled.h1``\&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;styled.h1()&lt;/code&gt; 功能是同样的。不过差异在于两种写法的传参方式。&lt;/p&gt;
&lt;p&gt;我们来看下面简单的例子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;logArgs&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;logArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; a b&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;作为标签模板字符串来调用：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; [&apos;&apos;]&lt;/span&gt;

logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like pizza&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; [&apos;I like pizza&apos;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看出，模板字符串方式会把传入的参数以数组来包一层。&lt;/p&gt;
&lt;h3&gt;插值（Interpolations）&lt;/h3&gt;
&lt;p&gt;模板字符串中可以存在插值，如：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteFood &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pizza&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;logArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteFood&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; I like pizza.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到，JavaScript 执行时会把变量插入到传入函数参数的字符串中。那在带有标签的模板字符串中使用时有什么表现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteFood &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pizza&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteFood&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; [&apos;I like &apos;, &apos;.&apos;] &apos;pizza&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们从结果中看到第一个结果还是字符串的数组，里面的元素在插值处分割而插值的内容则作为第二个参数被传递。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/feb005bb1f6d4e45610502e668f9b3c9/5e17e/logargs-explanation.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 28.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3klEQVQY042Qy27CMBBF8/9/BggsUhWqEJLGJHbs+EWS/cGli+4KiyvNYu7RmSmEEHyeTghx5CBK9rsddV0xtRK3LQmXlhgj3geC94QQ/k3RdRJrNEvqWWLHGBKDS2gf6XNu/o6yGeQdPhf8C2ix2WxprjV3WxLHA602VNrzpSbOKlENkl7XxBCfsJfAdV1IaSbYKhskUi7OMZuEhZtuWN05w6an3VsnO+d+QWZP9CrPEZeLsz3S6SvfNv3ZvQEtjBnRekApiZQtxpr8U4UdPuh6xaVtMKPOy/HluT95ADwav9orQWJ1AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;logargs explanation&quot;
        title=&quot;logargs explanation&quot;
        src=&quot;/static/feb005bb1f6d4e45610502e668f9b3c9/799d3/logargs-explanation.png&quot;
        srcset=&quot;/static/feb005bb1f6d4e45610502e668f9b3c9/00d96/logargs-explanation.png 148w,
/static/feb005bb1f6d4e45610502e668f9b3c9/0b23c/logargs-explanation.png 295w,
/static/feb005bb1f6d4e45610502e668f9b3c9/799d3/logargs-explanation.png 590w,
/static/feb005bb1f6d4e45610502e668f9b3c9/5e17e/logargs-explanation.png 658w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;纯文本的字符串都被存放在第一个参数数组内，随后为插值内容。&lt;/p&gt;
&lt;p&gt;当多于一个插值时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteFood &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pizza&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteDrink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;cola&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteFood&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; and &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteDrink&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; [&apos;I like &apos;, &apos; and &apos;, &apos;.&apos;] &apos;pizza&apos; &apos;cola&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;每个插值都成为函数调用的下一个参数，我们可以有任意多个插值参数。&lt;/p&gt;
&lt;p&gt;与正常的函数调用相比：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteFood &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pizza&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; favoriteDrink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;cola&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;logArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;I like &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteFood&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; and &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;favoriteDrink&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; I like pizza and cola.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;所有的插值都混为了一个大字符串。&lt;/p&gt;
&lt;h2&gt;优势&lt;/h2&gt;
&lt;p&gt;这种方式开启了新的探索。以 &lt;code class=&quot;language-text&quot;&gt;styled-components&lt;/code&gt; 为例，我们有一个 &lt;code class=&quot;language-text&quot;&gt;&amp;lt;Button /&amp;gt;&lt;/code&gt; 组件，当 props 传入 &lt;code class=&quot;language-text&quot;&gt;primary&lt;/code&gt; 时期望按钮看起来更大，&lt;code class=&quot;language-text&quot;&gt;&amp;lt;Button primary /&amp;gt;&lt;/code&gt;。
我们可以如下来实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Button &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; styled&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;button&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
  font-size: &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;props&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;props&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;primary &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;2em&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;1em&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;得到的结果：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// font-size: 2em;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Button primary &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// font-size: 1em;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Button &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;让我们再回过来看 &lt;code class=&quot;language-text&quot;&gt;logArgs&lt;/code&gt; 函数。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;logArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Test &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;test&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; Test () =&gt; console.log(&apos;test&apos;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里注意得到的结果为整个字符串，而没有真正的函数。&lt;/p&gt;
&lt;p&gt;当以带标签的模板字符串调用时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;logArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Test &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;test&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// [&apos;Test&apos;, &apos;&apos;] () =&gt; console.log(&apos;test&apos;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;从结果上可能看不出，但这里得到了真正的函数（而不是字符串）。&lt;/p&gt;
&lt;p&gt;这意味着我们可以得到这个函数并且执行它。我们来看一个新的可以执行函数类型参数的函数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;execFuncArgs&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  args&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;arg&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; arg &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;arg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个函数执行时会执行类型为函数的参数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;execFuncArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; undefined&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;execFuncArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;this is a function&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; this is a function&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;execFuncArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;another one&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; another one&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们再来看：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;execFuncArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Hi, &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Executed!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; undefined&lt;/span&gt;

execFuncArgs&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Hi, &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Executed!&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;Executed!&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在带标签的模板字符串中 execFuncArgs 的第二个参数传递的是实际函数，然后继续执行该函数。&lt;code class=&quot;language-text&quot;&gt;styled-components&lt;/code&gt; 底层的实现就是依赖这个特性，在渲染时传入插值函数的 props 可以帮用户来动态更新样式。&lt;/p&gt;
&lt;h2&gt;总结&lt;/h2&gt;
&lt;p&gt;可以看到，JavaScript 的一个新特性就可以实现一个强大的库，为我们的开发带来更好的体验，我们需要不断去探索去总结去实践 JavaScript 实现更多新的能力。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[The WebSocket API]]></title><description><![CDATA[引言 WebSocket API 是一种较为高级的通信方式，它在客户端和服务端开启一条全双工的通道，可以从客户端发送消息至服务端并且可以接受事件驱动的响应而不需要主动去请求回复。简而言之，收发消息的两端一旦开启通道可相互自由通信。 WebSocket…]]></description><link>https://www.keisei.top/the-websocket-api/</link><guid isPermaLink="false">https://www.keisei.top/the-websocket-api/</guid><pubDate>Tue, 26 Nov 2019 15:21:00 GMT</pubDate><content:encoded>&lt;h2&gt;引言&lt;/h2&gt;
&lt;p&gt;WebSocket API 是一种较为高级的通信方式，它在客户端和服务端开启一条全双工的通道，可以从客户端发送消息至服务端并且可以接受事件驱动的响应而不需要主动去请求回复。简而言之，收发消息的两端一旦开启通道可相互自由通信。&lt;/p&gt;
&lt;h2&gt;WebSocket 客户端&lt;/h2&gt;
&lt;p&gt;为了使用 WebSocket 协议通信，需要创建 &lt;code class=&quot;language-text&quot;&gt;WebSocket&lt;/code&gt; 对象，会自动尝试创建到服务端的连接。&lt;/p&gt;
&lt;p&gt;WebSocket 构造函数接受两个参数：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;websocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebSocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; protocols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;url&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;    指定要连接的服务器的 URL 地址，应该以 &lt;code class=&quot;language-text&quot;&gt;wss://&lt;/code&gt; 协议开头，不安全的地址以 &lt;code class=&quot;language-text&quot;&gt;ws://&lt;/code&gt; 开头。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;protocols&lt;/code&gt; (可选)&lt;/p&gt;
&lt;p&gt;    一个协议字符串或是多个协议字符串的数组。这些字符串用来指定子协议，可以让一个服务器实现多个 WebSocket 子协议（例如，可以通过不同的 &lt;code class=&quot;language-text&quot;&gt;protocol&lt;/code&gt; 来使服务器处理不同类型的交互）。如果没有指定该参数，默认为空字符串。&lt;/p&gt;
&lt;p&gt;如果地址不可访问，构造函数会抛出 &lt;code class=&quot;language-text&quot;&gt;SecurityError&lt;/code&gt;，通常会出现在连接不安全的地址（几乎所有的客户端都要求提供安全的 WebSocket 连接，除非在相同的设备上或在同一个网络下）。&lt;/p&gt;
&lt;h3&gt;建立连接&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; exampleSocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebSocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;wss://www.example.com/socketserver&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;protocolOne&apos;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 可以选择多个协议&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; exmapleSocket2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;WebSocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;wss://www.example.com/socketserver2&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;protocolOne&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&apos;protocolTwo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;exampleSocket 此时的 readyState 是 &lt;code class=&quot;language-text&quot;&gt;CONNECTING&lt;/code&gt;，一旦握手成功可以传输数据时 &lt;code class=&quot;language-text&quot;&gt;readyState&lt;/code&gt; 的状态变为 &lt;code class=&quot;language-text&quot;&gt;OPEN&lt;/code&gt; 。 &lt;code class=&quot;language-text&quot;&gt;exampleSocket.protocol&lt;/code&gt; 属性可以得出服务端选择的协议是哪一个。&lt;/p&gt;
&lt;p&gt;建立 WebSocket 连接需要依赖&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism&quot;&gt;HTTP 升级机制&lt;/a&gt;，当我们通过 &lt;code class=&quot;language-text&quot;&gt;ws://www.example.com&lt;/code&gt; 或 &lt;code class=&quot;language-text&quot;&gt;wss://www.example.com&lt;/code&gt; 访问服务端时，实际上发生了隐式的请求升级。&lt;/p&gt;
&lt;h3&gt;发送数据至服务端&lt;/h3&gt;
&lt;p&gt;一旦建立连接，便可以通过 &lt;code class=&quot;language-text&quot;&gt;send()&lt;/code&gt; 方法向服务端发送 &lt;code class=&quot;language-text&quot;&gt;string&lt;/code&gt;， &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/Blob&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Blob&lt;/code&gt;&lt;/a&gt;，&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/ArrayBuffer&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;ArrayBuffer&lt;/code&gt;&lt;/a&gt; 格式的数据。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;一段发送至服务器的消息...&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;由于建立连接是异步并且可能会失败的，所以建立连接后立即调用 &lt;code class=&quot;language-text&quot;&gt;send()&lt;/code&gt; 方法是不能保证成功的。可以通过定义 &lt;code class=&quot;language-text&quot;&gt;onopen&lt;/code&gt; 监听函数来保证连接至少在开启后再去发送数据。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;onopen&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;一段发送至服务器的消息...&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;使用 JSON 传输对象&lt;/h4&gt;
&lt;p&gt;当需要向服务端传输复杂的数据时可以用&lt;a href=&quot;https://developer.mozilla.org/en/JSON&quot;&gt;JSON&lt;/a&gt;包装为字符串：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sendText&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 构造服务端处理数据所需的对象结构&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; msg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    type&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    text&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;text&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    id&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; clientID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    date&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Date&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 发送JSON字符串&lt;/span&gt;
  exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stringify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;msg&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;从服务端接收消息&lt;/h3&gt;
&lt;p&gt;WebSocket 是事件驱动的 API，当接收到消息，一个 &lt;code class=&quot;language-text&quot;&gt;message&lt;/code&gt; 事件会发送至 &lt;code class=&quot;language-text&quot;&gt;WebSocket&lt;/code&gt; 对象。可通过监听 &lt;code class=&quot;language-text&quot;&gt;message&lt;/code&gt; 事件或者定义 &lt;code class=&quot;language-text&quot;&gt;onmessage&lt;/code&gt; 事件句柄。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;onmessage&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;接收并解析数据&lt;/h4&gt;
&lt;p&gt;以聊天工具来说，客户端需要接收的数据包类型有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;登录握手&lt;/li&gt;
&lt;li&gt;消息文本&lt;/li&gt;
&lt;li&gt;用户列表更新&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以下为解析即将到来的数据：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;onmessage&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; f &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;chatbox&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contentDocument&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; msg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; time &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;date&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; timeStr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toLocaleTimeString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;id&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      clientID &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;setUsername&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;username&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;b&gt;User &amp;lt;em&gt;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;/em&gt; signed in at &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        timeStr &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;/b&gt;&amp;lt;br&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;(&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; timeStr &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;) &amp;lt;b&gt;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;/b&gt;: &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;br&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;rejectusername&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;b&gt;Your username has been set to &amp;lt;em&gt;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;/em&gt; because the name you chose is in use.&amp;lt;/b&gt;&amp;lt;br&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;userlist&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; ul &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;users&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        ul &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; msg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;users&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&amp;lt;br&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;userlistbox&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;innerHTML &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ul&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;chatbox&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contentWindow&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;scrollByPages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里我们通过 &lt;code class=&quot;language-text&quot;&gt;JSON.parse()&lt;/code&gt; 来将字符串数据解析为对象格式，并执行对应逻辑。&lt;/p&gt;
&lt;h4&gt;文本格式&lt;/h4&gt;
&lt;p&gt;通过 WebSocket 接收的文本为 UTF-8 格式。&lt;/p&gt;
&lt;h3&gt;关闭连接&lt;/h3&gt;
&lt;p&gt;当完成通信断开连接时通过调用 &lt;code class=&quot;language-text&quot;&gt;close()&lt;/code&gt; 方法来实现：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;exampleSocket&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在关闭连接时最好检查 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/bufferedAmount&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;bufferedAmount&lt;/code&gt;&lt;/a&gt; 在网路中是否还有未传输的数据。如果值不为 0，说明还有数据待处理，所以需要处理完成再关闭。&lt;/p&gt;
&lt;h3&gt;安全事项&lt;/h3&gt;
&lt;p&gt;WebSocket 不应该在混合环境中使用。即不能在 HTTPS 中建立不安全的 WebSocket，反之亦然。
现在大多数浏览器厂商只允许安全的 WebSocket 连接，不再支持在不安全的环境下使用。&lt;/p&gt;
&lt;h2&gt;WebSocket 服务端&lt;/h2&gt;
&lt;p&gt;简单来说一个 WebSocket 服务器是监听任何 TCP 服务器端口的应用程序。实现一个自定义的服务器听起来让人畏却，但实际上实现一个简单的 WebSocket 是非常容易的。&lt;/p&gt;
&lt;p&gt;可以使用任何支持&lt;a href=&quot;https://en.wikipedia.org/wiki/Berkeley_sockets&quot;&gt;Berkeley sockets&lt;/a&gt;的服务端语言来编写一个 WebSocket 服务器，例如 C(++)，Python，PHP，或者&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Server-Side_JavaScript&quot;&gt;服务端 JavaScript&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;WebSocket 服务器通常是独立的专门的服务器（为了负载均衡或其他实际的原因），所以需要使用&lt;a href=&quot;https://en.wikipedia.org/wiki/Reverse_proxy&quot;&gt;反向代理&lt;/a&gt;来检测 WebSocket 握手，预处理，并将客户端发送至真正的 WebSocket 服务器。这意味着不需要在服务器程序中处理 cookie 和鉴权等操作。&lt;/p&gt;
&lt;h3&gt;WebSocket 握手&lt;/h3&gt;
&lt;p&gt;首先，服务器必须使用一个标准的 TCP 套接字来监听即将到来的 socket 连接。在 WebSocket 中握手就是 &lt;code class=&quot;language-text&quot;&gt;Web&lt;/code&gt; 。它是从 HTTP 到 WebSockets 的桥梁。在握手过程中，连接协商过程中，如果条款是有问题的，任何一方都可以在连接成功之前退出。服务器必须小心理解任何客户端的请求，否则就会出现安全问题。&lt;/p&gt;
&lt;h4&gt;客户端握手请求&lt;/h4&gt;
&lt;p&gt;客户端握手过程通过连接服务器并且发送一个 WebSocket 连接请求。&lt;code class=&quot;language-text&quot;&gt;client&lt;/code&gt; 会发送一个标准的带有头部的 HTTP 请求（HTTP 版本必须 1.1 或更高，方法必须是 &lt;code class=&quot;language-text&quot;&gt;GET&lt;/code&gt; 请求）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;GET /chat HTTP/1.1
Host: example.com:8000
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;客户端可以征求扩展或子协议。一些其他常见的头信息&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent&quot;&gt;User-Agent&lt;/a&gt;，&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer&quot;&gt;Referer&lt;/a&gt;，&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cookie&quot;&gt;Cookie&lt;/a&gt; 或权限校验等也需要发送。它们并非与 WebSocket 直接关联，并且可以安全地忽略。通常来说反向代理会首先处理这些头信息。&lt;/p&gt;
&lt;p&gt;如果 header 中有任一信息有误，服务器会发出 &lt;code class=&quot;language-text&quot;&gt;400&lt;/code&gt; 的状态码并立即关闭 socket。&lt;/p&gt;
&lt;h4&gt;服务器握手响应&lt;/h4&gt;
&lt;p&gt;当服务器收到握手请求，会返回一个特殊的响应来指明协议会从 HTTP 变更为 WebSocket。头信息大致如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;此外，服务器可以决定扩展/子协议的请求。&lt;code class=&quot;language-text&quot;&gt;Sec-WebSocket-Accept&lt;/code&gt; 是根据从客户端的 &lt;code class=&quot;language-text&quot;&gt;Sec-WebSocket-Key&lt;/code&gt; 来生成的。具体规则为将 &lt;code class=&quot;language-text&quot;&gt;Sec-WebSocket-Key&lt;/code&gt; 和&lt;a href=&quot;https://en.wikipedia.org/wiki/Magic_string&quot;&gt;魔法字符串&lt;/a&gt; &lt;code class=&quot;language-text&quot;&gt;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&lt;/code&gt; 拼接至一起，然后执行 &lt;a href=&quot;https://en.wikipedia.org/wiki/SHA-1&quot;&gt;SHA-1 hash&lt;/a&gt;，最后返回该哈希 &lt;a href=&quot;https://en.wikipedia.org/wiki/Base64&quot;&gt;base64&lt;/a&gt;的编码格式。&lt;/p&gt;
&lt;p&gt;一旦服务端发送这些头信息，说明握手已经成功，可以交换数据。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;在发送握手的响应之前服务器可以发送其他头信息，或要求鉴权，或者通过其他状态码重定向到其他服务器。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;保持客户端连接&lt;/h4&gt;
&lt;p&gt;这并不直接与 WebSocket 协议关联，但值得提出：服务器需要保持客户端 socket 的连接，这样就不需要在完成握手后再次握手。&lt;/p&gt;
&lt;h3&gt;交换数据帧&lt;/h3&gt;
&lt;p&gt;服务端和客户端任一者可以选择在任何时候发送消息。&lt;/p&gt;
&lt;h4&gt;格式化&lt;/h4&gt;
&lt;p&gt;每个数据帧都需要遵循如下格式：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Frame format:
​​
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-------+-+-------------+-------------------------------+
    |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
    |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
    |N|V|V|V|       |S|             |   (if payload len==126/127)   |
    | |1|2|3|       |K|             |                               |
    +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
    |     Extended payload length continuedundefined if payload len == 127  |
    + - - - - - - - - - - - - - - - +-------------------------------+
    |                               |Masking-keyundefined if MASK set to 1  |
    +-------------------------------+-------------------------------+
    | Masking-key (continued)       |          Payload Data         |
    +-------------------------------- - - - - - - - - - - - - - - - +
    :                     Payload Data continued ...                :
    + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
    |                     Payload Data continued ...                |
    +---------------------------------------------------------------+&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;MASK 位表明了信息是否是编码的。信息从客户端发出时必须是加密的，服务端期望收到的值为 1，而服务端发送的数据不会加密，也不会设置 MASK 位。&lt;/p&gt;
&lt;p&gt;opcode 字段定义了如何解析数据载荷：0x0 表示继续，0x1 表示 UTF-8 格式的文本，0x2 表示二进制等。&lt;/p&gt;
&lt;p&gt;FIN 位表明是否是该数据流的最后一条信息。如果为 0，服务器会保持收听信息的其他部分，如果为 1 则认为信息已送达。&lt;/p&gt;
&lt;h4&gt;解码载荷长度&lt;/h4&gt;
&lt;p&gt;为了读取载荷数据需要知道何时停止读取，所以知道载荷长度非常重要：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;读取 9-15 位并解析为无符号整数。如果小于等于 125，那么该值就是数据长度。如果等于 126，执行第二步。如果等于 127，执行第三步。&lt;/li&gt;
&lt;li&gt;读取接下来的 16 位并解析为无符号整数，完成。&lt;/li&gt;
&lt;li&gt;读取接下来 64 位解析为无符号整数（最高位必须位 0），完成。&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;读取并解密数据&lt;/h4&gt;
&lt;p&gt;如果设置了 MASK 位，需要读后面 4 组 8 位，这是编码的 key。一旦载荷长度和编码 key 解析完成，可以继续从 socket 中读取该长度的字节数。为了解码，循环遍历加密数据的八位字节（文本数据的字节），然后将八位字节与 MASK 的第（i 模 4）个八位字节进行 XOR 运算。伪代码如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;DECODED&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ENCODED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;DECODED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ENCODED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;MASK&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;消息片段&lt;/h4&gt;
&lt;p&gt;FIN 和 opcode 字段在一起将发送的一条信息拆分为多个单独的帧。被称为&lt;code class=&quot;language-text&quot;&gt;message fragmentation&lt;/code&gt;。碎片化（Fragmentation）只在 opcode 的 &lt;code class=&quot;language-text&quot;&gt;0x0&lt;/code&gt; 至 &lt;code class=&quot;language-text&quot;&gt;0x2&lt;/code&gt; 有效。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;0x0：代表一个连续帧，意味着需要把该帧的数据载荷和上一帧的载荷连接在一起&lt;/li&gt;
&lt;li&gt;0x1：代表载荷为文本格式&lt;/li&gt;
&lt;li&gt;0x2：代表载荷为二进制格式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下面是一个简单的例子来说明服务端是如何响应客户端信息的：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Client: FIN=1undefined opcode=0x1undefined msg=&amp;quot;hello&amp;quot;
Server: (process complete message immediately) Hi.
Client: FIN=0undefined opcode=0x1undefined msg=&amp;quot;and a&amp;quot;
Server: (listeningundefined new message containing text started)
Client: FIN=0undefined opcode=0x0undefined msg=&amp;quot;happy new&amp;quot;
Server: (listeningundefined payload concatenated to previous message)
Client: FIN=1undefined opcode=0x0undefined msg=&amp;quot;year!&amp;quot;
Server: (process complete message) Happy new year to you too!&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;第一帧包含了全部的消息，所以服务端可以处理并响应。第二帧客户端发送了文本载荷但整个信息并没有完全送达，其他剩余部分通过连接帧来发送，通过标记&lt;code class=&quot;language-text&quot;&gt;FIN=1&lt;/code&gt;指明了最后一帧。&lt;/p&gt;
&lt;h3&gt;Pings and Pongs: WebSocket 心跳检测&lt;/h3&gt;
&lt;p&gt;在握手完成后，客户端或服务端都可以选择发送一个 ping 至对方，当 ping 收到时，接收方必须尽快发送一个 pong 给对方。可以通过这个机制来确认对方是否仍在连接。&lt;/p&gt;
&lt;p&gt;一个 ping 或 pong 只是一个普通的控制帧，Pings 的 opcode 为 &lt;code class=&quot;language-text&quot;&gt;0x9&lt;/code&gt; ，pongs 的 opcode 为 &lt;code class=&quot;language-text&quot;&gt;0xA&lt;/code&gt;。当收到一个 ping，发送 pong 时携带 ping 发送的一致的数据载荷（最大载荷长度为 125）。&lt;/p&gt;
&lt;h3&gt;关闭连接&lt;/h3&gt;
&lt;p&gt;客户端或服务端关闭连接可以发送一个带有包含一个特殊控制序列数据的控制帧来开启关闭握手。接收到此帧后，另一方会发送一个结束帧作为响应。先前的一方会关闭连接。关闭连接后收到的任何其他数据都会被丢掉。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[React Fiber 架构]]></title><description><![CDATA[介绍 React Fiber 是当前开发中的最新版 React…]]></description><link>https://www.keisei.top/react-fiber-architecture/</link><guid isPermaLink="false">https://www.keisei.top/react-fiber-architecture/</guid><pubDate>Fri, 22 Nov 2019 15:08:00 GMT</pubDate><content:encoded>&lt;h2&gt;介绍&lt;/h2&gt;
&lt;hr&gt;
&lt;p&gt;React Fiber 是当前开发中的最新版 React 的核心算法的实现。它的主要目标是提高动画、布局、手势等操作的响应速度。最大的功能就是增强渲染：有能力将渲染工作分割成多块，并将它们分散到多个帧中去渲染。&lt;/p&gt;
&lt;p&gt;其他关键功能包括有能力暂停、渲染，有新的更新时可以重复使用；有能力对不同的更新增加优先级；新的并发模式。&lt;/p&gt;
&lt;h3&gt;前置条件&lt;/h3&gt;
&lt;p&gt;在继续本文之前建议首先了解如下内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://facebook.github.io/react/blog/2015/12/18/react-components-elements-and-instances.html&quot;&gt;React Components, Elements, and Instances&lt;/a&gt; 掌握 React 中的一些基本术语&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://facebook.github.io/react/docs/reconciliation.html&quot;&gt;Reconciliation&lt;/a&gt; 对 React 和解算法的概括性描述&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/reactjs/react-basic&quot;&gt;React Basic Theoretical Concepts&lt;/a&gt; React 基本的理论性的概念描述。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://facebook.github.io/react/contributing/design-principles.html&quot;&gt;React Design Principles&lt;/a&gt; React 的设计准则很好的解释了 React Fiber 的出现。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;回顾&lt;/h2&gt;
&lt;hr&gt;
&lt;p&gt;在我们继续深入以前先来回顾一些新的概念。&lt;/p&gt;
&lt;h3&gt;什么是和解（Reconciliation）&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;reconciliation&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;    这是 React 用来对两棵树 diff 来决定要更新哪部分的算法。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;update&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;    React 应用中渲染数据的一次变化，通常是由 &lt;code class=&quot;language-text&quot;&gt;setState&lt;/code&gt; 触发的。最终结果是触发一次重新渲染。&lt;/p&gt;
&lt;p&gt;React API 的中心思想是如何更新，因为这会造成整个 APP 的重新渲染。这允许开发者可以声明式的推理，而不需要关心怎样有效地将 APP 从任何特定状态转换为另一种状态（A 到 B，B 到 C，C 到 A，以此类推）。&lt;/p&gt;
&lt;p&gt;实际上每次数据变化都要重新渲染整个应用只适用于最琐碎的一些应用。在现实世界中，就性能而言开销是非常巨大的。React 的优化做到了即便重新渲染整个应用依然能保证很高的性能。优化过程的大部分工作被称作 &lt;strong&gt;reconciliation&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;Reconciliation 是已经被人熟知的虚拟 DOM 背后的算法。从一个高度概括的角度来说：当你渲染一个 React 应用时，树上描述这个应用的所有节点被生成并保存在内存中，这棵树被刷新至渲染环境，如果是浏览器应用，则会转化成 DOM 节点的集合。当应用更新时（通常通过 &lt;code class=&quot;language-text&quot;&gt;setState&lt;/code&gt; ），一颗新树产生了，通过与之前的树进行比较计算出已渲染的应用哪部分需要更新。&lt;/p&gt;
&lt;p&gt;更加详细的描述可以在&lt;a href=&quot;https://facebook.github.io/react/docs/reconciliation.html&quot;&gt;文档&lt;/a&gt;中找到。关键点如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不同组件类型被认为是生成了不同的树。React 不会去 diff，而是直接将这部分旧节点替换掉。&lt;/li&gt;
&lt;li&gt;列表是通过 keys 来做 diff 的。Keys 应该是稳定的，可预见的，唯一的。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;和解与渲染&lt;/h3&gt;
&lt;p&gt;DOM 只是 React 能渲染的一种渲染环境。其他主要的原生系统 IOS 和 Android 也可以通过 React Native 来进行渲染。&lt;/p&gt;
&lt;p&gt;React 能支持多环境渲染的原因是，它被设计为和解和渲染过程分离。和解器计算树的哪部分被改变了，渲染器再根据得到的信息去真正渲染应用。&lt;/p&gt;
&lt;p&gt;分离意味着 React DOM 和 React Native 有各自的渲染器但是可以共享 React 核心提供的和解器。&lt;/p&gt;
&lt;p&gt;Fiber 重新实现了和解器，它原则上不关心渲染， 但渲染器仍然需要做出改变来支持并利用新的架构。&lt;/p&gt;
&lt;h3&gt;调度&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;scheduling&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;    决定何时执行工作的过程&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;work&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;    任何计算都应该被执行。&lt;code class=&quot;language-text&quot;&gt;Work&lt;/code&gt; 通常是一次更新的结果（通过 &lt;code class=&quot;language-text&quot;&gt;setState&lt;/code&gt; ）。&lt;/p&gt;
&lt;p&gt;React 的&lt;a href=&quot;https://facebook.github.io/react/contributing/design-principles.html#scheduling&quot;&gt;设计原则 &lt;/a&gt;中很好的描述了这部分主题：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;当前 React 的实现中，在一个时钟周期内 React 会遍历这棵更新过的树并且调用渲染函数渲染。在将来它会延迟某部分更新来保证不会掉帧。&lt;/p&gt;
&lt;p&gt;这在 React 设计中是一个常见的思想。一些流行的库的采用了 push 的方式，当有数据更新时，计算函数会执行。React 坚持 pull 的方式，计算函数除非必须否则可以延迟执行。&lt;/p&gt;
&lt;p&gt;React 不是一个通用的数据处理库。它是负责构建用户界面的。它处在应用中一块独立的位置来获取哪些计算是需要立即执行的，哪些是不必要的。&lt;/p&gt;
&lt;p&gt;如果一些内容用户是看不到的，React 可以延迟执行这部分任何的逻辑。如果数据更新的频率高于帧率，可以合并这些改变并批量更新。我们能对用户交互的部分工作（如按钮按下触发的动画）增加高优先级，对一些不重要的后台工作（如呈现刚从网络加载的新内容）延后执行来避免掉帧的现象。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;关键点在于：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在用户界面，每次数据更新没有必要立即渲染。实际上，这样会浪费性能造成丢帧降低用户的体验。&lt;/li&gt;
&lt;li&gt;不同的更新类型有不同的优先级—动画的更新需要比数据中心更新更快。&lt;/li&gt;
&lt;li&gt;基于 push 的方式需要开发者来决定如何调度工作。基于 pull 的方式允许库（React）更加智能的帮我们做出决定。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;React 目前还没有充分利用调度的优势，子树上数据的一次更新还是会立即渲染。彻底修改 React 核心算法以利用调用是 Fiber 背后的驱动思想。&lt;/p&gt;
&lt;h2&gt;什么是 Fiber&lt;/h2&gt;
&lt;hr&gt;
&lt;p&gt;我们现在来讨论 React Fiber 架构的核心。Fibers 是一个非常底层的抽象描述。&lt;/p&gt;
&lt;p&gt;我们已经建立了 Fiber 为 React 提供调度能力的主要目标，需要实现以下的能力：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;暂停工作并在一段时间后恢复&lt;/li&gt;
&lt;li&gt;对不同类型的工作提供优先级&lt;/li&gt;
&lt;li&gt;再利用先前已经完成的工作&lt;/li&gt;
&lt;li&gt;如果不需要则可以停止工作&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为了实现以上目标，我们首先需要找到一种方式将工作切分成多个单位。一个 fiber 就代表了一个工作单元。&lt;/p&gt;
&lt;p&gt;为了更近一步，我们回到之前的概念 &lt;a href=&quot;https://github.com/reactjs/react-basic#transformation&quot;&gt;React 组件就是 data 的函数映射&lt;/a&gt;，通常可以表示为：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;d&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;渲染一个 React 应用本质上就是调用一个函数，这个函数体中包含了调用其他的函数，以此类推。这种类比在思考 fiber 时非常有用。&lt;/p&gt;
&lt;p&gt;计算机追踪一个程序的执行通常的方式是采用&lt;a href=&quot;https://en.wikipedia.org/wiki/Call_stack&quot;&gt;调用栈&lt;/a&gt;。当一个函数被执行，一个新的栈帧被加入该栈。这个栈帧代表函数执行的位置。&lt;/p&gt;
&lt;p&gt;当处理 UI 时，一个问题是如果一次执行太多的函数会导致动画的丢帧，看起来断断续续。而且，如果有新的变动取代旧的，那么之前的工作实际上不是必须的。这就是 UI 组件和函数之间比较不同的地方，UI 组件有着比函数更多需要特殊关注的地方。&lt;/p&gt;
&lt;p&gt;最近新的浏览器（和 React Native）实现了帮助解决这个问题的 APIs：&lt;code class=&quot;language-text&quot;&gt;requestIdleCallback&lt;/code&gt; 安排一个在程序空闲期被调用的低优先级函数，&lt;code class=&quot;language-text&quot;&gt;requestAnimationFrame&lt;/code&gt; 安排一个在下个动画帧中被调用的高优先级函数。问题在于，为了使用这些 APIs，我们需要将渲染工作切分成多个单元。如果只依靠调用栈，它会一直运行知道栈为空。&lt;/p&gt;
&lt;p&gt;有没有办法来定制调用栈的行为来优化渲染 UIs？有没有办法能够中断调用并且手动操作栈帧呢？&lt;/p&gt;
&lt;p&gt;这就是 React Fiber 的目的，Fiber 为 React 组件重新实现了栈。可以认为一个 fiber 就是一个&lt;strong&gt;虚拟的栈帧&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;重新实现栈的好处是能在&lt;a href=&quot;https://www.facebook.com/groups/2003630259862046/permalink/2054053404819731/&quot;&gt;内存中保存栈帧&lt;/a&gt;，并且可以随时以任何方式去执行。这是实现调度至关重要的。&lt;/p&gt;
&lt;p&gt;除了调度之外，手动处理栈帧还可以实现并发和错误边界等功能。&lt;/p&gt;
&lt;h3&gt;Fiber 的结构&lt;/h3&gt;
&lt;p&gt;具体来说，一个 fiber 是一个包含组件信息，它的输入、输出的 JavaScript 对象。&lt;/p&gt;
&lt;p&gt;一个 fiber 对应一个栈帧，也对应一个组件的实例。&lt;/p&gt;
&lt;p&gt;这里有一些 fiber 比较重要的字段（非完整的列表）：&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;type&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;key&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;fiber 的 type 和 key 对 React 元素起着同样的作用（实际上，fiber 从一个元素创建时，这两个属性直接被复制过来）。&lt;/p&gt;
&lt;p&gt;fiber 的 type 描述了它对应的组件。对于合成组件，type 是一个函数或者类组件本身。对于原生元素（&lt;code class=&quot;language-text&quot;&gt;div&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;span&lt;/code&gt; 等），type 是一个字符串。&lt;/p&gt;
&lt;p&gt;从概念上来说，type 是在执行时被栈帧追踪的函数（如在 &lt;code class=&quot;language-text&quot;&gt;v = f(d)&lt;/code&gt; 中）。&lt;/p&gt;
&lt;p&gt;与 type 一起的 key，被用来在和解过程中决定 fiber 是否可以再利用。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;child&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;sibling&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;这两个字段指向其他的 fibers，描述一个 fiber 的递归树结构。&lt;/p&gt;
&lt;p&gt;child 字段对应组件 &lt;code class=&quot;language-text&quot;&gt;render&lt;/code&gt; 方法的返回值。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Child &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Parent&lt;/code&gt; 的子 fiber 对应着 &lt;code class=&quot;language-text&quot;&gt;Child&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;sibling 字段对应 &lt;code class=&quot;language-text&quot;&gt;render&lt;/code&gt; 返回多个孩子节点（Fiber 的新特性！）的情况：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Child1 &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Child2 &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;child fibers 组成了一个单链表，head 指针指向第一个孩子节点。所以在上例中， &lt;code class=&quot;language-text&quot;&gt;Parent&lt;/code&gt; 的孩子节点是 &lt;code class=&quot;language-text&quot;&gt;Child1&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;Child1&lt;/code&gt; 的兄弟节点是 &lt;code class=&quot;language-text&quot;&gt;Child2&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;回到我们的函数类比，可以认为一个孩子 fiber 是一个尾调用函数。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;return&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;return fiber 是当前 fiber 处理完成后需要返回的 fiber。从概念上来说它对应栈帧返回的地址。也可以理解为父 fiber。&lt;/p&gt;
&lt;p&gt;如果一个 fiber 有多个子 fiber，每个子 fiber 返回的 fiber 都是它的父 fiber。在前一个例子中，&lt;code class=&quot;language-text&quot;&gt;Child1&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;Child2&lt;/code&gt; 的 return fiber 是 &lt;code class=&quot;language-text&quot;&gt;Parent&lt;/code&gt;。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;pendingProps&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;memoizedProps&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;从概念上来说，props 是一个函数的参数。一个 fiber 的 &lt;code class=&quot;language-text&quot;&gt;pendingProps&lt;/code&gt; 是开始执行时被赋值，&lt;code class=&quot;language-text&quot;&gt;memoizedProps&lt;/code&gt; 是结束时被赋值。&lt;/p&gt;
&lt;p&gt;当即将到来的 &lt;code class=&quot;language-text&quot;&gt;pendingProps&lt;/code&gt; 和当前 &lt;code class=&quot;language-text&quot;&gt;memoizedProps&lt;/code&gt; 一致时，表明了 fiber 的前一次输出可以被重新使用，省去了不必要的工作。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;pendingWorkPriority&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;一个数字标识 fiber 工作的优先级。&lt;a href=&quot;https://github.com/facebook/react/blob/master/packages/react-reconciler/src/SchedulerWithReactIntegration.js&quot;&gt;ReactPriorityLevel&lt;/a&gt;模块中列出来不同的优先级和所对应的含义。&lt;/p&gt;
&lt;p&gt;除了一个特殊的例外 &lt;code class=&quot;language-text&quot;&gt;NoWork = 0&lt;/code&gt;，越大的数字代表了越低的优先级。例如，可以通过如下函数来验证一个 fiber 的优先级是否比给到的优先级相等或更高：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;matchesPriority&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;fiber&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; priority&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    fiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pendingWorkPriority &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; fiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pendingWorkPriority &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; priority
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;这个函数只是用来说明，并不是真正的 React Fiber 代码的一部分。&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;调度器使用优先级字段寻找下一个工作的单元，算法部分会在 future 部分讨论。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;alternate&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;flush&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;    刷新一个 fiber 就是渲染它的输出至屏幕。&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;work-in-progress&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;    一个 fiber 还未完成，即相对应的一个栈帧还没有被返回。&lt;/p&gt;
&lt;p&gt;在任何时候，一个组件实例至多有两个 fibers 与之对应：当前 fiber，刷新过的 fiber 和工作中的 fiber。&lt;/p&gt;
&lt;p&gt;当前 fiber 的交替是工作中的 fiber，反之亦然。&lt;/p&gt;
&lt;p&gt;一个 fiber 的交替是通过调用 &lt;code class=&quot;language-text&quot;&gt;cloneFiber&lt;/code&gt; 惰性创建的。并非总是会创建新的对象，&lt;code class=&quot;language-text&quot;&gt;cloneFiber&lt;/code&gt; 会尝试再利用存在的 fiber 的交替，减少内存占用。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;output&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;host component&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;    一个 React 应用的叶子节点。它们是渲染环境特有的（即在浏览器中，它们是 &lt;code class=&quot;language-text&quot;&gt;div&lt;/code&gt;，&lt;code class=&quot;language-text&quot;&gt;span&lt;/code&gt; 等）。在 JSX 中，它们使用小写标签名表示。&lt;/p&gt;
&lt;p&gt;从概念上来说，fiber 的输出就是一个函数的返回值。&lt;/p&gt;
&lt;p&gt;每个 fiber 最终都会有输出，但是输出只由宿主组件在叶子节点创建。输出随后在树上被传递。&lt;/p&gt;
&lt;p&gt;输出最终都会传送至渲染器，所以能够刷新这些变化至渲染环境。定义如何创建和更新输出内容是渲染器的责任。&lt;/p&gt;
&lt;h2&gt;未来&lt;/h2&gt;
&lt;p&gt;以上就是目前的全部内容，但这篇文章还远远不够。未来还将讨论一次更新在生命周期中采用的算法。话题包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调度器是如何找到下一个工作单元去执行的&lt;/li&gt;
&lt;li&gt;优先级是如何追踪的，又如何在 fiber 树中传播的&lt;/li&gt;
&lt;li&gt;调度器是怎样知道何时停止和恢复工作的&lt;/li&gt;
&lt;li&gt;刷新（flush）是如何工作的和如何标记为完成的&lt;/li&gt;
&lt;li&gt;副作用是如何工作的（例如生命周期函数）&lt;/li&gt;
&lt;li&gt;协程是什么，如何用来实现 context 和 layout 的&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/acdlite/react-fiber-architecture/&quot;&gt;https://github.com/acdlite/react-fiber-architecture/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JavaScript 引擎基础：Shapes 和 Inline Caches]]></title><description><![CDATA[JavaScript 引擎管道 当加载到我们所写的 JavaScript 代码，JavaScript 引擎开始解析源代码，并把它转换成抽象语法树（AST）。基于 AST，解释器开始工作并转换成字节码。此时引擎开始真正执行我们的 JavaScript 代码。 js engine…]]></description><link>https://www.keisei.top/V8-shapes-and-inline-cache/</link><guid isPermaLink="false">https://www.keisei.top/V8-shapes-and-inline-cache/</guid><pubDate>Mon, 18 Nov 2019 14:51:00 GMT</pubDate><content:encoded>&lt;h2&gt;JavaScript 引擎管道&lt;/h2&gt;
&lt;p&gt;当加载到我们所写的 JavaScript 代码，JavaScript 引擎开始解析源代码，并把它转换成抽象语法树（AST）。基于 AST，解释器开始工作并转换成字节码。此时引擎开始真正执行我们的 JavaScript 代码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/55263e94b3250c77560ffe9770630a34/js-engine-pipeline.svg&quot; alt=&quot;js engine pipeline&quot;&gt;&lt;/p&gt;
&lt;p&gt;为了让代码运行得更快，字节码可以与分析数据一起发送到优化编译器，基于分析到的数据做出一些假设，然后编译出高度优化的机器码。&lt;/p&gt;
&lt;p&gt;如果在某个节点的假设出错，优化编译器会造成负优化，并回退到解释器。&lt;/p&gt;
&lt;h3&gt;解释器/编译器 在 JavaScript 引擎中的管道&lt;/h3&gt;
&lt;p&gt;我们来放大管道流中真正执行 JavaScript 代码的部分，即代码被解释和优化，并解决主要引擎中存在的差异的地方。简单来讲，这里管道流包含解释器和优化编译器。解释器快速将源码生成未优化的字节码，优化编译器花更多一点的时间生成高度优化的机器码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/986a5bf438f0396c4d357fbe6823bfaa/interpreter-optimizing-compiler.svg&quot; alt=&quot;interpreter optimizing compiler&quot;&gt;&lt;/p&gt;
&lt;p&gt;这种通用的管道流 V8 在 Chrome 和 Node.js 中是如何工作的：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/8a9c248062e5984da280e1e128baf314/interpreter-optimizing-compiler-v8.svg&quot; alt=&quot;interpreter optimizing compiler v8&quot;&gt;&lt;/p&gt;
&lt;p&gt;解释器在 V8 中被称作点火器，它的作用是生成和执行字节码。当开始执行字节码时，它会收集分析的数据，用来加速未来的执行速度。当一个函数经常被执行，就会变成一个热函数，这部分字节码和分析的数据会被传递给涡轮风扇—我们的优化编译器，基于分析的数据来生成高度优化的机器码。&lt;/p&gt;
&lt;h2&gt;JavaScript 对象模型&lt;/h2&gt;
&lt;p&gt;让我们来看一下 JavaScript 引擎共性的方面是如何实现的。例如，JavaScript 对象模型是如何实现的，有哪些方式来加快属性的访问。&lt;/p&gt;
&lt;p&gt;ECMAScript 规范定义了所有对象都是字典，&lt;a href=&quot;https://tc39.es/ecma262/#sec-property-attributes&quot;&gt;属性的键值&lt;/a&gt;都是字符串类型。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2ad718f2149bab498cd22aa53c67ac6f/object-model.svg&quot; alt=&quot;object model&quot;&gt;&lt;/p&gt;
&lt;p&gt;除了 &lt;code class=&quot;language-text&quot;&gt;[[Value]]&lt;/code&gt; 以外，规范还定义了如下属性：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;[[Writable]]&lt;/code&gt; 决定了属性可以重新赋值，&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;[[Enumerable]]&lt;/code&gt; 决定了属性可以通过 &lt;code class=&quot;language-text&quot;&gt;for-in&lt;/code&gt; 枚举，&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;[[Configurable]]&lt;/code&gt; 决定了属性可以被删除。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;双方括号看起来新颖，这是规范用来表示属性的并且不直接暴露给 JavaScript。可以通过 &lt;code class=&quot;language-text&quot;&gt;Object.getOwnPropertyDescriptor&lt;/code&gt; API 来获取对象的属性描述符。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; foo&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getOwnPropertyDescriptor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; { value: 42, writable: true, enumerable: true, configurable: true }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;数组又是如何定义的呢？可以把数组理解为一种特殊的对象。其中一个不同点是数组对索引有特殊的处理逻辑。数组索引在 ECMAScript 规范中是特殊术语。数组在 JavaScript 中允许最多 2³²−1 个元素。数组索引是在 0 至 2³²−2 的任意有效的整数。&lt;/p&gt;
&lt;p&gt;另一个不同点是数组有一个魔法的&lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt;属性。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; array &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// -&gt; 2&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;c&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// -&gt; 3&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在这个例子中数组创建时 &lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 为 &lt;code class=&quot;language-text&quot;&gt;2&lt;/code&gt;，当我们给索引 &lt;code class=&quot;language-text&quot;&gt;2&lt;/code&gt; 赋值时，&lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 属性自动更新了。&lt;/p&gt;
&lt;p&gt;JavaScript 定义数组和定义对象相似，所有键值包括索引值都是明确的字符串类型。数组的第一个元素存在键 &lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; 的下面。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/6d34cbceadebfc3ccb045d3eb16eba87/array-1.svg&quot; alt=&quot;array 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 只是另一个不可枚举不可删除的属性而已。&lt;/p&gt;
&lt;p&gt;一旦一个元素加入数组，JavaScript 会自动更新 &lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 属性的 &lt;code class=&quot;language-text&quot;&gt;[[Value]]&lt;/code&gt; 值。&lt;/p&gt;
&lt;p&gt;一般来说，数组的行为与对象非常相似。&lt;/p&gt;
&lt;h2&gt;优化属性访问&lt;/h2&gt;
&lt;p&gt;现在让我们来看一下引擎如何让对象工作的高效。&lt;/p&gt;
&lt;p&gt;在 JavaScript 程序中，访问对象属性是最常见的操作。对于引擎来说让属性更快访问至关重要。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  foo&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;bar&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  baz&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;qux&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 这里我们访问 object 的 foo 属性。&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;foo&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Shapes&lt;/h3&gt;
&lt;p&gt;在 JavaScript 程序中，多个对象拥有相同的属性是非常常见的。这样的对象有相同的形状（shape）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// object1 和 object2 有同样的 shape&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对同样 shape 的对象访问同一属性也是很常见的。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;logX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;logX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;logX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;考虑到这一点，JavaScript 引擎可以基于对象的 shape 来优化对象属性的访问速度。&lt;/p&gt;
&lt;p&gt;假设一个对象上有属性 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; ，它用之前讨论过的字典数据结构表示：包含了字符串的 key，这些 key 的指针指向对应的元属性。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2ad718f2149bab498cd22aa53c67ac6f/object-model-1.svg&quot; alt=&quot;object model&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果访问 &lt;code class=&quot;language-text&quot;&gt;object.y&lt;/code&gt; ，引擎会在 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 中寻找键 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; ，然后加载对应的属性元数据，最后返回 &lt;code class=&quot;language-text&quot;&gt;[[Value]]&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;属性元数据在内存中是怎么存储的呢？我们应该把它们作为 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 的一部分存储呢？如果我们在将来会有更多的同 shape 的对象，那么作为 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 的一部分保存全部的字典数据是浪费的。作为优化，引擎会单独保存对象的 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/e961dd07670fe48f1d6154fcb05bfc42/shape-1.svg&quot; alt=&quot;shape 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 包含除了 &lt;code class=&quot;language-text&quot;&gt;[[Value]]&lt;/code&gt; 之外的所有的元属性数据，并且 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 会保存属性值在 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 中的偏移量，因此 JavaScript 引擎知道去哪里找到这些值。每个同一 shape 的 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 指向这个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 实例。现在每个 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 只需要保存对对象唯一的属性值。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/836c5d03087c8fd4323793df862ddeb6/shape-2.svg&quot; alt=&quot;shape 2&quot;&gt;&lt;/p&gt;
&lt;p&gt;当我们有多个对象时好处显而易见，无论有多少对象，只要它们拥有同样的 shape，我们只需要保存一次 shape 和属性信息。&lt;/p&gt;
&lt;h3&gt;过渡链和树（Transition chains and trees）&lt;/h3&gt;
&lt;p&gt;假设现在一个对象有一个确定的 shape，当我们此时在该对象上新增一个属性时，引擎该如何找到新的 shape？&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种 shape 形式在引擎中称为过渡链（transition chains）感觉这里还是原生比较直观。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/b32af721e8b02099051effa12ced05ac/shape-chain-1.svg&quot; alt=&quot;shape chain 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;对象 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 开始时没有任何属性，所以最初指向空 shape。第二步将值为 &lt;code class=&quot;language-text&quot;&gt;5&lt;/code&gt; 的 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性添加到对象 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 时，JavaScript 引擎会过渡到一个包含属性 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape，并且值 &lt;code class=&quot;language-text&quot;&gt;5&lt;/code&gt; 会添加到 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 偏移量 &lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; 的位置。同理，当新增 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 属性时，引擎会过渡到包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 的另一个 shape，并将 &lt;code class=&quot;language-text&quot;&gt;6&lt;/code&gt; 添加到 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 偏移量 &lt;code class=&quot;language-text&quot;&gt;1&lt;/code&gt; 的位置。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;注意：属性添加的顺序会影响shape。如 { x: 4undefined y: 5 } 和 { y: 5undefined x: 4 } 的 shape 不同。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们不需要为每个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 保存全部的属性。相反，每个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 只需要知道它自己新的属性。例如，我们不需要在最后一个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 中存储 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性，因为它可以在之前的链上找到。为了达到这个目的，每个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 需要指回之前的 shape ：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/84acac33e689906b5eafed489f5fe68f/shape-chain-2.svg&quot; alt=&quot;shape chain 2&quot;&gt;&lt;/p&gt;
&lt;p&gt;当代码中访问 &lt;code class=&quot;language-text&quot;&gt;o.x&lt;/code&gt; 时，引擎会向上遍历 transition chain 直到找到拥有 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;如果此时有两个空对象，我们分别向对象中添加不同的属性：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种情况我们会将树进行分叉形成 transition tree 而不再是一条链。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7285fe16e0ded670a519bd0470c3a3d6/shape-tree.svg&quot; alt=&quot;shape tree&quot;&gt;&lt;/p&gt;
&lt;p&gt;这里我们创建了空对象 &lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt; ， 并且向其添加了 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性。最终创建了包含一个值的 &lt;code class=&quot;language-text&quot;&gt;JSObject&lt;/code&gt; 和 两个 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s ：一个空 shape 和一个仅包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性信息的 shape。&lt;/p&gt;
&lt;p&gt;我们也创建了对象 &lt;code class=&quot;language-text&quot;&gt;b&lt;/code&gt; ，并增加了属性 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt;。结果产生了两条 shape 链，总共三个 shape。&lt;/p&gt;
&lt;p&gt;这是否意味着我们总是从空 shape 开始？并非如此。引擎会对已经拥有属性的对象字面量做优化。我们要么从空对象增加 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性，要么有对象已经存在 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
object1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在对象 &lt;code class=&quot;language-text&quot;&gt;object1&lt;/code&gt; 中，我们首先创建空 shape，并过渡到拥有 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的 shape。
对象 &lt;code class=&quot;language-text&quot;&gt;object2&lt;/code&gt; 可以直接从之前已经包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape 创建，不需要从空对象开始然后过渡。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/14f49d5717ffc330ab2e9f9e47faa16c/empty-shape-bypass.svg&quot; alt=&quot;empty shape bypass&quot;&gt;&lt;/p&gt;
&lt;p&gt;包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的对象从包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape 开始，高效的跳过了空 shape。这个优化缩短了过渡链并使字面构造对象更加高效。&lt;/p&gt;
&lt;p&gt;下面是一个三维点对象的表示：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; point &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
point&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
point&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
point&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;z &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;根据我们前面所讲的，这会在内存中创建 3 个 shape（不包括空 shape）。为了访问 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性，必须从链尾开始遍历寻找包含 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/1069bb39d70e1f1270fe887fb1637a06/shapetable-1.svg&quot; alt=&quot;shapetable&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果我们经常作此操作，会变得很慢，尤其是当对象有很多属性时。寻找属性的时间复杂度是 O（n）,即线性的复杂度。为了加快查询效率，JavaScript 引擎增加了一个 &lt;code class=&quot;language-text&quot;&gt;ShapeTable&lt;/code&gt; 的数据结构。这个 &lt;code class=&quot;language-text&quot;&gt;ShapeTable&lt;/code&gt; 是一个字典，匹配键值和对应的 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s 。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/5185c0139aa8e3cc3055648ef526d2e5/shapetable-2.svg&quot; alt=&quot;shapetable-2&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在我们又回到了字典表查找。这是我们开始添加 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s 的地方。所以我们为什么还要&lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s ？&lt;/p&gt;
&lt;p&gt;原因是 shapes 可以启用另一个优化方案：&lt;code class=&quot;language-text&quot;&gt;Inline Caches&lt;/code&gt;。&lt;/p&gt;
&lt;h3&gt;Inline Caches (ICs)&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s 背后真正的目的是内联缓存（ICs）。ICs 是使 JavaScript 快速运行的关键因素。JavaScript 引擎使用 ICs 来记录去哪里找对象的属性的信息，减少查询次数的开销。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当我们在编译器中执行时，生成如下的字节码：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/40a0bcd658e50b7512132eabe579f0bd/ic-1.svg&quot; alt=&quot;ic 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;get_by_id&lt;/code&gt; 指令从第一个参数 &lt;code class=&quot;language-text&quot;&gt;arg1&lt;/code&gt; 加载 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性，并将结果保存在 &lt;code class=&quot;language-text&quot;&gt;loc0&lt;/code&gt; 位置。第二条指令返回我们存在 &lt;code class=&quot;language-text&quot;&gt;loc0&lt;/code&gt; 中的数据。&lt;/p&gt;
&lt;p&gt;JSC 还将内联缓存嵌入包含两个未初始化插槽的 &lt;code class=&quot;language-text&quot;&gt;get_by_id&lt;/code&gt; 指令中。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7f8e0551ee220f9a9c850ddc7731fe0c/ic-2.svg&quot; alt=&quot;ic 2&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在我们调用&lt;code class=&quot;language-text&quot;&gt;getX&lt;/code&gt; 函数，并传参 &lt;code class=&quot;language-text&quot;&gt;{ x: &amp;#39;a&amp;#39; }&lt;/code&gt; ，这个对象有一个拥有 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的 shape，并且该 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt; 保存了偏移量和 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的元属性数据。当首次执行这个函数时，&lt;code class=&quot;language-text&quot;&gt;get_by_id&lt;/code&gt; 指令开始查找属性 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt;，最终找到该值保存在偏移量 &lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; 的位置。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/bfc0cd727c60f503382d21c0fe236545/ic-3.svg&quot; alt=&quot;ic 3&quot;&gt;&lt;/p&gt;
&lt;p&gt;嵌入 &lt;code class=&quot;language-text&quot;&gt;get_by_id&lt;/code&gt; 指令的内联缓存会记录 shape 和属性被查到的偏移量：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/7eb62f1dfed740115e04ffcef6788128/ic-4.svg&quot; alt=&quot;ic 4&quot;&gt;&lt;/p&gt;
&lt;p&gt;在随后的运行，内联缓存只需要比较 shape，如果相同就会直接返回记录的偏移量的值。特别是如果 JavaScript 引擎发现对象的 shape 在内联缓存中已经记录，不再需要去查询属性信息，这步耗时的操作会完全跳过。&lt;/p&gt;
&lt;h2&gt;高效存储数组&lt;/h2&gt;
&lt;p&gt;数组保存的属性又称为索引，对应的值称为数组元素。在每个单个数组中保存每个数组元素的属性信息是浪费内存的，JavaScript 引擎默认情况下索引值的属性是可写、可遍历、可删除，并且将数组元素和其他命名属性分开存储。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; array &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;#jsconfeu&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;引擎保存了数组长度 &lt;code class=&quot;language-text&quot;&gt;1&lt;/code&gt;，并指向包含偏移量和 &lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt; 属性的 &lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/59616921d42c4e5b04c71f3f6887b9de/array-shape.svg&quot; alt=&quot;array shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;和之前看到的一样，但是数组的元素值存在哪里呢？&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/0d617beeb57476b7d2867dada081498e/array-elements.svg&quot; alt=&quot;array elements&quot;&gt;&lt;/p&gt;
&lt;p&gt;每个数组都有一个单独的元素备份库，包含了所有元素的值。JavaScript 引擎不需要为数组元素保存任何属性信息，因为通常它们都是可写、可枚举、可删除的。&lt;/p&gt;
&lt;h2&gt;收获与总结&lt;/h2&gt;
&lt;p&gt;我们学习到了 JavaScript 引擎是如何存储对象和数组的，&lt;code class=&quot;language-text&quot;&gt;Shape&lt;/code&gt;s 和 &lt;code class=&quot;language-text&quot;&gt;ICs&lt;/code&gt; 是如何对它们常用的操作做出优化的。基于这些知识，我们总结了以下可以提高性能的代码：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;总是按同一种方式初始化对象，这样就不会产生多种不同的 shape；&lt;/li&gt;
&lt;li&gt;不要试图修改数组的属性信息，否则存储和操作会降低性能。&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[React源码中导致V8性能断崖下滑的真相]]></title><description><![CDATA[JavaScript 类型 JavaScript 的值总共具有 8 种不同的类型： 可以通过  关键字来校验值的类型。 尽管  有着它自身的一种类型，但  却返回  而不是  。为了理解原因，我们首先把所有的类型分为两组： object (即  类型) primitives…]]></description><link>https://www.keisei.top/V8-performance-cliff/</link><guid isPermaLink="false">https://www.keisei.top/V8-performance-cliff/</guid><pubDate>Thu, 14 Nov 2019 14:42:00 GMT</pubDate><content:encoded>&lt;h2&gt;JavaScript 类型&lt;/h2&gt;
&lt;p&gt;JavaScript 的值总共具有 8 种不同的类型：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;Number&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Symbol&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BigInt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Boolean&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Null&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以通过 &lt;code class=&quot;language-text&quot;&gt;typeof&lt;/code&gt; 关键字来校验值的类型。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;number&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;string&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;bar&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;symbol&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42n&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;bigint&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;boolean&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;undefined&apos;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;object&apos; wtf?&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; &apos;object&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;尽管 &lt;code class=&quot;language-text&quot;&gt;Null&lt;/code&gt; 有着它自身的一种类型，但 &lt;code class=&quot;language-text&quot;&gt;typeof null&lt;/code&gt; 却返回 &lt;code class=&quot;language-text&quot;&gt;object&lt;/code&gt; 而不是 &lt;code class=&quot;language-text&quot;&gt;null&lt;/code&gt; 。为了理解原因，我们首先把所有的类型分为两组：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;object (即 &lt;code class=&quot;language-text&quot;&gt;Object&lt;/code&gt; 类型)&lt;/li&gt;
&lt;li&gt;primitives (任何非 object 类型)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;null&lt;/code&gt; 表示 &lt;code class=&quot;language-text&quot;&gt;no object value&lt;/code&gt; ，&lt;code class=&quot;language-text&quot;&gt;undefined&lt;/code&gt; 表示 &lt;code class=&quot;language-text&quot;&gt;no value&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/d52963211bf54974552289fe7b64ec43/primitives-objects.svg&quot; alt=&quot;类型表示&quot;&gt;&lt;/p&gt;
&lt;p&gt;根据这条思路，Brendan Eich 在设计 JavaScript 语言时，使 &lt;code class=&quot;language-text&quot;&gt;typeof&lt;/code&gt; 所有右侧的值都返回 &lt;code class=&quot;language-text&quot;&gt;object&lt;/code&gt; ，即所有 object 和 null 的值，这也是 Java 的特点之一。尽管规范中存在 &lt;code class=&quot;language-text&quot;&gt;Null&lt;/code&gt; 类型，但这就是 &lt;code class=&quot;language-text&quot;&gt;typeof null === &amp;#39;object&amp;#39;&lt;/code&gt; 的原因。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/5aca2330406be983d35ab591cfd76890/primitives-objects-typeof.svg&quot; alt=&quot;typeof 对象&quot;&gt;&lt;/p&gt;
&lt;h2&gt;值的表示&lt;/h2&gt;
&lt;p&gt;JavaScript 引擎必须能够在内存中对任意类型的 JavaScript 值进行表示，并且不同类型的值的表示方式不同。&lt;/p&gt;
&lt;p&gt;举例来说，&lt;code class=&quot;language-text&quot;&gt;42&lt;/code&gt; 是一个 &lt;code class=&quot;language-text&quot;&gt;number&lt;/code&gt; 类型，在内存中就有多种表示整型数字的方式：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;表示&lt;/th&gt;
&lt;th&gt;位&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;8 位&lt;/td&gt;
&lt;td&gt;0010 1010&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;32 位&lt;/td&gt;
&lt;td&gt;0000 0000 0000 0000 0000 0000 0010 1010&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;32 位 IEEE-754 浮点&lt;/td&gt;
&lt;td&gt;0100 0010 0010 1000 0000 0000 0000 0000&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;64 位 IEEE-754 浮点&lt;/td&gt;
&lt;td&gt;0100 0000 0100 0101 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;ECMAScript 标准中数字采用 64 位浮点数表示，即双精度浮点数或 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 。但考虑到性能问题，JavaScript 引擎并不会在任何时候都以 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 表示数字。只要外部表现的行为与 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 一致，引擎在内部可以选择其他的表示方式。&lt;/p&gt;
&lt;p&gt;在现实世界中，JavaScript 应用中大部分的整数数字类型都在 0 - 2³²−2 范围内，这个范围也是&lt;a href=&quot;https://tc39.es/ecma262/#array-index&quot;&gt;有效的数字索引值&lt;/a&gt;的范围。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 最小的有效索引值&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 最大的有效索引值&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;JavaScript 引擎对这类整数可以选择一种最佳的内存表示方式来优化通过索引访问数组元素的代码。处理器在做内存读取操作时，数组索引必须为二级制补码。&lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 来表示索引显然是浪费的，并且引擎不得不在每次访问数组元素时来回切换 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 和二进制补码形式。&lt;/p&gt;
&lt;p&gt;32 位二进制补码表示并不止对数组操作有帮助，实际上处理器在对整数操作时会比对浮点数操作更快。下面例子中第一个循环会是第二个循环的二倍之快：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再比如做模运算时，&lt;code class=&quot;language-text&quot;&gt;const remainder = value % divisor;&lt;/code&gt; 如果 &lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;divisor&lt;/code&gt; 都为整数时会比不是整数要快很多。如果操作数都是整数，CPU 在计算时会非常高效，对于 &lt;code class=&quot;language-text&quot;&gt;divisor&lt;/code&gt; 是 2 的幂的情况，V8 还有其他更快的计算方式。但如果出现了浮点数，那计算过程会变得复杂，花费的时间也会上升。&lt;/p&gt;
&lt;p&gt;由于整数运算的执行速度通常比浮点运算快得多，因此看来，引擎可以始终对所有整数和整数运算的所有结果使用二进制补码。但 ECMAScript 在 Float64 上实现了标准化，因此某些整数运算实际上会产生浮点数。 在这种情况下，JS 引擎产生正确的结果非常重要。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Float64具有53位的安全整数范围。超出这个范围就会失去精度。&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;53&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;53&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// → true&lt;/span&gt;

&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// → true&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// → true&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// → true&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;NaN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;即使左侧的值为整数，右侧的所有值为浮点数。使用 32 位二进制补码无法正确执行上述操作。 JavaScript 引擎需要确保整数运算能匹配 Float64 的结果。&lt;/p&gt;
&lt;p&gt;对于 31 位有符号整数范围内的小整数，V8 使用一种称为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 的特殊表示形式。 任何不是 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 的东西都表示为 &lt;code class=&quot;language-text&quot;&gt;HeapObject&lt;/code&gt;，这是内存中某个实体的地址。 对于数字，我们使用一种特殊的 &lt;code class=&quot;language-text&quot;&gt;HeapObject&lt;/code&gt;（即 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt;）来表示不在 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 范围内的数字。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;4.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Smi&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;Infinity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;NaN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如上面的示例所示，一些 JavaScript 数字表示为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; s，而其他 JavaScript 数字表示为 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt;s。 V8 特别针对 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt;s 进行了优化，因为小整数在现实世界的 JavaScript 程序中非常常见。 不需要为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt;s 在内存中分配特殊块，并且通常整数运算会更快。&lt;/p&gt;
&lt;p&gt;这里重要的一点是，即使是具有相同 JavaScript 类型的值，作为优化在后台可能会以完全不同的方式表示。&lt;/p&gt;
&lt;h2&gt;Smi vs. HeapNumber vs. MutableHeapNumber&lt;/h2&gt;
&lt;p&gt;下面我们来看一下底层的实现。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//Smi&lt;/span&gt;
  y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HeapNumber&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;42&lt;/code&gt; 可以通过 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 来表示，它可以直接存在 object 中，而 &lt;code class=&quot;language-text&quot;&gt;4.2&lt;/code&gt; 需要一个独立的实体来保存，object 指向那个实体。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ee34e425c3e1fbf1c1fc1ffecf23ef7d/smi-vs-heapnumber.svg&quot; alt=&quot;smi vs heapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;当我们执行以下代码时：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; o.x = 52&lt;/span&gt;
o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; o.y = 5.2&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;因为新值 &lt;code class=&quot;language-text&quot;&gt;52&lt;/code&gt; 仍满足 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示的范围，所以 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 值会在原位置更新。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/12759730c985a0bca1d3c3238f6b762f/update-smi.svg&quot; alt=&quot;update smi&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;y = 5.2&lt;/code&gt; 不能用 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示，并且与 &lt;code class=&quot;language-text&quot;&gt;4.2&lt;/code&gt; 不同，所以 V8 只好分配一份新的 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; 实体给到 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/8cb79b00f2ac6201641f665825860cae/update-heapnumber.svg&quot; alt=&quot;update heapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt;s 是不可变的，这可以带来一些明显的优化。如 &lt;code class=&quot;language-text&quot;&gt;o.x = o.y&lt;/code&gt; 操作，实际上只是将 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的指针指向 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 指向的实体 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; ，而不需要重新创建。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/42fbb18915e39e9f044fcfb2ad35c9c0/heapnumbers.svg&quot; alt=&quot;update heapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; 的一个劣势是更新数据会比 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 慢，考虑以下代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 创建`HeapNumber` 实体&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// 创建一个新 `HeapNumber` 实体&lt;/span&gt;
  o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这段代码总共生成了 6 个 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; 实体，但其中 5 个是没有必要的。为了避免这种情况， V8 将这种数据标记为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 字段，提供了一种原地更新非 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 的类型 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 来存储 &lt;code class=&quot;language-text&quot;&gt;Float64&lt;/code&gt; 数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ec93b06346d3c327811c0b3a4bfb9cfe/mutableheapnumber.svg&quot; alt=&quot;mutableheapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;当值更新时，V8 会简单原地更新 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 的数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/fb55956decd70357d3727da027d6a8c0/update-mutableheapnumber.svg&quot; alt=&quot;update mutableheapnumber&quot;&gt;&lt;/p&gt;
&lt;p&gt;但这中也有陷阱，当&lt;code class=&quot;language-text&quot;&gt;y = o.x&lt;/code&gt; 时，如果 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 也指向同一 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 那么下次 &lt;code class=&quot;language-text&quot;&gt;o.x&lt;/code&gt; 的值更新， &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 也会跟着更新，这显然是违背 JavaScript 规范的。所以当 &lt;code class=&quot;language-text&quot;&gt;o.x&lt;/code&gt; 被访问时，首先需要将值转换为正常的 &lt;code class=&quot;language-text&quot;&gt;HeapNumber&lt;/code&gt; 。&lt;/p&gt;
&lt;h2&gt;Shape 弃用和迁移&lt;/h2&gt;
&lt;p&gt;如果一个字段初始时是 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 后来变更为非 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 类型，底层是如何变更呢？&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; 两个对象的 x 是 Smi 类型&lt;/span&gt;
b&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// -&gt; b.x 现在是 Double 类型&lt;/span&gt;
y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/42568b32a305e7779c0b3529dc19a3c9/shape.svg&quot; alt=&quot;shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;当 &lt;code class=&quot;language-text&quot;&gt;b.x&lt;/code&gt; 变为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示时，V8 分配了一个新的空 shape，并指向 x，也创建了一个 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 来存储新值 &lt;code class=&quot;language-text&quot;&gt;0.2&lt;/code&gt;。然后对象 &lt;code class=&quot;language-text&quot;&gt;b&lt;/code&gt; 指向新 shape ，对象的值指向偏移量为 0 的 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt;。最后把旧 shape 标记为弃用的，断开 transition 树。&lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 完成了从空 shape 到新创建的 shape 的过渡。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2c4e36b13eb8bbfed1ef427981c82b84/shape-transition.svg&quot; alt=&quot;shape transition&quot;&gt;&lt;/p&gt;
&lt;p&gt;由于 a 对象还在指向旧的 shape，所以不能移除。V8 定义了任何取 a 中的属性或对 a 赋值之前先将 a 迁移至新的 shape。这样最终会使得标记为弃用的 shape 不可访问， 这时垃圾回收就可以释放这段内存了。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/ce3cd892ec50b10c31df5a0b7360addb/shape-deprecation.svg&quot; alt=&quot;shape deprecation&quot;&gt;&lt;/p&gt;
&lt;p&gt;还有另一种情况：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  z&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这时 V8 需要找到这条链路上 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 之前的 shape，即 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/be221219de8e08427e540e2c91fb95fb/split-shape.svg&quot; alt=&quot;split shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;从分离的 shape 开始，我们创建了新的过渡链，并标记 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 类型，旧的子树弃用。最后一步迁移对象 o 至新的 shape，&lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 的值保存在 &lt;code class=&quot;language-text&quot;&gt;MutableHeapNumber&lt;/code&gt; 中。一旦所有旧 shape 的引用全都消失，那这棵树上所有旧的 shape 也会被回收。&lt;/p&gt;
&lt;h2&gt;可扩展性和完整过渡&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Object.preventExtensions()&lt;/code&gt; 可以阻止新的属性添加至一个对象中。
&lt;code class=&quot;language-text&quot;&gt;Object.seal&lt;/code&gt; 包含了 &lt;code class=&quot;language-text&quot;&gt;Object.preventExtensions()&lt;/code&gt; 的功能，并且它会标记所有属性为不可配置。
&lt;code class=&quot;language-text&quot;&gt;Object.freeze&lt;/code&gt; 与 &lt;code class=&quot;language-text&quot;&gt;Object.seal&lt;/code&gt; 类似，同时所有属性值不能更改。&lt;/p&gt;
&lt;p&gt;考虑一个具体的情况：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;preventExtensions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;像之前一样，从空 shape 过渡到新的存有 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 属性的 shape。当我们执行 &lt;code class=&quot;language-text&quot;&gt;Object.preventExtensions()&lt;/code&gt; 时，执行了一个特殊过渡至被标记为不可扩展的新 shape。这个过渡并不是因为新的属性，只是进行了标记。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/06702e6d19b4d30aecc4aef008062f71/shape-nonextensible.svg&quot; alt=&quot;shape nonextensible&quot;&gt;&lt;/p&gt;
&lt;p&gt;注意我们不能直接在原地更新 &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; 的 shape，原因是对象 &lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt; 仍然是可扩展的。&lt;/p&gt;
&lt;h2&gt;React 性能问题&lt;/h2&gt;
&lt;p&gt;让我们最终来看一个真实的问题，&lt;a href=&quot;https://github.com/facebook/react/issues/14365&quot;&gt;react issue #14365&lt;/a&gt;。当 React 团队对一个现实的程序执行 profile 时，他们发现了 V8 一个奇怪的性能问题影响了 React 核心代码。下面是简化过的代码：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;preventExtensions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对象 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 有两个值为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示的属性，然后禁用了 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 的扩展性，并强制将第二个属性转换为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示。
根据前面的知识，代码的运行步骤如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/909307edf284801f22671924a8ec2426/repro-shape-setup.svg&quot; alt=&quot;repro shape setup&quot;&gt;&lt;/p&gt;
&lt;p&gt;两个属性为 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示，对象 &lt;code class=&quot;language-text&quot;&gt;o&lt;/code&gt; 指向最终过渡到 non-extensible 的 shape。&lt;/p&gt;
&lt;p&gt;现在我们将 &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; 更新为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示，意味着我们需要从头开始找到分离的 shape &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt;，但是 V8 出现了分歧，分离的 shape 是可扩展的，但是当前的 shape 被标记为非扩展的，V8 不知道如何正确进行过渡，实际上创建了一个独立的 shape。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/1eda5891848b0642cf5994353013aa14/orphaned-shape.svg&quot; alt=&quot;orphaned shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;可以想象当有很多这种对象时，会多糟糕。React 核心代码就产生了这一问题，&lt;code class=&quot;language-text&quot;&gt;FiberNode&lt;/code&gt; 有几个开启 profile 操作时记录时间戳的字段。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;actualStartTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;preventExtensions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; node1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; node2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这些字段如 &lt;code class=&quot;language-text&quot;&gt;actualStartTime&lt;/code&gt; 初始时赋值为 0 或 -1，即初始以 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 表示。但是后来执行&lt;a href=&quot;https://w3c.github.io/hr-time/#dom-performance-now&quot;&gt;performance.now()&lt;/a&gt;时返回的浮点数的时间戳保存至这些字段中，即变更为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示。&lt;/p&gt;
&lt;p&gt;最初的表示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/4e86dcfaefd0c365f5765f0373ceef9f/fibernode-shape.svg&quot; alt=&quot;fibernode shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;当存储时间戳时，V8 产生了矛盾：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/6d567cf6c6e15c4c00673566132faa72/orphan-islands.svg&quot; alt=&quot;orphan islands&quot;&gt;&lt;/p&gt;
&lt;p&gt;V8 为 node1 生成了 orphaned shape，在随后的某个节点为 node2 生成了不相交的另一个 orphaned shape。现实中 React 应用中 &lt;code class=&quot;language-text&quot;&gt;FiberNode&lt;/code&gt; 不止一两个，所以可想而知严重降低了 V8 的性能。&lt;/p&gt;
&lt;p&gt;现在 V8 v7.4 版本已经修复了这个问题，并且使得字段表示的更新成本更低。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/001011f0d3562e81e060befdf21d6b41/fix-fibernode-shape-2.svg&quot; alt=&quot;fix fibernode shape&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在当 &lt;code class=&quot;language-text&quot;&gt;actualStartTime&lt;/code&gt; 赋值为 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示时，会正确的产生一条新的过渡链，并将之前的标记为弃用，在未来的某个时间点回收。&lt;/p&gt;
&lt;p&gt;React 团队的&lt;a href=&quot;https://github.com/facebook/react/pull/14383&quot;&gt;解决方式&lt;/a&gt;是初始化时将所有的 time 和 duration 字段以 &lt;code class=&quot;language-text&quot;&gt;Double&lt;/code&gt; 表示：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 强制以 Double 表示&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;actualStartTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Number&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;NaN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 随后可以以 Smi 来真正初始化值&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;actualStartTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;preventExtensions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; node1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; node2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FiberNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以使用任何不符合 &lt;code class=&quot;language-text&quot;&gt;Smi&lt;/code&gt; 范围的浮点值来代替 Number.NaN，如 &lt;code class=&quot;language-text&quot;&gt;0.000001&lt;/code&gt;， &lt;code class=&quot;language-text&quot;&gt;Number.MIN_VALUE&lt;/code&gt;， &lt;code class=&quot;language-text&quot;&gt;-0&lt;/code&gt;和 &lt;code class=&quot;language-text&quot;&gt;Infinity&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;JavaScript 引擎在底层做了哪些神奇的操作，我们不得而知，但是记住不要混用类型，这样可以提交 V8 的性能。例如不要给数字类型的字段初始化 &lt;code class=&quot;language-text&quot;&gt;null&lt;/code&gt; 值，这会失去字段表示的优势，并且代码更易读：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 不要这么写!&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Point&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Point&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;402&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;换句话说，&lt;strong&gt;可读性高的代码性能更好！&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;收获与总结&lt;/h2&gt;
&lt;p&gt;本文主要深入了以下内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;JavaScript 类型分为基本类型和引用类型，&lt;code class=&quot;language-text&quot;&gt;typeof&lt;/code&gt; 会有误导性；&lt;/li&gt;
&lt;li&gt;即便是同一种数据类型，它背后的表示形式可能不同；&lt;/li&gt;
&lt;li&gt;V8 尽可能去寻找 JavaScript 应用中每个字段的最佳表示形式；&lt;/li&gt;
&lt;li&gt;V8 如何处理 shape 弃用和迁移，包括扩展性过渡。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;基于以上知识，在编写 JavaScript 代码时以下注意事项可以提高性能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;总是以同一种方式初始化对象，shape 可以变得高效；&lt;/li&gt;
&lt;li&gt;选择对字段类型合适的初始值来帮助 JavaScript 引擎选择表示形式。&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item></channel></rss>