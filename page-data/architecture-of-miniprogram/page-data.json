{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/architecture-of-miniprogram/","result":{"data":{"site":{"siteMetadata":{"title":"学习随笔"}},"markdownRemark":{"id":"e7b9c109-4a51-535e-9c28-cb15299cbece","excerpt":"笔者之前接手过一些小程序的项目，不过当时时间紧任务重，基本上就是边看文档边撸代码，并没有真正好好的理解小程序的设计。今天准备花些时间来了解一下，小程序背后的故事。 前世今生 小程序这个概念应该是微信最早提出并推广应用的。当时发布之后我也尝试做过类似 Instagram…","html":"<p>笔者之前接手过一些小程序的项目，不过当时时间紧任务重，基本上就是边看文档边撸代码，并没有真正好好的理解小程序的设计。今天准备花些时间来了解一下，小程序背后的故事。</p>\n<h3>前世今生</h3>\n<p>小程序这个概念应该是微信最早提出并推广应用的。当时发布之后我也尝试做过类似 Instagram 这样的支持上传，浏览图片的小程序，无奈当时刚发布时小程序的框架还有很多不完善的地方，比如像素单位在 Android 和 iOS 上不统一，开发工具体验差等，因此而弃坑。现在回过头来看小程序的发展已然非常成熟，各家大厂纷纷跟进，百花齐放。</p>\n<p>回到正题，小程序是如何出现的？</p>\n<p>据微信官方文档的介绍，在早期微信就封装过一个微信 JS-SDK，包含了很多拍摄，录音，二维码，支付等 API。记得当时做微信公众号的开发时，确实体会到了在 web 页面中调用微信原生功能的强大与便捷。但是，由于 web 应用会共享一个线程，即渲染线程和脚本线程是互斥的，所以当脚本执行时页面的渲染会卡住，给人不好的体验。所以微信开发者后面就给出了一个新的方案，既能够提供原生功能和体验，又能保障用户的安全前提下快速开发迭代。</p>\n<h3>设计理念</h3>\n<h4>选型</h4>\n<p>小程序的初衷就是要求渲染快，加载快。所以通常的渲染页面的技术：</p>\n<ol>\n<li>纯客户端原生渲染</li>\n<li>纯 Web 技术渲染</li>\n<li>Hybrid 技术渲染</li>\n</ol>\n<p>纯客户端渲染需要跟随宿主环境一起发布，这种会破环小程序开发者的发布，并且不能云端热更新。\n纯 Web 渲染就像之前提到了在复杂交互页面上会存在性能问题。\n所以最终采用 Hybrid 方式，轻量级的组件采用 Web 技术渲染，而复杂的应用则会采用客户端原生渲染（如地图），两者结合来提供更好的性能和体验。</p>\n<h4>安全</h4>\n<p>不完全采用 Web 技术渲染小程序的另一大原因是由于 Web 技术的灵活性，可以通过 JavaScript 脚本随意跳转或修改页面上的内容。另外还有一些只允许展示的敏感数据是禁止 JavaScript 访问的。</p>\n<p>所以需要提供一个单独的沙箱环境来运行 JavaScript 代码。这个沙箱环境中不能提供浏览器相关接口，只能用作解释执行 JavaScript。就像浏览器中的 Service Worker，WebWorker 一样，启用单独的 worker 线程来执行 JavaScript。这个沙箱环境在客户端有提供（iOS 下是内置的 JavaScriptCore 框架，Android 下是微信 x5 内核的 JsCore 环境），该环境就是小程序逻辑层。</p>\n<h3>宿主环境</h3>\n<p>所谓的宿主环境其实就是微信 APP，在小程序中，渲染线程和逻辑线程是分开执行的，渲染层的界面使用 WebView 进行渲染，逻辑线程运行在 JsCore 中。</p>\n<p>一个小程序存在多个界面，即渲染层存在多个 WebView 线程。</p>\n<h4>通信模型</h4>\n<p>渲染层和逻辑层的的通信是通过宿主环境（Native）进行中转的，逻辑层发送的网络请求也由 Native 转发。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ad156d1c827ca78a893b6ed057d2f8a6/7eaff/communication.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.10865874363327%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABwUlEQVQ4y41T0W7TMBTth05omhAPaA8IxKfA+I9Nmnie2BAICQQd1ZSpq9bEWZqkSdMmce344OvKXhLSgaUTO/eee3xuYo+gh1KqAzv68f/hjOghhMB2u91Br8uyxGq1ArexPsQW680aeZ5rDnfxjqAV1XsiZAGux7/Q6MJGCpd/5ABszjAZT4AGLt51qEHFq0piHClMYuBHqBAVEkru8sSTQiItE/hrH2zD8LAOhwUtru4Vzm6Ac0/hVM93S22hoQJh2iNH73+/w7OLA7y4fI7XX16ZuND5jqCkb8eFETn3YOaPt8CylMZ5W/DD5ARHnw5x/Pkl3n59s1+Q6+DPhwbfmcQ3X2Km3bXbtS1nVYagCODncyw2i6dbph9RVyUEr3diehMppYHlKKkguX6vd+tBQSooigK+7yMIAgfGGGazGabTqVm3c3N/jjRNYTX+EqTzF8cJkiQxRDtHUYQwDM17G3Ecm/NKRqjWCdp2aG6axsB9Ar2mduq6dpw+jzajQ05jtO8KEYEckEMSJJEsy0ysqipX0x7OoU0M3VnOuWmH2iKX1tm++z1q7zREICH6GZ7nGXf7NnYOnxLst/QvMcIf2pmH3hzrJfUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"communication\"\n        title=\"communication\"\n        src=\"/static/ad156d1c827ca78a893b6ed057d2f8a6/799d3/communication.png\"\n        srcset=\"/static/ad156d1c827ca78a893b6ed057d2f8a6/00d96/communication.png 148w,\n/static/ad156d1c827ca78a893b6ed057d2f8a6/0b23c/communication.png 295w,\n/static/ad156d1c827ca78a893b6ed057d2f8a6/799d3/communication.png 590w,\n/static/ad156d1c827ca78a893b6ed057d2f8a6/2a3d6/communication.png 885w,\n/static/ad156d1c827ca78a893b6ed057d2f8a6/ae92f/communication.png 1180w,\n/static/ad156d1c827ca78a893b6ed057d2f8a6/7eaff/communication.png 2356w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>数据驱动</h4>\n<p>即逻辑层的 data 与渲染层的 view 是相对应的，当调用了 setData 时，逻辑层生成新的 DOM 树并与旧的树进行 diff，然后把有差异的部分通过中转传递到渲染层，从而完成 UI 更新。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1dc3badd29cbcf2218de43a9c4f803db/3c7f1/render-process.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.62818336162988%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB20lEQVQ4y4WUTW/UMBCG+y+RKn4CAnGGIxzhBD+EAx83RG+AhEC7Krtqy2rzpV013aydxI4dxy8zDgndD4qlJ7Fn7Ncz9sgnoOa932Fo+/b/zeF2wh1r7UjbtijLEkVR7Nj3KbZFIIxNbxsFWYTpjR5JkmA2m8E5N/p25wDRVYT4Vxz6QyA7gta28K7FdeXwfQ1Mr4GvqUdOY7azfxBdiAXmYh5YyiW6tjseYUOLzpYe7y48Plx2eHsBZNKBVoxRME+/PcH9s1OcfrqH5z+ecVIw1tw6Q5rUURSlbvFm7vH+EvQHPi48auPgOINbab+cvsDjL4/w8PMDvP75ijbcE+RJ/aIOVwVwvjaYrm1I37s/F9H29Jk0tFENbXUQGvwHKVdVCVVJNLqksaKdO9qoo+j/4loXBA3hnQ+w7eBSmNVqhSiKIUm4blRAagmhRUASHBELKsP+OthLmnNUsKOIuOlGh5Ru1A2yMkMiY0Qion4a0mzpvJVVyFUe7IlIjgtqrUNRb8UWQgrUVd1T1nQUKlBVFUQpRj8XNd/ygSAXsZQScRyHwma4n2UpJtMJJpMJ0jQdfYN/s9kgz3MopfYL28IYE6I8Bi/4l51FuR8E+cNnN3DXg3DXQzH8fwN2azZtybJe2wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"render process\"\n        title=\"render process\"\n        src=\"/static/1dc3badd29cbcf2218de43a9c4f803db/799d3/render-process.png\"\n        srcset=\"/static/1dc3badd29cbcf2218de43a9c4f803db/00d96/render-process.png 148w,\n/static/1dc3badd29cbcf2218de43a9c4f803db/0b23c/render-process.png 295w,\n/static/1dc3badd29cbcf2218de43a9c4f803db/799d3/render-process.png 590w,\n/static/1dc3badd29cbcf2218de43a9c4f803db/2a3d6/render-process.png 885w,\n/static/1dc3badd29cbcf2218de43a9c4f803db/3c7f1/render-process.png 1178w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>参考</h3>\n<p><a href=\"https://developers.weixin.qq.com/ebook?action=get_post_info&#x26;docid=0008aeea9a8978ab0086a685851c0a\">https://developers.weixin.qq.com/ebook?action=get_post_info&#x26;docid=0008aeea9a8978ab0086a685851c0a</a></p>","frontmatter":{"title":"初识小程序架构","date":"February 23, 2020","description":"本文以微信小程序为例，来了解微信小程序的架构和底层实现原理"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"tags":["Mini Program"],"slug":"/architecture-of-miniprogram/","previous":{"excerpt":"本文我们来看一下用于ECMAScript和WebAssembly的V8 引擎的内存管理。V8 引擎现在被 NodeJS，Deno 等运行时，Electron，还有 Chrome，Chromium，Brave，Opera 和 Microsoft Edge…","fields":{"slug":"/architecture-of-v8-memory/"},"frontmatter":{"date":"February 24, 2020","description":"对V8的内存管理加以了解","title":"了解 V8 内存管理","tags":["V8","Garbage Collection"]}},"next":{"excerpt":"React Native 是一个能够允许 JavaScript 和 native 代码一样在 iOS 和 Android 设备上运行和交互的现代框架。它提供了一种编写一次多端运行的能力，有机会使我们统一应用的架构。对于新手而言了解 RN…","fields":{"slug":"/architecture-of-rn/"},"frontmatter":{"date":"February 22, 2020","description":"对RN架构有一个整体的了解，原文章可能已过时但核心原理应该是不变的。","title":"初识 React Native 架构","tags":["Architecture","React Native"]}}}}}