{"componentChunkName":"component---src-templates-blog-post-js","path":"/webpack-behind-the-scene/","result":{"data":{"site":{"siteMetadata":{"title":"学习随笔"}},"markdownRemark":{"id":"5f0fed60-ebf7-547f-8c64-105dbdbffdbb","excerpt":"简介 现代化的前端应用离不开打包工具，从早期人们所熟知的 Grunt, Gulp 到现在炙手可热的 webpack, rollup 等，这些工具的崛起使得我们的代码构建更加方便，通过 Loader，插件等机制我们可以应用最新的技术，如新语法，预处理 CSS（Scss, Less），热更新方便了开发体验，摇树（Tree…","html":"<h2>简介</h2>\n<p>现代化的前端应用离不开打包工具，从早期人们所熟知的 Grunt, Gulp 到现在炙手可热的 webpack, rollup 等，这些工具的崛起使得我们的代码构建更加方便，通过 Loader，插件等机制我们可以应用最新的技术，如新语法，预处理 CSS（Scss, Less），热更新方便了开发体验，摇树（Tree Shaking）减少打包体积等。</p>\n<p>今天主要以 webpack 为例来了解打包工具发展至今是如何工作的，又通过哪些方式为我们提供了更多能力。以下图片简单描述了 webpack 的整个构建流程。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ab7934a1db677767b5369ef3963f3b9d/c1bb8/webpack-process.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.00942655145326%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAEDBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB4hJczk//xAAXEAEBAQEAAAAAAAAAAAAAAAABEAID/9oACAEBAAEFAodNBf/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAAEFAAAAAAAAAAAAAAAAAAEQESAhYf/aAAgBAQAGPwJAGFZD/8QAHRAAAgIBBQAAAAAAAAAAAAAAAAERUXEhMYGR4f/aAAgBAQABPyFKV4aVwJbAlBbrBZOOj//aAAwDAQACAAMAAAAQ0D//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QZH//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8QbX//xAAcEAEBAAICAwAAAAAAAAAAAAABEQAxIWFBcZH/2gAIAQEAAT8QkUNYZCiD2zhQgVmW+fecwQjWs1BrHp8M/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"webpack process\"\n        title=\"webpack process\"\n        src=\"/static/ab7934a1db677767b5369ef3963f3b9d/88218/webpack-process.jpg\"\n        srcset=\"/static/ab7934a1db677767b5369ef3963f3b9d/7237a/webpack-process.jpg 148w,\n/static/ab7934a1db677767b5369ef3963f3b9d/0cfdf/webpack-process.jpg 295w,\n/static/ab7934a1db677767b5369ef3963f3b9d/88218/webpack-process.jpg 590w,\n/static/ab7934a1db677767b5369ef3963f3b9d/77d57/webpack-process.jpg 885w,\n/static/ab7934a1db677767b5369ef3963f3b9d/5a917/webpack-process.jpg 1180w,\n/static/ab7934a1db677767b5369ef3963f3b9d/c1bb8/webpack-process.jpg 1273w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>工作原理</h2>\n<p>webpack 按其官方介绍，是一款静态资源打包器。在 webpack 的世界，所有的资源（JavaScript，图片，CSS，字体文件等）都是模块（module），在执行时，webpack 从<a href=\"https://webpack.js.org/concepts/entry-points/\">入口</a>开始分析所依赖的模块，然后递归处理依赖模块的依赖，最终生成一个<a href=\"https://webpack.js.org/concepts/dependency-graph/\">依赖图</a>。</p>\n<p>webpack 的 80%是由其插件组成，它自身也是事件驱动的架构。在 webpack 生态中，插件是关键的要素，并且为社区提供了强大的能力来进入 webpack 的编译过程中。插件通过 <code class=\"language-text\">hook</code> 方式对每次编译发出的事件做出响应。</p>\n<p>webpack 中一个核心模块是 <code class=\"language-text\">Tapable</code>，许多对象继承了 <code class=\"language-text\">Tapable</code> 类。该类暴露了 <code class=\"language-text\">tap</code>，<code class=\"language-text\">tapAsync</code>，<code class=\"language-text\">tapPromise</code> 方法，插件可以使用这些方法注入将在整个编译过程中触发的自定义构建过程。</p>\n<p>首先来看张图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/91af4f4bbef2a30e532c68bc23a60b04/02420/webpack-build-process.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86.0488798370672%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAABg0lEQVQ4y5VTy06DQBT1/z/GpXHhwoWPaG0XksZo0wihtLzmzcC88dKqSW0tenKZAOHMOfee4aw/QGtaInGjhLVWawPlve+P4ezwVcHy5zhKqoQxgQnBmBhjfiWHAf22Ajwq2xUol1r2Y9hTBjqsOdvMFrO4jMfJznkwVlQky1Fe4qpCvBGY4U53WmullB5goP8jZHAK/KRon16KRUq10kmdTJfTt/Ub9EwpY4xDSdmesj2IKAWzccZv7ff/69mHIZIVSievk2W+JITVNfREQZ8QijDhXIxExTuWlikWyDvvoKUBAa7tXRgh1xJF8TzFGSGCMg7SCA1pY0xBH3b7lWw1pzQr67hpCm9FCH6X/zdOKDuZ3aHXS53d9OjR5PdGi69TFPa3CEfIeH69vDrf3F2sby/c6pHTEiG6dY7BPMxv18Jucj/Ivivm7H3C4ydYuzJytvs8e3/5MXZfKW1DGA97nxxckAvHI7x6sDRy4sVZ9WdyH4wiStaC5l1T6RZDuifIH28q3kzIh/aOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"webpack build process，https://miro.medium.com/max/982/1*NU-KdDY_WxCh3YcDGEbTiw.png\"\n        title=\"webpack build process，https://miro.medium.com/max/982/1*NU-KdDY_WxCh3YcDGEbTiw.png\"\n        src=\"/static/91af4f4bbef2a30e532c68bc23a60b04/799d3/webpack-build-process.png\"\n        srcset=\"/static/91af4f4bbef2a30e532c68bc23a60b04/00d96/webpack-build-process.png 148w,\n/static/91af4f4bbef2a30e532c68bc23a60b04/0b23c/webpack-build-process.png 295w,\n/static/91af4f4bbef2a30e532c68bc23a60b04/799d3/webpack-build-process.png 590w,\n/static/91af4f4bbef2a30e532c68bc23a60b04/2a3d6/webpack-build-process.png 885w,\n/static/91af4f4bbef2a30e532c68bc23a60b04/02420/webpack-build-process.png 982w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>简而言之，当 webpack 载入一个模块时，<code class=\"language-text\">compiler</code> 把模块放入称为 <code class=\"language-text\">chunk</code> 的容器内，并在渲染到浏览器之前在它上面执行大量的插件逻辑。</p>\n<p>我们来根据上图一步步来详解：</p>\n<h3>1.编译器（Compiler）</h3>\n<p>当 webpack 载入一个新模块时，Compiler 会第一时间执行（在 webpack.js 中 <code class=\"language-text\">compiler.run()</code>），它本身为 <code class=\"language-text\">tapable</code> 的一个实例。它处于调用栈的最高层，为 webpack 分发事件。它支持注册 <a href=\"https://webpack.js.org/api/compiler-hooks\"><code class=\"language-text\">Hooks</code></a>，可以控制 webpack 开始、停止、处理资源文件、监听模式等。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// node_modules/webpack/lib/webpack.js</span>\n\n<span class=\"token comment\">/**\n * @param {WebpackOptions} options options object\n * @param {function(Error=, Stats=): void=} callback callback\n * @returns {Compiler | MultiCompiler} the compiler object\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">webpack</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">options<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> webpackOptionsValidationErrors <span class=\"token operator\">=</span> <span class=\"token function\">validateSchema</span><span class=\"token punctuation\">(</span>\n    webpackOptionsSchema<span class=\"token punctuation\">,</span>\n    options\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>webpackOptionsValidationErrors<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebpackOptionsValidationError</span><span class=\"token punctuation\">(</span>webpackOptionsValidationErrors<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> compiler<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    compiler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MultiCompiler</span><span class=\"token punctuation\">(</span>\n      Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span> <span class=\"token operator\">=></span> <span class=\"token function\">webpack</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> options <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    options <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebpackOptionsDefaulter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    compiler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Compiler</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    compiler<span class=\"token punctuation\">.</span>options <span class=\"token operator\">=</span> options<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">NodeEnvironmentPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      infrastructureLogging<span class=\"token punctuation\">:</span> options<span class=\"token punctuation\">.</span>infrastructureLogging<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>plugins <span class=\"token operator\">&amp;&amp;</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> plugin <span class=\"token keyword\">of</span> options<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> plugin <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">plugin</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">,</span> compiler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">plugin</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    compiler<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span><span class=\"token function\">environment</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    compiler<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span><span class=\"token function\">afterEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    compiler<span class=\"token punctuation\">.</span>options <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebpackOptionsApply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> compiler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid argument: options'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> callback <span class=\"token operator\">!==</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid argument: callback'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      options<span class=\"token punctuation\">.</span>watch <span class=\"token operator\">===</span> <span class=\"token boolean\">true</span> <span class=\"token operator\">||</span>\n      <span class=\"token punctuation\">(</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> options<span class=\"token punctuation\">.</span><span class=\"token function\">some</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">o</span> <span class=\"token operator\">=></span> o<span class=\"token punctuation\">.</span>watch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> watchOptions <span class=\"token operator\">=</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">?</span> options<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">o</span> <span class=\"token operator\">=></span> o<span class=\"token punctuation\">.</span>watchOptions <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">:</span> options<span class=\"token punctuation\">.</span>watchOptions <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> compiler<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>watchOptions<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    compiler<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> compiler<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// node_modules/webpack/lib/Compiler.js</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Tapable</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">context</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>hooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">/** @type {SyncBailHook&lt;Compilation>} */</span>\n\t\t\tshouldEmit<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncBailHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"compilation\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {AsyncSeriesHook&lt;Stats>} */</span>\n\t\t\tdone<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncSeriesHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"stats\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {AsyncSeriesHook&lt;>} */</span>\n\t\t\tadditionalPass<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncSeriesHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {AsyncSeriesHook&lt;Compiler>} */</span>\n\t\t\tbeforeRun<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncSeriesHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"compiler\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {AsyncSeriesHook&lt;Compiler>} */</span>\n\t\t\trun<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncSeriesHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"compiler\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {AsyncSeriesHook&lt;Compilation>} */</span>\n\t\t\temit<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncSeriesHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"compilation\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {AsyncSeriesHook&lt;string, Buffer>} */</span>\n\t\t\tassetEmitted<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncSeriesHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"file\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"content\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {AsyncSeriesHook&lt;Compilation>} */</span>\n\t\t\tafterEmit<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncSeriesHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"compilation\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Compilation, CompilationParams>} */</span>\n\t\t\tthisCompilation<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"compilation\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"params\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Compilation, CompilationParams>} */</span>\n\t\t\tcompilation<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"compilation\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"params\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// ...</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//...</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>2.编译/依赖图 （Compilation/Dependency Graph）</h3>\n<p>编译器接下来会创建编译对象（Compilation），<code class=\"language-text\">Compilation</code> 是 webpack 的核心，从编译对象开始构建依赖图，提升树并渲染成束（编译器和编译对象都继承自 Tapable 类）。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// node_modules/webpack/lib/Compilation.js</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compilation</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Tapable</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">/**\n\t * Creates an instance of Compilation.\n\t * @param {Compiler} compiler the compiler which created the compilation\n\t */</span>\n\t<span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">compiler</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>hooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Module>} */</span>\n\t\t\tbuildModule<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"module\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Module>} */</span>\n\t\t\trebuildModule<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"module\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Module, Error>} */</span>\n\t\t\tfailedModule<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"module\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Module>} */</span>\n\t\t\tsucceedModule<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"module\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Dependency, string>} */</span>\n\t\t\taddEntry<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"entry\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Dependency, string, Error>} */</span>\n\t\t\tfailedEntry<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"entry\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">/** @type {SyncHook&lt;Dependency, string, Module>} */</span>\n\t\t\tsucceedEntry<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"entry\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"module\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n\t\t\t<span class=\"token comment\">/** @type {SyncWaterfallHook&lt;DependencyReference, Dependency, Module>} */</span>\n\t\t\tdependencyReference<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncWaterfallHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n\t\t\t\t<span class=\"token string\">\"dependencyReference\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token string\">\"dependency\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token string\">\"module\"</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h3>3.分析器（Resolver）</h3>\n<p>当把入口文件传递给 webpack 时，会分发给解析器。解析器会判断给到的相对路径是否存在，并返回绝对路径和其他如上下文、请求、调用等额外信息。如，在 <code class=\"language-text\">node</code> 中 require 一个声明，它会被传入模块解析器来判断是否存在。（<code class=\"language-text\">ResolverFactory.js</code>）</p>\n<h3>4.模块工厂（Module Factories）</h3>\n<p>工厂方法通常用来创建对象或实例。webpack 中，模块工厂用来创建模块实例。模块工厂拿到从解析器正确解析返回的路径，去该路径的文件收集源码，然后创建一个模块对象/实例（<code class=\"language-text\">NormalModuleFactory.js</code> &#x26; <code class=\"language-text\">ContextModuleFactory.js</code>）。</p>\n<h3>5.解析器（Parser）</h3>\n<p>解析器是把传入的字符串源码转换成<a href=\"https://astexplorer.net/\">ATS（抽象语法树）</a>。webpack 解析器类使用了 <code class=\"language-text\">acron</code> 解析器，接收模块对象（包含源码）参数，并返回 AST 对象。webpack 遍历整棵树找到所有的 require 和 import，并生成依赖图。解析器会把依赖附在模块上。注意我们会通过 <code class=\"language-text\">loaders</code> 注册一些 <code class=\"language-text\">rules</code>，当满足规则时对应的 loader 会转换代码至 JavaScript 中，然后解析器解析这些代码到 ATS 中。</p>\n<h3>6.模板（Templates ）</h3>\n<p>模板随后会把解析过的模块对象和生成的代码进行数据绑定。生成一个包含模块的 chunk 数组。整个模块可以分为三部分：</p>\n<ul>\n<li>块模板（Chunk Template）</li>\n<li>模块模板（Module Template）</li>\n<li>依赖模板（Dependency Templates）</li>\n</ul>\n<p>这个处理过程会重复执行直到处理完所有的依赖。webpack 的核心工作是解析文件并将所有内容捆绑到一个依赖图中。这使得 webpack 可以增量编译。</p>\n<h2>小结</h2>\n<p>webpack 的出现使前端工程化迈向了新的台阶，使我们开发更便捷。webpack 提供的能力也促进了社区的发展来完善构建流程。</p>","frontmatter":{"title":"webpack 基本原理","date":"December 04, 2019","description":"本文主要介绍了对webpack的初步认识以及内部的工作原理。"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/webpack-behind-the-scene/","previous":{"fields":{"slug":"/promise-from-scratch/"},"frontmatter":{"title":"简单的Promise实现"}},"next":{"fields":{"slug":"/tagged-template-literals/"},"frontmatter":{"title":"神奇的模板字符串"}}}}}