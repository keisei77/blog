{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/react-virtual-dom-and-diff/","result":{"data":{"site":{"siteMetadata":{"title":"学习随笔"}},"markdownRemark":{"id":"fac885d8-04d1-563d-bebf-e2833239396a","excerpt":"写了这么久的 React，你或许对虚拟 DOM 是怎么工作的感到好奇，本文将通过解读部分  和  源码来尝试作详细的解释。在开始前，你是否考虑过为什么我们不是直接对 DOM 进行修改？  接下来的章节将总结一下 DOM 是如何被创建的，并给出为什么 React 首先会创建虚拟 DOM 的原因。 理解 DOM…","html":"<p>写了这么久的 React，你或许对虚拟 DOM 是怎么工作的感到好奇，本文将通过解读部分 <code class=\"language-text\">React</code> 和 <code class=\"language-text\">React DOM</code> 源码来尝试作详细的解释。在开始前，你是否考虑过为什么我们不是直接对 DOM 进行修改？</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3fa419ab1c7985e55a5ae2ce264949c8/1241b/render-circle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.99386503067485%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABcElEQVQoz21SUU/CMBDmzRefTPylvpoQ3nz1xQff9B8Yf4BIxEgCCUEBFRFdZIOtXVnXbV27W72xEZFwvTbXy12v931XM/8lz/PSgBxQ0bHt3JGaVjrDpTQArONwZwsmzlvBWTMe29wYjX4hBPGo63p4Eo8snWUGUPv+svq9wfB57C48n64IobHgo5lzektObsL2m5dGq1XAnbkz6L+Mhq8Yac8dSnzI85pKlQhFkkh8nvl+FEVoBIm+7orLTmKxFK9SJsx1UhFwHmABKdPq21WrxtCV+FkQncGmyVILUWAex153yhVUuJQoVMlSw9Ms6liZRZKq8bzQ9VPmYaYP6/FBXd1PipqlcytZQXsStKexRfH/iHNVs4xrfcJxgx814rt3tScZo20/fv6wXRoUV4AwFJyHSVKUcmh00SRXPU1FVjGynbxhGSIR+r4fhpyxAnnGEEQmBBKW7eF5azz+5kRKicQi8miU2GS50WB2huUX8MI39nX6qNEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"render circle\"\n        title=\"render circle\"\n        src=\"/static/3fa419ab1c7985e55a5ae2ce264949c8/799d3/render-circle.png\"\n        srcset=\"/static/3fa419ab1c7985e55a5ae2ce264949c8/00d96/render-circle.png 148w,\n/static/3fa419ab1c7985e55a5ae2ce264949c8/0b23c/render-circle.png 295w,\n/static/3fa419ab1c7985e55a5ae2ce264949c8/799d3/render-circle.png 590w,\n/static/3fa419ab1c7985e55a5ae2ce264949c8/1241b/render-circle.png 652w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>接下来的章节将总结一下 DOM 是如何被创建的，并给出为什么 React 首先会创建虚拟 DOM 的原因。</p>\n<h2>理解 DOM 是如何构建的</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bffdaae72a3f7e0e6f897fb3de65d61c/71f87/dom-build-process.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.223107569721115%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABTUlEQVQoz31Ra0/CMBTdT/enmGhi/OAHExMNKFmCxiEQI7BNNhh7sfejpRtbu1Ic6PiA4k3Tk9yee3LuKbc9Kra7KkwHd7ajwl2DbU8Vd+p5Oc7XadXI/S3AATBcgfu5t3zTLTdJe3NtqBkhit/joQylgpQ1SXScnm6GCDUy7Bs5CPlsdTvSjQdxqvlBW5R5efaZzDpuRwYSwbgm9XWzJSoBREc2OcY2NVBKMcGUViWp+QRXmFBixfHYMJcp9KEv+RN3Fcz8yIeoLJSiUH92/r0S2+sL6uKcf26NpFdHePLasqvd9D8EdR54F1F0dRjeAjD1/U6WmWuygUVBqqpkpYNCKwxAlgMMEUW4Ikme5yWmVUpIckh743mXhnnmeTwvL66FgRpZj07rJequ1mBvjP3zVSzLugB0MYZ6GE8M20OhAhQb2U2ybH+alBv8An7s++YHoKVgAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dom build process\"\n        title=\"dom build process\"\n        src=\"/static/bffdaae72a3f7e0e6f897fb3de65d61c/799d3/dom-build-process.png\"\n        srcset=\"/static/bffdaae72a3f7e0e6f897fb3de65d61c/00d96/dom-build-process.png 148w,\n/static/bffdaae72a3f7e0e6f897fb3de65d61c/0b23c/dom-build-process.png 295w,\n/static/bffdaae72a3f7e0e6f897fb3de65d61c/799d3/dom-build-process.png 590w,\n/static/bffdaae72a3f7e0e6f897fb3de65d61c/71f87/dom-build-process.png 753w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>来自 Mozilla: <a href=\"https://developer.mozilla.org/en-US/docs/Mozilla/Introduction_to_Layout_in_Mozilla\">Basic Data Flow</a></p>\n<p>我们不会详细介绍 DOM 是如何创建并在屏幕上打印的，可以通过<a href=\"https://developer.mozilla.org/en-US/docs/Introduction_to_Layout_in_Mozilla\">这篇</a>和<a href=\"http://taligarsiel.com/Projects/howbrowserswork1.htm#Parsing_general\">这篇</a>了解从 HTML 转换成 DOM 并打印到屏幕上的全流程。</p>\n<p>DOM 是一种树形结构，每次对 DOM 操作都是很快的，但是被改变的部分，和它的子代元素需要执行<strong>重绘/重排</strong>（<strong>Reflow/Layou</strong>）步骤，改变的部分需要重新渲染，这个过程是比较慢的。所以越多的元素重绘/重排，你的应用就会越慢。</p>\n<p>虚拟 DOM 是减少这两个步骤，为大型复杂应用提供更好的性能表现。</p>\n<h2>理解虚拟 DOM</h2>\n<p>现在了解了 DOM 是如何构建的，我们来看一下虚拟 DOM。我们将通过一个简单的应用来解释虚拟 DOM 是如何工作的。通过视觉化会比较容易理解。</p>\n<blockquote>\n<p>我们不会对首次渲染进行过多解释，会专注于重新渲染，这会帮助我们理解虚拟 DOM 和 diff 的工作原理。一旦了解了这部分内容，首次渲染的理解就会非常容易。</p>\n</blockquote>\n<p>下面是一个简单的计算器</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 337px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7b2e308585291237a12e35044afdbd61/a4aa2/basic-calculator.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.66765578635015%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABZElEQVQoz6WSbVOCUBCF+f8/I+tz4WQEKGoqcGl8qQkUTAQREBRwUEl5M9JqQmjGpufjvXvm7O5ZKN6niKIoCIL9eUAohl5dXjyzfQRDxdGIYRhZEm/gW4psVogHGC5VyjgDKLY/ONSnvCCuz5WxexIwGI5LY0mW5akiIwja67RrtQZeJqoEASiSH4of0jgt3v8DyJqbAs/zw1dVmQCamkxVVVXmln2c/5sTz0+xwL3U67XiXanVbACabJEUTZOKpmebzBHnviZGYZrEPEesT1WOHRiGPpsvTNN0V65/IEiz3W5zxDNN51jBse2FZen6zHacTR7r9Trxzzhr2iPTThISRZHnhfFYWi6XcRSdtJ2YZzuHTGMGAM1ybK/TJRtNQNGGYSQfxzl/EmaAvq4yPu42jMLd2UCu6zqO4202nue5q1XuVn+N6qnXhYtFBL6+KhTQSjXw/XMSTuXs73ae9/bX83wHHQdUVYEnRsoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"basic calculator\"\n        title=\"basic calculator\"\n        src=\"/static/7b2e308585291237a12e35044afdbd61/a4aa2/basic-calculator.png\"\n        srcset=\"/static/7b2e308585291237a12e35044afdbd61/00d96/basic-calculator.png 148w,\n/static/7b2e308585291237a12e35044afdbd61/0b23c/basic-calculator.png 295w,\n/static/7b2e308585291237a12e35044afdbd61/a4aa2/basic-calculator.png 337w\"\n        sizes=\"(max-width: 337px) 100vw, 337px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ReactDOM <span class=\"token keyword\">from</span> <span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Calculator</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> output<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> IntegerA<span class=\"token punctuation\">,</span> IntegerB<span class=\"token punctuation\">,</span> IntegerC<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h2</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">using React</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h2</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          Input 1:\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">placeholder</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Input 1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>input1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>input</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          Input 2 :</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">placeholder</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Input 2<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>input2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>input</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span>\n            <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>add<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              IntegerA <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">findDOMNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>refs<span class=\"token punctuation\">.</span>input1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              IntegerB <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">findDOMNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>refs<span class=\"token punctuation\">.</span>input2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              IntegerC <span class=\"token operator\">=</span> IntegerA <span class=\"token operator\">+</span> IntegerB<span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> output<span class=\"token punctuation\">:</span> IntegerC <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n          <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            Add\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span>\n            <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>subtract<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              IntegerA <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">findDOMNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>refs<span class=\"token punctuation\">.</span>input1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              IntegerB <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">findDOMNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>refs<span class=\"token punctuation\">.</span>input2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              IntegerC <span class=\"token operator\">=</span> IntegerA <span class=\"token operator\">-</span> IntegerB<span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> output<span class=\"token punctuation\">:</span> IntegerC <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n          <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            Subtract\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>hr</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h2</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Output: </span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h2</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Calculator.js</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Calculator <span class=\"token keyword\">from</span> <span class=\"token string\">'./Calculator'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Layout</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Basic Calculator</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Calculator</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Main.js</p>\n<p>初次渲染后 DOM 的结构：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 397px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b90b0dbade3fdf737d45b6f465961c1d/3c7c4/dom-structure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 136.27204030226702%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsSAAALEgHS3X78AAACYklEQVQ4y5VTCW7jMAzs/9+3wAK7aJo0tmvLsu6DOr2UnXZ7oElKKHYMacjRcPjwt+O/f02HR9Ut7jTH05wGkXH1PPcs4Rq+Xw+lFsm46iUwwkbCiCigS7A1hfVWPNRaU85OevXCh+MfRvq5O07nw9g/O+tBejzwLbiUgi9jjB41nwntnyhlTyd2OCzToKIPa11vgFNOmio5cELGhS6EzFZZEHCl7IU2vjCFt14LlWvhlttgpJMu+RAh57Ri9e3Yp1QNvONxnzI6kWlciLTaRZdyLOutyhdwrVorI+xEO0LPwzwzacCpYFW0MuIfSNrEEDLGO9pb9hyzPAvHfHIaTxuTrUnJKZCLlzRo5l1kDJxLKeUPgsUUFVN60q1zteS2Uq2l3kkbs3DBhRLDMjDNmOEWHOyCNXbt0Pb7ovZ+Zy45akb4zDTXXoUU0H/3CbZWTbWdHZvPjJz6kRP8FMTMvaWDW16MhmnySsUI8cOdUUArrXwWKaT1fUNb5lJrE6GUmhK+6hvZV3DJ3jgzaS8hWgfWChGtsVLJqCJwyCFfo42hXiR/5IYQtZBz585nQYgkPemeOkqoExb974V7a8FFMKyMZpadTJB2qkgy57aJmqHz8V4llRLb8/Ng4J7Tjfb+eWf8p+29l6PIm2Bl06dVf41rU7UHgBdSzGKmiqJPcLAsWEiAl7pRuYEjtKmaRkSivbTXSOGKTz6A0VI4w4thR3LsaNezfmlZ7H2VARtslVM9G5A5kdM21ekOe5aiBgnK/0zt3YfYpzaSV2fwC7hsfeIO7VXKD5CXysGAOPHo4/rD+AdryyriQlVhxAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dom structure\"\n        title=\"dom structure\"\n        src=\"/static/b90b0dbade3fdf737d45b6f465961c1d/3c7c4/dom-structure.png\"\n        srcset=\"/static/b90b0dbade3fdf737d45b6f465961c1d/00d96/dom-structure.png 148w,\n/static/b90b0dbade3fdf737d45b6f465961c1d/0b23c/dom-structure.png 295w,\n/static/b90b0dbade3fdf737d45b6f465961c1d/3c7c4/dom-structure.png 397w\"\n        sizes=\"(max-width: 397px) 100vw, 397px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>React 内部构建组件树的方式：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3517317595645abc36f5b23c6bc82098/b66d4/react-internal-build-component-tree.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.45454545454545%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAChUlEQVQoz3WSW08TQRTH9yP4QXzw1RhJjAR88Y1EiC8aHtBHvIQEEhLkRQWtGCxGiEVpTcVqwiVYI4hQAcvNS6nQloJAu2wvuzu3nb3N7rqwiiSEf04mJzPnN3POP8PhQ0IIaxQLIj7VWTjRIkwkiiYRMcHHiXOOCFIjvg5mM0BEVFVV53j9hW3blgFyTKV/Ua/yFwLz1HFY0wi44M83RCBS2X7NEdjdsvbCNk3m2FZwWb32RgosuLAdnIeNEf7pDNQMdvCGdegOzsu9VWf21bB0xrdVGwLMspK8dmd4ezJF3CPrH+JWHtAcsx2ZGCIgmkqxon5eKYRj67NrxbIM0zl5IStndyFEiO4LY0Lofxe4rphS5edr+sUfOe16RK7qEVo/4ImUcq5bOO8Xvv7Wlna0mv5yAZludXBRqQ9LBrO9FrjJjOoOdn8ClIg1nEC+cWF0haQLWs90+cmUuCUaOcACcazoLmCt5GlkGdqm6s3Bre5qjz8VQ3GJeWOrimuKm5iGYeqaZxJBwE3ujkP/tHTvo1TZnb/yGkHV4lTDSvN4p6wwXbE0olHi2KYbpk4NnXowgi5s9s3Bwe9K+ButD+abR2Wi29xPXk/xZChptI8VuqZQqsTiGzCRU3yTctuo4Ja+XFTbRnL+GOiJgY4o/3xelSHSdW2v7epnUu2AVBcEZx9k60Lg1gi+2Ftqfk8vvSid7sg2DpMbQ6Di4Ub9IL4cFCs60w1vkYwUm+35x/GQuVb9EvRoEs9taiJhPLJExZrbpNEk+rJpDMSlwEwxuqYHZkq9sdKrJZzYBoltlClb3HH/lu1/i/aodLI9E4iT2+92qx9lWsekSl+mpi/fMpi6GVr9A55D2lhlm3ohAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"react internal build component tree\"\n        title=\"react internal build component tree\"\n        src=\"/static/3517317595645abc36f5b23c6bc82098/799d3/react-internal-build-component-tree.png\"\n        srcset=\"/static/3517317595645abc36f5b23c6bc82098/00d96/react-internal-build-component-tree.png 148w,\n/static/3517317595645abc36f5b23c6bc82098/0b23c/react-internal-build-component-tree.png 295w,\n/static/3517317595645abc36f5b23c6bc82098/799d3/react-internal-build-component-tree.png 590w,\n/static/3517317595645abc36f5b23c6bc82098/b66d4/react-internal-build-component-tree.png 825w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>当按下 Add 按钮时发生了什么</h3>\n<p>我们在两个输入框中输入 100 和 50 并按下 <strong>Add</strong> 按钮。</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">Input 1: 100\nInput 2: 50\n\nOutput: 150</code></pre></div>\n<p>当按下 <strong>Add</strong> 按钮时，我们对 <strong><em>State</em></strong> 设置了新的值：150。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">//Calculator.js</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span>\n  <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>add<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    IntegerA <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">findDOMNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>refs<span class=\"token punctuation\">.</span>input1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    IntegerB <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">findDOMNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>refs<span class=\"token punctuation\">.</span>input2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    IntegerC <span class=\"token operator\">=</span> IntegerA <span class=\"token operator\">+</span> IntegerB<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> output<span class=\"token punctuation\">:</span> IntegerC <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n<span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  Add\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h3>将组件标记为脏值</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 543px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/774c95201fdd2a386e74a5d3f9a384e8/bd6bc/marking-component-dirty.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.436464088397784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABe0lEQVQY021QT0sCURzcS7cuQnXuE3iuQ13KQ0JE9z5CUNekQ4ZEUHmI3FKoQ4hQp1SwCMoKForMSxbuYbVS3BZ3bfftPvfPe29fuoJeHIY5/H4zDAxDh8H1NPkG1zNw48Zay8BUEfbvfTDDw10Xnj2CzKo7tV9j1tzAiQn+JKFS/VPVQdglxMW4Q0pIN9QhQi5ClJK9ez14ZqwklcVzK/pkUuIAaJq2gwnFnnd4cwemp46pS2Kdoja2DBfb1O0QDZphoSCzrHIcVy8vtOucLYpYEMDtbTWVUh4e5Z9aSwWqBjRNKwoyxytZrvzesD9Ex0KEAS/P5fDW53b4O52G0q/F88bYmOL3S4GAOTJixmLeSPjlyxrfsUa3nZlDcSKiMyFj905nCKVKGzahIbWUNqWoXoeTk63p6UYwqPt8MJEgXjhfBvOsuBRvLET55dPmHCsf3LWY3rKDnTFGlQrkOJDP41IJ63rvLQE7kvvdzDZDV+LWtRrKyK9V+A+tf5k2fPY/aQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"marking-component-dirty\"\n        title=\"marking-component-dirty\"\n        src=\"/static/774c95201fdd2a386e74a5d3f9a384e8/bd6bc/marking-component-dirty.png\"\n        srcset=\"/static/774c95201fdd2a386e74a5d3f9a384e8/00d96/marking-component-dirty.png 148w,\n/static/774c95201fdd2a386e74a5d3f9a384e8/0b23c/marking-component-dirty.png 295w,\n/static/774c95201fdd2a386e74a5d3f9a384e8/bd6bc/marking-component-dirty.png 543w\"\n        sizes=\"(max-width: 543px) 100vw, 543px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>首先我们来了解第一步，组件是如何被标记为脏值的。</p>\n<ol>\n<li>所有 DOM 的事件监听器都被 React 自定义的事件监听器所包装。所以当按下 <strong><em>Add</em></strong> 时，事件被发送到 react 的事件监听器，所以会执行上面的匿名函数。</li>\n<li>在匿名函数中，我们调用了 <strong><em>this.setState()</em></strong> 函数并传入了新值。</li>\n<li><strong><em>setState()</em></strong> 函数会将该组件标记为脏值。</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// ReactUpdate.js - enqueueUpdate(component) function</span>\ndirtyComponents<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>你可能会好奇，为什么 React 不直接将按钮标记为脏值，而是整个组件，那是因为，在调用 setState 时，通过 <strong>this.setState()</strong> 调用的，<strong>this</strong> 在这里指向的是 <strong>Calculator</strong> 组件实例。</p>\n</blockquote>\n<ol start=\"4\">\n<li>现在，<strong>Calculator</strong> 组件被标记为脏值。</li>\n</ol>","frontmatter":{"title":"虚拟DOM和diff算法在React中的工作方式","date":"January 19, 2020","description":"本文主要介绍React中的虚拟DOM和diff算法是如何工作的，以及部分源码解读"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"tags":["React","React diff","Virtual DOM"],"slug":"/react-virtual-dom-and-diff/","previous":null,"next":{"excerpt":"最近在看 Redux 文档，了解了 redux 的工作原理，发现 action 只能同步被 dispatch，那有没有办法执行异步调用呢？答案是通过中间件来实现。之前简单了解过 Node.js 服务端框架 Express 和 Koa…","fields":{"slug":"/understanding-the-middleware/"},"frontmatter":{"date":"January 12, 2020","description":"了解中间件的概念","title":"了解中间件","tags":["middleware"]}}}}}