{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/react-renderimg-process/","result":{"data":{"site":{"siteMetadata":{"title":"学习随笔"}},"markdownRemark":{"id":"b5d0b343-b09e-53ed-9199-556900ad6db4","excerpt":"前言 前段时间测试同学找我看了一个问题，客户环境某详情页打开时，浏览器当前页就会卡住，控制台没有报错，无法进行任何操作，而只有该 id 的详情页有问题。遇到这种情况，首先想到的是某段代码出现了内存泄漏，但是线上环境代码是混淆后的，sourcemap…","html":"<h3>前言</h3>\n<p>前段时间测试同学找我看了一个问题，客户环境某详情页打开时，浏览器当前页就会卡住，控制台没有报错，无法进行任何操作，而只有该 id 的详情页有问题。遇到这种情况，首先想到的是某段代码出现了内存泄漏，但是线上环境代码是混淆后的，sourcemap 由于证书问题无法下载，只能硬着头皮去打断点一点点调试。</p>\n<h3>使用 performance 工具记录脚本运行过程</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e5bd74990ea1ea34ae7d076f2656aa5a/b89a9/infinite-looping.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.052083333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHYdGsiof/EABUQAQEAAAAAAAAAAAAAAAAAABAB/9oACAEBAAEFAmP/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAbEAACAQUAAAAAAAAAAAAAAAAAAWEQESExQf/aAAgBAQABPyFpp8LuDMGlf//aAAwDAQACAAMAAAAQkM//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQMBAT8QuK//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPxBH/8QAHhABAAICAQUAAAAAAAAAAAAAAQCRESFRMUFx4fD/2gAIAQEAAT8QQG33mAGivuZXUpAdhUwcFTBwVP/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"infinite looping\"\n        title=\"infinite looping\"\n        src=\"/static/e5bd74990ea1ea34ae7d076f2656aa5a/88218/infinite-looping.jpg\"\n        srcset=\"/static/e5bd74990ea1ea34ae7d076f2656aa5a/7237a/infinite-looping.jpg 148w,\n/static/e5bd74990ea1ea34ae7d076f2656aa5a/0cfdf/infinite-looping.jpg 295w,\n/static/e5bd74990ea1ea34ae7d076f2656aa5a/88218/infinite-looping.jpg 590w,\n/static/e5bd74990ea1ea34ae7d076f2656aa5a/77d57/infinite-looping.jpg 885w,\n/static/e5bd74990ea1ea34ae7d076f2656aa5a/5a917/infinite-looping.jpg 1180w,\n/static/e5bd74990ea1ea34ae7d076f2656aa5a/b89a9/infinite-looping.jpg 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>从上图可以看出脚本非常有规律的重复执行某段逻辑。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9a45dd5553f3951c5e89cc65bb77bdaa/b89a9/infinite-looping2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.052083333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMBBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHrLasVh//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAQEBAAAAAAAAAAAAAAAAADEAIP/aAAgBAQAGPwIiMf/EABcQAQEBAQAAAAAAAAAAAAAAAAEAERD/2gAIAQEAAT8h1ms1g9//2gAMAwEAAgADAAAAEMAP/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERUf/aAAgBAwEBPxCrCrD/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPxCI/8QAGxAAAgIDAQAAAAAAAAAAAAAAAAERITFRgbH/2gAIAQEAAT8QUe/S+vYmZbkjmrJJZ//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"infinite looping with exact call stack\"\n        title=\"infinite looping with exact call stack\"\n        src=\"/static/9a45dd5553f3951c5e89cc65bb77bdaa/88218/infinite-looping2.jpg\"\n        srcset=\"/static/9a45dd5553f3951c5e89cc65bb77bdaa/7237a/infinite-looping2.jpg 148w,\n/static/9a45dd5553f3951c5e89cc65bb77bdaa/0cfdf/infinite-looping2.jpg 295w,\n/static/9a45dd5553f3951c5e89cc65bb77bdaa/88218/infinite-looping2.jpg 590w,\n/static/9a45dd5553f3951c5e89cc65bb77bdaa/77d57/infinite-looping2.jpg 885w,\n/static/9a45dd5553f3951c5e89cc65bb77bdaa/5a917/infinite-looping2.jpg 1180w,\n/static/9a45dd5553f3951c5e89cc65bb77bdaa/b89a9/infinite-looping2.jpg 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>当放大到某段执行过程时，可以看到其中充斥着大量的 react 执行逻辑，而想要找到真正的我们代码中的逻辑还需要再进一步去发掘。</p>\n<p>从 react 源码点进去看 <code class=\"language-text\">performWorkUntilDeadline</code> 这个函数，主要是取当前时间和产出间隔时间相加得到 deadline 然后再执行从调度器传入的回调函数。这里有个我感觉比较新的 API：<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel\">MessageChannel</a>，感兴趣的可以了解下，生成两个端口进行通信。</p>\n<h3>本地重现</h3>\n<p>在通过 performance 工具进行检查之外，还有一种比较简单的方法是本地模拟。因为只有该 id 出现了问题，大概率是数据处理上没有做好兼容，那么根据线上数据可以构建本地环境方便调试。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9db6c17e75c148a767933d83a435cd38/b89a9/memory-overflow.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.052083333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIFA//EABUBAQEAAAAAAAAAAAAAAAAAAAED/9oADAMBAAIQAxAAAAHanNpUHHJv/8QAGxAAAQQDAAAAAAAAAAAAAAAAAQACAxEQEhP/2gAIAQEAAQUCbHSDRWoUBPW8f//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/ASf/xAAWEQADAAAAAAAAAAAAAAAAAAADEDH/2gAIAQIBAT8BJV//xAAcEAACAQUBAAAAAAAAAAAAAAAAAgEQEiExQVH/2gAIAQEABj8CuaFz6cNDRX//xAAbEAEAAgIDAAAAAAAAAAAAAAABABEhMUFhkf/aAAgBAQABPyFEUKdsSqayOCFOnktZU7zLQ0T/2gAMAwEAAgADAAAAEKsv/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8QI//EABcRAQEBAQAAAAAAAAAAAAAAAAEAESH/2gAIAQIBAT8QTw2t/8QAGxAAAgIDAQAAAAAAAAAAAAAAAREAITFRoYH/2gAIAQEAAT8QMZFG+14AoxJDQ1I8iy/xDAFkoHSzuYL5Oaf/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"memory overflow\"\n        title=\"memory overflow\"\n        src=\"/static/9db6c17e75c148a767933d83a435cd38/88218/memory-overflow.jpg\"\n        srcset=\"/static/9db6c17e75c148a767933d83a435cd38/7237a/memory-overflow.jpg 148w,\n/static/9db6c17e75c148a767933d83a435cd38/0cfdf/memory-overflow.jpg 295w,\n/static/9db6c17e75c148a767933d83a435cd38/88218/memory-overflow.jpg 590w,\n/static/9db6c17e75c148a767933d83a435cd38/77d57/memory-overflow.jpg 885w,\n/static/9db6c17e75c148a767933d83a435cd38/5a917/memory-overflow.jpg 1180w,\n/static/9db6c17e75c148a767933d83a435cd38/b89a9/memory-overflow.jpg 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在任务管理器中可以看到当前页面占用了 94%的 CUP 和 1.5G 的内存，而且控制台报错瞬间达上千条。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e9f08c2e8b14b50d91036180beaa4581/65739/warning.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 104.76758045292014%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAACM0lEQVQ4y41Ui5KaQBC8//+pJCogLxEBxVNPwOOCCj7YXVAUSK/mEo2SuqqpraLYpnume3g5huEhSVgYMsvKB1ZmDnAyw8xsJ+v3s8Egt2y8WjnDxHV5jcfxyI1tm3r+S52m9X6POk4mTNep1GWKiiKilGl6bg4Oo9H546Pebu9qs8H5Uu92vNL0tHhnskxabSqKTNXo5RO5bRfTWYXb12t/Cny73V9wEQQcI4qZ0eeEw+FxOjt5HueBun/Al7plXhCpS2XlOH4t5vNyHVfrdRktyygqV+vqk+0ZeL+HbNLukE6HKgrImaYzWcEjb0RRC8+v0GcTc+H7RBRxlbTbFMiewRSFyjK04CuZrp98v75v/kZ2EGDUpNXhAIDVy8B7vd+Y7X9kc/CCUwkYtYrKTTO3LPh3DsNH2DNmRaWCREWJNwyTbad4m5fL5VPkA1hWaFfO9B46zPpm7jiF552j6CvgxXU2wHC1cCiOy59R/ZiQZ1YtIJh0hMwwEEmE5GA7ed/kj+64ipOakGZmPyA/WtwqzExT0TOVJMwPzqXfvsOIg+tWSdLoM9N4PIkgXNcD/fOcWvZnWqeNYAwMa0RaLcwci8knZ5pIe9YzuNWI90PCb5g9HzBoxsDAA5OL2dv5Pazi+Gs+S90USRZEuHVJWxsn3C5Xq6f4u63CSkAtOkfUDuAfjfh6rdZNbt0OLOB/ku5lE1Tt8DrBP6DaJE2ab8F8JSnfZxlIBtmqBpNhDxQ1gX8B0HB+jYradvEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"warning\"\n        title=\"warning\"\n        src=\"/static/e9f08c2e8b14b50d91036180beaa4581/799d3/warning.png\"\n        srcset=\"/static/e9f08c2e8b14b50d91036180beaa4581/00d96/warning.png 148w,\n/static/e9f08c2e8b14b50d91036180beaa4581/0b23c/warning.png 295w,\n/static/e9f08c2e8b14b50d91036180beaa4581/799d3/warning.png 590w,\n/static/e9f08c2e8b14b50d91036180beaa4581/65739/warning.png 839w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>不得不说开发环境下，react 的提醒还是比较友好的，提示出现了死循环，useEffect 中执行了 setState 操作，然后触发了重渲染，然后又导致了 useEffect 的回调执行，但是生产环境没有提示确实有点头疼。根据组件渲染层级可以很快找到出问题的组件。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8aa78b81acfd29772d2b44bf935e6f33/b89a9/react-profiler.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.052083333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAMAAf/aAAwDAQACEAMQAAABttytVMcYO//EABwQAAEDBQAAAAAAAAAAAAAAAAEAAxICBBEhMf/aAAgBAQABBQJljcRmIVsSX6+r/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8BJ//EABYRAQEBAAAAAAAAAAAAAAAAABEDEP/aAAgBAgEBPwGi5//EABsQAAICAwEAAAAAAAAAAAAAAAABAhEQEjFx/9oACAEBAAY/AtpJMqkcOsj7j//EAB0QAQACAQUBAAAAAAAAAAAAAAEAEVEQMWGBkaH/2gAIAQEAAT8hso5+dSkghMTheSurFO7MnT//2gAMAwEAAgADAAAAEFj/AP/EABURAQEAAAAAAAAAAAAAAAAAABEA/9oACAEDAQE/EARf/8QAFhEBAQEAAAAAAAAAAAAAAAAAAREA/9oACAECAQE/EJSurv/EAB0QAQEAAQQDAAAAAAAAAAAAAAERABAhQWExscH/2gAIAQEAAT8QCKNQ7cMfcXADQB4k94GS/aM4QgqmNEEUDGUjtp//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"react profiler\"\n        title=\"react profiler\"\n        src=\"/static/8aa78b81acfd29772d2b44bf935e6f33/88218/react-profiler.jpg\"\n        srcset=\"/static/8aa78b81acfd29772d2b44bf935e6f33/7237a/react-profiler.jpg 148w,\n/static/8aa78b81acfd29772d2b44bf935e6f33/0cfdf/react-profiler.jpg 295w,\n/static/8aa78b81acfd29772d2b44bf935e6f33/88218/react-profiler.jpg 590w,\n/static/8aa78b81acfd29772d2b44bf935e6f33/77d57/react-profiler.jpg 885w,\n/static/8aa78b81acfd29772d2b44bf935e6f33/5a917/react-profiler.jpg 1180w,\n/static/8aa78b81acfd29772d2b44bf935e6f33/b89a9/react-profiler.jpg 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在这里不得不称赞一下，react devtool 中 profiler 非常好用的功能，它能记录组件渲染的变化情况，会指出是什么原因导致的某个组件重新渲染，帮我们快速定位问题，以及排查避免不必要的组件进行渲染。</p>\n<h3>罪魁祸首</h3>\n<p>在经过本地复现和查看对应源码时发现，某同事之前修改了一个较为底层的 custom hook，在这个 hook 中，原本在 useEffect 回调中创建了一个变量，默认值为 <code class=\"language-text\">[]</code>，被提到了外层作用域，然后把这个变量加入了 useEffect 的依赖数组中：</p>\n<p>改之前：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">useFetcher</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> options <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> codes <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_</span> <span class=\"token operator\">=></span> _<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// setState()</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>改之后：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">useFetcher</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> options <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> codes <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_</span> <span class=\"token operator\">=></span> _<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// setState()</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>codes<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>问题发生在 props 中 options 是空数组时，codes 也是空数组，当组件调用 <code class=\"language-text\">useFetcher</code> 时，每次 codes 都会创建新的 <code class=\"language-text\">[]</code>，导致组件重复渲染，进而重复调用 <code class=\"language-text\">useFetcher</code> 。</p>\n<h3>解决方式</h3>\n<p>如果多个地方用到了某个变量，并且需要保持一致时，可以通过使用 <code class=\"language-text\">useMemo</code> 来缓存，这样就避免了每次生成新的对象。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">useFetcher</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> options <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> codes <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> options<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_</span> <span class=\"token operator\">=></span> _<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>options<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// setState()</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>codes<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>反思</h3>\n<p>虽然这个问题解决起来非常简单，但是发现问题的过程并不是那么容易，所以但凡有趁手的工具就尽量利用起来。归根结底说起来还是要对 javascript 基础重视起来，常见的重渲染问题许多都是因为 props 的引用导致的，即没有将变量缓存起来。</p>\n<p>推荐一篇博文：<a href=\"https://blog.isquaredsoftware.com/2020/05/blogged-answers-a-mostly-complete-guide-to-react-rendering-behavior/\">A (Mostly) Complete Guide to React Rendering Behavior</a></p>","frontmatter":{"title":"React 重渲染问题记录","date":"September 08, 2020","description":"本文从一个bug导致 React 重渲染的发生，了解有哪些方法工具避免不必要的重渲染。"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"tags":["React","optimize"],"slug":"/react-renderimg-process/","previous":null,"next":{"excerpt":"前言 最近深感能力不足，于是开始了每日的 leetcode 刷题。为了以后复习方便，单独开了一个仓库进行存档。每道题目为单个 md 文件，commit…","fields":{"slug":"/basic-bash-script/"},"frontmatter":{"date":"July 31, 2020","description":"学习基本的 bash 脚本来提高自动化能力","title":"bash 脚本入门","tags":["Bash"]}}}}}