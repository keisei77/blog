{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/mini-editor/","result":{"data":{"site":{"siteMetadata":{"title":"学习随笔"}},"markdownRemark":{"id":"126a35f6-53e5-54ca-99ef-fe4a346e4d69","excerpt":"前言 之前曾有打算做一个富文本编辑器，最近花了一些时间开始开发，目前处于原型开发阶段。这其中遇到了一些棘手的问题，在此先记录一下。 初步构建 通过 CRA（create-react-app…","html":"<h3>前言</h3>\n<p>之前曾有打算做一个富文本编辑器，最近花了一些时间开始开发，目前处于原型开发阶段。这其中遇到了一些棘手的问题，在此先记录一下。</p>\n<h3>初步构建</h3>\n<p>通过 CRA（<a href=\"https://github.com/facebook/create-react-app\">create-react-app</a>）快速搭建项目。\n根据常见的编辑器样式，确定分为工具栏和输入框组件。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d6ea7377fc13429772d26e6d2bb536a/50cab/prototype-editor.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.890625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAbklEQVQoz6WSwQqAIBBE9/+/UbtYeFwVpJDVKTOpc/tg2NvwBpbssmDbHIyxqLWi01r7HXJuhfceMSWIiDoUQgAzY6Kx6wvpW6ThqhyFGqNbYt5h9Rr+NxtkKYjlAHVNTeT5DLcn2Mz6ye07+eIEEmZ46zdxaIYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"prototype editor\"\n        title=\"prototype editor\"\n        src=\"/static/1d6ea7377fc13429772d26e6d2bb536a/799d3/prototype-editor.png\"\n        srcset=\"/static/1d6ea7377fc13429772d26e6d2bb536a/00d96/prototype-editor.png 148w,\n/static/1d6ea7377fc13429772d26e6d2bb536a/0b23c/prototype-editor.png 295w,\n/static/1d6ea7377fc13429772d26e6d2bb536a/799d3/prototype-editor.png 590w,\n/static/1d6ea7377fc13429772d26e6d2bb536a/50cab/prototype-editor.png 768w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>工具栏</h4>\n<p>工具栏暂定加粗、斜体、下划线三种样式。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Toolbar</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token operator\">:</span> Toolbar</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> toolbarState<span class=\"token punctuation\">,</span> toolbarDispatch <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Toggle</span></span>\n        <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>bold<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">label</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>粗体<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">enabled</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>toolbarState<span class=\"token punctuation\">.</span>bold<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n          <span class=\"token function\">toolbarDispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'bold'</span><span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> toolbarState<span class=\"token punctuation\">.</span>content <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BoldSvg</span></span> <span class=\"token attr-name\">enabled</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>toolbarState<span class=\"token punctuation\">.</span>bold<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Toggle</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Toggle</span></span>\n        <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>italic<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">label</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>斜体<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">enabled</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>toolbarState<span class=\"token punctuation\">.</span>italic<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n          <span class=\"token function\">toolbarDispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'italic'</span><span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> toolbarState<span class=\"token punctuation\">.</span>content <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItalicSvg</span></span> <span class=\"token attr-name\">enabled</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>toolbarState<span class=\"token punctuation\">.</span>italic<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Toggle</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Toggle</span></span>\n        <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>underline<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">label</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>下划线<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">enabled</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>toolbarState<span class=\"token punctuation\">.</span>underline<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n          <span class=\"token function\">toolbarDispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'underline'</span><span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> toolbarState<span class=\"token punctuation\">.</span>content <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UnderlineSvg</span></span> <span class=\"token attr-name\">enabled</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>toolbarState<span class=\"token punctuation\">.</span>underline<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Toggle</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>工具栏部分主要是各种按钮，以及点击时应该执行的 action。</p>\n<p>这里工具栏 Icon 采用了 svg 文件，这样我们可以修改它的 fill 属性来向用户表明是否是选中的：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f0cde03962a4c815094634ccb0d6f529/95c41/indicate-button-enabled.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.68627450980392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAcElEQVQoz61RSQqAMBDr//9oXQaXk3WvYjvRiop4HA3kMpBMQlRWlNBxAq0jEBECvPciMjNU1fSgvICp6+MgNQt0zkFN44DGGFhr7y9SBr1i/IfD8JlKikvLb0NRzdOMbId0bPfKH4e4As1uxbKPsgHQLilCwP8UdwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"indicate button enabled\"\n        title=\"indicate button enabled\"\n        src=\"/static/f0cde03962a4c815094634ccb0d6f529/799d3/indicate-button-enabled.png\"\n        srcset=\"/static/f0cde03962a4c815094634ccb0d6f529/00d96/indicate-button-enabled.png 148w,\n/static/f0cde03962a4c815094634ccb0d6f529/0b23c/indicate-button-enabled.png 295w,\n/static/f0cde03962a4c815094634ccb0d6f529/799d3/indicate-button-enabled.png 590w,\n/static/f0cde03962a4c815094634ccb0d6f529/95c41/indicate-button-enabled.png 765w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>输入框</h4>\n<p>输入框部分，我们不能使用 textarea 标签来渲染的原因是不能对它的内容改变样式。我们使用了 <code class=\"language-text\">contentEditable</code> 属性来使 div 变为可编辑状态。</p>\n<p>另外，我们需要在输入时重置光标的位置，否则光标会一直在文本首位闪烁。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resetCaret</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token operator\">:</span> HTMLElement</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> tailNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  el<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>tailNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> isTargetFocused <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span>activeElement <span class=\"token operator\">===</span> el<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tailNode <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> tailNode<span class=\"token punctuation\">.</span>nodeValue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> isTargetFocused<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> selection <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">getSelection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selection<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> range <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createRange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      range<span class=\"token punctuation\">.</span><span class=\"token function\">setStart</span><span class=\"token punctuation\">(</span>tailNode<span class=\"token punctuation\">,</span> tailNode<span class=\"token punctuation\">.</span>nodeValue<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      range<span class=\"token punctuation\">.</span><span class=\"token function\">collapse</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      selection<span class=\"token punctuation\">.</span><span class=\"token function\">removeAllRanges</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      selection<span class=\"token punctuation\">.</span><span class=\"token function\">addRange</span><span class=\"token punctuation\">(</span>range<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>el <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">HTMLElement</span><span class=\"token punctuation\">)</span> el<span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Textarea</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token operator\">:</span> Textarea</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> content<span class=\"token punctuation\">,</span> changeHandler <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> elRef <span class=\"token operator\">=</span> useRef <span class=\"token operator\">&lt;</span> HTMLDivElement <span class=\"token operator\">></span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> isMount <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>elRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>elRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>content <span class=\"token operator\">!==</span> elRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      elRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> content<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">resetCaret</span><span class=\"token punctuation\">(</span>elRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>content<span class=\"token punctuation\">,</span> isMount<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n      <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>textarea<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">contentEditable</span>\n      <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>elRef<span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">onInput</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token function\">changeHandler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">onBlur</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token function\">changeHandler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">onKeyUp</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token function\">changeHandler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">onKeyDown</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token function\">changeHandler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>content<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>那么我们是如何知道用户选择了哪些文本呢？</h4>\n<p>我们可以通过 <code class=\"language-text\">window.getSelection()</code> 这个函数来获取用户选择的文本对象。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5e7cd2d83b2c85402f6b4ef614d5222f/c87be/selection.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.86094316807739%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAxklEQVQoz6WQ2w6DIBBE+f+P9KW3tIUqAgILOl0w9pY+tDrJCbsbMpmM0FpD3RQOxwOkkoghgogQI7+REHjvuq5irIG19gNXcW5GeO9xPV2hTgqtbBE9GwXC4IdqNhOQY0b5W2aiVGfPfwPfKY1YJHLOcHKA3vVwXcA0gZkqRcv8KyLlBHtxaBsF03OS8Wn0jx6GJaE5W/T7G8iFVaneEhZDfeyhGi5eGpR9TcJHh5QSxjwip7n0xPuWlGJJ9K2PTYavxy26A4M+xUvJe1PPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"selection\"\n        title=\"selection\"\n        src=\"/static/5e7cd2d83b2c85402f6b4ef614d5222f/799d3/selection.png\"\n        srcset=\"/static/5e7cd2d83b2c85402f6b4ef614d5222f/00d96/selection.png 148w,\n/static/5e7cd2d83b2c85402f6b4ef614d5222f/0b23c/selection.png 295w,\n/static/5e7cd2d83b2c85402f6b4ef614d5222f/799d3/selection.png 590w,\n/static/5e7cd2d83b2c85402f6b4ef614d5222f/c87be/selection.png 827w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>当选择上面的 <code class=\"language-text\">Hello</code> 时，可以看到输出了各种 Node 和各种 Offset，我们可以简单通过这些 Offset 来确定当前选中的文本。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">function</span> <span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token operator\">:</span> ToolbarState<span class=\"token punctuation\">,</span> action<span class=\"token operator\">:</span> ToolbarAction</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> currentSelection <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">getSelection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentSelection<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> selectedContent <span class=\"token operator\">=</span> currentSelection<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">let</span> currentContent <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">'bold'</span><span class=\"token operator\">:</span>\n          currentContent <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n            selectedContent<span class=\"token punctuation\">,</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;span style=\"font-weight: 700;\"></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>selectedContent<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/span></span><span class=\"token template-punctuation string\">`</span></span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span> bold<span class=\"token operator\">:</span> <span class=\"token operator\">!</span>state<span class=\"token punctuation\">.</span>bold<span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> currentContent <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">'italic'</span><span class=\"token operator\">:</span>\n          currentContent <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n            selectedContent<span class=\"token punctuation\">,</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;span style=\"font-style: italic;\"></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>selectedContent<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/span></span><span class=\"token template-punctuation string\">`</span></span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span> italic<span class=\"token operator\">:</span> <span class=\"token operator\">!</span>state<span class=\"token punctuation\">.</span>italic<span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> currentContent <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">'underline'</span><span class=\"token operator\">:</span>\n          currentContent <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n            selectedContent<span class=\"token punctuation\">,</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;span style=\"text-decoration: underline;\"></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>selectedContent<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/span></span><span class=\"token template-punctuation string\">`</span></span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span>\n            underline<span class=\"token operator\">:</span> <span class=\"token operator\">!</span>state<span class=\"token punctuation\">.</span>underline<span class=\"token punctuation\">,</span>\n            content<span class=\"token operator\">:</span> currentContent<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">'change'</span><span class=\"token operator\">:</span>\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> action<span class=\"token punctuation\">.</span>payload <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'change'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> action<span class=\"token punctuation\">.</span>payload <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> state<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>toolbarState<span class=\"token punctuation\">,</span> toolbarDispatch<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> useReducer<span class=\"token operator\">&lt;</span>\n    Reducer<span class=\"token operator\">&lt;</span>ToolbarState<span class=\"token punctuation\">,</span> ToolbarAction<span class=\"token operator\">></span>\n  <span class=\"token operator\">></span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    content<span class=\"token operator\">:</span> <span class=\"token string\">'&lt;div>Hello World!&lt;/div>'</span><span class=\"token punctuation\">,</span>\n    bold<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    italic<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    underline<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这部分是目前实现比较挫的地方，简单使用了 <code class=\"language-text\">useReducer</code> 来简化 setState 操作。可以看到这部分代码存在一些问题，首先由于 <code class=\"language-text\">contentEditable</code> 存在的缘故，用户输入的任何内容其实 React 并不能控制，我们只能通过各种事件的回调拿到 target 中的 innerHTML(TODO: innerText 是不是更好)</p>\n<p>当然我们可以通过 <code class=\"language-text\">document.execCommand()</code> 方法来传入对应的命令生成格式化的文本，但为了更深入地实现文本的可编辑性，我们暂时不考虑这种现成的 API。</p>\n<h3>开源 draft.js 体验</h3>\n<p><a href=\"https://draftjs.org/\">draft.js</a> 是 facebook 团队开源的 React 版富文本编辑器库，官方提供了一个简易的 Demo：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9aebc6248acb34be03dd3af267bb34ea/83225/draft.js.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.751914241960186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/0lEQVQoz51Sy3KDMAzk//+tJ9J7J6d4CjgYbPwAtpYSEYeSmbSa0ch6sKy8ruZ5RowRKSXQmeK6rm85mUSxytoRdV3j63zG6fOEy0XhXTsCr0IIaNsWxvRQSkFrjYZzg77X0NcrurbjqLs213o0TYNlWX6BM0NqyMoEHmOA955r7Fs9ckwpcp++O2RIDQKjwVt8OIE45xjgqCZgAr4xnKaJnYastRizUz4MhnMSi+bERUCxpWBZ0eG2Dq2YB+9MWP3MmuJLpYufgHIBnCaPYbQcX6m5V/apXjLcq1UO7t9Yacu992EUlLcPUeRS/+PE7Ds4uHw1G+D+gf7V91v9AMG1YsQJMjuEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"draft.js\"\n        title=\"draft.js\"\n        src=\"/static/9aebc6248acb34be03dd3af267bb34ea/799d3/draft.js.png\"\n        srcset=\"/static/9aebc6248acb34be03dd3af267bb34ea/00d96/draft.js.png 148w,\n/static/9aebc6248acb34be03dd3af267bb34ea/0b23c/draft.js.png 295w,\n/static/9aebc6248acb34be03dd3af267bb34ea/799d3/draft.js.png 590w,\n/static/9aebc6248acb34be03dd3af267bb34ea/83225/draft.js.png 653w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>RichEditor-editor<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>DraftEditor-root<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>DraftEditor-editorContainer<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n        <span class=\"token attr-name\">aria-describedby</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>placeholder-7k0cv<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>notranslate public-DraftEditor-content<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">contenteditable</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">role</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>textbox<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">spellcheck</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>false<span class=\"token punctuation\">\"</span></span><span class=\"token style-attr language-css\"><span class=\"token attr-name\">\n        <span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token property\">outline</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span> <span class=\"token property\">user-select</span><span class=\"token punctuation\">:</span> text<span class=\"token punctuation\">;</span> <span class=\"token property\">white-space</span><span class=\"token punctuation\">:</span> pre-wrap<span class=\"token punctuation\">;</span> <span class=\"token property\">overflow-wrap</span><span class=\"token punctuation\">:</span> break-word<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span>\n      <span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">data-contents</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n            <span class=\"token attr-name\">data-block</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">data-editor</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>7k0cv<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">data-offset-key</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>b6so6-0-0<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n              <span class=\"token attr-name\">data-offset-key</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>b6so6-0-0<span class=\"token punctuation\">\"</span></span>\n              <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>public-DraftStyleDefault-block public-DraftStyleDefault-ltr<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token punctuation\">></span></span>\n              <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">data-offset-key</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>b6so6-0-0<span class=\"token punctuation\">\"</span></span><span class=\"token style-attr language-css\"><span class=\"token attr-name\"> <span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token property\">font-weight</span><span class=\"token punctuation\">:</span> bold<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">data-text</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>hello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n              <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>当实现粗体时，可以看到生成的 html 中，多出了一段<code class=\"language-text\">font-weight: bold;</code>的 span，其中很关键的一处是节点上有 offset-key 的 dataset，<code class=\"language-text\">b6so6-0-0</code> 第一段为标识文本片段的随机字符串，第二段目的不明，第三段为各种样式的索引值。</p>\n<p>那么是如何实现的呢？</p>\n<p>首先我们来创建编辑器：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useState<span class=\"token punctuation\">,</span> useEffect<span class=\"token punctuation\">,</span> useCallback <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Editor<span class=\"token punctuation\">,</span> RichUtils<span class=\"token punctuation\">,</span> EditorState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'draft-js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> InlineStyleControls <span class=\"token keyword\">from</span> <span class=\"token string\">'./InlineStyleControls'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">'draft-js/dist/Draft.css'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">DraftEditor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>editorState<span class=\"token punctuation\">,</span> setEditorState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>EditorState<span class=\"token punctuation\">.</span><span class=\"token function\">createEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> editor <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">focusEditor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>editor<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">(</span>editor <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">focusEditor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> onChange <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">editorState</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">setEditorState</span><span class=\"token punctuation\">(</span>editorState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> toggleInlineStyle <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token parameter\">inlineStyle</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span>RichUtils<span class=\"token punctuation\">.</span><span class=\"token function\">toggleInlineStyle</span><span class=\"token punctuation\">(</span>editorState<span class=\"token punctuation\">,</span> inlineStyle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>onChange<span class=\"token punctuation\">,</span> editorState<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> padding<span class=\"token operator\">:</span> <span class=\"token string\">'24px'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>focusEditor<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">InlineStyleControls</span></span>\n        <span class=\"token attr-name\">editorState</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>editorState<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">onToggle</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>toggleInlineStyle<span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Editor</span></span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>editor<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">editorState</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>editorState<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>onChange<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> DraftEditor<span class=\"token punctuation\">;</span></code></pre></div>\n<p>我们以加粗为例，当点击加粗按钮时，实际上会调用 <code class=\"language-text\">RichUtils.toggleInlineStyle()</code> 方法：\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/540e2fdfa04da6df5641babb6ff1e0db/97b2d/draft-editor.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.29612756264237%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACA0lEQVQ4y61T7Y6bMBDk/Z+uf3pqc2lIckBIwAb8DdhM1+aSSxq1p1ZdaWQQ9nhmZ8maZsRmK7A7SFQVx2GXo8j3YOcOXCzggwfrPYQOsOMC41bYEdDWoyhr1Ocz2rbFsizIfhQjvrwIfH0VeNl02OQc+XFA/qaRlzMO1YztcUTNZigLIl4gzQqhApqW40yEnHN475EFaxFGum7xWILHR9HzMq/rrZan1dL5y+WCoihwOp2Q+TmAlyXq/R7H/ZGsNnC0aXQWxlg4N5KVlSKtD/ggLImj73tS6AMUyRYdQ8taDLyFFgOU1rDGYDIKSkoopRH3RpJ7GNoTLUfCqqqQVWWFC6kSQkLTIaUUpBT0/gxJxIwxNE2TUNd16t31OQaTbQ8VGO/TgSg5Hoik0co9opKu6xKGYXi66IqseFubGUlOxQm84enDSEE5NyG8Ny/aiylGhBB+i+y42xJhnTaa3kC2ilQIukCmUB5T/byyb983OFDCs58xqgmGWQxE2LAe/n2Mfg3iT8hiI2PfwhIw6Rm6MbDcom8lvRuEeX4g/VShTCOhkhonRxohja7pYAcJR6MTCZe/UJldU4qW7WAhGYVTU0ha4V/qRpgUDg79JY6PoJSn9MfEb5qUOuduiBOwToG7rdpMxHGncCJryXKn0h8zz+t4fDYm90iWZRzOZNnjf9RPuHTakzx7vL4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"draft editor\"\n        title=\"draft editor\"\n        src=\"/static/540e2fdfa04da6df5641babb6ff1e0db/799d3/draft-editor.png\"\n        srcset=\"/static/540e2fdfa04da6df5641babb6ff1e0db/00d96/draft-editor.png 148w,\n/static/540e2fdfa04da6df5641babb6ff1e0db/0b23c/draft-editor.png 295w,\n/static/540e2fdfa04da6df5641babb6ff1e0db/799d3/draft-editor.png 590w,\n/static/540e2fdfa04da6df5641babb6ff1e0db/97b2d/draft-editor.png 878w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这里 <code class=\"language-text\">editorState</code> 是我们通过 <code class=\"language-text\">EditorState.createEmpty()</code> 创建的 immutable 的初始状态，可以看到初始化了 currentContent,redoStack,selection,treeMap,undoStack 等属性。</p>\n<p><code class=\"language-text\">toggleInlineStyle</code>内部实现：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">toggleInlineStyle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">editorState<span class=\"token punctuation\">,</span> inlineStyle</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 首先获取用户选择的文本</span>\n  <span class=\"token keyword\">var</span> selection <span class=\"token operator\">=</span> editorState<span class=\"token punctuation\">.</span><span class=\"token function\">getSelection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 获取当前 style</span>\n  <span class=\"token keyword\">var</span> currentStyle <span class=\"token operator\">=</span> editorState<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentInlineStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token comment\">// 获取当前文本内容</span>\n  <span class=\"token keyword\">var</span> content <span class=\"token operator\">=</span> editorState<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> newContent<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 如果当前 style 中已有需要设置的 style，那直接去除，否则新增样式。</span>\n  <span class=\"token comment\">// 这里调用了 DraftModifier 模块来更新样式</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentStyle<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>inlineStyle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    newContent <span class=\"token operator\">=</span> DraftModifier<span class=\"token punctuation\">.</span><span class=\"token function\">removeInlineStyle</span><span class=\"token punctuation\">(</span>\n      content<span class=\"token punctuation\">,</span>\n      selection<span class=\"token punctuation\">,</span>\n      inlineStyle\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    newContent <span class=\"token operator\">=</span> DraftModifier<span class=\"token punctuation\">.</span><span class=\"token function\">applyInlineStyle</span><span class=\"token punctuation\">(</span>\n      content<span class=\"token punctuation\">,</span>\n      selection<span class=\"token punctuation\">,</span>\n      inlineStyle\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> EditorState<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>editorState<span class=\"token punctuation\">,</span> newContent<span class=\"token punctuation\">,</span> <span class=\"token string\">'change-inline-style'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">DraftModifier.applyInlineStyle</code> 内部简单调用了 <code class=\"language-text\">ContentStateInlineStyle.add(contentState, selectionState, inlineStyle);</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> ContentStateInlineStyle <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">add</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">contentState<span class=\"token punctuation\">,</span> selectionState<span class=\"token punctuation\">,</span> inlineStyle</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">modifyInlineStyle</span><span class=\"token punctuation\">(</span>contentState<span class=\"token punctuation\">,</span> selectionState<span class=\"token punctuation\">,</span> inlineStyle<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">remove</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">contentState<span class=\"token punctuation\">,</span> selectionState<span class=\"token punctuation\">,</span> inlineStyle</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">modifyInlineStyle</span><span class=\"token punctuation\">(</span>contentState<span class=\"token punctuation\">,</span> selectionState<span class=\"token punctuation\">,</span> inlineStyle<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">modifyInlineStyle</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">contentState<span class=\"token punctuation\">,</span>\n  selectionState<span class=\"token punctuation\">,</span>\n  inlineStyle<span class=\"token punctuation\">,</span>\n  addOrRemove</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> blockMap <span class=\"token operator\">=</span> contentState<span class=\"token punctuation\">.</span><span class=\"token function\">getBlockMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> startKey <span class=\"token operator\">=</span> selectionState<span class=\"token punctuation\">.</span><span class=\"token function\">getStartKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> startOffset <span class=\"token operator\">=</span> selectionState<span class=\"token punctuation\">.</span><span class=\"token function\">getStartOffset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> endKey <span class=\"token operator\">=</span> selectionState<span class=\"token punctuation\">.</span><span class=\"token function\">getEndKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> endOffset <span class=\"token operator\">=</span> selectionState<span class=\"token punctuation\">.</span><span class=\"token function\">getEndOffset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 这里 blockMap 为 immutable 类型，skipUntil，takeUntil，concat 可以简单理解为跳过某部分，获取某部分，最终获取 startKey，endKey 之间的内容。</span>\n  <span class=\"token keyword\">var</span> newBlocks <span class=\"token operator\">=</span> blockMap\n    <span class=\"token punctuation\">.</span><span class=\"token function\">skipUntil</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> k</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> k <span class=\"token operator\">===</span> startKey<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">takeUntil</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> k</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> k <span class=\"token operator\">===</span> endKey<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token function\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>endKey<span class=\"token punctuation\">,</span> blockMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>endKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">block<span class=\"token punctuation\">,</span> blockKey</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> sliceStart<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">var</span> sliceEnd<span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 这里是确定分片的起止位置</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startKey <span class=\"token operator\">===</span> endKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sliceStart <span class=\"token operator\">=</span> startOffset<span class=\"token punctuation\">;</span>\n        sliceEnd <span class=\"token operator\">=</span> endOffset<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        sliceStart <span class=\"token operator\">=</span> blockKey <span class=\"token operator\">===</span> startKey <span class=\"token operator\">?</span> startOffset <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        sliceEnd <span class=\"token operator\">=</span> blockKey <span class=\"token operator\">===</span> endKey <span class=\"token operator\">?</span> endOffset <span class=\"token operator\">:</span> block<span class=\"token punctuation\">.</span><span class=\"token function\">getLength</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">var</span> chars <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span><span class=\"token function\">getCharacterList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">var</span> current<span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 针对每个字符确定样式</span>\n      <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>sliceStart <span class=\"token operator\">&lt;</span> sliceEnd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        current <span class=\"token operator\">=</span> chars<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>sliceStart<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        chars <span class=\"token operator\">=</span> chars<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n          sliceStart<span class=\"token punctuation\">,</span>\n          addOrRemove\n            <span class=\"token operator\">?</span> CharacterMetadata<span class=\"token punctuation\">.</span><span class=\"token function\">applyStyle</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> inlineStyle<span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">:</span> CharacterMetadata<span class=\"token punctuation\">.</span><span class=\"token function\">removeStyle</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> inlineStyle<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        sliceStart<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> block<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'characterList'</span><span class=\"token punctuation\">,</span> chars<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> contentState<span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    blockMap<span class=\"token operator\">:</span> blockMap<span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>newBlocks<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    selectionBefore<span class=\"token operator\">:</span> selectionState<span class=\"token punctuation\">,</span>\n    selectionAfter<span class=\"token operator\">:</span> selectionState<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>总结</h3>\n<p>在线编辑器虽然目前是非常常见的一个功能，但是想要做到优秀的体验和强大的能力，并不是那么容易实现的。此外，通过阅读优秀项目的源码，可以为我们的工作提供一些新的思路，也能提高阅读源码的能力和速度。</p>","frontmatter":{"title":"迷你富文本编辑器","date":"April 14, 2020","description":"手撸富文本编辑器遇到的问题及参考思路"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"tags":["Editor","draft.js"],"slug":"/mini-editor/","previous":{"excerpt":"前言 当我们需要 React 服务端渲染时，需要了解  这个对象。它能够使组件渲染成静态的 html 标记。 ReactDOMServer 提供了四个方法，其中  和  可以在浏览器和 node 环境中运行， 和  由于使用了 node 中特有的 stream…","fields":{"slug":"/getting-started-react-dom-server-render/"},"frontmatter":{"date":"April 17, 2020","description":"了解 React DOM 服务端渲染过程，以 renderToString 函数为例了解整个执行逻辑","title":"入门 React DOM 服务端渲染","tags":["React DOM","Server Render"]}},"next":{"excerpt":"对于前端开发者来说，除 API…","fields":{"slug":"/what-frontend-developer-should-know-about-banckend/"},"frontmatter":{"date":"March 15, 2020","description":"本文主要介绍一些前端应该知道的后端知识点。","title":"【译】前端开发人员应该知道的后端知识","tags":["backend knowledge"]}}}}}