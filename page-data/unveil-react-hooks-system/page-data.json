{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/unveil-react-hooks-system/","result":{"data":{"site":{"siteMetadata":{"title":"学习随笔"}},"markdownRemark":{"id":"b0fcafdd-75c5-5767-b039-7d01635c80e0","excerpt":"React Hooks 在 React 16.7 版本发布后，在社区掀起了一股新的浪潮，真的是谁用谁都说真香。刚使用 Hooks 时难免会对该机制的原理感到神奇，在遇到问题时，由于它背后复杂的调用栈我们很难进行调试，所以有必要更深层次了解 React Hooks…","html":"<p>React Hooks 在 React 16.7 版本发布后，在社区掀起了一股新的浪潮，真的是谁用谁都说真香。刚使用 Hooks 时难免会对该机制的原理感到神奇，在遇到问题时，由于它背后复杂的调用栈我们很难进行调试，所以有必要更深层次了解 React Hooks 系统，这样我们遇到问题可以快速定位甚至提前避免。今天我们就来看一下 React 是如何实现的？</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/614488308537ef9bd8f60457869947e3/3dead/react-hooks-representation.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.98830409356725%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAADGElEQVQoz41RC0hTURi+m7k5TVNTVCh1EysV6SXYAyUIyqRMc5uiqCwtRVPnA0wwE8oUUckkH4WYVlIpOt3u5szNu9mcblPm3J27alNnGJj5oocP6nS3MEIoPPBxfr7/+98QtIun4zMO6GCGt47PJO5CzPTUdYV5oJyL7rrOUHctl07VcOk0LY9BxZNQUZjhicMfx0mUH+WF8qNp+E9Df/twMKl/2TRIyw23USE5tqiywmFUfs/+C3rdCkznWc0jmTZ6XspeDE60QWE6WcePJhvbg0kLLT6kudZAkp7PoGhhJgUTXKPgE1DwhLgdQYFCjYAgM0hF8pl+IDNIFus4Naf/NU3t2Ljly1G19XMdRvrv2IOz3QlKI1I+NNP/iId1uHHyC2i8irIr64gocK7ttfe2Tjj+pkr6Hjb2TXRxinhJLiYu+7HUo7BeTAJgHUqvFHtBUu1SrmRsjS1SL7O2Az/1Cjk/RlTg+5AcLCMipT1E24PTFl2qvoZejX6+RzMiYDcwqSZtQmGLz3ZcarnYBxrQr26pZ7fAwPjKakp2sRvOk43czgGgHgFApQCfRT2GQy5HbXHermNA8UQ8ujLVo57hxN8PMXVOjs6qDlDMAOfhqVV7dpXED+INfXRBtEYvkcZAWwKL1qZKa5K+O4tSRPtNMTi4gohrtjsQoG0tkknhphiDZSXCLE8T1/TWkPROt7Ih16/O13aOx5mFMoNYKJ+V4EdBvj7l1pw1VcbhuGPVhEZZOeOVsi6/Wf4w+W5rqtlf+kJx/Fn35O1GwWT2g2aVLxRUdIsgN0jS1bP9lcpppJiHVLvtPFpefYH5z+2I9s1uowfntkcFQACYudjSPld6If9UZCE/IK5M6von6IQG+FsOA+czC8Aq4wOwTdKv293ANvax1YsWJj8nJsKyMzXWEc5kOfLS4u25MREOwvDL+5tScp3gtAwHbhrbsSk5x8mcrHh6zSppYjP95uTmhURsw4+FbR5mYVtHWBNbJtu814aCEsJgQAhRHniJaCQHQcLwMIog8ioVWEIE1fljRPU5P+LPgxDhF+XhixWhsoYwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"react hooks representation\"\n        title=\"react hooks representation\"\n        src=\"/static/614488308537ef9bd8f60457869947e3/799d3/react-hooks-representation.png\"\n        srcset=\"/static/614488308537ef9bd8f60457869947e3/00d96/react-hooks-representation.png 148w,\n/static/614488308537ef9bd8f60457869947e3/0b23c/react-hooks-representation.png 295w,\n/static/614488308537ef9bd8f60457869947e3/799d3/react-hooks-representation.png 590w,\n/static/614488308537ef9bd8f60457869947e3/3dead/react-hooks-representation.png 684w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<center>React hooks 粗略概要</center>\n<p>首先让我们来了解一下确保 hooks 在 React 作用域内被调用的机制，因为如果没有在正确的上下文执行 hooks 是没有意义的：</p>\n<h3>The dispatcher</h3>\n<p>dispatcher 是一个包含 hooks 函数的共享的对象。它在 ReactDOM 渲染的时期动态地被分配或被清除，并保证用户在 React 组件外不能访问 hooks（<a href=\"https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberHooks.js#L62\">源码实现</a>）。</p>\n<p>dispatcher 在每个和每次 hook 调用时通过 <code class=\"language-text\">resolveDispatcher()</code> 函数来处理（<a href=\"https://github.com/facebook/react/blob/19f6fe170ce920d7183a5620f4e218334c8bac62/packages/react/src/ReactHooks.js#L21\">源码实现</a>）。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> currentDispatcher<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> dispatcherWithHooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* ... */</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">resolveDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentDispatcher<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> currentDispatcher<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hooks can't be called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useXXX</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dispatcher <span class=\"token operator\">=</span> <span class=\"token function\">resolveDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> dispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">useXXX</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">renderRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentDispatcher <span class=\"token operator\">=</span> dispatcherWithHooks<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">performWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  currentDispatcher <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<center>Dispatcher 简单实现</center>","frontmatter":{"title":"浅析 React Hooks","date":"January 08, 2020","description":"本文对目前大热的 React Hooks 源码进行简单剖析。"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"tags":["React Hooks"],"slug":"/unveil-react-hooks-system/","previous":null,"next":{"fields":{"slug":"/understanding-javascript-decorators/"},"frontmatter":{"title":"JavaScript 装饰器","tags":["JavaScript Decorator"]}}}}}