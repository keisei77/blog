{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/unveil-react-hooks-system/","result":{"data":{"site":{"siteMetadata":{"title":"学习随笔"}},"markdownRemark":{"id":"b0fcafdd-75c5-5767-b039-7d01635c80e0","excerpt":"React Hooks 在 React 16.7 版本发布后，在社区掀起了一股新的浪潮，真的是谁用谁都说真香。刚使用 Hooks 时难免会对该机制的原理感到神奇，在遇到问题时，由于它背后复杂的调用栈我们很难进行调试，所以有必要更深层次了解 React Hooks…","html":"<p>React Hooks 在 React 16.7 版本发布后，在社区掀起了一股新的浪潮，真的是谁用谁都说真香。刚使用 Hooks 时难免会对该机制的原理感到神奇，在遇到问题时，由于它背后复杂的调用栈我们很难进行调试，所以有必要更深层次了解 React Hooks 系统，这样我们遇到问题可以快速定位甚至提前避免。今天我们就来看一下 React 是如何实现的？</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/614488308537ef9bd8f60457869947e3/3dead/react-hooks-representation.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.98830409356725%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAADGElEQVQoz41RC0hTURi+m7k5TVNTVCh1EysV6SXYAyUIyqRMc5uiqCwtRVPnA0wwE8oUUckkH4WYVlIpOt3u5szNu9mcblPm3J27alNnGJj5oocP6nS3MEIoPPBxfr7/+98QtIun4zMO6GCGt47PJO5CzPTUdYV5oJyL7rrOUHctl07VcOk0LY9BxZNQUZjhicMfx0mUH+WF8qNp+E9Df/twMKl/2TRIyw23USE5tqiywmFUfs/+C3rdCkznWc0jmTZ6XspeDE60QWE6WcePJhvbg0kLLT6kudZAkp7PoGhhJgUTXKPgE1DwhLgdQYFCjYAgM0hF8pl+IDNIFus4Naf/NU3t2Ljly1G19XMdRvrv2IOz3QlKI1I+NNP/iId1uHHyC2i8irIr64gocK7ttfe2Tjj+pkr6Hjb2TXRxinhJLiYu+7HUo7BeTAJgHUqvFHtBUu1SrmRsjS1SL7O2Az/1Cjk/RlTg+5AcLCMipT1E24PTFl2qvoZejX6+RzMiYDcwqSZtQmGLz3ZcarnYBxrQr26pZ7fAwPjKakp2sRvOk43czgGgHgFApQCfRT2GQy5HbXHermNA8UQ8ujLVo57hxN8PMXVOjs6qDlDMAOfhqVV7dpXED+INfXRBtEYvkcZAWwKL1qZKa5K+O4tSRPtNMTi4gohrtjsQoG0tkknhphiDZSXCLE8T1/TWkPROt7Ih16/O13aOx5mFMoNYKJ+V4EdBvj7l1pw1VcbhuGPVhEZZOeOVsi6/Wf4w+W5rqtlf+kJx/Fn35O1GwWT2g2aVLxRUdIsgN0jS1bP9lcpppJiHVLvtPFpefYH5z+2I9s1uowfntkcFQACYudjSPld6If9UZCE/IK5M6von6IQG+FsOA+czC8Aq4wOwTdKv293ANvax1YsWJj8nJsKyMzXWEc5kOfLS4u25MREOwvDL+5tScp3gtAwHbhrbsSk5x8mcrHh6zSppYjP95uTmhURsw4+FbR5mYVtHWBNbJtu814aCEsJgQAhRHniJaCQHQcLwMIog8ioVWEIE1fljRPU5P+LPgxDhF+XhixWhsoYwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"react hooks representation\"\n        title=\"react hooks representation\"\n        src=\"/static/614488308537ef9bd8f60457869947e3/799d3/react-hooks-representation.png\"\n        srcset=\"/static/614488308537ef9bd8f60457869947e3/00d96/react-hooks-representation.png 148w,\n/static/614488308537ef9bd8f60457869947e3/0b23c/react-hooks-representation.png 295w,\n/static/614488308537ef9bd8f60457869947e3/799d3/react-hooks-representation.png 590w,\n/static/614488308537ef9bd8f60457869947e3/3dead/react-hooks-representation.png 684w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<center>React hooks 粗略概要</center>\n<p>首先让我们来了解一下确保 hooks 在 React 作用域内被调用的机制，因为如果没有在正确的上下文执行 hooks 是没有意义的：</p>\n<h3>The dispatcher</h3>\n<p>dispatcher 是一个包含 hooks 函数的共享的对象。它在 ReactDOM 渲染的时期动态地被分配或被清除，并保证用户在 React 组件外不能访问 hooks（<a href=\"https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberHooks.js#L62\">源码实现</a>）。</p>\n<p>dispatcher 在每个和每次 hook 调用时通过 <code class=\"language-text\">resolveDispatcher()</code> 函数来处理（<a href=\"https://github.com/facebook/react/blob/19f6fe170ce920d7183a5620f4e218334c8bac62/packages/react/src/ReactHooks.js#L21\">源码实现</a>）。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> currentDispatcher<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> dispatcherWithHooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* ... */</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">resolveDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentDispatcher<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> currentDispatcher<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hooks can't be called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useXXX</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dispatcher <span class=\"token operator\">=</span> <span class=\"token function\">resolveDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> dispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">useXXX</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">renderRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentDispatcher <span class=\"token operator\">=</span> dispatcherWithHooks<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">performWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  currentDispatcher <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<center>Dispatcher 简单实现</center>\n<p>我们有了初步认识，现在正式来了解 hooks。首先介绍一个新概念：</p>\n<h3>The hooks queue</h3>\n<p>在底层，hooks 在它们调用顺序中作为 node 节点链接在一起。它们如此表现是因为 hooks 并不是简单地创建和销毁。它们通过一种机制来实现。每个 hook 有多个属性：</p>\n<ul>\n<li>在初始渲染时创建它的初始状态</li>\n<li>它们的状态随时可以更新</li>\n<li>React 在将来的渲染时能够记住 hook 的状态</li>\n<li>React 能够基于调用顺序提供正确的状态</li>\n<li>React 知道 hook 属于哪个 fiber</li>\n</ul>\n<p>相应的，我们需要重新思考我们看待组件状态的方式。目前为止我们理解的是简单的对象：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  foo<span class=\"token operator\">:</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span>\n  bar<span class=\"token operator\">:</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">,</span>\n  baz<span class=\"token operator\">:</span> <span class=\"token string\">'baz'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>但是当处理 hooks 时，它们应该被当作队列来看待，每个节点代表了状态中的每个 model：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  memoizedState<span class=\"token operator\">:</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span>\n  next<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    memoizedState<span class=\"token operator\">:</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">,</span>\n    next<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      memoizedState<span class=\"token operator\">:</span> <span class=\"token string\">'baz'</span><span class=\"token punctuation\">,</span>\n      next<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>每个 hook 节点的 schema 的<a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L243\">实现</a>，hook 上这些属性重点关注 <code class=\"language-text\">memoizedState</code> 和 <code class=\"language-text\">next</code>，其他的属性专门用于 <code class=\"language-text\">useReducer()</code> hook 来缓存 dispatched actions 和 基础状态来保证在大多数情况下 reduction 过程可以作为 fallback 重复执行：</p>\n<ul>\n<li><code class=\"language-text\">baseState</code> - 传入 reducer 的 state 对象</li>\n<li><code class=\"language-text\">baseUpdate</code> - 创建 <code class=\"language-text\">baseState</code> 的最新 dispatched action</li>\n<li><code class=\"language-text\">queue</code> - dispatched actions 的最新队列，等待传入 reducer</li>\n</ul>\n<p>回到 hooks，在每个及每次函数组件调用前，<code class=\"language-text\">prepareHooks()</code> 函数会先调用，当前的 fiber 和在 hooks 队列中的的第一个节点被保存在全局的变量中。通过这种方式，每次我们调用 hook 函数（<code class=\"language-text\">useXXX()</code>）它都知道要在哪个上下文执行。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> currentlyRenderingFiber<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> workInProgressQueue<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> currentHook<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">prepareHooks</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">recentFiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentlyRenderingFiber <span class=\"token operator\">=</span> workInProgressFiber<span class=\"token punctuation\">;</span>\n  currentHook <span class=\"token operator\">=</span> recentFiber<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">finishHooks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentlyRenderingFiber<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> workInProgressHook<span class=\"token punctuation\">;</span>\n  currentlyRenderingFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  workInProgressHook <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  currentHook <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">resolveCurrentlyRenderingFiber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentlyRenderingFiber<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> currentlyRenderingFiber<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hooks can't be called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  workInProgressHook <span class=\"token operator\">=</span> currentHook <span class=\"token operator\">?</span> <span class=\"token function\">cloneHook</span><span class=\"token punctuation\">(</span>currentHook<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">createNewHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  currentHook <span class=\"token operator\">=</span> currentHook<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useXXX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">resolveCurrentlyRenderingFiber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">createWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">recentFiber<span class=\"token punctuation\">,</span>\n  workInProgressFiber<span class=\"token punctuation\">,</span>\n  Component<span class=\"token punctuation\">,</span>\n  props</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">prepareHooks</span><span class=\"token punctuation\">(</span>recentFiber<span class=\"token punctuation\">,</span> workInProgressFiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">Component</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">finishHooks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>一旦更新结束，<code class=\"language-text\">finishHooks()</code> 函数会被调用，在 hooks 队列中的第一个节点的引用会存储在渲染过的 fiber 的 <code class=\"language-text\">memoizedState</code> 属性中。这意味着 hooks 队列和它的状态可以在外部被定位：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ChildComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'baz'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ParentComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> childFiberRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> hookNode <span class=\"token operator\">=</span> childFiberRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hookNode<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    hookNode <span class=\"token operator\">=</span> hooksNode<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hookNode<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    hookNode <span class=\"token operator\">=</span> hooksNode<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hookNode<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> <span class=\"token string\">'baz'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ChildComponent</span></span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>childFiberRef<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<center>外部读取组件记忆的状态</center>\n<p>我们来看一下更详细的独立的 hooks，首先看一下常见的 state hook：</p>\n<h3>State hooks</h3>\n<p>或许会感到奇怪，但是 <code class=\"language-text\">useState</code> hook 在底层使用了 <code class=\"language-text\">useReducer</code> hook 并简单提供了一个预定义的 reducer（<a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L339\">查看实现</a>）。这就是说 <code class=\"language-text\">useState</code> 返回的结果实际是一个 reducer state 和一个 action dispatcher。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">basicStateReducer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">typeof</span> action <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function\">action</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> action<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>state setter 还可以基于父组件当前的状态执行变更，而不需要传入不同的 prop：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ParentComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> setName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ChildComponent</span></span> <span class=\"token attr-name\">toUpperCase</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>setName<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ChildComponent</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">props</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    props<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span> <span class=\"token operator\">=></span> state<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>最后我们来看一下 effect hook，在组件生命周期起了什么主要作用和如何工作的：</p>\n<h3>Effect hooks</h3>\n<p>Effect hook 表现有些不同，并且有个额外的逻辑层：</p>\n<ul>\n<li>在渲染时创建，但是在绘制结束时执行</li>\n<li>如果提供了，它们会在下次绘制前被销毁</li>\n<li>它们的调用根据定义时的顺序执行</li>\n</ul>\n<p>每个 fiber 的 hooks 队列中保存了 effect 节点。每个 effect 的类型不同，应在合适的阶段执行：</p>\n<ul>\n<li>在更新前执行 <code class=\"language-text\">getSnapshotBeforeUpdate()</code>（<a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js#L646\">实现</a>）</li>\n<li>执行所有的插入，更新，删除和卸载（<a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js#L687\">实现</a>）</li>\n<li>执行所有生命周期函数和 ref 回调函数。生命周期的函数单独执行，在整棵树的所有插入，更新删除都已被执行。该执行也触发了渲染器特定的初始 effects。（<a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js#L732\">实现</a>）</li>\n<li>Effects 是通过 <code class=\"language-text\">useEffect()</code> hook 调度（<a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js#L779\">实现</a>）</li>\n</ul>\n<p>当执行到 effect hooks 时，它们被存在 fiber 的 <code class=\"language-text\">udpateQueue</code> 属性中，每个 effect 节点有以下 schema（<a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L477\">实现</a>）：</p>\n<ul>\n<li><code class=\"language-text\">tag</code> - 二级制数指定了 effect 的行为</li>\n<li><code class=\"language-text\">create</code> - 绘制结束后应该执行的回调</li>\n<li><code class=\"language-text\">destory</code> - <code class=\"language-text\">create()</code> 返回的回调函数，应该在初次渲染后执行</li>\n<li><code class=\"language-text\">inputs</code> - 一些值得集合决定 effect 应该销毁和重建</li>\n<li><code class=\"language-text\">next</code> - 在函数组件中定义的下一个 effect 的引用</li>\n</ul>\n<p>除了 <code class=\"language-text\">tag</code> 属性之外，其他属性比较直接和易懂。 <code class=\"language-text\">tag</code> 是一些二级制值的组合：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> NoEffect <span class=\"token operator\">=</span> <span class=\"token comment\">/*             */</span> <span class=\"token number\">0b00000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> UnmountSnapshot <span class=\"token operator\">=</span> <span class=\"token comment\">/*      */</span> <span class=\"token number\">0b00000010</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> UnmountMutation <span class=\"token operator\">=</span> <span class=\"token comment\">/*      */</span> <span class=\"token number\">0b00000100</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> MountMutation <span class=\"token operator\">=</span> <span class=\"token comment\">/*        */</span> <span class=\"token number\">0b00001000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> UnmountLayout <span class=\"token operator\">=</span> <span class=\"token comment\">/*        */</span> <span class=\"token number\">0b00010000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> MountLayout <span class=\"token operator\">=</span> <span class=\"token comment\">/*          */</span> <span class=\"token number\">0b00100000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> MountPassive <span class=\"token operator\">=</span> <span class=\"token comment\">/*         */</span> <span class=\"token number\">0b01000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> UnmountPassive <span class=\"token operator\">=</span> <span class=\"token comment\">/*       */</span> <span class=\"token number\">0b10000000</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>对于这些二进制值常用的有管道符（<code class=\"language-text\">|</code>）并按位添加到单个值。然后通过连字符（<code class=\"language-text\">&amp;</code>）来检测 tag 是否实现了某中类型。如果结果非 0，意味着 tag 指定了具体的行为。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> MountPassive <span class=\"token operator\">|</span> UnmountPassive<span class=\"token punctuation\">;</span>\n<span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>effectTag<span class=\"token punctuation\">,</span> <span class=\"token number\">0b11000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> MountPassive<span class=\"token punctuation\">,</span> <span class=\"token number\">0b10000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>以下是 React 支持的 effect hook 类型：</p>\n<ul>\n<li>Default effect — <code class=\"language-text\">UnmountPassive | MountPassive</code></li>\n<li>Mutation effect — <code class=\"language-text\">UnmountSnapshot | MountMutation</code></li>\n<li>Layout effect — <code class=\"language-text\">UnmountMutation | MountLayout</code></li>\n</ul>\n<p>以下是 React 如何检测表现实现的：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">&amp;</span> unmountTag<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoHookEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Unmount</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">&amp;</span> mountTag<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoHookEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Mount</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>基于我们已经了解的 effect hooks，我们可以从外部注入 effect 到一个确切的 fiber：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">injectEffect</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> lastEffect <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">.</span>lastEffect\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">destroyEffect</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on destroy'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createEffect</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on create'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> destroy\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> injectedEffect <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    tag<span class=\"token operator\">:</span> <span class=\"token number\">0b11000000</span><span class=\"token punctuation\">,</span>\n    next<span class=\"token operator\">:</span> lastEffect<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">,</span>\n    create<span class=\"token operator\">:</span> createEffect<span class=\"token punctuation\">,</span>\n    destroy<span class=\"token operator\">:</span> destroyEffect<span class=\"token punctuation\">,</span>\n    inputs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>createEffect<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  lastEffect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> injectedEffect\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> ParentComponent <span class=\"token operator\">=</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ChildComponent</span></span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>injectEffect<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h3>参考</h3>\n<p><a href=\"https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba\">https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba</a></p>","frontmatter":{"title":"【译】浅析 React Hooks","date":"January 08, 2020","description":"本文对目前大热的 React Hooks 源码进行简单剖析。"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"tags":["React","React Hooks"],"slug":"/unveil-react-hooks-system/","previous":{"excerpt":"最近在看 Redux 文档，了解了 redux 的工作原理，发现 action 只能同步被 dispatch，那有没有办法执行异步调用呢？答案是通过中间件来实现。之前简单了解过 Node.js 服务端框架 Express 和 Koa…","fields":{"slug":"/understanding-the-middleware/"},"frontmatter":{"date":"January 12, 2020","description":"了解中间件的概念","title":"【译】了解中间件","tags":["middleware"]}},"next":{"excerpt":"什么是装饰器 装饰器是“装饰函数（或方法）”的一种简称。它是一个通过修改传入的函数或方法的行为并返回一个新函数的函数。 我们可以在任何支持函数为一等公民的语言中实现装饰器，如 JavaScript…","fields":{"slug":"/understanding-javascript-decorators/"},"frontmatter":{"date":"January 05, 2020","description":"JavaScript 装饰器入门介绍","title":"【译】JavaScript 装饰器","tags":["JavaScript Decorator"]}}}}}